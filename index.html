<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
    <style>
        * { -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .animate-slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f9f9f9; 
            color: #4b5563; 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden; 
        }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            display: none;
        }
        input:read-only, select:disabled, textarea:readOnly {
            pointer-events: none;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp, getApps, deleteApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { Calendar, MapPin, Clock, Train, Bus, Car, Footprints, Plane, TramFront, Plus, Trash2, Map as LucideMap, ArrowRight, Image, Loader, X, DollarSign, Navigation, PieChart, Menu, History, LogOut, Check, CloudSun, Timer, BarChart3, BedDouble, Phone, Settings, Camera, ChevronDown, LogIn, LogOut as LogOutIcon, Pencil, Users, Edit3, CloudCog, Shield, Save, UserX, Copy, Wifi, WifiOff, Database, ArrowRightCircle, Info, Download } from 'lucide-react';

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-travel-planner';

        // --- Constants ---
        const currencies = [
            { value: 'JPY', label: '日圓 (JPY)' },
            { value: 'TWD', label: '新台幣 (TWD)' }
        ];

        const transportOptions = [
            { value: 'walk', label: '步行', icon: Footprints }, { value: 'car', label: '自駕', icon: Car },
            { value: 'taxi', label: '計程車', icon: Car }, { value: 'bus', label: '公車', icon: Bus },
            { value: 'train', label: '電車', icon: Train }, { value: 'shinkansen', label: '新幹線', icon: Train },
            { value: 'nightbus', label: '夜間巴士', icon: Bus }, { value: 'tram', label: '路面電車', icon: TramFront },
            { value: 'plane', label: '飛機', icon: Plane },
        ];

        const CATEGORY_COLORS = { '餐飲': '#FF6384', '交通': '#36A2EB', '住宿': '#FFCE56', '購物': '#4BC0C0', '娛樂': '#9966FF', '門票': '#FF9F40', '藥妝': '#FF6B6B', '其他': '#C9CBCF' };

        // --- Helper Functions ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getOrCreateUserId = () => {
            let uid = localStorage.getItem('gtp_local_uid');
            if (!uid) {
                uid = generateId();
                localStorage.setItem('gtp_local_uid', uid);
            }
            return uid;
        };

        const resizeImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height, max = 1024;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
        
        const sanitizeFirestoreData = (data) => JSON.parse(JSON.stringify(data, (k, v) => v === undefined ? null : v));
        const getDatesArray = (s, e) => { const a = [], d = new Date(s), ed = new Date(e); while(d<=ed) { a.push(new Date(d).toISOString().split('T')[0]); d.setDate(d.getDate()+1); } return a; };
        const getDayOfWeek = (d) => ['週日','週一','週二','週三','週四','週五','週六'][new Date(d).getDay()];
        const getMonthDay = (d) => { const date = new Date(d); return `${date.getMonth()+1}/${date.getDate()}`; };
        
        const openGoogleMaps = (query) => {
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
        };

        const processImageUpload = async (file) => {
            const b64 = await resizeImage(file);
            if (!b64) return null;
            const imgbbKey = localStorage.getItem('gtp_imgbb_key');
            if (imgbbKey) {
                try {
                    const formData = new FormData();
                    formData.append('image', b64.split(',')[1]);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, { method: 'POST', body: formData });
                    const data = await res.json();
                    if (data.success) return data.data.url;
                } catch (err) { console.error("Imgbb error", err); }
            }
            return b64;
        };

        // --- Sub-Components ---

        const AutoSaveInput = ({ value, onSave, readOnly, ...props }) => {
            const [v, setV] = useState(value ?? '');
            useEffect(() => setV(value ?? ''), [value]);
            const handleBlur = () => {
                const normalizedV = v === null || v === undefined ? '' : String(v);
                const normalizedValue = value === null || value === undefined ? '' : String(value);
                if (normalizedV !== normalizedValue) onSave(normalizedV);
            };
            const propsFinal = { ...props, value: v, onChange: e => setV(e.target.value), onBlur: handleBlur, onKeyDown: e => e.key === 'Enter' && e.target.blur(), readOnly };
            return props.type === 'textarea' ? <textarea {...propsFinal} /> : <input {...propsFinal} />;
        };

        const InfoPopup = ({ isOpen, onClose, title, content }) => !isOpen ? null : (
            <div className="fixed inset-0 z-[200] flex items-center justify-center px-4">
                <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                <div className="bg-white w-full max-w-sm rounded-2xl p-6 relative z-10 shadow-xl border border-gray-100">
                    <h3 className="text-lg font-bold text-[#0ABAB5] mb-3 flex items-center gap-2"><Info size={20} /> {title}</h3>
                    <div className="text-sm text-gray-600 leading-relaxed whitespace-pre-line">{content}</div>
                    <button onClick={onClose} className="mt-6 w-full py-2.5 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition-colors">了解</button>
                </div>
            </div>
        );

        const ConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => !isOpen ? null : (
            <div className="fixed inset-0 z-[200] flex items-center justify-center px-4">
                <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onCancel}></div>
                <div className="bg-[#F5FDFC] w-full max-w-xs rounded-2xl p-6 relative z-10 text-center border border-gray-100 shadow-xl">
                    <h3 className="text-lg font-bold text-gray-800 mb-2">確認</h3>
                    <p className="text-gray-600 mb-6 text-sm whitespace-pre-line">{message}</p>
                    <div className="flex gap-3"><button onClick={onCancel} className="flex-1 py-2 rounded-xl text-gray-500 bg-gray-200">取消</button><button onClick={onConfirm} className="flex-1 py-2 rounded-xl bg-red-500 text-white">確定</button></div>
                </div>
            </div>
        );

        const SimplePieChart = ({ data }) => {
            const total = data.reduce((sum, item) => sum + item.value, 0);
            if (total === 0) return <div className="h-40 flex items-center justify-center text-gray-400 text-sm border-2 border-dashed border-gray-200 rounded-full w-40 mx-auto">尚無消費數據</div>;
            let currentAngle = 0;
            return (
                <div className="relative h-48 w-48 mx-auto">
                    <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                        {data.map((item, i) => {
                            const angle = (item.value / total) * 360;
                            const x1 = 50 + 50 * Math.cos(Math.PI * currentAngle / 180);
                            const y1 = 50 + 50 * Math.sin(Math.PI * currentAngle / 180);
                            const x2 = 50 + 50 * Math.cos(Math.PI * (currentAngle + angle) / 180);
                            const y2 = 50 + 50 * Math.sin(Math.PI * (currentAngle + angle) / 180);
                            const largeArc = angle > 180 ? 1 : 0;
                            const pathData = total === item.value ? `M 50 50 m -50, 0 a 50,50 0 1,0 100,0 a 50,50 0 1,0 -100,0` : `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArc} 1 ${x2} ${y2} Z`;
                            const slice = <path key={i} d={pathData} fill={item.color} stroke="white" strokeWidth="1" />;
                            currentAngle += angle;
                            return slice;
                        })}
                        <circle cx="50" cy="50" r="30" fill="white" />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center flex-col">
                        <span className="text-xs text-gray-400">總支出</span>
                        <span className="text-lg font-bold text-gray-700">${total.toLocaleString()}</span>
                    </div>
                </div>
            );
        };

        const SimpleBarChart = ({ data }) => {
            const maxVal = Math.max(...data.map(d => d.total), 1); 
            return (
                <div className="w-full overflow-x-auto no-scrollbar">
                    <div className="flex items-end gap-3 h-40 pt-6 px-2 min-w-max">
                        {data.map((item, i) => {
                            const heightPercent = (item.total / maxVal) * 100;
                            return (
                                <div key={i} className="flex flex-col items-center gap-1 group w-12 h-full justify-end">
                                    <div className="relative w-4 rounded-t-md bg-[#C8D9D9] border border-[#B0C4C4]" style={{ height: `${Math.max(heightPercent, 2)}%` }}>
                                        {item.total > 0 && <div className="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-[8px] px-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-20">${item.total}</div>}
                                    </div>
                                    <div className="text-[8px] text-gray-500 font-medium">{item.date.slice(5)}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const TransactionDetailModal = ({ transaction, onClose, onViewImage }) => {
            if (!transaction) return null;
            const color = CATEGORY_COLORS[transaction.category] || '#ccc';
            return (
                <div className="fixed inset-0 z-[120] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm"></div>
                    <div className="bg-white w-full max-w-sm rounded-2xl p-5 relative z-10 shadow-xl" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center gap-2 mb-4"><div className="w-2 h-8 rounded-full" style={{backgroundColor:color}}></div><h3 className="text-xl font-bold text-gray-800">{transaction.title || '未命名'}</h3></div>
                        <div className="space-y-4">
                            <div className="flex justify-between border-b border-gray-100 pb-2"><span className="text-gray-500">金額</span><span className="text-2xl font-bold text-[#D68C68]">{transaction.cost} <small>{transaction.currency}</small></span></div>
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div><label className="text-xs text-gray-400 block">分類</label>{transaction.category}</div>
                                <div><label className="text-xs text-gray-400 block">付款人</label>{transaction.payer}</div>
                            </div>
                            {transaction.photoUrls?.length > 0 && <div className="flex gap-2 overflow-x-auto no-scrollbar">{transaction.photoUrls.map((p, i) => (<img key={i} src={typeof p === 'string' ? p : p.url} className="w-20 h-20 object-cover rounded-lg" onClick={() => onViewImage(typeof p === 'string' ? p : p.url)} />))}</div>}
                            <button onClick={onClose} className="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold mt-2">關閉</button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditTripModal = ({ isOpen, onClose, tripData, onSave }) => {
            const [formData, setFormData] = useState({ destination: '', startDate: '', endDate: '' });
            useEffect(() => {
                if (isOpen && tripData) {
                    setFormData({ destination: tripData.destination || '', startDate: tripData.startDate || '', endDate: tripData.endDate || '' });
                }
            }, [isOpen, tripData]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[170] flex items-center justify-center px-4">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white w-full max-w-sm rounded-2xl p-6 relative z-10 shadow-xl border border-gray-100 animate-fadeIn">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Settings size={22} className="text-[#0ABAB5]" /> 旅程設定</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-100 rounded-full"><X size={20} className="text-gray-400" /></button>
                        </div>
                        <div className="space-y-5">
                            <div>
                                <label className="text-xs font-bold text-gray-400 block mb-1 uppercase tracking-wider">目的地名稱</label>
                                <input value={formData.destination} onChange={e=>setFormData({...formData, destination: e.target.value})} className="w-full p-3 bg-gray-100 rounded-xl outline-none font-bold text-gray-700 focus:ring-2 focus:ring-[#0ABAB5]/20" />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs font-bold text-gray-400 block mb-1 uppercase tracking-wider">開始日期</label>
                                    <input type="date" value={formData.startDate} onChange={e=>setFormData({...formData, startDate: e.target.value})} className="w-full p-3 bg-gray-100 rounded-xl text-sm font-bold text-gray-700 outline-none" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-400 block mb-1 uppercase tracking-wider">結束日期</label>
                                    <input type="date" value={formData.endDate} onChange={e=>setFormData({...formData, endDate: e.target.value})} className="w-full p-3 bg-gray-100 rounded-xl text-sm font-bold text-gray-700 outline-none" />
                                </div>
                            </div>
                            <div className="pt-2">
                                <button onClick={() => { if(!formData.destination.trim()) return alert("請輸入名稱"); onSave(formData); }} className="w-full py-4 bg-[#0ABAB5] text-white rounded-xl font-bold shadow-lg active:scale-95 transition-all">儲存變更</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AccommodationCard = ({ date, data, onUpdate, onPhotoUpload, onPhotoDelete, onViewImage, onAdd, onDelete, isOwner, currentMember }) => {
            const [expandedId, setExpandedId] = useState(null);
            return (
                <div className="bg-[#FFF9C4] border border-yellow-300 shadow-sm rounded-2xl p-1.5 mt-4 relative mb-2">
                    {(!data || data.length === 0) && <div className="text-center text-yellow-600 text-xs py-1">尚未新增住宿</div>}
                    {(data || []).map((item, index) => {
                        if (!item) return null;
                        const isExpanded = expandedId === item.id;
                        return (
                            <div key={item.id || index} className={index > 0 ? "border-t border-yellow-200 pt-0.5 mt-0.5" : ""}>
                                <div className="flex items-center justify-between cursor-pointer" onClick={() => setExpandedId(isExpanded ? null : item.id)}>
                                    <div className="flex items-center gap-1 flex-1 min-w-0 pr-8">
                                        <BedDouble size={14} className="text-gray-600 flex-shrink-0" />
                                        <div onClick={(e) => e.stopPropagation()} className="w-[80%]">
                                            <AutoSaveInput type="text" readOnly={!isOwner} placeholder="輸入飯店名稱..." value={item.name} onSave={(val) => onUpdate(item.id, 'name', val)} className="bg-transparent text-xs font-bold text-gray-800 outline-none w-full" />
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-1">
                                        {isOwner && <button onClick={(e) => { e.stopPropagation(); onDelete(item.id); }} className="text-red-400 p-0.5"><Trash2 size={12} /></button>}
                                        <ChevronDown size={14} className={`text-yellow-600 transition ${isExpanded ? 'rotate-180' : ''}`} />
                                    </div>
                                </div>
                                <div className={`transition-all overflow-hidden ${isExpanded ? 'max-h-[1000px] opacity-100' : 'max-h-0 opacity-0'}`}>
                                    <div className="pt-1 pb-0.5 space-y-1">
                                        <div className="flex-1 flex flex-col gap-1">
                                            <AutoSaveInput type="text" readOnly={!isOwner} placeholder="訂房編號" value={item.bookingCode} onSave={(val) => onUpdate(item.id, 'bookingCode', val)} className="text-xs text-gray-500 bg-transparent outline-none w-full px-1"/>
                                            <AutoSaveInput type="text" readOnly={!isOwner} placeholder="備註 (Wifi/密碼...)" value={item.note} onSave={(val) => onUpdate(item.id, 'note', val)} className="text-xs text-gray-600 bg-transparent outline-none w-full px-1 border-b border-yellow-200 border-dashed pb-1"/>
                                        </div>
                                        <div className="flex gap-2">
                                            <div className="flex-[3] bg-[#E2E2E2] rounded-lg px-2 py-0.5 flex items-center gap-1 overflow-hidden">
                                                <Phone size={10} className="text-green-600 flex-shrink-0" />
                                                <AutoSaveInput type="text" readOnly={!isOwner} placeholder="電話" value={item.phone} onSave={(val) => onUpdate(item.id, 'phone', val)} className="text-[10px] bg-transparent outline-none w-full" />
                                            </div>
                                            <div className="flex-[7] bg-[#E2E2E2] rounded-lg px-2 py-0.5 flex items-center gap-1 overflow-hidden">
                                                <MapPin size={10} className="text-red-500 flex-shrink-0" />
                                                <AutoSaveInput type="text" readOnly={!isOwner} placeholder="地址" value={item.address} onSave={(val) => onUpdate(item.id, 'address', val)} className="text-[10px] bg-transparent outline-none w-full" />
                                                <button onClick={() => item.address && window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}`, '_blank')} className="text-blue-500"><Navigation size={10} /></button>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 overflow-x-auto no-scrollbar py-1">
                                            {item.photoUrls?.map((p, i) => {
                                                const url = typeof p === 'string' ? p : p.url;
                                                const canDel = isOwner || (currentMember && p.uploader === currentMember.name);
                                                return (<div key={i} className="relative flex-shrink-0"><img src={url} className="w-10 h-10 object-cover rounded-lg border border-yellow-200" onClick={() => onViewImage(url)} />{canDel && <button onClick={() => onPhotoDelete(item.id, url, 'accom')} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8} /></button>}</div>);
                                            })}
                                            <button onClick={() => onPhotoUpload(item.id)} className="w-10 h-10 border-2 border-dashed border-yellow-300 text-yellow-500 rounded-lg flex items-center justify-center bg-yellow-100"><Image size={14} /></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                    {isOwner && <button onClick={onAdd} className="absolute -bottom-6 right-2 bg-yellow-400 text-white shadow-md rounded-full p-1.5 border-2 border-white"><Plus size={14} /></button>}
                </div>
            );
        };

        const MemberManagementModal = ({ isOpen, onClose, tripData, currentMember, onUpdateMember, onRemoveMember, onAddMember }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newMemberName, setNewMemberName] = useState('');
            if (!isOpen || !tripData) return null;
            const isOwner = currentMember?.role === 'owner';
            const handleAdd = () => {
                if (!newMemberName.trim()) return;
                onAddMember({ name: newMemberName.trim(), pin: '0000', role: 'collaborator', deviceId: 'manual_' + Date.now() });
                setNewMemberName(''); setIsAdding(false);
            };
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center px-4">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-full max-w-md rounded-2xl p-6 relative z-10 flex flex-col max-h-[80vh] shadow-2xl border border-gray-100">
                        <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-[#0ABAB5] flex items-center gap-2"><Users size={20}/> 旅伴管理</h3><button onClick={onClose}><X size={20}/></button></div>
                        <div className="overflow-y-auto space-y-2 mb-4 pr-1">
                            {tripData.members.map((m, i) => (
                                <div key={i} className={`p-3 rounded-xl border flex justify-between items-center ${m.name === currentMember?.name ? 'border-[#0ABAB5] bg-[#EDF7F6]' : 'border-gray-100 bg-white'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500">{m.name.charAt(0)}</div>
                                        <div><div className="font-bold text-sm text-gray-700">{m.name} {m.role === 'owner' && <Shield size={12} className="inline text-yellow-500"/>}</div><div className="text-[10px] text-gray-400">PIN: {m.pin}</div></div>
                                    </div>
                                    {isOwner && m.role !== 'owner' && <button onClick={() => onRemoveMember(i)} className="text-gray-300 hover:text-red-400 p-2"><UserX size={16}/></button>}
                                </div>
                            ))}
                        </div>
                        {isOwner && (isAdding ? (
                            <div className="flex gap-2"><input value={newMemberName} onChange={e=>setNewMemberName(e.target.value)} className="flex-1 p-2 bg-[#E2E2E2] rounded-lg text-sm outline-none" placeholder="旅伴名稱"/><button onClick={handleAdd} className="bg-[#0ABAB5] text-white p-2 rounded-lg"><Check size={18}/></button></div>
                        ) : <button onClick={()=>setIsAdding(true)} className="w-full py-2 bg-[#E0F2F1] text-[#00695C] rounded-lg font-bold text-sm">+ 新增旅伴</button>)}
                    </div>
                </div>
            );
        };

        const LandingView = ({ onConnect, onOffline, joinId, setJoinId, onJoin, recentTrips, onDeleteTrip, isOffline, onCreateTrip }) => {
            const [configInput, setConfigInput] = useState('');
            const [imgbbKey, setImgbbKey] = useState(''); 
            const [testStatus, setTestStatus] = useState('idle');
            const [errorMessage, setErrorMessage] = useState('');
            const [infoType, setInfoType] = useState(null); 

            useEffect(() => {
                const storedConfig = localStorage.getItem('gtp_firebase_config');
                const storedImgbb = localStorage.getItem('gtp_imgbb_key');
                if (storedConfig) {
                    try { setConfigInput(JSON.stringify(JSON.parse(storedConfig), null, 2).replace(/[{}]/g, '').trim()); } catch(e) { setConfigInput(storedConfig); }
                }
                if (storedImgbb) setImgbbKey(storedImgbb);
            }, []);

            const handleTest = async () => {
                setTestStatus('testing');
                setErrorMessage('');
                const parseConfig = (str) => {
                    try { return JSON.parse(str); } catch (e) {
                        const obj = {};
                        ['apiKey', 'projectId', 'authDomain', 'storageBucket', 'messagingSenderId', 'appId'].forEach(key => {
                            const regex = new RegExp(`${key}\\s*:\\s*["']([^"']+)["']`, 'i');
                            const match = str.match(regex);
                            if (match) obj[key] = match[1];
                        });
                        return obj.apiKey ? obj : null;
                    }
                };
                const config = parseConfig(configInput);
                if (!config) { setTestStatus('error'); setErrorMessage('設定檔格式不正確'); return; }
                try {
                    const tempApp = initializeApp(config, 'test-' + Date.now());
                    await signInAnonymously(getAuth(tempApp));
                    await deleteApp(tempApp);
                    localStorage.setItem('gtp_firebase_config', JSON.stringify(config));
                    localStorage.setItem('gtp_imgbb_key', imgbbKey.trim());
                    onConnect(config);
                    setTestStatus('success');
                } catch (e) { setTestStatus('error'); setErrorMessage(e.message); }
            };

            return (
                <div className="flex flex-col h-full bg-[#F5FDFC] overflow-y-auto no-scrollbar">
                    <div className="flex-1 flex flex-col p-8 max-w-md mx-auto w-full">
                        <div className="text-center mb-6"><h1 className="text-3xl font-bold text-[#0ABAB5] mb-2">Travel Plan</h1><p className="text-gray-500 text-sm">設定雲端連線或讀取本機行程</p></div>
                        <div className="bg-gray-100 p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
                            <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-gray-400 uppercase tracking-wide">Firebase Configuration</label><button onClick={() => setInfoType('firebase')} className="text-gray-400 hover:text-[#0ABAB5]"><Info size={16} /></button></div>
                            <textarea value={configInput} onChange={(e) => { setConfigInput(e.target.value); setTestStatus('idle'); }} className="w-full h-12 p-3 bg-[#E2E2E2] rounded-xl text-xs font-mono outline-none resize-none mb-4 placeholder-gray-500" placeholder={`apiKey: "...",\nprojectId: "..."`} />
                            <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-gray-400 uppercase tracking-wide">Imgbb API Key (選填)</label><button onClick={() => setInfoType('imgbb')} className="text-gray-400 hover:text-[#0ABAB5]"><Info size={16} /></button></div>
                            <input value={imgbbKey} onChange={(e) => setImgbbKey(e.target.value)} className="w-full p-3 bg-[#E2E2E2] rounded-xl text-xs font-mono outline-none mb-4 placeholder-gray-500" placeholder="例如: 358e4c7..." />
                            <div className="flex items-center gap-3">
                                <button onClick={handleTest} className="flex-1 py-2 rounded-lg font-bold text-xs bg-[#E0F2F1] text-[#00695C] hover:bg-[#B2DFDB] transition-colors flex items-center justify-center gap-2">{testStatus === 'testing' ? <Loader className="animate-spin" size={14} /> : '測試並儲存連線'}</button>
                                {testStatus === 'success' && <span className="text-green-500 flex items-center text-xs font-bold gap-1 animate-fadeIn"><Check size={14}/> 成功</span>}
                                {testStatus === 'error' && <span className="text-red-500 flex items-center text-xs font-bold gap-1 animate-fadeIn"><X size={14}/> 失敗</span>}
                            </div>
                            {errorMessage && <p className="text-red-500 text-[10px] mt-2">{errorMessage}</p>}
                        </div>
                        <div className="flex gap-2 w-full mb-8">
                            <button onClick={onCreateTrip} className="flex-1 py-3 rounded-xl font-bold text-white bg-[#0ABAB5] shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"><Plus size={18} /> 建立雲端新旅程</button>
                            <button onClick={() => { localStorage.removeItem('gtp_firebase_config'); onOffline(); }} className="w-[35%] py-3 rounded-xl font-bold text-white bg-red-400 shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 text-xs"><WifiOff size={18} /> 單機版</button>
                        </div>
                        <div className="border-t border-gray-200 pt-6">
                            <div className="bg-gray-100 rounded-xl p-3 mb-4 flex gap-2 shadow-sm border border-gray-100"><input placeholder="輸入旅程 ID 例如：x9z8y7" value={joinId} onChange={e => setJoinId(e.target.value)} className="flex-1 p-2 bg-[#E2E2E2] rounded-lg text-sm outline-none font-bold text-gray-700" /><button onClick={() => onJoin(joinId)} className="bg-[#0ABAB5] text-white p-2 rounded-lg hover:bg-[#008985] transition-colors"><ArrowRight size={20} /></button></div>
                            {recentTrips.length > 0 && (
                                <div className="space-y-2">
                                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex items-center gap-2"><History size={14}/> 近期瀏覽</h3>
                                    {recentTrips.map(trip => (
                                        <div key={trip.id} onClick={() => onJoin(trip.id)} className="bg-[#EDF7F6] p-3 rounded-xl border border-gray-200 shadow-sm flex justify-between items-center cursor-pointer hover:border-[#0ABAB5] transition-all group">
                                            <div><div className="font-bold text-gray-700 text-sm flex items-center gap-2">{trip.destination}{trip.id.toString().startsWith('trip_') && <span className="text-[9px] bg-gray-100 text-gray-500 px-1.5 rounded border border-gray-200">本機</span>}</div><div className="text-[10px] text-gray-400 mt-0.5">{trip.dateRange}</div></div>
                                            <button onClick={(e) => { e.stopPropagation(); onDeleteTrip(trip.id, e); }} className="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-2"><Trash2 size={16} /></button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                    <InfoPopup isOpen={!!infoType} onClose={() => setInfoType(null)} title={infoType === 'firebase' ? 'Firebase 設定' : 'Imgbb 設定'} content={infoType === 'firebase' ? '請從 Firebase Console 複製 config 內容填入，成功測試後即可啟用雲端同步。' : '填入 Imgbb API Key 後，照片將優先上傳至外部圖床，不受 1MB 資料庫限制影響。'} />
                </div>
            );
        };

        const ActivityModal = ({ isOpen, onClose, onSave, tripData, defaultValues, currentMember, selectedDate }) => {
            const [formData, setFormData] = useState({ date: selectedDate, time: '09:00', title: '', note: '', transport: 'walk', duration: '60', bookingCode: '', cost: '', currency: 'JPY', payer: '我', category: '娛樂', photoUrls: [] });
            const fileRef = useRef(null);
            useEffect(() => {
                if (isOpen) {
                    setFormData(defaultValues ? {
                        ...defaultValues,
                        currency: defaultValues.currency || tripData?.currency || 'JPY',
                        payer: defaultValues.payer || currentMember?.name || '我',
                        date: defaultValues.date || selectedDate
                    } : {
                        date: selectedDate, time: '09:00', title: '', note: '', transport: 'walk', duration: '60', bookingCode: '', cost: '', 
                        currency: tripData?.currency || 'JPY', payer: currentMember?.name || '我', category: '娛樂', photoUrls: []
                    });
                }
            }, [isOpen, defaultValues, selectedDate, tripData, currentMember]); 
            if (!isOpen) return null;
            const handleFile = async (e) => {
                const f = e.target.files[0];
                if (f) {
                    const url = await processImageUpload(f);
                    if (url) setFormData(prev => ({ ...prev, photoUrls: [...(prev.photoUrls || []), url] }));
                }
                e.target.value = '';
            };
            return (
                <div className="fixed inset-0 z-[110] flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 bg-black/30" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-full sm:max-w-sm rounded-t-3xl sm:rounded-2xl relative z-10 flex flex-col max-h-[90vh] overflow-hidden shadow-2xl">
                        <div className="bg-[#6A8E83] p-4 text-center text-white font-bold flex justify-between items-center"><span>{defaultValues ? '編輯行程' : '新增行程'}</span><button onClick={onClose}><X size={20}/></button></div>
                        <div className="p-4 space-y-4 overflow-y-auto no-scrollbar">
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs text-gray-400 font-bold block">日期</label><input type="date" value={formData.date} onChange={e=>setFormData({...formData, date:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold border border-gray-100" /></div>
                                <div className="flex-1"><label className="text-xs text-gray-400 font-bold block">時間</label><input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold border border-gray-100" /></div>
                            </div>
                            <div><label className="text-xs text-gray-400 font-bold block">行程名稱</label><input value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})} className="w-full p-2 bg-[#E2E2E2] rounded-xl text-sm font-bold" placeholder="例如：參觀雷門" /></div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs text-gray-400 font-bold block">交通</label><select value={formData.transport} onChange={e=>setFormData({...formData, transport:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm">{transportOptions.map(t=><option key={t.value} value={t.value}>{t.label}</option>)}</select></div>
                                <div className="flex-1"><label className="text-xs text-gray-400 font-bold block">預算</label><input type="number" value={formData.cost} onChange={e=>setFormData({...formData, cost:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm" placeholder="0" /></div>
                            </div>
                            <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                {formData.photoUrls?.map((url, i) => (<div key={i} className="relative w-12 h-12 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded-lg" /><button onClick={() => setFormData(p => ({...p, photoUrls: p.photoUrls.filter((_, idx) => idx !== i)}))} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button></div>))}
                                <button onClick={()=>fileRef.current.click()} className="w-12 h-12 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400"><Camera size={20}/></button>
                                <input type="file" ref={fileRef} className="hidden" onChange={handleFile} accept="image/*" />
                            </div>
                            <button onClick={()=>onSave(formData)} className="w-full py-3 bg-[#6A8E83] text-white rounded-xl font-bold shadow-md">儲存行程</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ExpenseModal = ({ isOpen, onClose, onSave, tripData, defaultValues, currentMember, selectedDate }) => {
            const [formData, setFormData] = useState({ date: selectedDate, time: '', cost: '', title: '', payer: '', currency: '', category: '餐飲', photoUrls: [], note: '' });
            const fileRef = useRef(null);
            useEffect(() => {
                if (isOpen) {
                    setFormData(defaultValues ? { ...defaultValues, date: defaultValues.originalDate || selectedDate } : { date: selectedDate, time: new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}), cost: '', title: '', payer: currentMember?.name || '我', currency: tripData?.currency || 'JPY', category: '餐飲', photoUrls: [], note: '' });
                }
            }, [isOpen, defaultValues, selectedDate, tripData, currentMember]);
            if (!isOpen) return null;
            const handleFile = async (e) => {
                const f = e.target.files[0];
                if (f) {
                    const url = await processImageUpload(f);
                    if (url) setFormData(prev => ({ ...prev, photoUrls: [...(prev.photoUrls || []), url] }));
                }
                e.target.value = '';
            };
            return (
                <div className="fixed inset-0 z-[110] flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 bg-black/30" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-full sm:max-w-sm rounded-t-3xl sm:rounded-2xl relative z-10 flex flex-col max-h-[90vh] overflow-hidden shadow-2xl">
                        <div className="bg-[#D68C68] p-4 text-center text-white font-bold flex justify-between items-center"><span>{defaultValues ? '編輯記帳' : '新增消費'}</span><button onClick={onClose}><X size={20}/></button></div>
                        <div className="p-4 space-y-4 overflow-y-auto no-scrollbar">
                            <div className="flex gap-2">
                                <div className="flex-[2]"><label className="text-xs text-gray-400 font-bold block">金額</label><input type="number" value={formData.cost} onChange={e=>setFormData({...formData, cost:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-3 text-xl font-bold" placeholder="0" autoFocus /></div>
                                <div className="flex-1"><label className="text-xs text-gray-400 font-bold block">幣別</label><select value={formData.currency} onChange={e=>setFormData({...formData, currency:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-3 font-bold">{currencies.map(c=><option key={c.value} value={c.value}>{c.value}</option>)}</select></div>
                            </div>
                            <div><label className="text-xs text-gray-400 font-bold block">品項名稱</label><input value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})} className="w-full p-3 bg-[#E2E2E2] rounded-xl text-sm font-bold" placeholder="例如：拉麵" /></div>
                            <div className="grid grid-cols-2 gap-2">
                                <div><label className="text-xs text-gray-400 font-bold block">類別</label><select value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm">{Object.keys(CATEGORY_COLORS).map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                <div><label className="text-xs text-gray-400 font-bold block">付款人</label><select value={formData.payer} onChange={e=>setFormData({...formData, payer:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm">{tripData?.members.map(m=><option key={m.name} value={m.name}>{m.name}</option>)}</select></div>
                            </div>
                            <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                {formData.photoUrls?.map((url, i) => (<div key={i} className="relative w-12 h-12 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded-lg" /><button onClick={() => setFormData(p => ({...p, photoUrls: p.photoUrls.filter((_, idx) => idx !== i)}))} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button></div>))}
                                <button onClick={()=>fileRef.current.click()} className="w-12 h-12 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400"><Camera size={20}/></button>
                                <input type="file" ref={fileRef} className="hidden" onChange={handleFile} accept="image/*" />
                            </div>
                            <button onClick={()=>onSave(formData)} className="w-full py-3 bg-[#D68C68] text-white rounded-xl font-bold shadow-md">儲存交易</button>
                        </div>
                    </div>
                </div>
            );
        };

        const HeaderWithTabs = ({ tripData, selectedDate, setSelectedDate, handleAddDate, view, setView, setIsMenuOpen, isOffline }) => {
            const datesList = useMemo(() => tripData ? getDatesArray(tripData.startDate, tripData.endDate) : [], [tripData]);
            return (
                <div className="bg-[#0ABAB5] z-10 relative flex flex-col">
                    <div className="text-white px-4 pt-4 pb-2 flex justify-between items-start">
                        <div className="flex items-center gap-3"><button onClick={() => setIsMenuOpen(true)} className="p-1 hover:bg-white/10 rounded transition-colors"><Menu size={24}/></button><h1 className="font-bold text-xl leading-tight">{tripData.destination}</h1></div>
                        <div className="flex items-center gap-1">{isOffline ? <WifiOff size={16} className="text-red-300"/> : <Wifi size={16} className="text-[#00FF00]"/>}</div>
                    </div>
                    <div className="flex items-center pl-3 pr-4 pb-3 gap-2">
                        <div className="flex-1 flex overflow-x-auto space-x-2 no-scrollbar">{datesList.map((d, i) => (<button key={d} onClick={() => { setSelectedDate(d); setView('planner'); }} className={`flex-shrink-0 w-11 h-11 flex flex-col items-center justify-center rounded-xl transition-all border ${d === selectedDate ? 'bg-white text-[#00695C] font-bold border-[#eeeeee]' : 'bg-[#008985] text-white opacity-80 border-transparent'}`}><span className="text-[8px] opacity-70">D{i+1}</span><span className="text-[11px] font-bold">{getMonthDay(d)}</span><span className="text-[8px] opacity-70">{getDayOfWeek(d)}</span></button>))}<button onClick={handleAddDate} className="flex-shrink-0 w-11 h-11 flex items-center justify-center border border-dashed border-white/50 rounded-xl text-white active:scale-95 transition-all"><Plus size={20}/></button></div>
                        <button onClick={() => setView(view === 'planner' ? 'expense' : 'planner')} className="flex-shrink-0 w-9 h-9 bg-yellow-500 rounded-full flex items-center justify-center text-yellow-900 ring-2 ring-yellow-600 shadow-lg active:scale-95 transition-all"><DollarSign size={22} strokeWidth={3} /></button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [userId] = useState(getOrCreateUserId());
            const [view, setView] = useState('landing'); 
            const [tripId, setTripId] = useState('');
            const [tripData, setTripData] = useState(null);
            const [selectedDate, setSelectedDate] = useState('');
            const [currentMember, setCurrentMember] = useState(null); 
            const [isOffline, setIsOffline] = useState(true);
            const [recentTrips, setRecentTrips] = useState([]);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [modals, setModals] = useState({ expense: false, activity: false, viewingImage: null, transaction: null, members: false, editTrip: false });
            const [editingActivity, setEditingActivity] = useState(null);
            const [editingExpense, setEditingExpense] = useState(null);
            const [confirm, setConfirm] = useState({ open: false, msg: '', action: null });
            const [setupForm, setSetupForm] = useState({ destination: '', startDate: new Date().toLocaleDateString('en-CA'), endDate: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toLocaleDateString('en-CA'), currency: 'JPY', nickname: '', pin: '' });
            
            const isOwner = useMemo(() => currentMember?.role === 'owner', [currentMember]);
            const unsubscribeRef = useRef(null);

            useEffect(() => {
                const stored = localStorage.getItem('gtp_recent_trips');
                if (stored) setRecentTrips(JSON.parse(stored));
                const config = localStorage.getItem('gtp_firebase_config');
                if (config) handleConfigUpdate(JSON.parse(config));
            }, []);

            const handleConfigUpdate = async (config) => {
                if (unsubscribeRef.current) unsubscribeRef.current();
                if (!config) { setIsOffline(true); return; }
                try {
                    if (getApps().length > 0) await Promise.all(getApps().map(app => deleteApp(app)));
                    const app = initializeApp(config);
                    const auth = getAuth(app);
                    await signInAnonymously(auth);
                    setIsOffline(false);
                    onAuthStateChanged(auth, u => { if (!u) setIsOffline(true); });
                } catch (e) { setIsOffline(true); }
            };

            const processLoadedData = useCallback((d) => {
                if (!d) return null;
                return { ...d, flights: { outbound: d.flights?.outbound || {}, inbound: d.flights?.inbound || {} }, expenseCategories: d.expenseCategories || Object.keys(CATEGORY_COLORS), accommodations: d.accommodations || {}, itinerary: d.itinerary || {}, members: Array.isArray(d.members) ? d.members : [] };
            }, []);

            useEffect(() => {
                if (!tripId) return;
                if (isOffline) {
                    const localData = localStorage.getItem(`gtp_trip_${tripId}`);
                    if (localData) {
                        const d = processLoadedData(JSON.parse(localData));
                        setTripData(d); if (!selectedDate) setSelectedDate(d.startDate);
                        setCurrentMember(d.members.find(m => m.deviceId === userId) || d.members[0]);
                    }
                } else {
                    const db = getFirestore();
                    unsubscribeRef.current = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId), (s) => {
                        if (s.exists()) {
                            const d = processLoadedData(s.data());
                            setTripData(d); if (!selectedDate) setSelectedDate(d.startDate);
                            setCurrentMember(d.members.find(m => m && m.deviceId === (getAuth().currentUser?.uid || userId)) || d.members[0]);
                        }
                    });
                }
                return () => unsubscribeRef.current?.();
            }, [tripId, isOffline, processLoadedData, userId]);

            const updateTrip = async (field, val) => {
                const newData = { ...tripData, [field]: val };
                if (isOffline) { setTripData(newData); localStorage.setItem(`gtp_trip_${tripId}`, JSON.stringify(newData)); }
                else { await updateDoc(doc(getFirestore(), 'artifacts', appId, 'public', 'data', 'trips', tripId), { [field]: sanitizeFirestoreData(val) }); }
            };

            const { expenseStats, sortedExpenses } = useMemo(() => {
                if (!tripData) return { expenseStats: [], sortedExpenses: [] };
                const statsMap = new window.Map();
                const sortedByDate = [];
                const allDates = getDatesArray(tripData.startDate, tripData.endDate);
                allDates.forEach(date => {
                    const dayItems = (tripData.itinerary[date] || []).filter(a => a && (a.transport === 'expense' || a.cost > 0));
                    if (dayItems.length > 0) sortedByDate.push({ date, items: dayItems });
                    dayItems.forEach(item => {
                        const curr = item.currency || tripData.currency;
                        if (!statsMap.has(curr)) statsMap.set(curr, { currency: curr, total: 0, catMap: new window.Map(), dailyMap: new window.Map() });
                        const s = statsMap.get(curr); const cost = parseFloat(item.cost) || 0; s.total += cost;
                        const cat = item.category || '其他'; s.catMap.set(cat, (s.catMap.get(cat) || 0) + cost); s.dailyMap.set(date, (s.dailyMap.get(date) || 0) + cost);
                    });
                });
                const statsArr = Array.from(statsMap.values()).map(s => ({
                    currency: s.currency, total: s.total,
                    pieData: Array.from(s.catMap.entries()).map(([k, v]) => ({ category: k, value: v, color: CATEGORY_COLORS[k] || '#ccc' })).sort((a,b) => b.value - a.value),
                    barData: allDates.map(d => ({ date: d, total: s.dailyMap.get(d) || 0, breakdown: [] }))
                }));
                return { expenseStats: statsArr, sortedExpenses: sortedByDate };
            }, [tripData]);

            const handleSaveActivity = (data) => {
                const newIt = { ...tripData.itinerary }; const dayActs = [...(newIt[data.date] || [])];
                if (editingActivity) {
                    if (editingActivity.date !== data.date) { newIt[editingActivity.date] = (newIt[editingActivity.date] || []).filter(a => a.id !== editingActivity.id); dayActs.push({ ...data, id: editingActivity.id }); }
                    else { const idx = dayActs.findIndex(a => a.id === editingActivity.id); dayActs[idx] = { ...data, id: editingActivity.id }; }
                } else dayActs.push({ ...data, id: generateId(), createdBy: currentMember.name });
                newIt[data.date] = dayActs; updateTrip('itinerary', newIt); setModals({...modals, activity: false}); setEditingActivity(null);
            };

            const handleSaveExpense = (data) => {
                const newIt = { ...tripData.itinerary }; const dayActs = [...(newIt[data.date] || [])]; const exp = { ...data, transport: 'expense' };
                if (editingExpense) {
                    if (editingExpense.originalDate !== data.date) { newIt[editingExpense.originalDate] = (newIt[editingExpense.originalDate] || []).filter(e => e.id !== editingExpense.id); dayActs.push({ ...exp, id: editingExpense.id }); }
                    else { const idx = dayActs.findIndex(e => e.id === editingExpense.id); dayActs[idx] = { ...exp, id: editingExpense.id }; }
                } else dayActs.push({ ...exp, id: generateId(), createdBy: currentMember.name });
                newIt[data.date] = dayActs; updateTrip('itinerary', newIt); setModals({...modals, expense: false}); setEditingExpense(null);
            };

            const handleEditTripSave = (newData) => {
                if (!isOwner) return;
                const newDates = getDatesArray(newData.startDate, newData.endDate);
                const newIt = {};
                const newAcc = {};
                newDates.forEach(date => {
                    newIt[date] = tripData.itinerary[date] || [];
                    newAcc[date] = tripData.accommodations[date] || [];
                });
                const updatedTrip = { ...tripData, ...newData, itinerary: newIt, accommodations: newAcc };
                if (isOffline) { setTripData(updatedTrip); localStorage.setItem(`gtp_trip_${tripId}`, JSON.stringify(updatedTrip)); }
                else { setDoc(doc(getFirestore(), 'artifacts', appId, 'public', 'data', 'trips', tripId), sanitizeFirestoreData(updatedTrip)); }
                if (!newDates.includes(selectedDate)) setSelectedDate(newDates[0]);
                setModals({...modals, editTrip: false});
            };

            return (
                <div className="w-full max-w-[480px] h-screen bg-[#F5FDFC] shadow-2xl flex flex-col overflow-hidden relative mx-auto border-x border-[#eeeeee]">
                    {isMenuOpen && (
                        <div className="fixed inset-0 z-[160] flex">
                            <div className="absolute inset-0 bg-black/50" onClick={() => setIsMenuOpen(false)}></div>
                            <div className="relative w-72 bg-[#F5FDFC] h-full shadow-2xl p-6 flex flex-col animate-slide-in-left">
                                <div className="flex justify-between items-center mb-8"><h2 className="text-xl font-bold text-[#0ABAB5]">Travel Plan</h2><button onClick={() => setIsMenuOpen(false)} className="text-gray-400 p-1 hover:bg-gray-100 rounded-full"><X size={24} /></button></div>
                                {tripData && (
                                    <div className="mb-6 p-4 bg-[#EDF7F6] rounded-xl border border-[#eeeeee]">
                                        <label className="text-[10px] font-bold text-gray-400 block mb-1">{isOffline ? '本機旅程 ID' : '雲端旅程 ID'}</label>
                                        <div className="flex items-center justify-between gap-2"><span className="font-mono font-bold text-gray-700 truncate">{tripData.id}</span><button onClick={() => { const ta = document.createElement('textarea'); ta.value = tripData.id; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert("已複製 ID"); }} className="text-[#0ABAB5] p-1 hover:bg-white/50 rounded"><Copy size={16}/></button></div>
                                    </div>
                                )}
                                <nav className="space-y-2">
                                    <button onClick={() => { setTripData(null); setView('setup'); setIsMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 hover:bg-[#E0F2F1] rounded-xl font-bold text-gray-600 transition-colors"><Plus size={18} /> 建立雲端新旅程</button>
                                    {tripData && <button onClick={() => { setModals({...modals, editTrip: true}); setIsMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 hover:bg-[#E0F2F1] rounded-xl font-bold text-gray-600 transition-colors"><Settings size={18} /> 旅程設定</button>}
                                    {tripData && <button onClick={() => { setModals({...modals, members: true}); setIsMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 hover:bg-[#E0F2F1] rounded-xl font-bold text-gray-600 transition-colors"><Users size={18} /> 旅伴管理</button>}
                                    <div className="pt-4 mt-4 border-t border-gray-100"><button onClick={() => { handleConfigUpdate(null); setView('landing'); setIsMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 hover:bg-red-50 rounded-xl font-bold text-red-400 transition-colors"><LogOutIcon size={18} /> 回到連線設定</button></div>
                                </nav>
                            </div>
                        </div>
                    )}

                    {view === 'landing' ? (
                        <LandingView onConnect={c => { handleConfigUpdate(c); setView('landing'); }} onOffline={() => { handleConfigUpdate(null); setView('setup'); }} recentTrips={recentTrips} joinId={tripId} setJoinId={setTripId} onJoin={id => { setTripId(id); setView('planner'); }} onDeleteTrip={(id) => { const n = recentTrips.filter(t => t.id !== id); setRecentTrips(n); localStorage.setItem('gtp_recent_trips', JSON.stringify(n)); localStorage.removeItem(`gtp_trip_${id}`); }} onCreateTrip={() => { setTripData(null); setView('setup'); }} isOffline={isOffline} />
                    ) : (
                        <>
                            {tripData && view !== 'setup' && (
                                <HeaderWithTabs tripData={tripData} selectedDate={selectedDate} setSelectedDate={setSelectedDate} setView={setView} view={view} setIsMenuOpen={setIsMenuOpen} isOffline={isOffline} handleAddDate={() => { const d = new Date(tripData.endDate); d.setDate(d.getDate() + 1); updateTrip('endDate', d.toISOString().split('T')[0]); }} />
                            )}
                            <div className="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar">
                                {view === 'setup' ? (
                                    <div className="p-4 space-y-4 max-w-md mx-auto">
                                        <div className="text-center mb-6"><h2 className="text-3xl font-bold text-[#0ABAB5]">建立新旅程</h2><p className="text-gray-400 text-xs mt-2">設定您的目的地與初始成員資料</p></div>
                                        <div className="space-y-3">
                                            <input placeholder="目的地" className="w-full p-3 bg-[#E2E2E2] rounded-xl outline-none font-bold text-gray-700" value={setupForm.destination} onChange={e=>setSetupForm({...setupForm, destination: e.target.value})} />
                                            <div className="flex gap-2"><input type="date" className="flex-1 p-3 bg-[#E2E2E2] rounded-xl text-sm font-bold text-gray-700" value={setupForm.startDate} onChange={e=>setSetupForm({...setupForm, startDate: e.target.value})} /><input type="date" className="flex-1 p-3 bg-[#E2E2E2] rounded-xl text-sm font-bold text-gray-700" value={setupForm.endDate} onChange={e=>setSetupForm({...setupForm, endDate: e.target.value})} /></div>
                                            <select className="w-full p-3 bg-[#E2E2E2] rounded-xl font-bold text-gray-700" value={setupForm.currency} onChange={e=>setSetupForm({...setupForm, currency: e.target.value})}>{currencies.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}</select>
                                            <div className="grid grid-cols-2 gap-2"><input placeholder="您的暱稱" className="w-full p-3 bg-[#E2E2E2] rounded-xl font-bold outline-none text-gray-700" value={setupForm.nickname} onChange={e=>setSetupForm({...setupForm, nickname: e.target.value})} /><input type="password" placeholder="PIN 碼" className="w-full p-3 bg-[#E2E2E2] rounded-xl font-bold outline-none text-gray-700" value={setupForm.pin} onChange={e=>setSetupForm({...setupForm, pin: e.target.value})} /></div>
                                            <button onClick={async () => {
                                                if (!setupForm.destination || !setupForm.nickname) return alert("請填寫目的地與暱稱");
                                                const id = generateId(); const dates = getDatesArray(setupForm.startDate, setupForm.endDate);
                                                const fbUid = !isOffline ? getAuth().currentUser?.uid : null;
                                                const initData = { ...setupForm, id, members: [{ name: setupForm.nickname, pin: setupForm.pin, deviceId: isOffline ? userId : (fbUid || userId), role: 'owner' }], itinerary: {}, accommodations: {}, expenseCategories: Object.keys(CATEGORY_COLORS), flights: { outbound: {}, inbound: {} } };
                                                dates.forEach(d => { initData.itinerary[d] = []; initData.accommodations[d] = []; });
                                                if (isOffline) { localStorage.setItem(`gtp_trip_${id}`, JSON.stringify(initData)); } else { await setDoc(doc(getFirestore(), 'artifacts', appId, 'public', 'data', 'trips', id), sanitizeFirestoreData(initData)); }
                                                setRecentTrips(p => { const n = [{id, destination: setupForm.destination, dateRange: `${setupForm.startDate} - ${setupForm.endDate}`}, ...p].slice(0,5); localStorage.setItem('gtp_recent_trips', JSON.stringify(n)); return n; });
                                                setTripId(id); setSelectedDate(setupForm.startDate); setView('planner');
                                            }} className="w-full py-4 bg-[#0ABAB5] text-white rounded-xl font-bold shadow-lg mt-4 active:scale-95 transition-all">開始規劃旅程</button>
                                            <button onClick={()=>setView('landing')} className="w-full text-gray-400 text-xs text-center font-bold py-2">返回首頁</button>
                                        </div>
                                    </div>
                                ) : (
                                    !tripData ? <div className="flex h-full items-center justify-center flex-col gap-4 text-gray-400"><Loader size={32} className="animate-spin text-[#0ABAB5]" /><p className="font-bold">載入旅程中...</p></div> : (
                                        view === 'planner' ? (
                                            <div className="space-y-4 animate-slide-in-left">
                                                <div className="grid grid-cols-2 gap-3"><button onClick={()=>setModals({...modals, activity:true})} className="py-2 rounded-xl bg-[#6A8E83] text-white font-bold flex items-center justify-center gap-2 shadow-sm active:scale-95 transition-all"><Plus size={18}/>行程</button><button onClick={()=>setModals({...modals, expense:true})} className="py-2 rounded-xl bg-[#D68C68] text-white font-bold flex items-center justify-center gap-2 shadow-sm active:scale-95 transition-all"><DollarSign size={18}/>記帳</button></div>
                                                {(tripData.itinerary?.[selectedDate] || []).slice().sort((a,b)=>(a.time||'00:00').localeCompare(b.time||'00:00')).map(act => (
                                                    <div key={act.id} className="bg-white p-4 rounded-2xl shadow-sm border border-[#eeeeee] flex justify-between items-center group animate-fadeIn">
                                                        <div className="flex gap-4 items-center"><div className="text-sm font-bold text-gray-400 flex flex-col items-center"><Clock size={12}/>{act.time}</div><div className="font-bold text-gray-700 text-lg">{act.title}</div></div>
                                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => { setEditingActivity({...act, date: selectedDate}); setModals({...modals, activity: true}); }} className="p-2 text-blue-400 hover:bg-blue-50 rounded-full"><Pencil size={16} /></button><button onClick={() => setConfirm({ open: true, msg: '確定要刪除這個行程項目嗎？', action: () => updateTrip('itinerary', { ...tripData.itinerary, [selectedDate]: (tripData.itinerary[selectedDate] || []).filter(a => a.id !== act.id) }) })} className="p-2 text-red-400 hover:bg-red-50 rounded-full"><Trash2 size={16} /></button></div>
                                                    </div>
                                                ))}
                                                <AccommodationCard date={selectedDate} data={tripData.accommodations?.[selectedDate] || []} onUpdate={(id, f, v) => { const newAcc = { ...tripData.accommodations }; const dayAcc = [...(newAcc[selectedDate] || [])]; const idx = dayAcc.findIndex(i => i.id === id); if (idx >= 0) { dayAcc[idx] = { ...dayAcc[idx], [f]: v }; newAcc[selectedDate] = dayAcc; updateTrip('accommodations', newAcc); } }} onAdd={() => { const newAcc = { ...tripData.accommodations }; const dayAcc = [...(newAcc[selectedDate] || []), { id: generateId(), name: '', bookingCode: '', photoUrls: [] }]; newAcc[selectedDate] = dayAcc; updateTrip('accommodations', newAcc); }} onDelete={(id) => setConfirm({ open: true, msg: '確定刪除住宿項目？', action: () => { const newAcc = { ...tripData.accommodations }; newAcc[selectedDate] = (newAcc[selectedDate] || []).filter(i => i.id !== id); updateTrip('accommodations', newAcc); }})} onPhotoUpload={(id) => { /* Upload trigger */ }} onViewImage={(url) => setModals({...modals, viewingImage: url})} isOwner={isOwner} currentMember={currentMember} />
                                            </div>
                                        ) : (
                                            <div className="space-y-6 animate-slide-in-left">
                                                {expenseStats.map(s => (<div key={s.currency} className="bg-white p-4 rounded-2xl shadow-sm border border-[#eeeeee]"><h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><PieChart size={16} className="text-[#D68C68]"/> {s.currency} 支出統計</h3><SimplePieChart data={s.pieData} /></div>))}
                                                <div className="space-y-4">{sortedExpenses.map(group => (<div key={group.date}><div className="text-xs font-bold text-gray-400 mb-2 px-1 flex items-center gap-2"><Calendar size={12}/> {group.date}</div>{group.items.map(e => (<div key={e.id} className="bg-white p-3 rounded-xl mb-2 flex justify-between items-center shadow-sm border border-[#eeeeee] cursor-pointer" onClick={() => setModals({...modals, transaction: e})}><div><div className="font-bold text-gray-700">{e.title}</div><div className="text-[10px] text-gray-400 font-bold">{e.category} • {e.payer}</div></div><div className="flex items-center gap-3"><div className="text-red-500 font-bold text-sm">-{e.cost} {e.currency}</div><button onClick={(ev) => { ev.stopPropagation(); setEditingExpense({...e, originalDate: group.date}); setModals({...modals, expense: true}); }} className="text-blue-400 p-1"><Edit3 size={14} /></button></div></div>))}</div>))}</div>
                                            </div>
                                        )
                                    )
                                )}
                            </div>
                            <ActivityModal key={`act-${editingActivity?.id || 'new'}`} isOpen={modals.activity} onClose={() => { setModals({...modals, activity:false}); setEditingActivity(null); }} onSave={handleSaveActivity} tripData={tripData} defaultValues={editingActivity} currentMember={currentMember} selectedDate={selectedDate} />
                            <ExpenseModal key={`exp-${editingExpense?.id || 'new'}`} isOpen={modals.expense} onClose={() => { setModals({...modals, expense:false}); setEditingExpense(null); }} onSave={handleSaveExpense} tripData={tripData} defaultValues={editingExpense} currentMember={currentMember} selectedDate={selectedDate} />
                            <MemberManagementModal isOpen={modals.members} onClose={()=>setModals({...modals, members:false})} tripData={tripData} currentMember={currentMember} onRemoveMember={(idx)=> { const m = [...tripData.members]; m.splice(idx,1); updateTrip('members', m); }} onAddMember={(newM)=>updateTrip('members', [...tripData.members, newM])} />
                            <EditTripModal isOpen={modals.editTrip} onClose={()=>setModals({...modals, editTrip: false})} tripData={tripData} onSave={handleEditTripSave} />
                            <TransactionDetailModal transaction={modals.transaction} onClose={() => setModals({...modals, transaction: null})} onViewImage={(url) => setModals({...modals, viewingImage: url})} />
                            {modals.viewingImage && <div className="fixed inset-0 z-[180] bg-black/80 flex items-center justify-center p-4" onClick={()=>setModals({...modals, viewingImage:null})}><img src={modals.viewingImage} className="max-w-full max-h-full object-contain" /></div>}
                            <ConfirmModal isOpen={confirm.open} message={confirm.msg} onConfirm={() => { confirm.action(); setConfirm({ open: false }); }} onCancel={() => setConfirm({ open: false })} />
                        </>
                    )}
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>