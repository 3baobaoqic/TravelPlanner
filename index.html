<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
    <style>
        * { -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .animate-slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f9f9f9; 
            color: #4b5563; 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden; 
        }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* CSS Hack to hide AM/PM text in WebKit browsers */
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            display: none;
        }
        /* Disable input interaction when readOnly */
        input:read-only, select:disabled, textarea:readOnly {
            pointer-events: none;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp, getApps, deleteApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { Calendar, MapPin, Clock, Train, Bus, Car, Footprints, Plane, TramFront, Plus, Trash2, Map, ArrowRight, Image, Loader, X, DollarSign, Navigation, PieChart, Menu, History, LogOut, Check, CloudSun, Timer, BarChart3, BedDouble, Phone, Settings, Camera, ChevronDown, LogIn, LogOut as LogOutIcon, Pencil, Users, Edit3, CloudCog, Shield, Save, UserX, Copy, Wifi, WifiOff, Database, ArrowRightCircle, Info, Download } from 'lucide-react';

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-travel-planner';

        // --- Constants ---
        const currencies = [
            { value: 'JPY', label: '日圓 (JPY)' },
            { value: 'TWD', label: '新台幣 (TWD)' }
        ];

        const transportOptions = [
            { value: 'walk', label: '步行', icon: Footprints }, { value: 'car', label: '自駕', icon: Car },
            { value: 'taxi', label: '計程車', icon: Car }, { value: 'bus', label: '公車', icon: Bus },
            { value: 'train', label: '電車', icon: Train }, { value: 'shinkansen', label: '新幹線', icon: Train },
            { value: 'nightbus', label: '夜間巴士', icon: Bus }, { value: 'tram', label: '路面電車', icon: TramFront },
            { value: 'plane', label: '飛機', icon: Plane },
        ];

        const durationOptions = Array.from({ length: 20 }, (_, i) => {
            const m = (i + 1) * 15, h = Math.floor(m / 60), min = m % 60;
            return { value: String(m), label: h === 0 ? `${min} 分鐘` : min === 0 ? `${h} 小時` : `${h} 小時 ${min} 分` };
        });

        const CATEGORY_COLORS = { '餐飲': '#FF6384', '交通': '#36A2EB', '住宿': '#FFCE56', '購物': '#4BC0C0', '娛樂': '#9966FF', '門票': '#FF9F40', '藥妝': '#FF6B6B', '其他': '#C9CBCF' };
        const PALETTE = Object.values(CATEGORY_COLORS);
        const TIME_OPTIONS = [];
        for(let i=0; i<24; i++) {
            const h = String(i).padStart(2, '0');
            TIME_OPTIONS.push(`${h}:00`);
            TIME_OPTIONS.push(`${h}:30`);
        }

        // --- Helper Functions ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        
        const getOrCreateUserId = () => {
            let uid = localStorage.getItem('gtp_local_uid');
            if (!uid) {
                uid = generateId();
                localStorage.setItem('gtp_local_uid', uid);
            }
            return uid;
        };

        const resizeImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height, max = 1024;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
        
        const sanitizeFirestoreData = (data) => JSON.parse(JSON.stringify(data, (k, v) => v === undefined ? null : v));
        const getDatesArray = (s, e) => { const a = [], d = new Date(s), ed = new Date(e); while(d<=ed) { a.push(new Date(d).toISOString().split('T')[0]); d.setDate(d.getDate()+1); } return a; };
        const getDayOfWeek = (d) => ['週日','週一','週二','週三','週四','週五','週六'][new Date(d).getDay()];
        const getMonthDay = (d) => { const date = new Date(d); return `${date.getMonth()+1}/${date.getDate()}`; };
        
        const openGoogleMaps = (query) => {
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
        };

        const processImageUpload = async (file) => {
            const b64 = await resizeImage(file);
            if (!b64) return null;
            const imgbbKey = localStorage.getItem('gtp_imgbb_key');
            if (imgbbKey) {
                try {
                    const formData = new FormData();
                    formData.append('image', b64.split(',')[1]);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, { method: 'POST', body: formData });
                    const data = await res.json();
                    if (data.success) return data.data.url;
                } catch (err) { console.error("Imgbb error", err); }
            }
            return b64;
        };

        const parseConfig = (str) => {
            try {
                return JSON.parse(str);
            } catch (e) {
                const obj = {};
                const keys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
                let found = false;
                keys.forEach(key => {
                    const regex = new RegExp(`["']?${key}["']?\\s*:\\s*["']([^"']+)["']`, 'i');
                    const match = str.match(regex);
                    if (match && match[1]) {
                        obj[key] = match[1];
                        found = true;
                    }
                });
                return found ? obj : null;
            }
        };

        // --- 子組件 ---

        const InfoPopup = ({ isOpen, onClose, title, content }) => !isOpen ? null : (
            <div className="fixed inset-0 z-[100] flex items-center justify-center px-4">
                <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                <div className="bg-white w-full max-w-sm rounded-2xl p-6 relative z-10 shadow-xl animate-[fadeIn_0.2s_ease-out]">
                    <h3 className="text-lg font-bold text-[#0ABAB5] mb-3 flex items-center gap-2">
                        <Info size={20} /> {title}
                    </h3>
                    <div className="text-sm text-gray-600 leading-relaxed whitespace-pre-line">
                        {content}
                    </div>
                    <button onClick={onClose} className="mt-6 w-full py-2.5 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition-colors">了解</button>
                </div>
            </div>
        );

        const LandingView = ({ onConnect, onOffline, joinId, setJoinId, onJoin, recentTrips, onDeleteTrip, isOffline, onCreateTrip }) => {
            const [configInput, setConfigInput] = useState('');
            const [imgbbKey, setImgbbKey] = useState(''); 
            const [testStatus, setTestStatus] = useState('idle');
            const [errorMessage, setErrorMessage] = useState('');
            const [infoType, setInfoType] = useState(null);

            useEffect(() => {
                const storedConfig = localStorage.getItem('gtp_firebase_config');
                const storedImgbb = localStorage.getItem('gtp_imgbb_key');
                if (storedConfig) {
                    try {
                        const parsed = JSON.parse(storedConfig);
                        setConfigInput(JSON.stringify(parsed, null, 2).replace(/[{}]/g, '').trim());
                    } catch(e) { setConfigInput(storedConfig); }
                }
                if (storedImgbb) setImgbbKey(storedImgbb);
                if (!isOffline) setTestStatus('success');
            }, [isOffline]);

            const handleTestConnection = async () => {
                setTestStatus('testing');
                const config = parseConfig(configInput);
                if (!config || !config.apiKey || !config.projectId) {
                    setTestStatus('error');
                    setErrorMessage('無法辨識 Firebase 設定檔格式');
                    return;
                }
                onConnect(config);
            };

            const handleJoinClick = () => {
                const cleanId = (joinId || '').trim();
                if (!cleanId) return alert("請輸入旅程 ID");
                onJoin(cleanId);
            };

            return (
                <div className="flex flex-col h-full bg-[#F5FDFC] overflow-y-auto no-scrollbar">
                    <div className="flex-1 flex flex-col p-8 max-w-md mx-auto w-full">
                        <div className="text-center mb-6">
                            <h1 className="text-3xl font-bold text-[#0ABAB5] mb-2">Travel Plan</h1>
                            <p className="text-gray-500 text-sm">設定雲端連線或讀取本機行程</p>
                        </div>
                        <div className="bg-gray-100 p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
                            <div className="flex justify-between items-center mb-2">
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wide">Firebase Configuration</label>
                                <button onClick={() => setInfoType('firebase')} className="text-gray-400 hover:text-[#0ABAB5] transition-colors"><Info size={16} /></button>
                            </div>
                            <textarea value={configInput} onChange={(e) => { setConfigInput(e.target.value); setTestStatus('idle'); }} className="w-full h-12 p-3 bg-[#E2E2E2] border border-gray-200 rounded-xl text-xs font-mono outline-none resize-none mb-4" placeholder={`apiKey: "...",\nprojectId: "..."`} />
                            <div className="flex justify-between items-center mb-2">
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wide">Imgbb API Key (選填)</label>
                                <button onClick={() => setInfoType('imgbb')} className="text-gray-400 hover:text-[#0ABAB5] transition-colors"><Info size={16} /></button>
                            </div>
                            <input value={imgbbKey} onChange={(e) => { setImgbbKey(e.target.value); setTestStatus('idle'); }} className="w-full p-3 bg-[#E2E2E2] border border-gray-200 rounded-xl text-xs font-mono outline-none mb-4" placeholder="例如: 358e4c7980312..." />
                            <button onClick={handleTestConnection} className="w-full py-2 rounded-lg font-bold text-xs bg-[#0ABAB5] text-white">測試連線</button>
                        </div>
                        <div className="flex gap-2 w-full mb-8">
                            <button onClick={onCreateTrip} className="flex-1 py-3 rounded-xl font-bold text-white shadow-lg bg-[#0ABAB5] flex items-center justify-center gap-2"><Plus size={18} /> 建立雲端新旅程</button>
                            <button onClick={() => onOffline()} className="w-[35%] py-3 rounded-xl font-bold text-white bg-red-400 flex items-center justify-center gap-2 shadow-lg"><WifiOff size={18} /> 單機版</button>
                        </div>
                        <div className="border-t border-gray-200 pt-6">
                            <div className="bg-gray-100 border border-gray-100 rounded-xl p-3 mb-4 shadow-sm flex gap-2">
                                <input placeholder="輸入旅程 ID 例如：x9z8y7" value={joinId} onChange={e => setJoinId(e.target.value)} className="flex-1 p-2 bg-[#E2E2E2] border border-gray-200 rounded-lg text-gray-700 font-bold outline-none text-sm" />
                                <button onClick={handleJoinClick} className="bg-[#0ABAB5] text-white p-2 rounded-lg"><ArrowRight size={20} /></button>
                            </div>
                            {recentTrips.length > 0 && (
                                <div className="mt-8">
                                    <h3 className="text-xs font-bold text-gray-400 mb-3 flex items-center gap-2 uppercase tracking-wider"><History size={14}/> 近期瀏覽</h3>
                                    <div className="space-y-2">
                                        {recentTrips.map(trip => (
                                            <div key={trip.id} onClick={() => onJoin(trip.id)} className="bg-[#EDF7F6] p-3 rounded-xl border border-gray-200 flex justify-between items-center cursor-pointer hover:border-[#0ABAB5] group transition-all">
                                                <div><div className="font-bold text-gray-700 text-sm">{trip.destination || '未命名行程'}{trip.id.toString().startsWith('trip_') && <span className="ml-2 text-[9px] bg-gray-100 text-gray-500 px-1.5 rounded border border-gray-200">本機</span>}</div><div className="text-[10px] text-gray-400">{trip.dateRange}</div></div>
                                                <button onClick={(e) => { e.stopPropagation(); onDeleteTrip(trip.id, e); }} className="p-2 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all"><Trash2 size={14} /></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    <InfoPopup isOpen={infoType !== null} onClose={() => setInfoType(null)} title={infoType === 'firebase' ? '如何取得 Firebase 設定' : '如何取得 Imgbb API Key'} content={infoType === 'firebase' ? 'Firebase Console -> 專案設定 -> 一般 -> 您的應用程式 -> Config' : '前往 api.imgbb.com 註冊後取得 API Key。'} />
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => !isOpen ? null : (
            <div className="fixed inset-0 z-[100] flex items-center justify-center px-4">
                <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onCancel}></div>
                <div className="bg-[#F5FDFC] w-full max-w-xs rounded-2xl p-6 border border-[#eeeeee] relative z-10 text-center flex flex-col items-center shadow-xl">
                    <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-500"><Trash2 size={24} /></div>
                    <h3 className="text-lg font-bold text-gray-800 mb-2">確認</h3>
                    <p className="text-gray-600 mb-6 text-sm whitespace-pre-line">{message}</p>
                    <div className="flex gap-3 w-full">
                        <button onClick={onCancel} className="flex-1 py-2.5 rounded-xl text-gray-500 font-bold bg-gray-200 border border-[#eeeeee]">取消</button>
                        <button onClick={onConfirm} className="flex-1 py-2.5 rounded-xl bg-red-500 text-white font-bold">確定</button>
                    </div>
                </div>
            </div>
        );

        const MemberManagementModal = ({ isOpen, onClose, tripData, currentMember, onUpdateMember, onRemoveMember, onAddMember }) => {
            const [editingIndex, setEditingIndex] = useState(null);
            const [editForm, setEditForm] = useState({ name: '', pin: '' });
            const [confirmRemove, setConfirmRemove] = useState(null);
            const [isAdding, setIsAdding] = useState(false);
            const [newMemberName, setNewMemberName] = useState('');
            if (!isOpen || !tripData) return null;
            const isOwner = currentMember?.role === 'owner';
            const handleSaveClick = (index) => { if (!editForm.name.trim() || !editForm.pin.trim()) return; onUpdateMember(index, editForm); setEditingIndex(null); };
            const handleAddClick = () => { if (!newMemberName.trim() || tripData.members.some(m => m.name === newMemberName.trim())) return; onAddMember({ name: newMemberName.trim(), pin: '0000', role: 'collaborator', deviceId: 'offline_' + Date.now() }); setNewMemberName(''); setIsAdding(false); };
            return (
                <div className="fixed inset-0 z-[90] flex items-center justify-center px-4">
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-full max-w-md rounded-2xl p-6 border border-[#eeeeee] relative z-10 flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-center mb-4 border-b border-[#eeeeee] pb-2"><h3 className="text-lg font-bold text-[#0ABAB5] flex items-center gap-2"><Users size={20}/> 旅伴管理</h3><button onClick={onClose}><X size={20} className="text-gray-400" /></button></div>
                        <div className="p-2 bg-yellow-50 rounded mb-2 text-xs text-yellow-600 border border-yellow-100">單機模式下，可在此新增虛擬旅伴以進行分帳。</div>
                        <div className="space-y-3 overflow-y-auto p-1 mb-4 custom-scrollbar">
                            {tripData.members.map((member, index) => {
                                if (!member) return null;
                                const isEditing = editingIndex === index;
                                const isSelf = member.name === currentMember.name; 
                                const isMemberOwner = member.role === 'owner';
                                return (
                                    <div key={index} className={`p-3 rounded-xl border ${isSelf ? 'border-[#0ABAB5] bg-[#E0F2F1]' : 'bg-[#EDF7F6]'} flex items-center justify-between`}>
                                            {isEditing ? (
                                                <div className="flex-1 flex gap-2 items-center"><input value={editForm.name} onChange={e => setEditForm({...editForm, name: e.target.value})} className="w-1/2 p-2 text-sm bg-[#E2E2E2] border border-[#eeeeee] rounded-lg outline-none focus:border-[#0ABAB5]"/><input value={editForm.pin} onChange={e => setEditForm({...editForm, pin: e.target.value})} className="w-1/3 p-2 text-sm bg-[#E2E2E2] border border-[#eeeeee] rounded-lg outline-none focus:border-[#0ABAB5]"/><button onClick={() => handleSaveClick(index)} className="text-green-500 p-1"><Save size={18} /></button><button onClick={() => setEditingIndex(null)} className="text-gray-400 p-1"><X size={18} /></button></div>
                                            ) : (
                                                <div className="flex items-center justify-between w-full">
                                                    <div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs ${isMemberOwner ? 'bg-yellow-400' : 'bg-gray-400'}`}>{member.name.charAt(0).toUpperCase()}</div><div><div className="font-bold text-gray-700 text-sm flex items-center gap-1">{member.name}{isMemberOwner && <Shield size={12} className="text-yellow-500"/>}{isSelf && <span className="text-[10px] text-[#0ABAB5] bg-[#0ABAB5]/10 px-1 rounded">我</span>}</div><div className="text-[10px] text-gray-400">PIN: {member.pin}</div></div></div>
                                                    <div className="flex gap-1">{isOwner && (
                                                        <React.Fragment>
                                                            <button onClick={() => {setEditingIndex(index); setEditForm({name:member.name, pin:member.pin});}} className="p-2 text-gray-400 hover:text-[#0ABAB5] transition-colors"><Edit3 size={16}/></button>
                                                            {!isMemberOwner && <button onClick={() => setConfirmRemove(index)} className="p-2 text-gray-400 hover:text-red-500 transition-colors"><UserX size={16}/></button>}
                                                        </React.Fragment>
                                                    )}</div>
                                                </div>
                                            )}
                                    </div>
                                );
                            })}
                        </div>
                        {isOwner && (<div className="mt-auto pt-2 border-t border-[#eeeeee]">{isAdding ? (<div className="flex gap-2 items-center animate-fadeIn"><input value={newMemberName} onChange={(e) => setNewMemberName(e.target.value)} placeholder="旅伴名稱" className="flex-1 p-3 bg-[#E2E2E2] border border-[#eeeeee] rounded-xl outline-none focus:border-[#0ABAB5] text-sm" autoFocus /><button onClick={handleAddClick} className="bg-[#0ABAB5] text-white p-3 rounded-xl hover:bg-[#008985]"><Check size={18} /></button><button onClick={() => { setIsAdding(false); setNewMemberName(''); }} className="bg-gray-200 text-gray-500 p-3 rounded-xl hover:bg-gray-300"><X size={18} /></button></div>) : (<button onClick={() => setIsAdding(true)} className="w-full py-3 bg-[#E0F2F1] text-[#00695C] rounded-xl font-bold border border-[#B2DFDB] hover:bg-[#B2DFDB] transition-colors flex items-center justify-center gap-2"><Plus size={18} /> 新增旅伴</button>)}</div>)}
                    </div>
                    <ConfirmModal isOpen={confirmRemove !== null} message="確定移除旅伴？" onConfirm={() => { onRemoveMember(confirmRemove); setConfirmRemove(null); }} onCancel={() => setConfirmRemove(null)} />
                </div>
            );
        };

        const SimplePieChartRaw = ({ data }) => {
            const total = data.reduce((sum, item) => sum + item.value, 0);
            if (total === 0) return <div className="h-40 flex items-center justify-center text-gray-400 text-sm">尚無數據</div>;
            let currentAngle = 0;
            return (
                <div className="relative h-48 w-48 mx-auto">
                    <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                        {data.map((item, i) => {
                            const angle = (item.value / total) * 360;
                            const x1 = 50 + 50 * Math.cos(Math.PI * currentAngle / 180);
                            const y1 = 50 + 50 * Math.sin(Math.PI * currentAngle / 180);
                            const x2 = 50 + 50 * Math.cos(Math.PI * (currentAngle + angle) / 180);
                            const y2 = 50 + 50 * Math.sin(Math.PI * (currentAngle + angle) / 180);
                            const largeArc = angle > 180 ? 1 : 0;
                            const pathData = total === item.value ? "M 50 50 m -50, 0 a 50,50 0 1,0 100,0 a 50,50 0 1,0 -100,0" : `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArc} 1 ${x2} ${y2} Z`;
                            const slice = <path key={i} d={pathData} fill={item.color} stroke="white" strokeWidth="1" />;
                            currentAngle += angle; return slice;
                        })}
                        <circle cx="50" cy="50" r="30" fill="#F5FDFC" />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center flex-col"><span className="text-xs text-gray-400">總支出</span><span className="text-lg font-bold text-gray-700">${total.toLocaleString()}</span></div>
                </div>
            );
        };

        const SimpleBarChartRaw = ({ data }) => {
            const maxVal = Math.max(...data.map(d => d.total), 1); 
            if (data.length === 0 || maxVal === 0) return <div className="text-xs text-center text-gray-400 py-4">尚無資料</div>;
            return (
                <div className="w-full overflow-x-auto no-scrollbar">
                    <div className="flex items-end gap-3 h-40 pt-6 px-2 min-w-max">
                        {data.map((item, i) => {
                            const displayHeight = Math.max((item.total / maxVal) * 100, 2); 
                            return (
                                <div key={i} className="flex flex-col items-center gap-1 group w-12 h-full justify-end">
                                    <div className="relative w-4 flex flex-col-reverse rounded-t-md overflow-hidden bg-[#C8D9D9] border border-[#B0C4C4]" style={{ height: `${displayHeight}%` }}>
                                        {item.breakdown.map((seg, idx) => <div key={idx} style={{ height: `${(seg.cost / item.total) * 100}%`, backgroundColor: seg.color }} className="w-full transition-all duration-300" />)}
                                    </div>
                                    <div className="text-[10px] text-gray-500 font-medium">{item.date.slice(5).replace('-','/')}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const TransactionDetailModalRaw = ({ transaction, onClose, onViewImage }) => {
            if (!transaction) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center" onClick={onClose}>
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm"></div>
                    <div className="bg-[#F5FDFC] w-[85%] max-w-sm rounded-2xl p-5 border border-[#eeeeee] relative z-10" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center gap-2 mb-4"><div className="w-2 h-8 rounded-full" style={{backgroundColor:CATEGORY_COLORS[transaction.category]||'#ccc'}}></div><h3 className="text-xl font-bold">{transaction.title || '未命名'}</h3></div>
                        <div className="space-y-4">
                            <div className="flex justify-between border-b pb-2"><span className="text-gray-500">金額</span><span className="text-2xl font-bold text-[#D68C68]">{transaction.cost} <small>{transaction.currency}</small></span></div>
                            <div className="grid grid-cols-2 gap-4 text-sm"><div><label className="text-xs text-gray-400 block">分類</label>{transaction.category}</div><div><label className="text-xs text-gray-400 block">付款人</label>{transaction.payer}</div></div>
                            {transaction.photoUrls?.length > 0 && <div className="flex gap-2 overflow-x-auto">{transaction.photoUrls.map((p, i) => { if(!p) return null; const url = typeof p === 'string' ? p : p.url; return <img key={i} src={url} className="w-20 h-20 object-cover rounded-lg" onClick={() => onViewImage(url)} />; })}</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const ImageModalRaw = ({ src, onClose }) => !src ? null : <div className="fixed inset-0 z-[70] bg-black/20 flex items-center justify-center p-4" onClick={onClose}><img src={src} className="max-w-full max-h-full object-contain rounded-lg shadow-2xl" /></div>;

        const AutoSaveInputRaw = ({ value, onSave, readOnly, ...props }) => {
            const [v, setV] = useState(value ?? '');
            useEffect(() => setV(value ?? ''), [value]);
            const handleBlur = () => { if (String(v) !== String(value ?? '')) onSave(v); };
            const propsFinal = { ...props, value: v, onChange: e => setV(e.target.value), onBlur: handleBlur, onKeyDown: e => e.key === 'Enter' && e.target.blur(), readOnly };
            return props.type === 'textarea' ? <textarea {...propsFinal} /> : <input {...propsFinal} />;
        };

        const AccommodationCard = ({ date, data, onUpdate, onPhotoUpload, onPhotoDelete, onViewImage, onAdd, onDelete, isOwner, currentMember, tripData }) => {
            const [expandedId, setExpandedId] = useState(null);
            const tripDates = useMemo(() => tripData ? getDatesArray(tripData.startDate, tripData.endDate) : [date], [tripData, date]);
            return (
                <div className="bg-[#FFF9C4] border border-yellow-300 shadow-sm rounded-2xl p-1.5 mt-4 relative mb-2">
                    {(!data || data.length === 0) && <div className="text-center text-yellow-600 text-xs py-1">尚未新增住宿</div>}
                    {(data || []).map((item, index) => {
                        if (!item) return null;
                        const isExpanded = expandedId === item.id;
                        return (
                            <div key={item.id || index} className={index > 0 ? "border-t border-yellow-200 pt-0.5 mt-0.5" : ""}>
                                <div className="flex items-center justify-between cursor-pointer" onClick={() => setExpandedId(isExpanded ? null : item.id)}>
                                    <div className="flex items-center gap-1 flex-1 min-w-0 pr-8">
                                        < BedDouble size={14} className="text-gray-600 flex-shrink-0" />
                                        <div onClick={(e) => e.stopPropagation()} className="w-[80%]">
                                            <AutoSaveInputRaw type="text" readOnly={!isOwner} placeholder="飯店名稱..." value={item.name} onSave={(val) => onUpdate(item.id, 'name', val)} className="bg-transparent text-xs font-bold text-gray-800 outline-none placeholder-gray-400 w-full leading-none" />
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-1">
                                        {isOwner && <button onClick={(e) => { e.stopPropagation(); onDelete(item.id); }} className="text-red-400 hover:text-red-600 p-0.5"><Trash2 size={12} /></button>}
                                        <ChevronDown size={14} className={`text-yellow-600 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`} />
                                    </div>
                                </div>
                                <div className={`transition-all duration-300 ease-in-out overflow-hidden ${isExpanded ? 'max-h-[1000px] opacity-100' : 'max-h-0 opacity-0'}`}>
                                    <div className="pt-1 pb-0.5 space-y-1">
                                        <div className="flex gap-1 mb-1">
                                            <div className="flex-[6.5] flex flex-col gap-1 min-w-0 justify-center">
                                                <div className="pl-1"><AutoSaveInputRaw type="text" readOnly={!isOwner} placeholder="訂房編號" value={item.bookingCode} onSave={(val) => onUpdate(item.id, 'bookingCode', val)} className="text-xs text-gray-500 bg-transparent outline-none w-full"/></div>
                                                <div className="pl-1"><AutoSaveInputRaw type="text" readOnly={!isOwner} placeholder="備註" value={item.note} onSave={(val) => onUpdate(item.id, 'note', val)} className="text-xs text-gray-600 bg-transparent outline-none w-full border-b border-dashed border-yellow-200"/></div>
                                            </div>
                                            <div className="flex-[3.5] flex flex-col gap-1 min-w-0 pr-1 items-end">
                                                <div className="flex items-center gap-0.5 bg-white/40 px-1 py-0.5 rounded border border-yellow-200 text-xs w-fit">
                                                    <LogIn size={12} className="text-green-600 shrink-0 mr-0.5" /><select disabled={!isOwner} value={item.checkInDate || date} onChange={(e) => onUpdate(item.id, 'checkInDate', e.target.value)} className="bg-transparent outline-none text-gray-700 font-medium p-0">{tripDates.map(d => <option key={d} value={d}>{getMonthDay(d)}</option>)}</select>
                                                </div>
                                                <div className="flex items-center gap-0.5 bg-white/40 px-1 py-0.5 rounded border border-yellow-200 text-xs w-fit">
                                                    <LogOutIcon size={12} className="text-red-600 shrink-0 mr-0.5" /><select disabled={!isOwner} value={item.checkOutDate || date} onChange={(e) => onUpdate(item.id, 'checkOutDate', e.target.value)} className="bg-transparent outline-none text-gray-700 font-medium p-0">{tripDates.map(d => <option key={d} value={d}>{getMonthDay(d)}</option>)}</select>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex flex-col gap-1">
                                            <div className="flex gap-2 items-stretch">
                                                <div className="flex items-center gap-1 bg-[#E2E2E2] border border-gray-300 px-2 py-0.5 rounded-lg flex-[3] overflow-hidden"><Phone size={10} className="text-green-600 flex-shrink-0" /><AutoSaveInputRaw type="text" readOnly={!isOwner} placeholder="電話" value={item.phone} onSave={(val) => onUpdate(item.id, 'phone', val)} className="text-xs text-gray-600 bg-transparent outline-none w-full min-w-0"/></div>
                                                <div className="flex items-center gap-1 bg-[#E2E2E2] border border-gray-300 px-2 py-0.5 rounded-lg flex-[7] overflow-hidden"><MapPin size={10} className="text-red-500 flex-shrink-0" /><AutoSaveInputRaw type="text" readOnly={!isOwner} placeholder="地址" value={item.address} onSave={(val) => onUpdate(item.id, 'address', val)} className="text-xs text-gray-600 bg-transparent outline-none w-full min-w-0"/><button onClick={() => item.address && window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}`, '_blank')} className="text-blue-500 p-1 rounded flex-shrink-0"><Navigation size={10} /></button></div>
                                            </div>
                                            <div className="flex items-center gap-2 overflow-x-auto pb-1 no-scrollbar mt-0.5">
                                                {item.photoUrls?.map((p, i) => {
                                                    const url = typeof p === 'string' ? p : p.url;
                                                    const canDelete = isOwner || (currentMember && p.uploader === currentMember.name);
                                                    return ( <div key={i} className="relative flex-shrink-0"> <img src={url} className="w-10 h-10 object-cover rounded-lg border border-yellow-200 cursor-zoom-in" onClick={() => onViewImage(url)} /> {canDelete && <button onClick={() => onPhotoDelete(item.id, url, 'accom')} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 hover:bg-red-600 transition"><X size={10} /></button>} </div> );
                                                })}
                                                <button onClick={() => onPhotoUpload(item.id)} className="w-10 h-10 flex items-center justify-center border-2 border-dashed border-yellow-300 text-yellow-500 hover:text-yellow-600 hover:border-yellow-600 rounded-lg transition-colors flex-shrink-0 bg-yellow-100"><Image size={16} /></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                    {isOwner && <button onClick={onAdd} className="absolute -bottom-6 right-2 bg-yellow-400 text-white shadow-md rounded-full p-1.5 hover:bg-yellow-500 transition-colors z-10 border-2 border-white"><Plus size={14} /></button>}
                </div>
            );
        };

        const FlightCard = ({ label, icon: Icon, data, onUpdate, isOwner }) => (
            <div className="bg-[#EFF6FF] border-l-4 border-[#3B82F6] shadow-sm rounded-xl py-2 px-3 mb-4 relative border border-[#eeeeee]">
                <div className="absolute top-0 right-0 bg-[#3B82F6] text-white text-[10px] px-2 py-0.5 rounded-bl-lg rounded-tr-xl font-bold">{label}</div>
                <div className="flex items-center justify-between mt-2.5">
                    <div className="flex flex-col items-start w-1/3"><label className="text-[10px] text-gray-400 font-medium mb-0 leading-tight">起飛</label><AutoSaveInputRaw type="text" readOnly={!isOwner} value={data.depTime} placeholder="14:00" maxLength={5} onSave={(val) => onUpdate('depTime', val)} className="text-lg font-bold text-gray-700 bg-transparent outline-none w-full p-0 leading-none" /><AutoSaveInputRaw type="text" readOnly={!isOwner} placeholder="機場/航廈" value={data.depAirport} onSave={(val) => onUpdate('depAirport', val)} className="text-xs text-gray-500 font-medium bg-transparent outline-none w-full mt-0.5 placeholder-gray-300" /></div>
                    <div className="flex flex-col items-center justify-center w-1/3 px-2"><div className="text-[#3B82F6] mb-0.5 transform rotate-45"><Icon size={20} /></div><div className="w-full flex items-center justify-center relative mb-0.5"><div className="h-px bg-gray-300 w-full absolute top-1/2 left-0"></div><div className="w-1.5 h-1.5 bg-[#3B82F6] rounded-full z-10"></div></div><AutoSaveInputRaw type="text" readOnly={!isOwner} placeholder="航班號" value={data.number} onSave={(val) => onUpdate('number', val)} className="text-center text-sm font-bold text-[#1E40AF] bg-transparent outline-none w-full placeholder-gray-300 uppercase" /></div>
                    <div className="flex flex-col items-end w-1/3"><label className="text-[10px] text-gray-400 font-medium mb-0 leading-tight">抵達</label><AutoSaveInputRaw type="text" readOnly={!isOwner} value={data.arrTime} placeholder="18:30" maxLength={5} onSave={(val) => onUpdate('arrTime', val)} className="text-lg font-bold text-gray-700 bg-transparent outline-none w-full p-0 leading-none text-right" /><AutoSaveInputRaw type="text" readOnly={!isOwner} placeholder="機場/航廈" value={data.arrAirport} onSave={(val) => onUpdate('arrAirport', val)} className="text-xs text-gray-500 font-medium bg-transparent outline-none w-full mt-0.5 text-right placeholder-gray-300" /></div>
                </div>
            </div>
        );

        const ActivityModal = ({ isOpen, onClose, onSave, tripData, defaultValues, currentMember, selectedDate, onUpdateCategories }) => {
            const [formData, setFormData] = useState({ date: selectedDate, time: '09:00', title: '', note: '', transport: 'walk', duration: '60', bookingCode: '', cost: '', currency: 'JPY', payer: '我', category: '', photoUrls: [] });
            const fileRef = useRef(null);
            const [isAddingCat, setIsAddingCat] = useState(false);
            const [newCatName, setNewCatName] = useState("");
            useEffect(() => {
                 if (isOpen) {
                     if (defaultValues) { setFormData({ ...defaultValues, date: defaultValues.date || selectedDate }); } 
                     else { setFormData({ time: '09:00', title: '', note: '', transport: 'walk', duration: '60', bookingCode: '', cost: '', currency: tripData?.currency || 'JPY', payer: currentMember?.name || '我', category: '', photoUrls: [], date: selectedDate }); }
                     setIsAddingCat(false); setNewCatName("");
                 }
            }, [isOpen, selectedDate, defaultValues, tripData, currentMember]); 
            if (!isOpen) return null;
            const handleFile = async (e) => { const f = e.target.files[0]; if(f) { const url = await processImageUpload(f); if(url) setFormData(p => ({...p, photoUrls: [...(p.photoUrls || []), url]})); } e.target.value = ''; };
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 bg-black/20" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-[85%] sm:max-w-sm rounded-t-3xl sm:rounded-2xl overflow-hidden border border-[#eeeeee] relative z-10 flex flex-col max-h-[90vh]">
                        <div className="bg-[#6A8E83] p-3 text-center text-white font-bold relative">{defaultValues ? '編輯行程' : '新增行程'}<button onClick={onClose} className="absolute right-3"><X size={20}/></button></div>
                        <div className="p-4 space-y-4 overflow-y-auto flex-1">
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs text-gray-400 font-bold block">日期</label><input type="date" value={formData.date} onChange={e=>setFormData({...formData, date:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold border outline-none" /></div>
                                <div className="flex-1"><label className="text-xs text-gray-400 font-bold block">時間</label><input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold border outline-none" /></div>
                            </div>
                            <div><label className="text-xs text-gray-400 font-bold block">名稱</label><input value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})} className="w-full p-2 bg-[#E2E2E2] rounded-xl text-sm font-bold border outline-none" /></div>
                            <div><label className="text-xs text-gray-400 font-bold block">備註</label><textarea value={formData.note} onChange={e=>setFormData({...formData, note:e.target.value})} rows={2} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm resize-none border outline-none" /></div>
                            <div className="flex gap-2">
                                <div className="w-1/2"><label className="text-xs text-gray-400 font-bold block">交通</label><select value={formData.transport} onChange={e=>setFormData({...formData, transport:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold border outline-none">{transportOptions.map(t=><option key={t.value} value={t.value}>{t.label}</option>)}</select></div>
                                <div className="w-1/2"><label className="text-xs text-gray-400 font-bold block">停留</label><select value={formData.duration} onChange={e=>setFormData({...formData, duration:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold border outline-none">{durationOptions.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}</select></div>
                            </div>
                            <div className="border-t border-[#eeeeee] pt-2">
                                <div className="flex justify-between mb-2"><span className="text-xs font-bold text-gray-400">費用與記帳</span></div>
                                <div className="flex gap-2 mb-2 items-start">
                                    <div className="flex-1 flex flex-col gap-2">
                                        <div className="flex items-center bg-[#E2E2E2] rounded-xl px-2 border h-[38px]"><span className="text-xs text-gray-400">$</span><input type="number" value={formData.cost} onChange={e=>setFormData({...formData, cost:e.target.value})} placeholder="金額" className="w-full bg-transparent p-2 text-sm outline-none" /></div>
                                        <div><div className="flex justify-between mb-1 h-[16px]"><label className="text-[10px] text-gray-400 font-bold">分類</label><button onClick={() => setIsAddingCat(!isAddingCat)} className="text-[10px] text-[#6A8E83] font-bold">{isAddingCat ? '取消' : '+ 新增'}</button></div>
                                            {isAddingCat ? (<div className="flex gap-1 h-[34px]"><input value={newCatName} onChange={e => setNewCatName(e.target.value)} placeholder="新分類" className="w-full bg-[#E2E2E2] rounded-xl p-2 text-xs border outline-none"/><button onClick={() => { if (newCatName.trim()) { onUpdateCategories([...(tripData.expenseCategories||[]), newCatName.trim()]); setFormData({ ...formData, category: newCatName.trim() }); setNewCatName(""); setIsAddingCat(false); }}} className="bg-[#6A8E83] text-white px-2 rounded-lg text-xs"><Check size={14} /></button></div>
                                            ) : (<select value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl px-2 h-[34px] text-xs font-bold border outline-none">{(tripData.expenseCategories || []).map(c=><option key={c} value={c}>{c}</option>)}</select>)}
                                        </div>
                                    </div>
                                    <div className="w-[35%] flex flex-col gap-2">
                                        <div className="bg-[#E2E2E2] rounded-xl px-1 border h-[38px] flex items-center"><select value={formData.currency} onChange={e=>setFormData({...formData, currency:e.target.value})} className="w-full bg-transparent p-1 text-sm font-bold outline-none">{currencies.map(c=><option key={c.value} value={c.value}>{c.value}</option>)}</select></div>
                                        <div><label className="text-[10px] text-gray-400 font-bold block mb-1">付款人</label><select value={formData.payer} onChange={e=>setFormData({...formData, payer:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl px-2 h-[34px] text-xs font-bold border outline-none">{tripData.members.map(m=><option key={m.name} value={m.name}>{m.name}</option>)}</select></div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-2 overflow-x-auto pb-1">
                                {formData.photoUrls?.map((url, i)=>(<div key={i} className="relative w-10 h-10 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded-lg" /><button onClick={()=>{const n=[...formData.photoUrls]; n.splice(i,1); setFormData({...formData, photoUrls:n})}} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button></div>))}
                                <button onClick={()=>fileRef.current.click()} className="w-10 h-10 border-2 border-dashed border-gray-300 rounded flex items-center justify-center flex-shrink-0"><Camera size={16}/></button><input type="file" ref={fileRef} className="hidden" onChange={handleFile} />
                            </div>
                            <button onClick={()=>onSave(formData)} className="w-full py-3 bg-[#6A8E83] text-white rounded-xl font-bold shadow-md">儲存變更</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ExpenseModalRaw = ({ isOpen, onClose, onSave, onUpdateCategories, selectedDate, currentMember, defaultValues, tripData }) => {
            const [formData, setFormData] = useState({ date: selectedDate, time: '', cost: '', title: '', payer: '', currency: '', category: '', photoUrls: [], note: '' });
            const [isManage, setIsManage] = useState(false);
            const fileRef = useRef(null);
            useEffect(() => {
                 if(isOpen) {
                     if (defaultValues) { setFormData({ date: defaultValues.originalDate || selectedDate, time: defaultValues.time || '', cost: defaultValues.cost || '', title: defaultValues.title || '', payer: defaultValues.payer || '', currency: defaultValues.currency || '', category: defaultValues.category || '', photoUrls: defaultValues.photoUrls || [], note: defaultValues.note || '' }); } 
                     else { setFormData({ date: selectedDate, time: new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}), cost: '', title: '', payer: currentMember?.name || '我', currency: tripData?.currency || 'JPY', category: '餐飲', photoUrls: [], note: '' }); }
                 }
            }, [isOpen, selectedDate, defaultValues, tripData, currentMember]);
            if (!isOpen) return null;
            const handleFile = async (e) => { const f = e.target.files[0]; if(f) { const url = await processImageUpload(f); if(url) setFormData(p => ({...p, photoUrls: [...(p.photoUrls || []), url]})); } e.target.value=''; };
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 bg-black/20" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-[85%] sm:max-w-sm rounded-t-3xl sm:rounded-2xl border border-[#eeeeee] relative z-10 flex flex-col max-h-[90vh]">
                        <div className="bg-[#D68C68] p-3 text-center text-white font-bold relative">記帳<button onClick={onClose} className="absolute right-3"><X size={20}/></button></div>
                        <div className="p-4 space-y-4 overflow-y-auto flex-1">
                            <div className="flex items-end gap-2">
                                <div className="w-[50%]"><label className="text-xs text-gray-400 font-bold block">金額</label><div className="relative"><DollarSign className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400" size={16} /><input type="number" value={formData.cost} onChange={e=>setFormData({...formData, cost:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl pl-7 p-2 text-xl font-bold border outline-none" /></div></div>
                                <div className="w-[20%]"><label className="text-xs text-gray-400 font-bold block">幣別</label><select value={formData.currency} onChange={e=>setFormData({...formData, currency:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold border outline-none">{currencies.map(c=><option key={c.value} value={c.value}>{c.value}</option>)}</select></div>
                                <div className="w-[30%]"><label className="text-xs text-gray-400 font-bold block">付款人</label><select value={formData.payer} onChange={e=>setFormData({...formData, payer:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold border outline-none">{tripData.members.map(m=><option key={m.name} value={m.name}>{m.name}</option>)}</select></div>
                            </div>
                            <div>
                                <div className="flex justify-between items-center mb-2"><label className="text-xs text-gray-400 font-bold">分類</label><button onClick={()=>setIsManage(!isManage)} className="text-xs text-[#D68C68] font-bold">管理</button></div>
                                {isManage ? <div className="bg-[#E2E2E2] p-2 rounded-xl border mb-2"><div className="flex flex-wrap gap-1 mb-2">{(tripData.expenseCategories||[]).map(c=><span key={c} className="bg-white px-2 py-1 rounded text-[10px] flex items-center gap-1 border">{c}<button onClick={()=>onUpdateCategories((tripData.expenseCategories||[]).filter(x=>x!==c))}><X size={10}/></button></span>)}</div></div> : <div className="flex flex-wrap gap-1.5">{(tripData.expenseCategories||[]).map(c=><button key={c} onClick={()=>setFormData({...formData, category:c})} className={`px-3 py-1.5 rounded-lg text-xs font-bold border ${formData.category===c?'bg-[#D68C68] text-white':'bg-[#E2E2E2]'}`}>{c}</button>)}</div>}
                            </div>
                            <div className="flex gap-2"><input type="date" value={formData.date} onChange={e=>setFormData({...formData, date:e.target.value})} className="flex-1 bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold border outline-none" /><input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-1/3 bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold border outline-none" /></div>
                            <div><label className="text-xs text-gray-400 font-bold block">名稱</label><input value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-3 text-sm font-bold border outline-none" /></div>
                            <div className="flex gap-2 overflow-x-auto">{formData.photoUrls?.map((url, i)=>(<div key={i} className="relative w-10 h-10 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded-lg" /><button onClick={()=>{const n=[...formData.photoUrls]; n.splice(i,1); setFormData({...formData, photoUrls:n})}} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button></div>))}<button onClick={()=>fileRef.current.click()} className="w-10 h-10 border-2 border-dashed rounded flex items-center justify-center flex-shrink-0"><Camera size={16}/></button><input type="file" ref={fileRef} className="hidden" onChange={handleFile} /></div>
                            <button onClick={()=>onSave(formData)} className="w-full py-3 bg-[#D68C68] text-white rounded-xl font-bold">儲存</button>
                        </div>
                    </div>
                </div>
            );
        };

        const HeaderWithTabs = ({ tripData, selectedDate, setSelectedDate, handleAddDate, view, setView, setIsMenuOpen, isOffline }) => {
            const datesList = useMemo(() => tripData ? getDatesArray(tripData.startDate, tripData.endDate) : [], [tripData]);
            return (
                <div className="bg-[#0ABAB5] z-10 relative flex flex-col">
                    <div className="text-white px-3 pt-3 pb-1 flex justify-between items-start">
                        <div className="flex items-center gap-3"><button onClick={() => setIsMenuOpen(true)}><Menu size={24}/></button><h1 className="font-bold leading-tight text-lg">{tripData.destination}</h1></div>
                        <div className="flex items-center gap-1">
                             <div className="w-8 h-8 flex items-center justify-center text-white rounded-full cursor-pointer hover:bg-white/10" onClick={() => { if (isOffline) { alert("目前為離線模式，無法產生分享連結。"); } else { const fbConfigStr = localStorage.getItem('gtp_firebase_config'); const imgbbKeyStr = localStorage.getItem('gtp_imgbb_key'); if (fbConfigStr) { try { const bundle = { id: tripData.id, firebase: JSON.parse(fbConfigStr), imgbb: imgbbKeyStr || '' }; const textToCopy = JSON.stringify(bundle); const textArea = document.createElement("textarea"); textArea.value = textToCopy; document.body.appendChild(textArea); textArea.select(); document.execCommand("Copy"); textArea.remove(); alert("已複製「一鍵設定懶人包」！"); } catch (e) { alert("產生分享連結失敗"); } } } }} title={isOffline ? "目前為離線模式" : "點擊複製一鍵分享懶人包"}>
                                {isOffline ? <WifiOff size={16} className="text-red-300"/> : <Wifi size={16} className="text-[#00FF00]"/>}
                            </div>
                        </div>
                    </div>
                    <div className="flex items-center pl-2 pr-3 pb-2 gap-2">
                        <div className="flex-1 flex overflow-x-auto space-x-2 no-scrollbar">
                            {datesList.map((d, i) => (
                                <button key={d} onClick={() => { setSelectedDate(d); setView('planner'); }} className={`flex-shrink-0 w-10 h-10 flex flex-col items-center justify-center rounded-xl transition-all duration-200 border ${d === selectedDate ? 'bg-[#F5FDFC] text-[#00695C] font-bold border-[#eeeeee]' : 'bg-[#008985] text-white opacity-90 border-transparent'}`}>
                                    <span className="text-[8px] leading-none opacity-80">D{i+1}</span><span className="text-[10px] font-bold leading-tight my-0.5">{getMonthDay(d)}</span><span className="text-[8px] leading-none opacity-90">{getDayOfWeek(d)}</span>
                                </button>
                            ))}
                            <button onClick={handleAddDate} className="flex-shrink-0 w-10 h-10 flex items-center justify-center border border-dashed border-white/50 rounded-xl text-white"><Plus size={20}/></button>
                        </div>
                        <button onClick={() => setView(view === 'planner' ? 'expense' : 'planner')} className="flex-shrink-0 w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-yellow-900 ring-2 ring-[#D68C68] transform hover:scale-105 transition-transform">
                            <DollarSign size={20} strokeWidth={3} />
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const getRestoredState = () => { try { const saved = localStorage.getItem('gtp_session_restore'); if (saved) return JSON.parse(saved); } catch(e) {} return null; };
            const [restored] = useState(getRestoredState);
            const [userId, setUserId] = useState(getOrCreateUserId());
            const [view, setView] = useState(restored?.view || 'landing'); 
            const [tripId, setTripId] = useState(restored?.tripId || '');
            const [tripData, setTripData] = useState(null);
            const [selectedDate, setSelectedDate] = useState(restored?.selectedDate || '');
            const selectedDateRef = useRef(selectedDate);
            useEffect(() => { selectedDateRef.current = selectedDate; }, [selectedDate]);
            const [modals, setModals] = useState({ expense: false, activity: false, viewingImage: null, transaction: null, editTrip: false, members: false, join: false });
            const [expandedId, setExpandedId] = useState(null);
            const [recentTrips, setRecentTrips] = useState([]);
            const [setupForm, setSetupForm] = useState(restored?.setupForm || { destination: '', startDate: new Date().toLocaleDateString('en-CA'), endDate: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toLocaleDateString('en-CA'), currency: 'JPY', nickname: '', pin: '' });
            const [confirm, setConfirm] = useState({ open: false, msg: '', action: null });
            const [joinId, setJoinId] = useState('');
            const fileRef = useRef(null);
            const [uploadTarget, setUploadTarget] = useState(null);
            const [expenseFilterDate, setExpenseFilterDate] = useState('all');
            const [expenseFilterPayer, setExpenseFilterPayer] = useState('all'); 
            const [expenseFilterCurrency, setExpenseFilterCurrency] = useState('all'); 
            const [isCreating, setIsCreating] = useState(false); 
            const [editingActivity, setEditingActivity] = useState(null);
            const [editingExpense, setEditingExpense] = useState(null); 
            const [currentMember, setCurrentMember] = useState(null); 
            const [isMenuOpen, setIsMenuOpen] = useState(false); 
            const [isOffline, setIsOffline] = useState(true);
            const [user, setUser] = useState(null); 
            const unsubscribeRef = useRef(null);
            const authUnsubscribeRef = useRef(null);
            const isOwner = currentMember?.role === 'owner';

            useEffect(() => {
                const storedRecents = localStorage.getItem('gtp_recent_trips'); if (storedRecents) setRecentTrips(JSON.parse(storedRecents));
                const timer = setTimeout(() => localStorage.removeItem('gtp_session_restore'), 500);
                const storedConfig = localStorage.getItem('gtp_firebase_config');
                if (storedConfig) reInit(JSON.parse(storedConfig)); else { setIsOffline(true); setUser({ uid: 'local' }); }
                return () => clearTimeout(timer);
            }, []);

            const reInit = async (config) => {
                 if (authUnsubscribeRef.current) authUnsubscribeRef.current();
                 if (!config) { setIsOffline(true); setUser({ uid: 'local' }); return; }
                 if (getApps().length > 0) { try { await Promise.all(getApps().map(app => deleteApp(app))); } catch(e) {} }
                 try {
                    const app = initializeApp(config); const auth = getAuth(app); await signInAnonymously(auth);
                    const fbUser = auth.currentUser; setIsOffline(false); setUser(fbUser);
                    authUnsubscribeRef.current = onAuthStateChanged(auth, (u) => setUser(u || null));
                 } catch (e) { setIsOffline(true); setUser({ uid: 'local' }); }
            };

            const handleConfigUpdate = async (input) => {
                 if (input === null) { localStorage.removeItem('gtp_firebase_config'); await reInit(null); return; }
                 let config = input;
                 if (typeof input === 'string') { try { config = JSON.parse(input); } catch(e) { config = null; } }
                 if (!config || !config.apiKey || !config.projectId) return alert("連線設定格式不正確");
                 localStorage.setItem('gtp_firebase_config', JSON.stringify(config));
                 await reInit(config);
            };

            const handleDeleteTripFromRecent = (id, e) => {
                if (e) e.stopPropagation();
                setConfirm({
                    open: true,
                    msg: '確定要移除此近期紀錄嗎？\n(這不會刪除雲端資料)',
                    action: () => {
                        const filtered = recentTrips.filter(t => t.id !== id);
                        setRecentTrips(filtered);
                        localStorage.setItem('gtp_recent_trips', JSON.stringify(filtered));
                    }
                });
            };

            useEffect(() => {
                if (!tripId) return;
                const procData = (d) => ({ ...d, flights: { outbound: d.flights?.outbound || {}, inbound: d.flights?.inbound || {} }, expenseCategories: d.expenseCategories || Object.keys(CATEGORY_COLORS), accommodations: d.accommodations || {}, itinerary: d.itinerary || {}, members: d.members || [] });
                if (isOffline) {
                    const localData = localStorage.getItem(`gtp_trip_${tripId}`);
                    if (localData) {
                        const d = procData(JSON.parse(localData)); setTripData(d);
                        if(!selectedDate) setSelectedDate(d.startDate);
                        let found = d.members.find(m => m.deviceId === userId) || d.members[0];
                        if (found) setCurrentMember(found); if(view === 'landing' || view === 'setup') setView('planner');
                    }
                } else {
                    const apps = getApps(); if (apps.length === 0) return;
                    const db = getFirestore(apps[0]);
                    if (unsubscribeRef.current) unsubscribeRef.current();
                    unsubscribeRef.current = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId), (s) => {
                        if(s.exists()) {
                            const d = procData(s.data()); setTripData(d);
                            if(!selectedDateRef.current) setSelectedDate(d.startDate);
                            const cu = getAuth(apps[0]).currentUser;
                            if(cu) {
                                const found = d.members.find(m => m.deviceId === cu.uid);
                                if (found) { setCurrentMember(found); if(view === 'landing' || view === 'setup') setView('planner'); } else setModals(m => ({...m, join: true}));
                            }
                        }
                    });
                }
            }, [user, tripId, isOffline]); 

            const updateTrip = (field, val) => {
                if (!tripData) return;
                if (isOffline) { const newData = { ...tripData, [field]: val }; setTripData(newData); localStorage.setItem(`gtp_trip_${tripData.id}`, JSON.stringify(newData)); }
                else { const db = getFirestore(); updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId), { [field]: sanitizeFirestoreData(val) }); }
            };

            const updateTripFull = (newData) => {
                if (isOffline) { setTripData(newData); localStorage.setItem(`gtp_trip_${newData.id}`, JSON.stringify(newData)); }
                else { const db = getFirestore(); setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId), sanitizeFirestoreData(newData)); }
            }

            const handleUpdateAccommodation = (id, field, val) => { 
                if(!isOwner) return; 
                const newAccoms = { ...tripData.accommodations };
                let masterItem = null;
                Object.values(newAccoms).forEach(list => { const found = list.find(i => i.id === id); if (found) masterItem = { ...found }; });
                if (!masterItem) return;

                masterItem[field] = val;
                const safeIn = masterItem.checkInDate || selectedDate;
                const allDates = getDatesArray(tripData.startDate, tripData.endDate);
                const nextIdx = allDates.indexOf(safeIn);
                const safeOut = masterItem.checkOutDate || (nextIdx < allDates.length - 1 ? allDates[nextIdx + 1] : safeIn);
                
                masterItem.checkInDate = safeIn;
                masterItem.checkOutDate = safeOut;

                allDates.forEach(dStr => {
                    let dayList = Array.isArray(newAccoms[dStr]) ? [...newAccoms[dStr]] : [];
                    const existingIdx = dayList.findIndex(i => i.id === id);
                    const shouldExist = (dStr >= safeIn && dStr < safeOut);

                    if (shouldExist) {
                        if (existingIdx > -1) dayList[existingIdx] = { ...masterItem };
                        else { dayList = dayList.filter(i => i.name || i.bookingCode); dayList.push({ ...masterItem }); }
                    } else if (existingIdx > -1) {
                        dayList.splice(existingIdx, 1);
                        if (dayList.length === 0) dayList.push({ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] });
                    }
                    newAccoms[dStr] = dayList;
                });
                updateTrip('accommodations', newAccoms);
            };

            const handlePhotoUpload = async (e) => {
                const f = e.target.files[0];
                if (f && uploadTarget) {
                    const url = await processImageUpload(f);
                    if (url) {
                        const photoObj = { url, uploader: currentMember.name };
                        if (uploadTarget.type === 'activity') {
                            const acts = [...tripData.itinerary[selectedDate]];
                            const idx = acts.findIndex(a=>a.id===uploadTarget.id);
                            if(idx>=0) { acts[idx].photoUrls = [...(acts[idx].photoUrls || []), photoObj]; updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: acts}); }
                        } else if (uploadTarget.type === 'accom') {
                            const nAc = { ...tripData.accommodations };
                            Object.keys(nAc).forEach(d => {
                                nAc[d] = (nAc[d]||[]).map(item => item.id === uploadTarget.id ? { ...item, photoUrls: [...(item.photoUrls || []), photoObj] } : item);
                            });
                            updateTrip('accommodations', nAc);
                        }
                    }
                }
                e.target.value = ''; setUploadTarget(null);
            };

            const handlePhotoDelete = (targetId, urlToDelete, type) => {
                setConfirm({ open: true, msg: '確定要刪除這張照片嗎？', action: () => {
                    if (type === 'activity') {
                        const acts = [...tripData.itinerary[selectedDate]];
                        const idx = acts.findIndex(a => a.id === targetId);
                        if(idx >= 0) { acts[idx].photoUrls = (acts[idx].photoUrls||[]).filter(p => (typeof p === 'string' ? p : p.url) !== urlToDelete); updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: acts}); }
                    } else {
                        const nAc = { ...tripData.accommodations };
                        Object.keys(nAc).forEach(d => {
                            nAc[d] = (nAc[d]||[]).map(item => item.id === targetId ? { ...item, photoUrls: (item.photoUrls || []).filter(p => (typeof p === 'string' ? p : p.url) !== urlToDelete) } : item);
                        });
                        updateTrip('accommodations', nAc);
                    }
                }});
            };

            const handleAddAccommodation = () => { 
                if(!isOwner) return; 
                const dates = getDatesArray(tripData.startDate, tripData.endDate);
                const nextDate = (dates.indexOf(selectedDate) < dates.length - 1) ? dates[dates.indexOf(selectedDate) + 1] : selectedDate;
                const newItem = { id: generateId(), name: '', bookingCode: '', checkInDate: selectedDate, checkInTime: '15:00', checkOutDate: nextDate, checkOutTime: '10:00', phone: '', address: '', photoUrls: [], note: '' }; 
                const nAc = { ...tripData.accommodations };
                dates.forEach(d => { if (d >= newItem.checkInDate && d < newItem.checkOutDate) { nAc[d] = (nAc[d] || []).filter(i => i.name || i.bookingCode); nAc[d].push(newItem); } });
                updateTrip('accommodations', nAc); 
            };

            const handleDeleteAccommodation = (id) => {
                if(!isOwner) return;
                setConfirm({ open: true, msg: '確定要刪除這筆住宿資料嗎？\n這將移除所有日期的關聯卡片。', action: () => { 
                    const newAccoms = { ...tripData.accommodations };
                    const allDates = getDatesArray(tripData.startDate, tripData.endDate);
                    allDates.forEach(dateStr => {
                        if (newAccoms[dateStr]) {
                            newAccoms[dateStr] = newAccoms[dateStr].filter(item => item.id !== id);
                            if (newAccoms[dateStr].length === 0) {
                                newAccoms[dateStr] = [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }];
                            }
                        }
                    });
                    updateTrip('accommodations', newAccoms);
                }});
            };

            const handleAddDate = () => {
                if (!isOwner) return;
                const currentEnd = new Date(tripData.endDate);
                currentEnd.setDate(currentEnd.getDate() + 1);
                const newEndDate = currentEnd.toISOString().split('T')[0];
                const newItinerary = { ...tripData.itinerary, [newEndDate]: [] };
                const newAccoms = { ...tripData.accommodations, [newEndDate]: [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }] };
                updateTripFull({ ...tripData, endDate: newEndDate, itinerary: newItinerary, accommodations: newAccoms });
            };

            const handleStart = async () => {
                const id = generateId(); const dates = getDatesArray(setupForm.startDate, setupForm.endDate);
                const itinerary = {}; dates.forEach(d => itinerary[d] = []);
                const accoms = {}; dates.forEach(d => { accoms[d] = [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }]; });
                const initialMember = { name: setupForm.nickname, pin: setupForm.pin, role: 'owner', deviceId: isOffline ? userId : user?.uid };
                const newData = { id, ...setupForm, itinerary, accommodations: accoms, members: [initialMember], expenseCategories: Object.keys(CATEGORY_COLORS), flights: { outbound: {}, inbound: {} } };
                if (isOffline) { localStorage.setItem(`gtp_trip_${id}`, JSON.stringify(newData)); setTripData(newData); setCurrentMember(initialMember); setTripId(id); setView('planner'); }
                else { await setDoc(doc(getFirestore(), 'artifacts', appId, 'public', 'data', 'trips', id), sanitizeFirestoreData(newData)); setTripId(id); setView('planner'); }
            };

            const handleSaveActivity = (data) => {
                if (!isOwner) return; const targetDate = data.date || selectedDate;
                const newItinerary = { ...tripData.itinerary };
                if (editingActivity) {
                    newItinerary[editingActivity.date || selectedDate] = (newItinerary[editingActivity.date || selectedDate] || []).filter(a => a.id !== editingActivity.id);
                    newItinerary[targetDate] = [...(newItinerary[targetDate] || []), { ...data, id: editingActivity.id, createdBy: editingActivity.createdBy }];
                } else {
                    newItinerary[targetDate] = [...(newItinerary[targetDate] || []), { ...data, id: generateId(), createdBy: currentMember.name }];
                }
                updateTrip('itinerary', newItinerary); setEditingActivity(null);
            };

            const handleSaveExpense = (data) => {
                const targetDate = data.date; const newItinerary = { ...tripData.itinerary };
                if (editingExpense) {
                    newItinerary[editingExpense.originalDate] = (newItinerary[editingExpense.originalDate] || []).filter(e => e.id !== editingExpense.id);
                    newItinerary[targetDate] = [...(newItinerary[targetDate] || []), { ...data, id: editingExpense.id, createdBy: editingExpense.createdBy, transport: 'expense' }];
                } else {
                    newItinerary[targetDate] = [...(newItinerary[targetDate] || []), { ...data, id: generateId(), createdBy: currentMember.name, transport: 'expense' }];
                }
                updateTrip('itinerary', newItinerary); setModals(m => ({ ...m, expense: false })); setEditingExpense(null);
            };

            const handleLocalJoin = (arg) => {
                const id = (arg || joinId).toString().trim(); if (!id) return;
                setTripData(null); const local = localStorage.getItem(`gtp_trip_${id}`);
                if (local) { setTripId(id); setView('planner'); } else if (!isOffline) { setTripId(id); setView('planner'); }
            };

            const sortedActivities = useMemo(() => {
                const acts = tripData?.itinerary?.[selectedDate] || [];
                return [...acts].filter(Boolean).sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            }, [tripData, selectedDate]);

            const expenseStatsByCurrency = useMemo(() => {
                if (!tripData) return [];
                const targetCurrs = expenseFilterCurrency === 'all' ? currencies.map(c => c.value) : [expenseFilterCurrency];
                return targetCurrs.map(currency => {
                    let total = 0; const catTotals = {}; (tripData.expenseCategories || []).forEach(c => catTotals[c] = 0);
                    const barData = (expenseFilterDate === 'all' ? getDatesArray(tripData.startDate, tripData.endDate) : [expenseFilterDate]).map(date => {
                        let dayTotal = 0; const dayCat = {};
                        (tripData.itinerary?.[date] || []).filter(a => a && (a.transport === 'expense' || a.cost > 0) && (expenseFilterPayer === 'all' || a.payer === expenseFilterPayer) && a.currency === currency).forEach(e => {
                            const cost = parseFloat(e.cost) || 0; dayTotal += cost; total += cost;
                            const cat = e.category || '其他'; dayCat[cat] = (dayCat[cat] || 0) + cost; catTotals[cat] = (catTotals[cat] || 0) + cost;
                        });
                        return { date, total: dayTotal, breakdown: Object.keys(dayCat).map(c => ({ category: c, cost: dayCat[c], color: CATEGORY_COLORS[c] || '#ccc' })) };
                    });
                    const pieData = Object.keys(catTotals).filter(k => catTotals[k] > 0).map(k => ({ category: k, value: catTotals[k], color: CATEGORY_COLORS[k] || '#ccc' })).sort((a,b)=>b.value-a.value);
                    return (total === 0 && expenseFilterCurrency === 'all') ? null : { currency, total, pieData, barData };
                }).filter(Boolean);
            }, [tripData, expenseFilterDate, expenseFilterPayer, expenseFilterCurrency]);

            return (
                <div className="w-full max-w-[480px] h-screen bg-[#E0F2F1] shadow-2xl flex flex-col overflow-hidden relative mx-auto border-x border-[#eeeeee]">
                    {!user ? <div className="flex h-full items-center justify-center text-[#0ABAB5] font-bold animate-pulse">載入中...</div> : (
                        view === 'landing' ? <LandingView onConnect={handleConfigUpdate} onOffline={() => handleConfigUpdate(null).then(() => setView('setup'))} onCreateTrip={() => setView('setup')} joinId={joinId} setJoinId={setJoinId} onJoin={(arg) => handleLocalJoin(arg)} recentTrips={recentTrips} onDeleteTrip={handleDeleteTripFromRecent} isOffline={isOffline} /> : (
                            <>
                                <div className={`absolute inset-0 z-50 bg-black/50 ${!isMenuOpen && 'hidden'}`} onClick={()=>setIsMenuOpen(false)}>
                                    <div className="w-72 bg-[#F5FDFC] h-full p-4" onClick={e=>e.stopPropagation()}>
                                        <h2 className="text-lg font-bold text-[#0ABAB5] mb-4">Travel Plan</h2>
                                        {tripData && <div className="mb-4 p-3 bg-[#EDF7F6] border border-[#eeeeee] rounded-xl shadow-sm"><label className="text-[10px] font-bold text-gray-400 block mb-1">旅程 ID</label><div className="text-xl font-bold text-gray-700">{tripData.id}</div></div>}
                                        <button onClick={()=>{setView('setup'); setIsMenuOpen(false);}} className="w-full text-left p-3 hover:bg-gray-100 rounded-xl mb-2 flex items-center gap-3 font-bold text-gray-600"><Plus size={18} /> 建立新旅程</button>
                                        <button onClick={()=>{setView('landing'); setIsMenuOpen(false);}} className="w-full text-left p-3 hover:bg-gray-100 rounded-xl mb-2 flex items-center gap-3 font-bold text-gray-500"><Settings size={18} /> 連線設定</button>
                                    </div>
                                </div>

                                {view === 'setup' ? (
                                    <div className="p-8 h-full flex flex-col relative">
                                        <div className="flex justify-center items-center mb-6 relative">
                                            <h2 className="text-3xl font-bold text-[#0ABAB5]">Travel Planner</h2>
                                        </div>
                                        <div className="flex-1 overflow-y-auto no-scrollbar pb-20">
                                            <div className="space-y-4">
                                                <div className="space-y-3 p-1">
                                                    <input placeholder="目的地" value={setupForm.destination} onChange={e=>setSetupForm({...setupForm, destination:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                                    <div className="flex gap-2">
                                                        <input type="date" value={setupForm.startDate} onChange={e=>setSetupForm({...setupForm, startDate:e.target.value})} className="flex-1 p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 font-bold" />
                                                        <input type="date" value={setupForm.endDate} onChange={e=>setSetupForm({...setupForm, endDate:e.target.value})} className="flex-1 p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 font-bold" />
                                                    </div>
                                                    <select value={setupForm.currency} onChange={e=>setSetupForm({...setupForm, currency:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm font-bold outline-none text-gray-700">
                                                        {currencies.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}
                                                    </select>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <input placeholder="您的暱稱" value={setupForm.nickname} onChange={e=>setSetupForm({...setupForm, nickname:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                                        <input type="password" placeholder="設定 PIN 碼" value={setupForm.pin} onChange={e=>setSetupForm({...setupForm, pin:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                                    </div>
                                                    <button onClick={handleStart} disabled={isCreating} className="w-full py-3.5 bg-[#0ABAB5] text-white rounded-xl font-bold shadow-sm hover:bg-[#008985] transition-all mt-4 flex items-center justify-center">{isCreating ? <Loader className="animate-spin" /> : '開始規劃'}</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    !tripData ? <div className="flex h-full items-center justify-center animate-pulse">尋找旅程中...</div> : (
                                        <>
                                            <HeaderWithTabs tripData={tripData} selectedDate={selectedDate} setSelectedDate={setSelectedDate} handleAddDate={handleAddDate} view={view} setView={setView} setIsMenuOpen={setIsMenuOpen} isOffline={isOffline} onExportExpenses={() => {}} />
                                            <div className="flex-1 overflow-y-auto p-4 pb-24">
                                                {view === 'planner' ? (
                                                    <div className="space-y-4">
                                                        <div className="grid grid-cols-2 gap-3 mb-4">{isOwner && <button onClick={()=>setModals({...modals, activity:true})} className="py-2 rounded-xl bg-[#6A8E83] text-white font-bold flex justify-center gap-2 border shadow-sm"><Plus size={18}/> 新增行程</button>}<button onClick={()=>setModals({...modals, expense:true})} className={`py-2 rounded-xl bg-[#D68C68] text-white font-bold flex justify-center gap-2 border shadow-sm ${!isOwner && 'col-span-2'}`}><DollarSign size={18}/> 記帳</button></div>
                                                        {selectedDate === tripData.startDate && <FlightCard label="去程" icon={Plane} data={tripData.flights.outbound} onUpdate={(f,v)=>updateTrip('flights', {...tripData.flights, outbound: {...tripData.flights.outbound, [f]:v}})} isOwner={isOwner} />}
                                                        {selectedDate === tripData.endDate && <FlightCard label="回程" icon={Plane} data={tripData.flights.inbound} onUpdate={(f,v)=>updateTrip('flights', {...tripData.flights, inbound: {...tripData.flights.inbound, [f]:v}})} isOwner={isOwner} />}
                                                        <div className="space-y-3">
                                                            {sortedActivities.map(act => {
                                                                const isExpanded = expandedId === act.id;
                                                                return (
                                                                <div key={act.id} className={`bg-[#F5FDFC] rounded-2xl border overflow-hidden ${act.transport==='expense'?'border-orange-100 bg-orange-50/30':'border-[#eeeeee]'}`}>
                                                                    <div className="flex items-stretch min-h-[2.8rem] cursor-pointer" onClick={()=>setExpandedId(isExpanded?null:act.id)}>
                                                                        <div className="w-16 flex flex-col items-center justify-center border-r border-gray-100 bg-white/50 py-1 px-1">
                                                                            <div onClick={(e) => e.stopPropagation()}><AutoSaveInputRaw value={act.time} onSave={v=> { const n = [...tripData.itinerary[selectedDate]]; const i = n.findIndex(x=>x.id===act.id); if(i>=0){n[i].time=v; updateTrip('itinerary',{...tripData.itinerary, [selectedDate]:n});} }} readOnly={!isOwner} className="font-bold text-sm text-center bg-transparent w-full outline-none text-gray-700" /></div>
                                                                            {act.transport === 'expense' && <div className="text-[10px] text-orange-400 flex items-center gap-1 mt-0.5"><DollarSign size={10}/>消費</div>}
                                                                        </div>
                                                                        <div className="flex-1 flex items-center px-4 overflow-hidden"><div className="w-full" onClick={(e) => e.stopPropagation()}><AutoSaveInputRaw value={act.title} onSave={v=> { const n = [...tripData.itinerary[selectedDate]]; const i = n.findIndex(x=>x.id===act.id); if(i>=0){n[i].title=v; updateTrip('itinerary',{...tripData.itinerary, [selectedDate]:n});} }} readOnly={!isOwner} className="font-bold text-lg bg-transparent w-full text-gray-800" /></div></div>
                                                                        <div className="flex items-center pr-3 gap-2">{act.transport !== 'expense' && <button onClick={(e) => {e.stopPropagation(); openGoogleMaps(act.title);}} className="text-gray-400 p-1"><Navigation size={16} /></button>}<ChevronDown size={20} className={`text-gray-300 transition ${isExpanded?'rotate-180':''}`}/></div>
                                                                    </div>
                                                                    <div className={`transition-all ${isExpanded?'max-h-[500px]':'max-h-0'}`}>
                                                                        <div className="p-4 border-t border-gray-100 bg-[#F5FDFC] space-y-3">
                                                                            <AutoSaveInputRaw value={act.note} onSave={v=> { const n = [...tripData.itinerary[selectedDate]]; const i = n.findIndex(x=>x.id===act.id); if(i>=0){n[i].note=v; updateTrip('itinerary',{...tripData.itinerary, [selectedDate]:n});} }} readOnly={!isOwner} placeholder="備註..." className="w-full text-sm bg-[#E2E2E2] rounded-xl p-2 border border-[#eeeeee]" />
                                                                            {act.transport==='expense' && <div className="flex gap-2 bg-orange-50 p-2 rounded-xl border border-orange-100 text-xs text-gray-600"><div className="flex-1 font-bold text-orange-600">${act.cost} {act.currency}</div><div className="flex-1">{act.category}</div><div>{act.payer}</div></div>}
                                                                            <div className="flex justify-between items-center"><label className="text-xs font-bold text-gray-400">照片/操作</label><div className="flex gap-2">{isOwner && <button onClick={() => { setEditingActivity(act); setModals({ ...modals, activity: true }); }} className="text-blue-400 p-1"><Pencil size={16} /></button>}<button onClick={() => { const n = tripData.itinerary[selectedDate].filter(x=>x.id!==act.id); updateTrip('itinerary', {...tripData.itinerary, [selectedDate]:n}); }} className="text-red-400 p-1"><Trash2 size={16}/></button></div></div>
                                                                            <div className="flex gap-2 overflow-x-auto">{act.photoUrls?.map((p,i) => { if(!p) return null; const url = typeof p === 'string' ? p : p.url; return (<div key={i} className="relative w-10 h-10 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded" onClick={()=>setModals({...modals, viewingImage:url})} /></div>) })}<button onClick={()=>{setUploadTarget({type:'activity', id:act.id}); fileRef.current.click();}} className="w-10 h-10 border-2 border-dashed border-gray-300 rounded flex items-center justify-center text-gray-400 flex-shrink-0"><Camera size={16}/></button></div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )})}
                                                        </div>
                                                        <AccommodationCard date={selectedDate} data={tripData.accommodations[selectedDate]} onUpdate={handleUpdateAccommodation} onPhotoUpload={(id)=>{setUploadTarget({type:'accom',id});fileRef.current.click()}} onPhotoDelete={handlePhotoDelete} onViewImage={(u)=>setModals({...modals, viewingImage:u})} onAdd={handleAddAccommodation} onDelete={handleDeleteAccommodation} isOwner={isOwner} currentMember={currentMember} tripData={tripData} />
                                                        {isOwner && <div className="mt-8 mb-4 flex justify-center"><button onClick={() => { if(confirm(`確定刪除 ${selectedDate} 的行程嗎？`)) { const nAc = {...tripData.accommodations}; const nIt = {...tripData.itinerary}; delete nAc[selectedDate]; delete nIt[selectedDate]; const dates = getDatesArray(tripData.startDate, tripData.endDate).filter(d=>d!==selectedDate); updateTripFull({...tripData, endDate: dates[dates.length-1], accommodations: nAc, itinerary: nIt}); setSelectedDate(dates[0]); } }} className="flex items-center gap-2 px-4 py-2 bg-red-50 text-red-400 rounded-xl text-xs font-bold border border-red-100"><Trash2 size={14} /> 刪除當日</button></div>}
                                                    </div>
                                                ) : (
                                                    <div className="space-y-6">
                                                        {expenseStatsByCurrency.map(stat => (
                                                            <div key={stat.currency} className="space-y-4 bg-white p-4 rounded-2xl border">
                                                                <h4 className="font-bold text-gray-800">{stat.currency === 'JPY' ? '🇯🇵 日圓' : '🇹🇼 台幣'} 支出</h4>
                                                                <SimplePieChartRaw data={stat.pieData} />
                                                                <div className="flex justify-between font-bold border-t pt-2"><span>總計</span><span className="text-[#D68C68] text-xl">${stat.total.toLocaleString()}</span></div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            <ActivityModal isOpen={modals.activity} onClose={()=>setModals({...modals, activity:false})} onSave={handleSaveActivity} tripData={tripData} currentMember={currentMember} selectedDate={selectedDate} defaultValues={editingActivity} onUpdateCategories={(c)=>updateTrip('expenseCategories',c)} />
                                            <ExpenseModalRaw isOpen={modals.expense} onClose={()=> { setModals({...modals, expense:false}); setEditingExpense(null); }} tripData={tripData} onSave={handleSaveExpense} onUpdateCategories={c=>updateTrip('expenseCategories',c)} selectedDate={selectedDate} currentMember={currentMember} defaultValues={editingExpense} />
                                            {modals.members && <MemberManagementModal isOpen={modals.members} onClose={() => setModals({ ...modals, members: false })} tripData={tripData} currentMember={currentMember} onUpdateMember={(idx, info) => { const n = [...tripData.members]; n[idx] = { ...n[idx], ...info }; updateTrip('members', n); }} onRemoveMember={(idx) => { const n = tripData.members.filter((_, i) => i !== idx); updateTrip('members', n); }} onAddMember={(m) => { const n = [...tripData.members, m]; updateTrip('members', n); }} />}
                                            {modals.transaction && <TransactionDetailModalRaw transaction={modals.transaction} onClose={() => setModals({ ...modals, transaction: null })} onViewImage={(url) => setModals({ ...modals, viewingImage: url })} />}
                                            <ImageModalRaw src={modals.viewingImage} onClose={()=>setModals({...modals, viewingImage:null})} />
                                            <input type="file" ref={fileRef} className="hidden" onChange={handlePhotoUpload} accept="image/*" />
                                        </>
                                    )
                                )}
                            </>
                        )
                    )}
                    <ConfirmModal isOpen={confirm.open} message={confirm.msg} onConfirm={()=>{confirm.action(); setConfirm({open:false})}} onCancel={()=>setConfirm({open:false})} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>