const [tripData, setTripData] = useState(null);
            const [selectedDate, setSelectedDate] = useState(restored?.selectedDate || '');
            const [modals, setModals] = useState({ expense: false, activity: false, viewingImage: null, transaction: null, editTrip: false, members: false, join: false });
            const [expandedId, setExpandedId] = useState(null);
            const [recentTrips, setRecentTrips] = useState([]);
            
            // Fix: Use ref to track selectedDate to avoid stale closure in onSnapshot
            const selectedDateRef = useRef(selectedDate);
            useEffect(() => { selectedDateRef.current = selectedDate; }, [selectedDate]);

            // Restore setup form data if available
            const [setupForm, setSetupForm] = useState(
                restored?.setupForm || { 


                    const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId), 
                        async (s) => { // Made async to handle auto-upload
                            if(s.exists()) {
                                const d = s.data();
                                setTripData(d);
                                // Fix: Use ref to check current selectedDate, preventing unwanted reset to startDate on update
                                if(!selectedDateRef.current) setSelectedDate(d.startDate);
                                
                                const currentAuthUser = getAuth(apps[0]).currentUser;
                                if(currentAuthUser) {


                                            <div className="flex-1 overflow-y-auto p-4 pb-24">
                                                {view === 'planner' ? (
                                                    <>
                                                        <div className="grid grid-cols-2 gap-3 mb-4">
                                                            {isOwner && <button onClick={()=>setModals({...modals, activity:true})} className="p-3 rounded-2xl bg-[#6A8E83] text-white font-bold flex justify-center items-center gap-2 border border-[#6A8E83]"><Plus size={18}/> 新增行程</button>}
                                                            <button onClick={()=>setModals({...modals, expense:true})} className={`p-3 rounded-2xl bg-[#D68C68] text-white font-bold flex justify-center items-center gap-2 border border-[#D68C68] ${!isOwner ? 'col-span-2' : ''}`}><DollarSign size={18}/> 記帳</button>
                                                        </div>
                                                        {/* Fix: Added unique keys to FlightCards to prevent state leakage between outbound/inbound */}
                                                        {selectedDate === tripData.startDate && <FlightCard key="outbound" label="去程" icon={Plane} data={tripData.flights.outbound} onUpdate={(f,v)=>updateTrip('flights', {...tripData.flights, outbound: {...tripData.flights.outbound, [f]:v}})} isOwner={isOwner} />}
                                                        {selectedDate === tripData.endDate && <FlightCard key="inbound" label="回程" icon={Plane} data={tripData.flights.inbound} onUpdate={(f,v)=>updateTrip('flights', {...tripData.flights, inbound: {...tripData.flights.inbound, [f]:v}})} isOwner={isOwner} />}
                                                        <div className="space-y-3">
                                                            {sortedActivities.map(act => {
                                                                const isExpanded = expandedId === act.id;