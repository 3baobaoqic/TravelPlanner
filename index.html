const HeaderWithTabs = ({ tripData, selectedDate, setSelectedDate, handleAddDate, view, setView, setIsMenuOpen, onManageMembers, isOffline, onOpenFirebase }) => {
            const datesList = useMemo(() => tripData ? getDatesArray(tripData.startDate, tripData.endDate) : [], [tripData]);
            
            return (
                <div className="bg-[#0ABAB5] z-10 relative flex flex-col">
                    {/* Top Row */}
                    <div className="text-white px-3 pt-3 pb-1 flex justify-between items-start">
                        <div className="flex items-center gap-3">
                            <button onClick={() => setIsMenuOpen(true)}><Menu size={24}/></button>
                            <h1 className="font-bold leading-tight text-lg">{tripData.destination}</h1>
                        </div>
                        <div className="flex items-center gap-1">
                             <button 
                                onClick={onOpenFirebase}
                                className="w-8 h-8 flex items-center justify-center text-white hover:bg-white/10 rounded-full transition-colors"
                                title={isOffline ? "目前為離線模式，點擊設定連線" : "已連線至 Firebase"}
                            >
                                {isOffline ? <WifiOff size={16} className="text-red-300"/> : <Wifi size={16} className="text-[#00FF00]"/>}
                            </button>
                        </div>
                    </div>
                    
                    {/* Bottom Row: Dates + Dollar Button */}
                    <div className="flex items-center pl-2 pr-3 pb-2 gap-2">
                        {/* Date List */}
                        <div className="flex-1 flex overflow-x-auto space-x-2 no-scrollbar">
                            {datesList.map((d, i) => (
                                <button 
                                    key={d} 
                                    onClick={() => { setSelectedDate(d); setView('planner'); }} 
                                    className={`flex-shrink-0 w-10 h-10 flex flex-col items-center justify-center rounded-xl transition-all duration-200 border ${d === selectedDate ? 'bg-[#F5FDFC] text-[#00695C] font-bold border-[#eeeeee]' : 'bg-[#008985] text-white opacity-90 border-transparent'}`}
                                >
                                    <span className="text-[8px] leading-none opacity-80">D{i+1}</span>
                                    <span className="text-[10px] font-bold leading-tight my-0.5">{getMonthDay(d)}</span>
                                    <span className="text-[8px] leading-none opacity-90">{getDayOfWeek(d)}</span>
                                </button>
                            ))}
                            <button onClick={handleAddDate} className="flex-shrink-0 w-10 h-10 flex items-center justify-center border border-dashed border-white/50 rounded-xl text-white"><Plus size={20}/></button>
                        </div>

                        {/* Dollar Button - Centered with dates, Scaled Down 10% */}
                        <button onClick={() => setView(view === 'planner' ? 'expense' : 'planner')} className="flex-shrink-0 w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-yellow-900 ring-2 ring-[#D68C68] transform hover:scale-105 transition-transform">
                            <DollarSign size={20} strokeWidth={3} />
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            
            // Lazy Initialize State from LocalStorage
            const getRestoredState = () => {
                try {
                    const saved = localStorage.getItem('gtp_session_restore');
                    if (saved) return JSON.parse(saved); // Just read, do NOT remove here
                } catch(e) {}
                return null;
            };
            
            // Initialize from restored state
            const [restored] = useState(getRestoredState);

            const [userId, setUserId] = useState(getOrCreateUserId());
            const [view, setView] = useState(restored?.view || 'landing'); // DEFAULT TO LANDING IF NO RESTORED VIEW
            const [tripId, setTripId] = useState(restored?.tripId || '');
            const [tripData, setTripData] = useState(null);
            const [selectedDate, setSelectedDate] = useState(restored?.selectedDate || '');
            const [modals, setModals] = useState({ expense: false, activity: false, viewingImage: null, transaction: null, editTrip: false, members: false, join: false });
            const [expandedId, setExpandedId] = useState(null);
            const [recentTrips, setRecentTrips] = useState([]);
            
            // Restore setup form data if available
            const [setupForm, setSetupForm] = useState(
                restored?.setupForm || { 
                    destination: '', 
                    // Fix: Use local time (en-CA gives YYYY-MM-DD) instead of ISO string (UTC) to avoid incorrect date in early morning
                    startDate: new Date().toLocaleDateString('en-CA'), 
                    endDate: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toLocaleDateString('en-CA'), 
                    currency: 'JPY', 
                    nickname: '', 
                    pin: '' 
                }
            );
            
            const [confirm, setConfirm] = useState({ open: false, msg: '', action: null });
            const [joinId, setJoinId] = useState('');
            const [homeJoinInput, setHomeJoinInput] = useState('');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [setupTab, setSetupTab] = useState('create');
            const fileRef = useRef(null);
            const [uploadTarget, setUploadTarget] = useState(null);
            const [expenseFilterDate, setExpenseFilterDate] = useState('all');
            const [isCreating, setIsCreating] = useState(false); 
            const [editingActivity, setEditingActivity] = useState(null);
            const [currentMember, setCurrentMember] = useState(null); 
            const [authError, setAuthError] = useState(null);
            const [connectionTimeout, setConnectionTimeout] = useState(false); 
            
            // Firebase states (default to offline/local)
            const [isOffline, setIsOffline] = useState(true);
            const [user, setUser] = useState(null); // Auth user
            const unsubscribeRef = useRef(null);
            const authUnsubscribeRef = useRef(null);
            
            // Derived state placed early to ensure scope availability
            const isOwner = currentMember?.role === 'owner';
            
            // Load recent trips and cleanup restore state on mount
            useEffect(() => {
                const storedRecents = localStorage.getItem('gtp_recent_trips');
                if (storedRecents) {
                    setRecentTrips(JSON.parse(storedRecents));
                }
                
                // Clear restore data AFTER it's been used for initialization
                // We use a small timeout to ensure the app has fully mounted and state is settled
                const timer = setTimeout(() => {
                    localStorage.removeItem('gtp_session_restore');
                }, 500);

                // Check if firebase config exists, try to init (silent mode)
                const storedConfig = localStorage.getItem('gtp_firebase_config');
                if (storedConfig) {
                    reInit(JSON.parse(storedConfig));
                } else {
                    // Fix: If no config, default to local mode immediately
                    setIsOffline(true);
                    setUser({ uid: 'local' });
                }

                return () => clearTimeout(timer);
            }, []);

            const reInit = async (config) => {
                 // Cleanup existing auth listener
                 if (authUnsubscribeRef.current) {
                    authUnsubscribeRef.current();
                    authUnsubscribeRef.current = null;
                 }
                 
                 if (!config) {
                    setIsOffline(true);
                    setUser({ uid: 'local' }); // Fix: Set dummy user for local mode
                    return;
                 }

                 // If we have active apps, try to delete them to start fresh (simple hot reload logic)
                 if (getApps().length > 0) {
                     try {
                        await Promise.all(getApps().map(app => deleteApp(app)));
                     } catch(e) { console.warn("Cleanup failed", e); }
                 }

                 try {
                    const app = initializeApp(config);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    
                    // Wait for auth state
                    await signInAnonymously(auth);
                    setIsOffline(false);
                    setUser(auth.currentUser);
                    
                    const authUnsub = onAuthStateChanged(auth, (u) => {
                         if (u) {
                             setUser(u);
                         } else {
                             setUser(null);
                         }
                     });
                     authUnsubscribeRef.current = authUnsub;
                 } catch (e) {
                    console.error("Auto-connect failed", e);
                    // Fallback to offline mode on error so UI doesn't freeze
                    setIsOffline(true);
                    setUser({ uid: 'offline_fallback' });
                    alert("連線失敗，將切換至離線模式。錯誤: " + e.message);
                 }
            };

            const handleConfigUpdate = async (config) => {
                 if (unsubscribeRef.current) {
                    unsubscribeRef.current();
                    unsubscribeRef.current = null;
                 }
                 if (authUnsubscribeRef.current) {
                    authUnsubscribeRef.current();
                    authUnsubscribeRef.current = null;
                 }
                 
                 setUser(null);
                 setIsOffline(true);
                 
                 // Add safety timeout to prevent infinite loading
                 const timeoutId = setTimeout(() => {
                     setUser((currentUser) => {
                         if (currentUser === null) {
                             alert("連線逾時，切換至離線模式");
                             setIsOffline(true);
                             return { uid: 'timeout_fallback' };
                         }
                         return currentUser;
                     });
                 }, 10000); // 10 seconds timeout

                 try {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await reInit(config);
                 } catch (e) {
                    console.error("Config update critical failure", e);
                    setUser({ uid: 'error_fallback' });
                 } finally {
                    clearTimeout(timeoutId);
                 }
            };

            useEffect(() => {
                // We don't need to re-run reInit on mount again, it's handled in the first useEffect
                return () => {
                    if (unsubscribeRef.current) unsubscribeRef.current();
                    if (authUnsubscribeRef.current) authUnsubscribeRef.current();
                };
            }, []);

            // --- Data Sync Logic (Hybrid with Auto-Upload) ---
            useEffect(() => {
                if (!tripId) return;

                // 1. If Offline, load from LocalStorage
                if (isOffline) {
                    const localData = localStorage.getItem(`gtp_trip_${tripId}`);
                    if (localData) {
                        const d = JSON.parse(localData);
                        setTripData(d);
                        
                        if(!selectedDate) setSelectedDate(d.startDate);
                        
                        let found = d.members.find(m => m.deviceId === userId);
                        if (!found && d.members.length > 0) {
                             found = d.members.find(m => m.role === 'owner') || d.members[0];
                        }
                        if (found) {
                            setCurrentMember(found);
                            // Only force redirect if we were in landing or setup
                            if(view === 'landing' || view === 'setup') {
                                 setView('planner');
                                 setSelectedDate(d.startDate);
                            }
                        }
                    }
                } else {
                    // 2. If Online, load from Firestore
                    const apps = getApps();
                    if (apps.length === 0) return; // Safety check
                    const db = getFirestore(apps[0]);

                    if (unsubscribeRef.current) {
                        unsubscribeRef.current();
                        unsubscribeRef.current = null;
                    }
                    
                    const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId), 
                        async (s) => { // Made async to handle auto-upload
                            if(s.exists()) {
                                const d = s.data();
                                setTripData(d);
                                if(!selectedDate) setSelectedDate(d.startDate);
                                
                                const currentAuthUser = getAuth(apps[0]).currentUser;
                                if(currentAuthUser) {
                                    const found = d.members.find(m => m.deviceId === currentAuthUser.uid);
                                    if (found) {
                                        setCurrentMember(found);
                                        // Force redirect from landing/setup to planner
                                        if(view === 'landing' || view === 'setup') {
                                            setView('planner');
                                            setSelectedDate(d.startDate);
                                        }
                                    } else {
                                        // Force Join Modal for non-members
                                        setModals(m => ({...m, join: true}));
                                    }
                                }
                                setRecentTrips(p => { 
                                    const newRecents = [{id: d.id, destination: d.destination, dateRange: `${d.startDate.slice(5)} - ${d.endDate.slice(5)}`}, ...p.filter(t=>t.id!==d.id)].slice(0,5); 
                                    localStorage.setItem('gtp_recent_trips', JSON.stringify(newRecents)); 
                                    return newRecents; 
                                });
                            } else {
                                // --- AUTO UPLOAD LOGIC ---
                                const localData = localStorage.getItem(`gtp_trip_${tripId}`);
                                if (localData) {
                                    try {
                                            console.log("Auto-uploading local data to Firebase...");
                                            const d = JSON.parse(localData);
                                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId), sanitizeFirestoreData(d));
                                    } catch (e) {
                                            console.error("Auto-upload failed", e);
                                    }
                                } else {
                                     // Not found anywhere
                                     if (!isOffline) {
                                         alert("找不到此旅程 ID，請確認 ID 是否正確。");
                                         setTripId('');
                                         setView('landing');
                                     }
                                }
                            }
                        },
                        (error) => {
                            console.error("Snapshot error:", error);
                            alert("讀取失敗，可能是權限問題或 ID 錯誤。");
                            setTripId('');
                            setView('landing');
                        }
                    );
                    unsubscribeRef.current = unsub;
                }
            }, [user, tripId, isOffline]); 

            const handleStart = async () => {
                if (!setupForm.nickname || !setupForm.pin) { alert('請輸入暱稱與 PIN 碼'); return; }
                
                const id = generateId();
                const dates = getDatesArray(setupForm.startDate, setupForm.endDate);
                const itinerary = {}; dates.forEach(d => itinerary[d] = []);
                const accoms = {}; dates.forEach(d => { accoms[d] = [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }]; });
                
                const currentUid = isOffline ? userId : (user ? user.uid : userId);
                
                const initialMember = { name: setupForm.nickname, pin: setupForm.pin, role: 'owner', deviceId: currentUid };
                
                const newData = { 
                    id, 
                    ...setupForm, 
                    ownerPin: setupForm.pin,
                    itinerary, 
                    accommodations: accoms, 
                    createdAt: Date.now(), 
                    members: [initialMember], 
                    expenseCategories: Object.keys(CATEGORY_COLORS), 
                    flights: { outbound: {}, inbound: {} } 
                };
                
                if (isOffline) {
                    localStorage.setItem(`gtp_trip_${id}`, JSON.stringify(newData));
                    const newRecent = [{id: newData.id, destination: newData.destination, dateRange: `${newData.startDate.slice(5)} - ${newData.endDate.slice(5)}`}, ...recentTrips].slice(0, 5);
                    setRecentTrips(newRecent);
                    localStorage.setItem('gtp_recent_trips', JSON.stringify(newRecent));
                    setTripData(newData);
                    setCurrentMember(initialMember);
                    setTripId(id);
                    setView('planner');
                } else {
                     const apps = getApps();
                     if (apps.length > 0) {
                         const db = getFirestore(apps[0]);
                         setIsCreating(true);
                         try {
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', id), sanitizeFirestoreData(newData));
                            setTripId(id);
                            setCurrentMember(initialMember);
                            setView('planner');
                         } catch (e) {
                             console.error(e);
                             alert("建立失敗: " + e.message);
                         } finally {
                             setIsCreating(false);
                         }
                     }
                }
            };

            const updateTripData = (newData) => {
                setTripData(newData);
                localStorage.setItem(`gtp_trip_${newData.id}`, JSON.stringify(newData));
            };

            const updateTrip = (field, val) => {
                if (!tripData) return;
                
                if (isOffline) {
                     const newData = { ...tripData, [field]: val };
                     setTripData(newData);
                     localStorage.setItem(`gtp_trip_${tripData.id}`, JSON.stringify(newData));
                } else {
                     const apps = getApps();
                     if (apps.length > 0) {
                         const db = getFirestore(apps[0]);
                         updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId), { [field]: sanitizeFirestoreData(val) });
                     }
                }
            };
            
            const updateTripFull = (newData) => {
                if (isOffline) {
                     setTripData(newData);
                     localStorage.setItem(`gtp_trip_${newData.id}`, JSON.stringify(newData));
                } else {
                     const apps = getApps();
                     if (apps.length > 0) {
                         const db = getFirestore(apps[0]);
                         setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId), sanitizeFirestoreData(newData));
                     }
                }
            }

            const handleUpdateMember = (index, newInfo) => {
                const newMembers = [...tripData.members];
                newMembers[index] = { ...newMembers[index], ...newInfo };
                updateTrip('members', newMembers);
            };

            const handleRemoveMember = (index) => {
                const newMembers = tripData.members.filter((_, i) => i !== index);
                updateTrip('members', newMembers);
            };

            const handleEditTripSave = (newData) => {
                if(!isOwner) return;
                const updatedTrip = { ...tripData, ...newData };
                if (newData.startDate !== tripData.startDate || newData.endDate !== tripData.endDate) {
                     const newDates = getDatesArray(newData.startDate, newData.endDate);
                     const newItinerary = { ...tripData.itinerary };
                     const newAccoms = { ...tripData.accommodations };
                     
                     newDates.forEach(d => { 
                         if(!newItinerary[d]) newItinerary[d] = []; 
                         if(!newAccoms[d]) newAccoms[d] = [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }]; 
                     });
                     updatedTrip.itinerary = newItinerary; 
                     updatedTrip.accommodations = newAccoms; 
                     setSelectedDate(newDates[0]); 
                }
                updateTripFull(updatedTrip); 
            };
            
            const updateActivity = (id, field, val) => { 
                if (!isOwner) return; 
                const acts = [...tripData.itinerary[selectedDate]]; 
                const idx = acts.findIndex(a=>a.id===id); 
                if(idx>=0) { acts[idx][field]=val; updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: acts}); } 
            };

            const handleSaveActivity = (data) => {
                if (!isOwner) return; 
                let acts = [...(tripData.itinerary[selectedDate] || [])];
                if (editingActivity) { acts = acts.map(a => a.id === editingActivity.id ? { ...data, id: editingActivity.id, createdBy: currentMember.name } : a); } 
                else { acts.push({ id: generateId(), ...data, createdBy: currentMember.name }); }
                updateTrip('itinerary', { ...tripData.itinerary, [selectedDate]: acts });
                setEditingActivity(null);
            };
            
            const deleteActivity = (id) => {
                if (!isOwner) return;
                setConfirm({ open: true, msg: '確定刪除此項目？', action: () => {
                    const newActs = tripData.itinerary[selectedDate].filter(a=>a.id!==id);
                    updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: newActs});
                }});
            };

            const deleteTransaction = (id, date, item) => {
                if (!isOwner && item.createdBy !== currentMember.name) { alert("只能刪除自己建立的記帳"); return; }
                setConfirm({ open: true, msg: '確定刪除此交易？', action: () => {
                    const newActs = tripData.itinerary[date].filter(a=>a.id!==id);
                    updateTrip('itinerary', {...tripData.itinerary, [date]: newActs});
                }});
            };
            
            const handleJoinTrip = async (memberInfo) => {
                 const { name, pin, role, isNew } = memberInfo;
                 let newMembers = [...tripData.members];
                 
                 // Determine ID based on mode
                 const currentUid = isOffline ? userId : (user ? user.uid : userId);
                 
                 if (isNew) {
                     newMembers.push({ name, pin, role, deviceId: currentUid });
                 } else {
                     newMembers = newMembers.map(m => m.name === name ? { ...m, deviceId: currentUid } : m);
                 }
 
                 updateTrip('members', newMembers);
                 
                 // Update local state immediately
                 const switchedMember = newMembers.find(m => m.name === name) || newMembers[newMembers.length - 1];
                 if(switchedMember) setCurrentMember(switchedMember);
                 
                 setModals(m => ({...m, join: false}));
            };

            const handleLocalJoin = (targetId) => {
                const idToJoin = targetId || joinId;
                if (!idToJoin) return;
                
                // Improved Logic:
                // 1. Always check local storage first (fastest)
                const localData = localStorage.getItem(`gtp_trip_${idToJoin}`);
                if (localData) {
                    setTripId(idToJoin);
                    setView('planner');
                    return;
                }

                // 2. If not local, check connectivity
                if (isOffline) {
                    // Check if they simply haven't configured it yet
                    const hasConfig = localStorage.getItem('gtp_firebase_config');
                    if (hasConfig) {
                        alert("找不到本機資料，且目前尚未成功連線至雲端。\n\n請檢查網路，或點擊上方「測試連線」確認設定是否正確。");
                    } else {
                        alert("找不到本機資料。\n\n若這是一個雲端行程 ID，請先填寫上方的 Firebase 設定並進行連線。");
                    }
                } else {
                    // 3. Online: Try to fetch from cloud (via useEffect)
                    setTripId(idToJoin);
                    setView('planner');
                }
            };
            
            const handleDeleteTrip = (id, e) => {
                e.stopPropagation();
                setConfirm({ open: true, msg: '確定移除此紀錄?', action: () => {
                    const updated = recentTrips.filter(t => t.id !== id);
                    setRecentTrips(updated);
                    localStorage.setItem('gtp_recent_trips', JSON.stringify(updated));
                    localStorage.removeItem(`gtp_trip_${id}`);
                }});
            };

            const handleAddDate = async () => {
                if(!isOwner) return;
                const currentEnd = new Date(tripData.endDate); currentEnd.setDate(currentEnd.getDate() + 1); const newEndDate = currentEnd.toISOString().split('T')[0];
                const newItinerary = { ...tripData.itinerary, [newEndDate]: [] };
                const newAccommodations = { ...tripData.accommodations, [newEndDate]: [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }] };
                const newData = { ...tripData, endDate: newEndDate, itinerary: newItinerary, accommodations: newAccommodations };
                updateTripFull(newData);
            };

            const handleUpdateAccommodation = (id, field, val) => { if(!isOwner) return; let currentList = tripData.accommodations[selectedDate]; if (!Array.isArray(currentList)) currentList = [currentList]; const newList = currentList.map(item => item.id === id ? { ...item, [field]: val } : item); updateTrip('accommodations', { ...tripData.accommodations, [selectedDate]: newList }); };
            const handleAddAccommodation = () => { if(!isOwner) return; let currentList = tripData.accommodations[selectedDate] || []; if (!Array.isArray(currentList)) currentList = [currentList]; const newList = [...currentList, { id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }]; updateTrip('accommodations', { ...tripData.accommodations, [selectedDate]: newList }); };
            const handleDeleteAccommodation = (id) => { if(!isOwner) return; setConfirm({ open: true, msg: '確定刪除?', action: () => { let currentList = tripData.accommodations[selectedDate]; if (!Array.isArray(currentList)) currentList = [currentList]; const newList = currentList.filter(item => item.id !== id); updateTrip('accommodations', { ...tripData.accommodations, [selectedDate]: newList }); }}); };
            
            const handlePhotoUpload = async (e) => {
                const f = e.target.files[0];
                if (f && uploadTarget) {
                    const b64 = await resizeImage(f);
                    if (b64) {
                        const photoObj = { url: b64, uploader: currentMember.name };
                        if (uploadTarget.type === 'activity') {
                            const acts = [...tripData.itinerary[selectedDate]];
                            const idx = acts.findIndex(a=>a.id===uploadTarget.id);
                            if(idx>=0) { 
                                acts[idx].photoUrls = [...(acts[idx].photoUrls||[]), photoObj]; 
                                updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: acts}); 
                            }
                        } else if (uploadTarget.type === 'accom') {
                            let currentList = tripData.accommodations[selectedDate];
                            if (!Array.isArray(currentList)) currentList = [currentList];
                            const newList = currentList.map(item => item.id === uploadTarget.id ? { ...item, photoUrls: [...(item.photoUrls || []), photoObj] } : item);
                            updateTrip('accommodations', { ...tripData.accommodations, [selectedDate]: newList });
                        }
                    }
                }
                e.target.value = ''; setUploadTarget(null);
            };

            const handlePhotoDelete = (targetId, urlToDelete, type) => {
                setConfirm({ open: true, msg: '確定要刪除這張照片嗎？', action: () => {
                    if (type === 'activity') {
                        const acts = [...tripData.itinerary[selectedDate]];
                        const idx = acts.findIndex(a => a.id === targetId);
                        if(idx >= 0) { 
                            acts[idx].photoUrls = acts[idx].photoUrls.filter(p => (typeof p === 'string' ? p : p.url) !== urlToDelete); 
                            updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: acts}); 
                        }
                    } else {
                        let currentList = tripData.accommodations[selectedDate];
                        if (!Array.isArray(currentList)) currentList = [currentList];
                        const newList = currentList.map(item => item.id === targetId ? { ...item, photoUrls: item.photoUrls.filter(p => (typeof p === 'string' ? p : p.url) !== urlToDelete) } : item);
                        updateTrip('accommodations', { ...tripData.accommodations, [selectedDate]: newList });
                    }
                }});
            };

            const expenseData = useMemo(() => {
                if (!tripData) return [];
                let targetActivities = [];
                if (expenseFilterDate === 'all') { targetActivities = Object.values(tripData.itinerary || {}).flat(); } 
                else { targetActivities = tripData.itinerary?.[expenseFilterDate] || []; }
                const expenses = targetActivities.filter(a => a.transport === 'expense' || (a.cost && a.cost > 0));
                const totals = {};
                const currentCategories = tripData.expenseCategories || Object.keys(CATEGORY_COLORS);
                currentCategories.forEach(c => totals[c] = 0);
                expenses.forEach(e => {
                    let cat = e.category;
                    if (!cat) {
                        if (e.transport === 'expense') cat = '其他';
                        else if (['plane','shinkansen','nightbus','train','bus','taxi','car'].includes(e.transport)) cat = '交通';
                        else if (e.title && e.title.includes('門票')) cat = '門票';
                        else cat = '娛樂';
                    }
                    totals[cat] = (totals[cat] || 0) + (e.cost || 0);
                });
                return Object.keys(totals).map(k => ({ category: k, value: totals[k], color: CATEGORY_COLORS[k] || '#ccc' }));
            }, [tripData, expenseFilterDate]);

            const dailyExpenseData = useMemo(() => {
                if (!tripData) return [];
                const datesToShow = expenseFilterDate === 'all' ? getDatesArray(tripData.startDate, tripData.endDate) : [expenseFilterDate];
                return datesToShow.map(date => {
                    const dayExpenses = (tripData.itinerary?.[date] || []).filter(a => a.transport === 'expense' || (a.cost && a.cost > 0));
                    let total = 0;
                    const breakdown = [];
                    const dayCatTotals = {};
                    dayExpenses.forEach(e => {
                        let cat = e.category;
                        if (!cat) {
                            if (e.transport === 'expense') cat = '其他';
                            else if (['plane','shinkansen','nightbus','train','bus','taxi','car'].includes(e.transport)) cat = '交通';
                            else if (e.title && e.title.includes('門票')) cat = '門票';
                            else cat = '娛樂';
                        }
                        dayCatTotals[cat] = (dayCatTotals[cat] || 0) + (e.cost || 0);
                        total += (e.cost || 0);
                    });
                    Object.keys(dayCatTotals).forEach(cat => { breakdown.push({ category: cat, cost: dayCatTotals[cat], color: CATEGORY_COLORS[cat] || PALETTE[Math.floor(Math.random() * PALETTE.length)] }); });
                    return { date, total, breakdown };
                });
            }, [tripData, expenseFilterDate]);

            const sortedExpensesByDate = useMemo(() => {
                if (!tripData) return [];
                const dates = expenseFilterDate === 'all' ? getDatesArray(tripData.startDate, tripData.endDate) : [expenseFilterDate];
                const expenseList = [];
                dates.forEach(date => {
                    const dayExpenses = (tripData.itinerary?.[date] || []).filter(a => a.transport === 'expense' || (a.cost && a.cost > 0));
                    if (dayExpenses.length > 0) { expenseList.push({ date, items: dayExpenses }); }
                });
                return expenseList;
            }, [tripData, expenseFilterDate]);

            const sortedActivities = useMemo(() => {
                const acts = tripData?.itinerary?.[selectedDate] || [];
                return [...acts].sort((a, b) => a.time.localeCompare(b.time));
            }, [tripData, selectedDate]);

            if (authError || connectionTimeout) return <div className="flex h-screen items-center justify-center bg-red-50 p-8"><div className="bg-[#F5FDFC] p-6 rounded-2xl shadow-xl max-w-md text-center"><h2 className="text-2xl font-bold text-red-500 mb-2">{authError ? "Firebase 驗證錯誤" : "連線逾時"}</h2><button onClick={() => window.location.reload()} className="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">重試</button></div></div>;

            // Pass session data to modal so it can save it before reloading
            const currentSessionData = { view, tripId, selectedDate, setupForm };

            return (
                <div className="w-full max-w-[480px] h-screen bg-[#E0F2F1] shadow-2xl flex flex-col overflow-hidden relative mx-auto border-x border-[#eeeeee]">
                    
                    {/* --- Conditional Content Rendering --- */}
                    {!user ? (
                        <div className="flex h-full items-center justify-center text-[#0ABAB5] font-bold animate-pulse">
                            載入中...
                        </div>
                    ) : (
                        <>
                            {view === 'landing' ? (
                                <LandingView 
                                    onConnect={(config) => handleConfigUpdate(config).then(() => setView('setup'))}
                                    onOffline={() => handleConfigUpdate(null).then(() => setView('setup'))}
                                    joinId={joinId}
                                    setJoinId={setJoinId}
                                    onJoin={(arg) => handleLocalJoin(typeof arg === 'string' ? arg : null)}
                                    recentTrips={recentTrips}
                                    onDeleteTrip={handleDeleteTrip}
                                />
                            ) : (
                                <>
                                    {/* Menu Overlay */}
                                    <div className={`absolute inset-0 z-50 bg-black/50 ${!isMenuOpen && 'hidden'}`} onClick={()=>setIsMenuOpen(false)}>
                                        <div className="w-72 bg-[#F5FDFC] h-full p-4" onClick={e=>e.stopPropagation()}>
                                            <h2 className="text-lg font-bold text-[#0ABAB5] mb-4">Good Travel Plan</h2>
                                            
                                            {/* Trip ID Display */}
                                            {tripData && view !== 'setup' && (
                                                <div className="mb-4 p-3 bg-white border border-[#eeeeee] rounded-xl shadow-sm">
                                                    <label className="text-[10px] font-bold text-gray-400 block mb-1">旅程 ID (點擊複製)</label>
                                                    <div 
                                                        className="text-xl font-bold text-gray-700 flex items-center gap-2 cursor-pointer active:scale-95 transition-transform"
                                                        onClick={() => {
                                                            const textArea = document.createElement("textarea");
                                                            textArea.value = tripData.id;
                                                            document.body.appendChild(textArea);
                                                            textArea.select();
                                                            document.execCommand("Copy");
                                                            textArea.remove();
                                                            alert("ID 已複製: " + tripData.id); 
                                                        }}
                                                    >
                                                        {tripData.id}
                                                        <span className="text-xs text-[#0ABAB5] bg-[#0ABAB5]/10 px-2 py-1 rounded-full">COPY</span>
                                                    </div>
                                                </div>
                                            )}

                                            <button onClick={()=>{setView('setup'); setIsMenuOpen(false);}} className="w-full text-left p-3 hover:bg-gray-100 rounded-xl mb-2 font-bold text-gray-600">建立新旅程</button>
                                            {view !== 'setup' && (
                                                <button 
                                                    onClick={() => { setModals({ ...modals, members: true }); setIsMenuOpen(false); }} 
                                                    className="w-full text-left p-3 hover:bg-gray-100 rounded-xl mb-2 flex items-center gap-3 font-bold text-gray-600"
                                                >
                                                    <Users size={18} /> 旅伴管理
                                                </button>
                                            )}
                                            
                                            {/* Button to go back to Landing Page (Firebase Setup) */}
                                            <div className="mt-4 pt-4 border-t border-gray-200">
                                                <button 
                                                    onClick={() => {
                                                        setIsMenuOpen(false);
                                                        setView('landing');
                                                    }}
                                                    className="w-full text-left p-3 hover:bg-gray-100 rounded-xl font-bold text-gray-500 flex items-center gap-2"
                                                >
                                                    <Settings size={18} /> 回到連線設定
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    {view === 'setup' && (
                                        <div className="p-8 h-full flex flex-col relative">
                                            {/* Header Area */}
                                            <div className="flex justify-center items-center mb-6 relative">
                                                <h2 className="text-3xl font-bold text-[#0ABAB5]">Travel Planner</h2>
                                            </div>

                                            {/* Content Area - Only Create Mode Now */}
                                            <div className="flex-1 overflow-y-auto no-scrollbar pb-20">
                                                <div className="space-y-4">
                                                    <h3 className="text-lg font-bold text-gray-700 mb-2">建立新旅程</h3>
                                                    <div className="space-y-3 p-1">
                                                        <input placeholder="目的地" value={setupForm.destination} onChange={e=>setSetupForm({...setupForm, destination:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                                        <div className="flex gap-2">
                                                            <input type="date" value={setupForm.startDate} onChange={e=>setSetupForm({...setupForm, startDate:e.target.value})} className="flex-1 p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 font-bold" />
                                                            <input type="date" value={setupForm.endDate} onChange={e=>setSetupForm({...setupForm, endDate:e.target.value})} className="flex-1 p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 font-bold" />
                                                        </div>
                                                        <select value={setupForm.currency} onChange={e=>setSetupForm({...setupForm, currency:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm font-bold outline-none text-gray-700">
                                                            {currencies.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}
                                                        </select>
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <input placeholder="您的暱稱" value={setupForm.nickname} onChange={e=>setSetupForm({...setupForm, nickname:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                                            <input type="password" placeholder="設定 PIN 碼" value={setupForm.pin} onChange={e=>setSetupForm({...setupForm, pin:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                                        </div>
                                                        <button onClick={handleStart} disabled={isCreating} className="w-full py-3.5 bg-[#0ABAB5] text-white rounded-xl font-bold shadow-sm hover:bg-[#008985] transition-all mt-4 flex items-center justify-center">{isCreating ? <Loader className="animate-spin" /> : '開始規劃'}</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Planner & Expense Views */}
                                    {(view === 'planner' || view === 'expense') && (
                                        !tripData ? (
                                            <div className="flex h-full items-center justify-center flex-col gap-4 text-gray-400">
                                                 <Loader size={32} className="animate-spin text-[#0ABAB5]" />
                                                 <p>正在搜尋旅程...</p>
                                                 <button onClick={() => setView('landing')} className="text-sm underline hover:text-gray-600">取消</button>
                                            </div>
                                        ) : (
                                        <>
                                            <HeaderWithTabs tripData={tripData} selectedDate={selectedDate} setSelectedDate={setSelectedDate} handleAddDate={handleAddDate} view={view} setView={setView} setIsMenuOpen={setIsMenuOpen} onManageMembers={() => setModals({ ...modals, members: true })} onOpenFirebase={() => setView('landing')} isOffline={isOffline} />
                                            
                                            <div className="flex-1 overflow-y-auto p-4 pb-24">
                                                {view === 'planner' ? (
                                                    <>
                                                        <div className="grid grid-cols-2 gap-3 mb-4">
                                                            {isOwner && <button onClick={()=>setModals({...modals, activity:true})} className="p-3 rounded-2xl bg-[#6A8E83] text-white font-bold flex justify-center items-center gap-2 border border-[#6A8E83]"><Plus size={18}/> 新增行程</button>}
                                                            <button onClick={()=>setModals({...modals, expense:true})} className={`p-3 rounded-2xl bg-[#D68C68] text-white font-bold flex justify-center items-center gap-2 border border-[#D68C68] ${!isOwner ? 'col-span-2' : ''}`}><DollarSign size={18}/> 記帳</button>
                                                        </div>
                                                        {selectedDate === tripData.startDate && <FlightCard label="去程" icon={Plane} data={tripData.flights.outbound} onUpdate={(f,v)=>updateTrip('flights', {...tripData.flights, outbound: {...tripData.flights.outbound, [f]:v}})} isOwner={isOwner} />}
                                                        {selectedDate === tripData.endDate && <FlightCard label="回程" icon={Plane} data={tripData.flights.inbound} onUpdate={(f,v)=>updateTrip('flights', {...tripData.flights, inbound: {...tripData.flights.inbound, [f]:v}})} isOwner={isOwner} />}
                                                        <div className="space-y-3">
                                                            {sortedActivities.map(act => {
                                                                const isExpanded = expandedId === act.id;
                                                                return (
                                                                <div key={act.id} className={`bg-[#F5FDFC] rounded-2xl border overflow-hidden ${act.transport==='expense'?'border-orange-100 bg-orange-50/30':'border-[#eeeeee]'}`}>
                                                                        <div className="flex items-stretch min-h-[2.8rem] cursor-pointer" onClick={()=>setExpandedId(isExpanded?null:act.id)}>
                                                                            <div className="w-16 flex flex-col items-center justify-center border-r border-gray-100 bg-white/50 py-1 px-1">
                                                                                <div onClick={(e) => e.stopPropagation()}><AutoSaveInput value={act.time} onSave={v=>updateActivity(act.id,'time',v)} readOnly={!isOwner} className="font-bold text-sm text-center bg-transparent w-full outline-none p-0 text-gray-700" /></div>
                                                                                {act.transport === 'expense' ? <div className="text-[10px] text-orange-400 flex items-center gap-1 mt-0.5"><DollarSign size={10}/>消費</div> : <div className="flex items-center justify-center gap-1 mt-0.5 w-full"></div>}
                                                                            </div>
                                                                            <div className="flex-1 flex items-center px-4 overflow-hidden"><div className="w-full" onClick={(e) => e.stopPropagation()}><AutoSaveInput value={act.title} onSave={v=>updateActivity(act.id,'title',v)} readOnly={!isOwner} className="font-bold text-lg bg-transparent w-full text-gray-800" /></div></div>
                                                                            <div className="flex items-center pr-3 gap-2">
                                                                                {act.transport !== 'expense' && <button onClick={(e) => {e.stopPropagation(); openGoogleMaps(act.title);}} className="text-gray-400 hover:text-[#0ABAB5] flex items-center justify-center p-1"><Navigation size={16} /></button>}
                                                                                <ChevronDown size={20} className={`text-gray-300 transition ${isExpanded?'rotate-180':''}`}/>
                                                                            </div>
                                                                        </div>
                                                                        <div className={`transition-all ${isExpanded?'max-h-[500px]':'max-h-0'}`}>
                                                                            <div className="p-4 border-t border-gray-100 bg-[#F5FDFC] space-y-3">
                                                                                <AutoSaveInput value={act.note} onSave={v=>updateActivity(act.id,'note',v)} readOnly={!isOwner} placeholder="備註..." className="w-full text-sm bg-[#E2E2E2] rounded-xl p-2 text-gray-700 border border-[#eeeeee]" />
                                                                                {act.transport!=='expense' && <div className="grid grid-cols-2 gap-2">
                                                                                    <div className="bg-[#E2E2E2] p-2 rounded-xl border border-[#eeeeee]"><label className="text-[10px] text-gray-400 font-bold">代碼</label><AutoSaveInput value={act.bookingCode} onSave={v=>updateActivity(act.id,'bookingCode',v)} readOnly={!isOwner} className="text-sm bg-transparent w-full text-gray-700"/></div>
                                                                                    <div className="bg-[#E2E2E2] p-2 rounded-xl border border-[#eeeeee]"><label className="text-[10px] text-gray-400 font-bold">費用</label><AutoSaveInput value={act.cost} onSave={v=>updateActivity(act.id,'cost',v)} type="number" readOnly={!isOwner} className="text-sm bg-transparent w-full text-gray-700"/></div>
                                                                                </div>}
                                                                                {act.transport==='expense' && <div className="flex gap-2 bg-orange-50 p-2 rounded-xl border border-orange-100"><div className="flex-1 text-orange-600 font-bold">${act.cost}</div><div className="flex-1">{act.currency}</div><div className="flex-1">{act.category}</div><div className="text-xs text-gray-400 self-center">{act.payer}付</div></div>}
                                                                                <div>
                                                                                    <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-gray-400">照片</label>
                                                                                        <div className="flex gap-2">
                                                                                            {act.transport!=='expense' && isOwner && <button onClick={() => { setEditingActivity(act); setModals({ ...modals, activity: true }); }} className="text-blue-400 hover:text-blue-600"><Pencil size={16} /></button>}
                                                                                            {(isOwner || (act.transport === 'expense' && act.createdBy === currentMember.name)) && <button onClick={() => act.transport==='expense' ? deleteTransaction(act.id, selectedDate, act) : deleteActivity(act.id)} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button>}
                                                                                        </div>
                                                                                    </div>
                                                                                    <div className="flex gap-2 overflow-x-auto">{act.photoUrls?.map((p,i) => { const url = typeof p === 'string' ? p : p.url; return (<div key={i} className="relative w-10 h-10 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded" onClick={()=>setModals({...modals, viewingImage:url})} />{(isOwner || (typeof p !== 'string' && p.uploader === currentMember.name)) && <button onClick={()=>setConfirm({open:true, msg:'刪除照片?', action:()=>{const n=[...act.photoUrls]; n.splice(i,1); updateActivity(act.id, 'photoUrls', n)}})} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button>}</div>) })}<button onClick={()=>{setUploadTarget({type:'activity', id:act.id}); fileRef.current.click();}} className="w-10 h-10 border-2 border-dashed rounded flex items-center justify-center text-gray-400"><Camera size={16}/></button></div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                </div>
                                                            )})}
                                                        </div>
                                                        <AccommodationCard date={selectedDate} data={Array.isArray(tripData.accommodations?.[selectedDate]) ? tripData.accommodations[selectedDate] : (tripData.accommodations?.[selectedDate] ? [tripData.accommodations[selectedDate]] : [])} onUpdate={handleUpdateAccommodation} onPhotoUpload={(id) => { setUploadTarget({type: 'accom', id: id}); fileRef.current?.click(); }} onPhotoDelete={handlePhotoDelete} onViewImage={(u)=>setModals({...modals, viewingImage:u})} onAdd={handleAddAccommodation} onDelete={handleDeleteAccommodation} isOwner={isOwner} currentMember={currentMember} />
                                                    </>
                                                ) : (
                                                    // ... (Expense View)
                                                    <div className="space-y-6">
                                                        <div className="flex justify-between items-center mb-2"><h3 className="text-lg font-bold text-gray-700 flex items-center gap-2"><History size={20} className="text-[#D68C68]" /> 交易紀錄</h3><div className="relative"><select value={expenseFilterDate} onChange={(e) => setExpenseFilterDate(e.target.value)} className="appearance-none pl-3 pr-8 py-1.5 bg-[#E2E2E2] border border-gray-200 text-gray-700 text-xs font-bold rounded-lg shadow-sm focus:outline-none focus:ring-1 focus:ring-[#0ABAB5] cursor-pointer"><option value="all">全部日期</option>{getDatesArray(tripData.startDate, tripData.endDate).map(date => (<option key={date} value={date}>{date}</option>))}</select><div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500"><ChevronDown size={12} /></div></div></div>
                                                        
                                                        {/* Inserted Transaction List Here */}
                                                        <div className="bg-[#F5FDFC] p-4 rounded-xl border border-[#eeeeee] shadow-sm">
                                                            {sortedExpensesByDate.length === 0 ? (
                                                                <div className="text-center py-8 text-gray-400 border-2 border-dashed border-gray-300 rounded-xl">尚無消費紀錄</div>
                                                            ) : (
                                                                <div className="space-y-4">
                                                                    {sortedExpensesByDate.map(({ date, items }) => (
                                                                        <div key={date}>
                                                                            <div className="flex items-center gap-2 mb-2">
                                                                                <span className="text-[10px] font-bold text-gray-500 bg-white/60 px-1.5 py-0.5 rounded border border-gray-200">{date}</span>
                                                                                <span className="text-[10px] text-gray-400">({getDayOfWeek(date)})</span>
                                                                            </div>
                                                                            <div className="space-y-2">
                                                                                {items.map(e => (
                                                                                    <div key={e.id} onClick={() => setModals({...modals, transaction:e})} className="flex justify-between items-center bg-[#EDF7F6] p-2.5 rounded-lg border border-[#E0F2F1] active:scale-[0.99] transition-transform cursor-pointer">
                                                                                        <div className="flex flex-col">
                                                                                            <div className="font-bold text-gray-700 text-sm">{e.title || '未命名'}</div>
                                                                                            <div className="text-[10px] text-gray-400 flex items-center gap-1 mt-0.5">
                                                                                                <span className="bg-[#E2E2E2] px-1.5 py-0.5 rounded text-gray-500">{e.category}</span>
                                                                                                <span>•</span><span>{e.payer}</span>
                                                                                                {e.time && <span>• {e.time}</span>}
                                                                                            </div>
                                                                                        </div>
                                                                                        <div className="flex items-center gap-3">
                                                                                            <div className="text-red-500 font-bold text-sm bg-red-50 px-2 py-1 rounded-lg">-{e.cost} <span className="text-[10px] font-normal text-red-400">{e.currency}</span></div>
                                                                                            <button onClick={(evt) => { evt.stopPropagation(); deleteTransaction(e.id, date, e); }} className="text-gray-400 hover:text-red-500 p-1 rounded-full hover:bg-red-50 transition-colors"><Trash2 size={16} /></button>
                                                                                        </div>
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>

                                                        <div className="bg-[#F5FDFC] p-4 rounded-xl border border-[#eeeeee]"><h3 className="font-bold text-gray-700 mb-4 text-sm flex items-center gap-2"><PieChart size={16} /> 支出類別統計</h3><SimplePieChart data={expenseData} /></div>
                                                        <div className="bg-[#F5FDFC] p-4 rounded-xl border border-[#eeeeee]"><h3 className="font-bold text-gray-700 mb-4 text-sm flex items-center gap-2"><BarChart3 size={16} /> 每日趨勢</h3><SimpleBarChart data={dailyExpenseData} /></div>
                                                    </div>
                                                )}
                                            </div>

                                            <ActivityModal isOpen={modals.activity} onClose={() => { setModals({...modals, activity:false}); setEditingActivity(null); }} onSave={handleSaveActivity} tripData={tripData} defaultValues={editingActivity} />
                                            <ExpenseModal 
                                                isOpen={modals.expense} 
                                                onClose={()=>setModals({...modals, expense:false})} 
                                                tripData={tripData} 
                                                onSave={(d, date)=>{
                                                    const acts=[...(tripData.itinerary[date]||[]), {id:generateId(), ...d, transport:'expense', createdBy: currentMember.name}]; 
                                                    updateTrip('itinerary', {...tripData.itinerary, [date]: acts});
                                                    setModals(m => ({...m, expense: false}));
                                                    setView('expense');
                                                }} 
                                                onUpdateCategories={c=>updateTrip('expenseCategories',c)} 
                                                selectedDate={selectedDate} 
                                            />
                                            <ImageModal src={modals.viewingImage} onClose={()=>setModals({...modals, viewingImage:null})} />
                                            <TransactionDetailModal transaction={modals.transaction} onClose={()=>setModals({...modals, transaction:null})} onViewImage={u=>setModals({...modals, viewingImage:u})} />
                                            {modals.editTrip && <EditTripModal isOpen={modals.editTrip} onClose={() => setModals({ ...modals, editTrip: false })} tripData={tripData} onSave={handleEditTripSave} />}
                                            <JoinModal isOpen={modals.join} onClose={() => setModals(m => ({...m, join: false}))} tripData={tripData} onJoin={handleJoinTrip} />
                                            <MemberManagementModal isOpen={modals.members} onClose={() => setModals({ ...modals, members: false })} tripData={tripData} currentMember={currentMember} onUpdateMember={handleUpdateMember} onRemoveMember={handleRemoveMember} />
                                            <input type="file" ref={fileRef} className="hidden" onChange={handlePhotoUpload} accept="image/*" />
                                        </>
                                        )
                                    )}
                                </>
                            )}
                            
                            {/* GLOBAL MODALS */}
                            <ConfirmModal isOpen={confirm.open} message={confirm.msg} onConfirm={()=>{confirm.action(); setConfirm({open:false})}} onCancel={()=>setConfirm({open:false})} />
                        </>
                    )}
                </div>
            );
        };