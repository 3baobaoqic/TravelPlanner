const handleLocalJoin = (targetId) => {
                // 優先使用 targetId，若無則使用 joinId，並強制移除前後空白，避免複製貼上時出錯
                const rawId = targetId !== undefined ? targetId : joinId;
                const idToJoin = (rawId || '').toString().trim();
                
                if (!idToJoin) return;
                
                // 【修復白屏關鍵】切換 ID 時先清空舊資料，避免渲染錯誤或殘留
                setTripData(null); 
                // 【新增】同時重置選取日期，確保進入新旅程時會自動選取第一天
                setSelectedDate(null);
                
                // 1. Always check local storage first (fastest)
                const localData = localStorage.getItem(`gtp_trip_${idToJoin}`);
                if (localData) {
                    try {
                        const d = processLoadedData(JSON.parse(localData));
                        setTripData(d); // Direct set for instant load
                        setTripId(idToJoin);
                        setView('planner');
                        
                        // Update recent trips for local load too
                        setRecentTrips(p => { 
                            const newRecents = [{id: d.id, destination: d.destination, dateRange: `${d.startDate.slice(5)} - ${d.endDate.slice(5)}`}, ...p.filter(t=>t.id!==d.id)].slice(0,5); 
                            localStorage.setItem('gtp_recent_trips', JSON.stringify(newRecents)); 
                            return newRecents; 
                        });
                        return;
                    } catch(e) {
                         console.error("Local load error", e);
                    }
                }

                // 2. If not local, check connectivity
                if (isOffline) {