import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithPopup, 
  GoogleAuthProvider, 
  onAuthStateChanged, 
  signInWithCustomToken, 
  signInAnonymously,
  signOut
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  query, 
  where, 
  onSnapshot, 
  doc, 
  updateDoc, 
  setDoc, 
  deleteField, 
  deleteDoc,
  orderBy,
  serverTimestamp,
  getDoc,
  arrayUnion,
  arrayRemove,
  getDocs,
  limit
} from 'firebase/firestore';
import { 
  getStorage, 
  ref, 
  uploadBytes, 
  getDownloadURL 
} from 'firebase/storage';
import { 
  Menu, Plus, Calendar, MapPin, Navigation, 
  Camera, DollarSign, PieChart, Languages, 
  Sun, Train, Car, Bus, Plane,
  Footprints, ChevronLeft, ChevronRight, X,
  LogOut, User, Image as ImageIcon, List,
  Sparkles, Loader2, Share2, Users, Search, Hash, CalendarPlus, Mic, MicOff, UserPlus, Check, Upload, Eye, Trash2, Settings, Wand2, Edit2, AlertTriangle
} from 'lucide-react';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer, Cell
} from 'recharts';

// ============================================================================
// --- 使用者 Firebase 設定區塊 (請填入您的設定) ---
// ============================================================================
const userFirebaseConfig = {
  apiKey: "AIzaSyAKTSFKT3IG7PkReQxURrTDRIasLfquTWo",
  authDomain: "travelplannerapp-276cf.firebaseapp.com",
  projectId: "travelplannerapp-276cf",
  storageBucket: "travelplannerapp-276cf.firebasestorage.app",
  messagingSenderId: "253131618834",
  appId: "1:253131618834:web:54b669bf8fad3a88e276cb",
  measurementId: "G-JWWRP5LX7F"
};

// --- Firebase Initialization ---
let app, auth, db, storage;
let isConfigured = false;

try {
  let configToUse;
  if (typeof __firebase_config !== 'undefined' && __firebase_config) {
    configToUse = JSON.parse(__firebase_config);
  } else if (userFirebaseConfig.apiKey !== "YOUR_API_KEY") {
    configToUse = userFirebaseConfig;
  }

  if (configToUse) {
    app = initializeApp(configToUse);
    auth = getAuth(app);
    db = getFirestore(app);
    storage = getStorage(app);
    isConfigured = true;
  }
} catch (e) {
  console.error("Firebase Init Error:", e);
}

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Gemini API Helper ---
const callGemini = async (prompt, systemInstruction) => {
  const apiKey = ""; 
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    systemInstruction: { parts: [{ text: systemInstruction }] },
    generationConfig: { responseMimeType: "application/json" }
  };

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
    const data = await response.json();
    return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
  } catch (error) {
    console.error("Gemini Call Failed", error);
    return null;
  }
};

// --- Constants ---
const CURRENCIES = [
  { code: 'TWD', label: '台幣 (TWD)' }, { code: 'JPY', label: '日幣 (JPY)' },
  { code: 'USD', label: '美金 (USD)' }, { code: 'VND', label: '越南盾 (VND)' },
  { code: 'CNY', label: '人民幣 (CNY)' }, { code: 'HKD', label: '港幣 (HKD)' },
  { code: 'GBP', label: '英鎊 (GBP)' }, { code: 'EUR', label: '歐元 (EUR)' },
];

const TRANSPORT_OPTIONS = [
  { type: 'walk', label: '步行', icon: <Footprints size={16} /> },
  { type: 'car', label: '自駕', icon: <Car size={16} /> },
  { type: 'bus', label: '公車', icon: <Bus size={16} /> },
  { type: 'train', label: '電車', icon: <Train size={16} /> },
  { type: 'shinkansen', label: '新幹線', icon: <Train size={16} className="text-blue-600" /> },
  { type: 'nightbus', label: '夜間巴士', icon: <Bus size={16} className="text-purple-600" /> },
];

const WEEKDAYS = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];

const getDatesArray = (startDate, endDate) => {
  const dates = [];
  let currentDate = new Date(startDate);
  const stopDate = new Date(endDate);
  while (currentDate <= stopDate) {
    dates.push(new Date(currentDate));
    currentDate.setDate(currentDate.getDate() + 1);
  }
  return dates;
};

const formatDateDisplay = (dateObj) => {
  if (!dateObj) return '';
  const m = dateObj.getMonth() + 1;
  const d = dateObj.getDate();
  const w = WEEKDAYS[dateObj.getDay()];
  return `${m}/${d} (${w})`;
};

const generateShareCode = () => Math.random().toString(36).substring(2, 8).toUpperCase();

const compressImage = (file, callback) => {
  const reader = new FileReader();
  reader.onload = (evt) => {
    const img = new Image();
    img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const maxDim = 800;
        let w = img.width, h = img.height;
        if (w > h && w > maxDim) { h *= maxDim/w; w = maxDim; }
        else if (h > maxDim) { w *= maxDim/h; h = maxDim; }
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        callback(canvas.toDataURL('image/jpeg', 0.6));
    };
    img.src = evt.target.result;
  };
  reader.readAsDataURL(file);
};

// --- Shared Components ---

const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 animate-in zoom-in-95">
        <div className="flex items-center gap-3 text-red-500 mb-3">
           <AlertTriangle size={24} />
           <h3 className="text-lg font-bold text-gray-900">{title}</h3>
        </div>
        <p className="text-gray-600 mb-6 text-sm leading-relaxed">{message}</p>
        <div className="flex gap-3 justify-end">
          <button onClick={onCancel} className="px-4 py-2 rounded-lg text-gray-600 bg-gray-100 hover:bg-gray-200 font-bold">取消</button>
          <button onClick={onConfirm} className="px-4 py-2 rounded-lg bg-red-500 text-white font-bold hover:bg-red-600 shadow-md">確定刪除</button>
        </div>
      </div>
    </div>
  );
};

const ConfigErrorScreen = () => (
  <div className="flex flex-col items-center justify-center h-screen bg-gray-50 p-8 text-center">
    <Settings className="text-red-500 mb-6" size={48} />
    <h1 className="text-2xl font-bold text-gray-800 mb-4">尚未設定 Firebase</h1>
    <p className="text-gray-600 mb-6 max-w-sm">請填寫 <code>userFirebaseConfig</code> 設定。</p>
  </div>
);

const LoginScreen = ({ onLogin }) => (
  <div className="flex flex-col items-center justify-center h-full bg-[#F0FFF4] p-6 no-scrollbar">
    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
      <div className="w-20 h-20 bg-[#0ABAB5]/20 rounded-full flex items-center justify-center mx-auto mb-6">
        <MapPin className="text-[#0ABAB5]" size={40} />
      </div>
      <h1 className="text-2xl font-bold text-gray-800 mb-2">Good Travel Plan</h1>
      <button onClick={onLogin} className="w-full bg-[#0ABAB5] text-white py-3 rounded-xl flex items-center justify-center gap-3 hover:opacity-90 transition shadow-sm mt-8 font-bold">
        開始使用
      </button>
    </div>
  </div>
);

const CreateTrip = ({ onCancel, onCreate }) => {
  const [dest, setDest] = useState('');
  const [start, setStart] = useState('');
  const [end, setEnd] = useState('');
  const [currency, setCurrency] = useState('JPY');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!dest || !start || !end) return;
    onCreate({ destination: dest, startDate: start, endDate: end, mainCurrency: currency });
  };

  return (
    <div className="p-6 bg-teal-100 h-full overflow-y-auto no-scrollbar">
      <div className="flex items-center mb-6">
        <button onClick={onCancel} className="p-2 -ml-2 text-teal-800"><ChevronLeft /></button>
        <h2 className="text-xl font-bold ml-2 text-teal-900">建立新旅程</h2>
      </div>
      <form onSubmit={handleSubmit} className="space-y-5 bg-white/90 p-6 rounded-2xl shadow-sm backdrop-blur-sm">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">目的地</label>
          <input type="text" value={dest} onChange={(e) => setDest(e.target.value)} placeholder="例如：東京、大阪" className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#0ABAB5] outline-none" />
        </div>
        <div className="grid grid-cols-2 gap-4">
          <div>
             <label className="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
             <input type="date" value={start} onChange={e => setStart(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none" />
          </div>
          <div>
             <label className="block text-sm font-medium text-gray-700 mb-1">結束日期</label>
             <input type="date" value={end} onChange={e => setEnd(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none" />
          </div>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">主要匯率</label>
          <select value={currency} onChange={e => setCurrency(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
            {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.label}</option>)}
          </select>
        </div>
        <button type="submit" className="w-full bg-[#0ABAB5] text-white py-4 rounded-xl font-bold text-lg shadow-md hover:opacity-90 transition mt-8">開始規劃</button>
      </form>
    </div>
  );
};

const ShareModal = ({ trip, setIsShareModalOpen }) => {
  const [email, setEmail] = useState('');
  const [loading, setLoading] = useState(false);
  const sharedList = trip.sharedEmails || [];

  const handleInvite = async () => {
    if (!email) return;
    setLoading(true);
    try {
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', trip.id), { sharedEmails: arrayUnion(email) });
      setEmail('');
    } catch (e) { console.error(e); } finally { setLoading(false); }
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
       <div className="bg-white w-full max-w-sm rounded-2xl p-6 relative">
          <button onClick={() => setIsShareModalOpen(false)} className="absolute top-4 right-4"><X size={24} className="text-gray-400" /></button>
          <h3 className="font-bold text-xl text-indigo-600 mb-6 flex items-center gap-2"><Share2 size={24} /> 邀請共用</h3>
          <div className="mb-4 bg-indigo-50 p-3 rounded-xl flex items-center justify-between border border-indigo-100">
             <div><span className="text-[10px] text-gray-500 font-bold">行程隨機碼</span><p className="text-2xl font-mono font-bold text-indigo-700">{trip.shareCode || '------'}</p></div>
             <button onClick={() => navigator.clipboard.writeText(trip.shareCode)} className="text-xs bg-white border border-indigo-200 px-2 py-1 rounded text-indigo-600">複製</button>
          </div>
          <div className="flex gap-2 mb-4"><input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="friend@gmail.com" className="flex-1 p-2 border rounded-lg outline-none" /><button onClick={handleInvite} disabled={loading} className="bg-indigo-600 text-white px-4 rounded-lg font-bold">邀請</button></div>
          <div className="mb-2 text-xs font-bold text-gray-500">目前共用名單</div>
          <div className="bg-gray-50 rounded-xl p-3 max-h-40 overflow-y-auto space-y-2">
             {sharedList.map((e, i) => (<div key={i} className="flex items-center gap-2 text-sm text-gray-700"><div className="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-xs"><User size={12} /></div>{e}</div>))}
          </div>
       </div>
    </div>
  );
};

const TopBar = ({ trip, onBack, viewMode, setViewMode, dates, activeDayIndex, setActiveDayIndex, setIsShareModalOpen, onAddDay }) => {
  const [weather, setWeather] = useState(null);

  useEffect(() => {
    const fetchWeather = async () => {
      if (!trip.destination) return;
      const coords = await callGemini(`Return lat/lng for "${trip.destination}" as JSON keys "lat", "lng".`, "JSON only.");
      if (coords?.lat) {
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lng}&current_weather=true`);
        const data = await res.json();
        if (data.current_weather) setWeather(data.current_weather.temperature);
      }
    };
    fetchWeather();
  }, [trip.destination]);

  return (
    <div className="bg-[#0ABAB5] shadow-md sticky top-0 z-20 transition-colors duration-300">
      <div className="flex justify-between items-center p-4 text-white">
        <div className="flex items-center gap-3 overflow-hidden">
          <button onClick={onBack}><Menu size={24} /></button>
          <div className="flex flex-col">
            <div className="flex items-center gap-2">
               <h1 className="font-bold text-lg truncate max-w-[150px]">{trip.destination}</h1>
               {weather && <div className="flex items-center gap-1 bg-white/20 px-2 py-0.5 rounded-full text-xs font-bold"><Sun size={12} className="text-yellow-300" />{weather}°C</div>}
            </div>
            <span className="text-xs opacity-80">{trip.startDate} ~ {trip.endDate}</span>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <button onClick={() => setIsShareModalOpen(true)} className="p-2 rounded-full bg-white/20 text-white hover:bg-white/30"><Share2 size={18} /></button>
          <button onClick={() => setViewMode('plan')} className={`p-2 rounded-full ${viewMode === 'plan' ? 'bg-white text-[#0ABAB5]' : 'bg-white/20 text-white'}`}><List size={18} /></button>
          <button onClick={() => setViewMode('stats')} className={`p-2 rounded-full ${viewMode === 'stats' ? 'bg-white text-[#0ABAB5]' : 'bg-white/20 text-white'}`}><PieChart size={18} /></button>
        </div>
      </div>
      {viewMode === 'plan' && (
        <div className="flex overflow-x-auto pb-3 px-4 gap-3 no-scrollbar">
          {dates.map((d, idx) => (
            <button key={idx} onClick={() => setActiveDayIndex(idx)} className={`flex-shrink-0 flex flex-col items-center justify-center min-w-[42px] h-[50px] rounded-xl transition-all ${idx === activeDayIndex ? 'bg-white text-[#0ABAB5] shadow-lg scale-105' : 'bg-white/20 text-white border border-white/10'}`}>
              <span className="text-[10px] font-bold opacity-80">D{idx + 1}</span>
              <span className="text-xs font-medium">{d.getDate()}</span>
              <span className="text-[10px] opacity-80">{WEEKDAYS[d.getDay()].replace('週','')}</span>
            </button>
          ))}
          <button onClick={onAddDay} className="flex-shrink-0 flex flex-col items-center justify-center min-w-[42px] h-[50px] rounded-xl bg-white/10 text-white/80 border border-white/10"><CalendarPlus size={16} /></button>
        </div>
      )}
    </div>
  );
};

const FlightInput = ({ trip, dateStr }) => {
  const [data, setData] = useState({ depTime: '', depLoc: '', flightCode: '', arrTime: '', arrLoc: '' });
  
  useEffect(() => {
    if (!trip || !dateStr) return;
    const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_flights`, dateStr), (snap) => {
      if (snap.exists()) {
         const d = snap.data();
         setData(typeof d.info === 'string' ? { ...data, flightCode: d.info } : { depTime: d.depTime||'', depLoc: d.depLoc||'', flightCode: d.flightCode||'', arrTime: d.arrTime||'', arrLoc: d.arrLoc||'' });
      }
    });
    return () => unsub();
  }, [trip, dateStr]);

  const update = async (field, val) => {
    setData(prev => ({ ...prev, [field]: val })); 
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_flights`, dateStr), { [field]: val }, { merge: true });
  };

  return (
    <div className="mx-4 mt-4 p-4 bg-sky-50 rounded-xl border border-sky-100 shadow-sm">
       <div className="flex items-center gap-2 text-sky-600 mb-3"><Plane size={16} /><span className="text-sm font-bold">航班資訊</span></div>
       <div className="flex justify-between items-start bg-white p-3 rounded-xl border border-sky-100 shadow-sm">
          <div className="flex flex-col w-[30%]">
             <input type="text" placeholder="14:30" className="text-xl font-bold text-gray-800 bg-transparent outline-none p-0 w-full text-center border-b border-gray-200 focus:border-sky-400" value={data.depTime} onChange={e => update('depTime', e.target.value)} />
             <input type="text" placeholder="起飛地" className="text-[10px] text-gray-500 bg-transparent outline-none mt-1 w-full text-center" value={data.depLoc} onChange={e => update('depLoc', e.target.value)} />
          </div>
          <div className="flex flex-col w-[40%] items-center px-1">
             <div className="text-sky-300 text-xs mb-0.5">✈</div>
             <input type="text" placeholder="航班" className="text-base font-bold text-sky-600 text-center bg-transparent outline-none w-full uppercase" value={data.flightCode} onChange={e => update('flightCode', e.target.value.toUpperCase())} />
             <div className="h-[1px] w-full bg-sky-200 mt-1"></div>
          </div>
          <div className="flex flex-col w-[30%]">
             <input type="text" placeholder="18:00" className="text-xl font-bold text-gray-800 bg-transparent outline-none p-0 w-full text-center border-b border-gray-200 focus:border-sky-400" value={data.arrTime} onChange={e => update('arrTime', e.target.value)} />
             <input type="text" placeholder="抵達地" className="text-[10px] text-gray-500 bg-transparent outline-none mt-1 w-full text-center" value={data.arrLoc} onChange={e => update('arrLoc', e.target.value)} />
          </div>
       </div>
    </div>
  );
};

const HotelInput = ({ trip, dateStr, setConfirmData }) => {
  const [info, setInfo] = useState({ code: '', photo: null });
  const [isViewing, setIsViewing] = useState(false);
  const [isUploading, setIsUploading] = useState(false);

  useEffect(() => {
    if (!trip || !dateStr) return;
    const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_hotels`, dateStr), s => s.exists() ? setInfo(s.data()) : setInfo({code:'', photo:null}));
    return () => unsub();
  }, [trip, dateStr]);

  const handleDelete = (e) => {
    e.preventDefault(); e.stopPropagation();
    setConfirmData({
      isOpen: true, title: "刪除照片", message: "確定要刪除這張照片嗎？",
      onConfirm: async () => {
         await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_hotels`, dateStr), { photo: null });
         setInfo(prev => ({ ...prev, photo: null }));
         setConfirmData(p => ({...p, isOpen: false}));
      }
    });
  };

  const handleFile = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    setIsUploading(true);
    try {
      const sRef = ref(storage, `trips/${trip.id}/hotels/${dateStr}_${file.name}`);
      await uploadBytes(sRef, file);
      const url = await getDownloadURL(sRef);
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_hotels`, dateStr), { photo: url }, { merge: true });
    } catch (err) {
      console.warn("Storage fallback");
      compressImage(file, async (url) => {
         await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_hotels`, dateStr), { photo: url }, { merge: true });
      });
    } finally { setIsUploading(false); }
  };

  return (
    <>
      <div className="mx-4 mt-4 p-4 bg-white rounded-xl border border-gray-100 shadow-sm flex flex-col gap-2">
         <div className="flex justify-between items-center mb-1">
            <div className="flex items-center gap-2 text-[#0ABAB5]"><MapPin size={16} /><span className="text-sm font-bold">今日住宿</span></div>
            <div className="flex gap-2">
               {isUploading && <Loader2 size={16} className="animate-spin" />}
               {info.photo && !isUploading && (
                 <>
                   <button type="button" onClick={() => setIsViewing(true)} className="p-1.5 bg-teal-50 text-teal-600 rounded-full"><Eye size={16} /></button>
                   <button type="button" onClick={handleDelete} className="p-1.5 bg-red-50 text-red-600 rounded-full"><Trash2 size={16} /></button>
                 </>
               )}
               <label className="p-1.5 bg-gray-50 text-gray-500 rounded-full cursor-pointer"><Upload size={16} /><input type="file" accept="image/*" className="hidden" onChange={handleFile} /></label>
            </div>
         </div>
         <input type="text" placeholder="輸入訂房代碼 / 飯店名稱" className="w-full text-sm p-2 bg-gray-50 rounded-lg outline-none" value={info.code || ''} onChange={e => setDoc(doc(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_hotels`, dateStr), { code: e.target.value }, { merge: true })} />
         {info.photo && (
            <div className="relative group w-full h-48 mt-2 rounded-lg overflow-hidden bg-gray-100 cursor-pointer">
               <img src={info.photo} className="w-full h-full object-cover" onClick={() => setIsViewing(true)} />
            </div>
         )}
      </div>
      {isViewing && info.photo && <div className="fixed inset-0 z-[90] bg-black/90 flex items-center justify-center p-4" onClick={() => setIsViewing(false)}><img src={info.photo} className="max-w-full max-h-[80vh] rounded-lg" /></div>}
    </>
  )
};

const ActivityList = ({ dailyActivities, onDelete, onEdit, onOpenPhoto }) => (
  <div className="p-4 space-y-6 pb-24">
    {dailyActivities.map((act) => (
      <div key={act.id} className="relative pl-6 border-l-2 border-[#0ABAB5]/30 last:border-0">
        <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-[#0ABAB5] border-2 border-white shadow-sm"></div>
        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-2 relative">
          <div className="flex justify-between items-start mb-2">
            <span className="bg-teal-50 text-teal-700 px-2 py-0.5 rounded text-xs font-mono font-bold">{act.time}</span>
            <div className="flex items-center gap-2">
               <span className="text-xs text-gray-400">{act.stayTime} 分鐘</span>
            </div>
          </div>
          <h3 className="font-bold text-gray-800 text-lg mb-1 pr-4">{act.title}</h3>
          {act.note && <p className="text-gray-500 text-sm mb-3">{act.note}</p>}
          {act.photo && (
             <div className="mb-3 w-16 h-16 rounded-lg overflow-hidden bg-gray-100 cursor-pointer" onClick={() => onOpenPhoto(act.photo)}>
                <img src={act.photo} className="w-full h-full object-cover" />
             </div>
          )}
          <div className="flex items-center justify-between mt-3 pt-3 border-t border-gray-50">
            <div className="flex items-center gap-2 text-gray-600 text-sm bg-gray-50 px-3 py-1.5 rounded-full">
              {TRANSPORT_OPTIONS.find(t => t.type === act.transport)?.icon}
              <span>{TRANSPORT_OPTIONS.find(t => t.type === act.transport)?.label}</span>
            </div>
            <div className="flex items-center gap-3">
                <a href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(act.title)}`} target="_blank" rel="noreferrer" className="flex items-center gap-1 text-blue-500 text-xs font-bold border border-blue-100 px-3 py-1.5 rounded-full"><Navigation size={12} /> 導航</a>
                <button type="button" onClick={(e) => { e.stopPropagation(); onEdit(act); }} className="p-2 text-gray-400 hover:text-blue-500 bg-gray-50 rounded-full"><Edit2 size={16} /></button>
                <button type="button" onClick={(e) => { e.stopPropagation(); onDelete(act.id); }} className="p-2 text-gray-400 hover:text-red-500 bg-gray-50 rounded-full"><Trash2 size={16} /></button>
            </div>
          </div>
        </div>
      </div>
    ))}
  </div>
);

// ... ActivityModal, AIPlannerModal, ExpenseModal, StatisticsView ...
// (Keeping these defined but compact for readability, logic same as before)

const ActivityModal = ({ currentDayDate, setIsAddingItem, handleAddActivity, initialData, trip }) => {
  const [form, setForm] = useState({ title: initialData?.title||'', time: initialData?.time||'09:00', transport: initialData?.transport||'walk', note: initialData?.note||'', stay: initialData?.stayTime||60, photo: initialData?.photo||null });
  const [isUploading, setIsUploading] = useState(false);

  const handlePhoto = async (e) => {
    const f = e.target.files[0]; if(!f) return; setIsUploading(true);
    try { const r = ref(storage, `trips/${trip.id}/activities/${Date.now()}_${f.name}`); await uploadBytes(r, f); const u = await getDownloadURL(r); setForm(p=>({...p, photo:u})); } 
    catch { compressImage(f, u => setForm(p=>({...p, photo:u}))); } finally { setIsUploading(false); }
  };

  const onSubmit = () => {
     const data = { title: form.title, time: form.time, transport: form.transport, note: form.note, stayTime: form.stay };
     if (form.photo) data.photo = form.photo;
     else if (initialData?.id) data.photo = deleteField(); // Explicit delete
     handleAddActivity(data, initialData?.id);
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-end justify-center">
      <div className="bg-white w-full max-w-md p-6 rounded-t-2xl h-[85vh] overflow-y-auto">
        <div className="flex justify-between mb-6"><h3 className="font-bold text-lg">{initialData ? '編輯' : '新增'} ({formatDateDisplay(currentDayDate)})</h3><button onClick={()=>setIsAddingItem(false)}><X /></button></div>
        <div className="space-y-5">
           <div><label className="text-xs font-bold text-gray-500">時間</label><input type="time" value={form.time} onChange={e=>setForm({...form, time:e.target.value})} className="w-full p-3 border rounded-xl" /></div>
           <div><label className="text-xs font-bold text-gray-500">名稱</label><input value={form.title} onChange={e=>setForm({...form, title:e.target.value})} className="w-full p-3 border rounded-xl" /></div>
           <div className="flex gap-2 overflow-x-auto pb-2">{TRANSPORT_OPTIONS.map(t=><button key={t.type} onClick={()=>setForm({...form, transport:t.type})} className={`p-2 border rounded-xl min-w-[60px] flex-col flex items-center ${form.transport===t.type?'bg-teal-50 border-teal-500 text-teal-600':'text-gray-500'}`}>{t.icon}<span className="text-xs">{t.label}</span></button>)}</div>
           <div className="flex items-center gap-2">{form.photo && <img src={form.photo} className="w-12 h-12 rounded" />}<label className="p-2 border rounded cursor-pointer text-sm flex gap-1 items-center">{isUploading?<Loader2 className="animate-spin"/>:<Camera/>} 上傳<input type="file" hidden onChange={handlePhoto}/></label>{form.photo && <button onClick={()=>setForm({...form, photo:null})}><Trash2 className="text-red-500"/></button>}</div>
           <div><label className="text-xs font-bold text-gray-500">備註</label><textarea value={form.note} onChange={e=>setForm({...form, note:e.target.value})} className="w-full p-3 border rounded-xl h-24"/></div>
           <button onClick={onSubmit} className="w-full bg-[#0ABAB5] text-white py-3 rounded-xl font-bold">{initialData?'更新':'新增'}</button>
        </div>
      </div>
    </div>
  )
};

const AIPlannerModal = ({ trip, activeDayIndex, handleAddActivity, setIsAIPlannerOpen }) => {
  const [step, setStep] = useState('input'); 
  const [prompt, setPrompt] = useState('');
  const [res, setRes] = useState([]);
  const [loading, setLoading] = useState(false);

  const gen = async (manual) => {
    setLoading(true); setStep('loading');
    const r = await callGemini(`Suggest 3 activities for ${trip.destination}. Context: ${manual||prompt}. JSON array: {time, title, note, transport, stayTime}.`, "Travel Guide JSON");
    if(r && Array.isArray(r)) { setRes(r); setStep('results'); }
    setLoading(false);
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white w-full max-w-md rounded-2xl p-6">
         <div className="flex justify-between mb-4"><h3 className="font-bold flex gap-2 text-[#0ABAB5]"><Sparkles /> AI 推薦</h3><button onClick={()=>setIsAIPlannerOpen(false)}><X /></button></div>
         {step === 'input' && (
           <div className="space-y-4">
             <textarea className="w-full p-3 bg-gray-50 rounded-xl h-32 border outline-none focus:border-[#0ABAB5]" placeholder="例如：想找親子景點..." value={prompt} onChange={e=>setPrompt(e.target.value)} />
             <button onClick={() => gen()} className="w-full bg-[#0ABAB5] text-white py-3 rounded-xl font-bold">生成推薦</button>
             <button onClick={() => gen("給我不容錯過的經典必去景點，自動安排最佳路線。")} className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-bold flex justify-center gap-2"><Wand2 size={18}/> 智慧自動生成 (Surprise Me)</button>
           </div>
         )}
         {step === 'loading' && <div className="py-10 text-center"><Loader2 className="animate-spin mx-auto mb-2"/>規劃中...</div>}
         {step === 'results' && (
           <div className="space-y-3">
             {res.map((s,i) => <div key={i} className="border p-3 rounded-xl bg-gray-50"><div className="font-bold">{s.time} {s.title}</div><div className="text-xs text-gray-500">{s.note}</div></div>)}
             <button onClick={() => { res.forEach(s => handleAddActivity(s)); setIsAIPlannerOpen(false); }} className="w-full bg-[#0ABAB5] text-white py-3 rounded-xl font-bold mt-2">全部加入</button>
           </div>
         )}
      </div>
    </div>
  )
};

const ExpenseModal = ({ trip, user, dateStr, setIsAddingExpense, handleAddExpense }) => {
  // ... (Same logic as before for Expense Modal, keeping it concise for this block)
  const [form, setForm] = useState({ amt:'', item:'', cat:'飲食', ai:'', curr: trip.mainCurrency, payer: user.displayName||'我' });
  const [loading, setLoading] = useState(false);
  const [url, setUrl] = useState(null);
  const [mode, setMode] = useState(null); // manage mode
  const [newIt, setNewIt] = useState('');
  
  const payers = useMemo(() => Array.from(new Set([user.displayName||'我', ...(trip.sharedEmails||[]), ...(trip.customMembers||[])])), [trip, user]);
  const cats = trip.customCategories || ['飲食', '交通', '住宿', '購物', '門票'];

  const aiParse = async () => {
    setLoading(true);
    const r = await callGemini(`Parse: "${form.ai}". JSON keys: amount(num), currency(str), item(str), category(str from [${cats}]).`, "Parser");
    setLoading(false);
    if(r) setForm(p=>({...p, amt:r.amount, item:r.item, cat:r.category, curr:r.currency}));
  };

  const upload = async (e) => {
    const f = e.target.files[0]; if(!f) return; setLoading(true);
    try { const r = ref(storage, `trips/${trip.id}/expenses/${Date.now()}_${f.name}`); await uploadBytes(r, f); const u = await getDownloadURL(r); setUrl(u); }
    catch { compressImage(f, u => setUrl(u)); } finally { setLoading(false); }
  };

  const addMeta = async () => {
    if(!newIt.trim()) return;
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', trip.id), { [mode==='payer'?'customMembers':'customCategories']: arrayUnion(newIt.trim()) });
    setNewIt('');
  };

  const delMeta = async (val) => {
    if(confirm(`Del ${val}?`)) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', trip.id), { [mode==='payer'?'customMembers':'customCategories']: arrayRemove(val) });
  };

  if(mode) return (
    <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4"><div className="bg-white w-full max-w-sm rounded-2xl p-6">
      <div className="flex justify-between mb-4"><h3 className="font-bold">管理{mode==='payer'?'付款人':'分類'}</h3><button onClick={()=>setMode(null)}><X/></button></div>
      <div className="flex gap-2 mb-4"><input className="border p-2 rounded flex-1" value={newIt} onChange={e=>setNewIt(e.target.value)}/><button onClick={addMeta}><Plus/></button></div>
      <div className="max-h-60 overflow-y-auto space-y-2">{(mode==='payer'?payers:cats).map((x,i)=><div key={i} className="flex justify-between p-2 bg-gray-50 rounded"><span>{x}</span><button onClick={()=>delMeta(x)} className="text-red-500"><Trash2/></button></div>)}</div>
    </div></div>
  );

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-end justify-center"><div className="bg-white w-full max-w-md p-6 rounded-t-2xl h-[85vh] overflow-y-auto">
       <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">記帳</h3><button onClick={()=>setIsAddingExpense(false)}><X/></button></div>
       <div className="bg-indigo-50 p-3 rounded-xl mb-4"><div className="flex gap-2"><input className="flex-1 p-2 rounded" value={form.ai} onChange={e=>setForm({...form, ai:e.target.value})} placeholder="AI 速記..." /><button onClick={aiParse} disabled={loading}><Sparkles/></button></div></div>
       <div className="space-y-4">
          <div className="flex gap-4"><div className="flex-1"><div className="flex justify-between"><label className="text-xs">付款人</label><button onClick={()=>setMode('payer')} className="text-[10px] text-blue-500">管理</button></div><select value={form.payer} onChange={e=>setForm({...form, payer:e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">{payers.map(p=><option key={p} value={p}>{p}</option>)}</select></div><div className="w-1/3"><label className="text-xs">幣別</label><select value={form.curr} onChange={e=>setForm({...form, curr:e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">{CURRENCIES.map(c=><option key={c.code} value={c.code}>{c.code}</option>)}</select></div></div>
          <input type="number" value={form.amt} onChange={e=>setForm({...form, amt:e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl text-2xl font-bold" placeholder="0" />
          <input value={form.item} onChange={e=>setForm({...form, item:e.target.value})} className="w-full p-3 border rounded-xl" placeholder="品項" />
          <div><div className="flex justify-between"><label className="text-xs">分類</label><button onClick={()=>setMode('category')} className="text-[10px] text-blue-500">管理</button></div><div className="flex flex-wrap gap-2">{cats.map(c=><button key={c} onClick={()=>setForm({...form, cat:c})} className={`px-3 py-1.5 rounded-full text-sm border ${form.cat===c?'bg-teal-500 text-white':'bg-white'}`}>{c}</button>)}</div></div>
          <div className="border-2 dashed p-4 flex justify-center">{loading?<Loader2 className="animate-spin"/>:url?<img src={url} className="h-24"/>:<label><Camera/><input type="file" hidden onChange={upload}/></label>}</div>
          <button onClick={()=>handleAddExpense({amount:Number(form.amt), item:form.item, category:form.cat, currency:form.curr, payer:form.payer, receiptUrl:url})} className="w-full bg-teal-500 text-white py-4 rounded-xl font-bold">儲存</button>
       </div>
    </div></div>
  )
};

// Itinerary View
const ItineraryView = ({ trip, user, onBack }) => {
  const [activeDayIndex, setActiveDayIndex] = useState(0);
  const [viewMode, setViewMode] = useState('plan');
  const [activities, setActivities] = useState([]);
  const [expenses, setExpenses] = useState([]);
  const [isAddingItem, setIsAddingItem] = useState(false);
  const [isAddingExpense, setIsAddingExpense] = useState(false);
  const [isAIPlannerOpen, setIsAIPlannerOpen] = useState(false);
  const [isShareModalOpen, setIsShareModalOpen] = useState(false);
  
  const [editingActivity, setEditingActivity] = useState(null);
  const [viewingPhotoUrl, setViewingPhotoUrl] = useState(null);
  
  const [confirmData, setConfirmData] = useState({ isOpen: false, title: '', message: '', onConfirm: null });
  
  const dates = useMemo(() => getDatesArray(trip.startDate, trip.endDate), [trip]);
  const currentDayDate = dates[activeDayIndex];
  const dateStr = currentDayDate ? currentDayDate.toISOString().split('T')[0] : '';
  const isFlightDay = activeDayIndex === 0 || activeDayIndex === dates.length - 1;
  
  useEffect(() => {
    if (!trip.id) return;
    const unsubAct = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_activities`), orderBy('time')), s => setActivities(s.docs.map(d => ({id:d.id, ...d.data()}))));
    const unsubExp = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_expenses`), orderBy('createdAt', 'desc')), s => setExpenses(s.docs.map(d => ({id:d.id, ...d.data()}))));
    return () => { unsubAct(); unsubExp(); };
  }, [trip.id]);

  const dailyActivities = activities.filter(a => a.date === dateStr);

  const handleAddActivity = async (data, id) => {
    if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_activities`, id), data);
    else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_activities`), { ...data, date: dateStr, tripId: trip.id, createdBy: user.uid });
    setIsAddingItem(false); setEditingActivity(null);
  };

  const handleDeleteActivity = (id) => {
      setConfirmData({
         isOpen: true, title: "刪除行程", message: "確定要刪除此行程嗎？",
         onConfirm: async () => {
             try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `trip_${trip.id}_activities`, id)); setConfirmData(p=>({...p, isOpen:false})); } 
             catch(err) { alert("Error: " + err.message); }
         }
      });
  }

  const handleDeleteTrip = (tripId) => {
     setConfirmData({ isOpen: true, title: "刪除旅程", message: "確定要刪除此旅程嗎？", onConfirm: async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId)); setConfirmData(p=>({...p, isOpen:false})); onBack(); }});
  };

  return (
    <div className="bg-[#F0FFF4] h-full overflow-y-auto no-scrollbar">
      <TopBar trip={trip} onBack={onBack} viewMode={viewMode} setViewMode={setViewMode} dates={dates} activeDayIndex={activeDayIndex} setActiveDayIndex={setActiveDayIndex} setIsShareModalOpen={setIsShareModalOpen} onAddDay={async () => { const d = new Date(trip.endDate); d.setDate(d.getDate()+1); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', trip.id), { endDate: d.toISOString().split('T')[0] }); }} />
      {viewMode === 'plan' && (
        <>
          {isFlightDay && <FlightInput trip={trip} dateStr={dateStr} />}
          <HotelInput trip={trip} dateStr={dateStr} setConfirmData={setConfirmData} />
          
          {/* Top Action Buttons */}
          <div className="px-4 mt-4 grid grid-cols-2 gap-3">
            <button onClick={() => { setEditingActivity(null); setIsAddingItem(true); }} className="py-4 rounded-xl bg-[#E0F2F1] text-[#00695C] font-bold shadow-sm flex items-center justify-center gap-2"><Plus size={20} /> <span>新增行程</span></button>
            <button onClick={() => setIsAddingExpense(true)} className="py-4 rounded-xl bg-[#FFF3E0] text-[#E65100] font-bold shadow-sm flex items-center justify-center gap-2"><DollarSign size={20} /> <span>新增記帳</span></button>
          </div>

          <ActivityList dailyActivities={dailyActivities} setIsAddingItem={setIsAddingItem} setIsAIPlannerOpen={setIsAIPlannerOpen} onEditItem={(act) => { setEditingActivity(act); setIsAddingItem(true); }} onDeleteItem={handleDeleteActivity} onOpenPhoto={(url) => setViewingPhotoUrl(url)} />
          <div className="pb-24 px-4 text-center"><button onClick={() => handleDeleteTrip(trip.id)} className="text-red-400 text-xs flex items-center justify-center gap-1 mx-auto mt-8 opacity-60 hover:opacity-100"><Trash2 size={12} /> 刪除此旅程</button></div>
        </>
      )}
      {viewMode === 'stats' && <StatisticsView trip={trip} expenses={expenses} />}
      {isAddingItem && <ActivityModal currentDayDate={currentDayDate} setIsAddingItem={setIsAddingItem} handleAddActivity={handleAddActivity} initialData={editingActivity} trip={trip} />}
      {isAddingExpense && <ExpenseModal trip={trip} user={user} dateStr={dateStr} setIsAddingExpense={setIsAddingExpense} handleAddExpense={handleAddExpense} />}
      {isAIPlannerOpen && <AIPlannerModal trip={trip} activeDayIndex={activeDayIndex} handleAddActivity={handleAddActivity} setIsAIPlannerOpen={setIsAIPlannerOpen} />}
      {isShareModalOpen && <ShareModal trip={trip} setIsShareModalOpen={setIsShareModalOpen} />}
      <ConfirmDialog isOpen={confirmData.isOpen} title={confirmData.title} message={confirmData.message} onConfirm={confirmData.onConfirm} onCancel={() => setConfirmData(prev => ({ ...prev, isOpen: false }))} />
      {viewingPhotoUrl && <div className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4" onClick={() => setViewingPhotoUrl(null)}><img src={viewingPhotoUrl} className="max-w-full max-h-screen rounded" /></div>}
    </div>
  );
};

// ... Sidebar, TravelApp (Main) ...
const Sidebar = ({ isOpen, onClose, trips, onSelectTrip, onCreateNew, onImport }) => {
  const [importCode, setImportCode] = useState('');
  const handleDelete = async (e, id) => { e.stopPropagation(); if(confirm("刪除？")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', id)); };
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex">
      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
      <div className="relative w-3/4 max-w-xs bg-white h-full shadow-2xl p-6 flex flex-col no-scrollbar">
        <h2 className="text-2xl font-bold text-[#0ABAB5] mb-6">My Trips</h2>
        <button onClick={() => { onCreateNew(); onClose(); }} className="flex items-center gap-3 w-full p-4 bg-teal-50 text-teal-700 rounded-xl mb-4 font-bold"><Plus /> 建立新旅程</button>
        <div className="mb-4 flex gap-2"><input className="w-full p-2 border rounded" placeholder="輸入代碼" value={importCode} onChange={e=>setImportCode(e.target.value)} /><button onClick={() => onImport(importCode)} className="bg-[#0ABAB5] text-white p-2 rounded"><Search size={16}/></button></div>
        <div className="flex-1 overflow-y-auto space-y-3">
          {trips.map(t => (
            <div key={t.id} onClick={() => { onSelectTrip(t); onClose(); }} className="w-full text-left p-4 border rounded-xl relative cursor-pointer hover:bg-gray-50 group">
               <div className="font-bold">{t.destination}</div>
               <div className="text-xs text-gray-400">{t.startDate}</div>
               <div className="absolute bottom-2 right-2 bg-gray-100 text-[10px] px-1 rounded text-gray-500 flex gap-1"><Hash size={10}/> {t.shareCode}</div>
               <button onClick={(e) => handleDelete(e, t.id)} className="absolute top-2 right-2 text-gray-300 hover:text-red-500"><Trash2 size={16} /></button>
            </div>
          ))}
        </div>
        <button onClick={() => signOut(auth)} className="mt-4 text-gray-500 flex gap-2"><LogOut /> 登出</button>
      </div>
    </div>
  );
};

export default function TravelApp() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('login');
  const [trips, setTrips] = useState([]);
  const [currentTrip, setCurrentTrip] = useState(null);
  const [isSidebarOpen, setSidebarOpen] = useState(false);

  useEffect(() => {
    const init = async () => { if(typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token); };
    init();
    return onAuthStateChanged(auth, u => { setUser(u); if(u && view === 'login') setView('home'); });
  }, []);

  useEffect(() => {
    if (!user) return;
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'trips'), orderBy('createdAt', 'desc'));
    return onSnapshot(q, (snap) => {
       const list = snap.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.createdBy === user.uid || t.users?.includes(user.uid));
       setTrips(list);
    });
  }, [user]);

  const handleCreate = async (data) => {
    const shareCode = generateShareCode();
    const ref = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'trips'), { ...data, createdBy: user.uid, users: [user.uid], shareCode, createdAt: serverTimestamp() });
    setCurrentTrip({ id: ref.id, ...data, shareCode });
    setView('trip');
  };

  const handleImport = async (code) => {
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'trips'), where('shareCode', '==', code));
    const snap = await getDocs(q);
    if (!snap.empty) {
       await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', snap.docs[0].id), { users: arrayUnion(user.uid) });
       setCurrentTrip({ id: snap.docs[0].id, ...snap.docs[0].data() });
       setView('trip');
    }
  };

  if (!isConfigured) return <ConfigErrorScreen />;
  if (view === 'login') return <LoginScreen onLogin={async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch { await signInAnonymously(auth); } }} />;

  return (
    <div className="max-w-md mx-auto bg-white h-screen shadow-2xl relative overflow-hidden flex flex-col font-sans">
      <style>{`.no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }`}</style>
      <Sidebar isOpen={isSidebarOpen} onClose={() => setSidebarOpen(false)} trips={trips} onSelectTrip={t => {setCurrentTrip(t); setView('trip');}} onCreateNew={() => setView('create')} onImport={handleImport} />
      
      <div className="flex-1 overflow-y-auto relative no-scrollbar bg-[#F0FFF4]">
         {view === 'create' && <CreateTrip onCancel={() => setView('home')} onCreate={handleCreate} />}
         {view === 'home' && (
            <div className="p-6 flex flex-col min-h-full">
               <div className="flex justify-between mb-8"><button onClick={() => setSidebarOpen(true)} className="p-2 bg-white rounded-full shadow"><Menu /></button></div>
               <div className="text-center my-10"><h2 className="text-3xl font-bold text-[#0ABAB5]">準備出發？</h2></div>
               <div className="space-y-4 flex-1">
                  {trips.map(t => (
                    <button key={t.id} onClick={() => { setCurrentTrip(t); setView('trip'); }} className="w-full bg-white p-5 rounded-2xl shadow-sm text-left">
                       <h3 className="font-bold text-xl">{t.destination}</h3>
                       <div className="text-xs text-gray-500">{t.startDate}</div>
                    </button>
                  ))}
                  <button onClick={() => setView('create')} className="w-full bg-[#0ABAB5] text-white py-4 rounded-xl font-bold shadow-lg mt-4"><Plus className="mx-auto" /></button>
               </div>
            </div>
         )}
         {view === 'trip' && currentTrip && <ItineraryView trip={currentTrip} user={user} onBack={() => setSidebarOpen(true)} />}
      </div>
    </div>
  );
}