<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- [MODIFIED] ä¿®æ”¹ viewport è¨­å®šï¼šç§»é™¤ user-scalable=noï¼Œä¸¦å…è¨±æœ€å¤§æ”¾å¤§åˆ° 5 å€ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Travel Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
    <style>
        * { -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .animate-slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f9f9f9; 
            color: #4b5563; 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden; 
        }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* CSS Hack to hide AM/PM text in WebKit browsers */
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            display: none;
        }
        /* Disable input interaction when readOnly */
        input:read-only, select:disabled, textarea:readOnly {
            pointer-events: none;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp, getApps, deleteApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        // [MODIFIED] Import enableIndexedDbPersistence
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { Calendar, MapPin, Clock, Train, Bus, Car, Footprints, Plane, TramFront, Plus, Trash2, Map, ArrowRight, Image, Loader, X, DollarSign, Navigation, PieChart, Menu, History, LogOut, Check, CloudSun, Timer, BarChart3, BedDouble, Phone, LogOut as CheckOutIcon, Settings, Camera, ChevronDown, LogIn, LogOut as LogOutIcon, Pencil, Users, Edit3, CloudCog, Shield, Save, UserX, Copy, Wifi, WifiOff, Database, ArrowRightCircle, Info, Download, ExternalLink } from 'lucide-react';

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-travel-planner';

        // --- Constants ---
        const currencies = [
            { value: 'JPY', label: 'æ—¥åœ“ (JPY)' },
            { value: 'TWD', label: 'æ–°å°å¹£ (TWD)' }
        ];

        const transportOptions = [
            { value: 'walk', label: 'æ­¥è¡Œ', icon: Footprints }, { value: 'car', label: 'è‡ªé§•', icon: Car },
            { value: 'taxi', label: 'è¨ˆç¨‹è»Š', icon: Car }, { value: 'bus', label: 'å…¬è»Š', icon: Bus },
            { value: 'train', label: 'é›»è»Š', icon: Train }, { value: 'shinkansen', label: 'æ–°å¹¹ç·š', icon: Train },
            { value: 'nightbus', label: 'å¤œé–“å·´å£«', icon: Bus }, { value: 'tram', label: 'è·¯é¢é›»è»Š', icon: TramFront },
            { value: 'plane', label: 'é£›æ©Ÿ', icon: Plane },
        ];

        const durationOptions = Array.from({ length: 20 }, (_, i) => {
            const m = (i + 1) * 15, h = Math.floor(m / 60), min = m % 60;
            return { value: String(m), label: h === 0 ? `${min} åˆ†é˜` : min === 0 ? `${h} å°æ™‚` : `${h} å°æ™‚ ${min} åˆ†` };
        });

        const CATEGORY_COLORS = { 'é¤é£²': '#FF6384', 'äº¤é€š': '#36A2EB', 'ä½å®¿': '#FFCE56', 'è³¼ç‰©': '#4BC0C0', 'å¨›æ¨‚': '#9966FF', 'é–€ç¥¨': '#FF9F40', 'è—¥å¦': '#FF6B6B', 'å…¶ä»–': '#C9CBCF' };
        const PALETTE = Object.values(CATEGORY_COLORS);
        const TIME_OPTIONS = [];
        for(let i=0; i<24; i++) {
            const h = String(i).padStart(2, '0');
            TIME_OPTIONS.push(`${h}:00`);
            TIME_OPTIONS.push(`${h}:30`);
        }

        // --- Helper Functions ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        
        const getOrCreateUserId = () => {
            let uid = localStorage.getItem('gtp_local_uid');
            if (!uid) {
                uid = generateId();
                localStorage.setItem('gtp_local_uid', uid);
            }
            return uid;
        };

        const resizeImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height, max = 1024;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    // è¨­å®šå£“ç¸®æ¯”ä¾‹ç‚º 0.8 (80%)
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
        
        const sanitizeFirestoreData = (data) => JSON.parse(JSON.stringify(data, (k, v) => v === undefined ? null : v));
        const getDatesArray = (s, e) => { const a = [], d = new Date(s), ed = new Date(e); while(d<=ed) { a.push(new Date(d).toISOString().split('T')[0]); d.setDate(d.getDate()+1); } return a; };
        const getDayOfWeek = (d) => ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][new Date(d).getDay()];
        const getMonthDay = (d) => { const date = new Date(d); return `${date.getMonth()+1}/${date.getDate()}`; };
        
        // FIX: Add robust date formatter to ensure YYYY-MM-DD format regardless of locale
        const toLocalISOString = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const openGoogleMaps = (query) => {
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
        };

        // --- Error Boundary Component ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex h-screen flex-col items-center justify-center bg-red-50 p-6 text-center">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-500"><Trash2 size={32} /></div>
                            <h1 className="text-xl font-bold text-gray-800 mb-2">ç™¼ç”Ÿé æœŸå¤–çš„éŒ¯èª¤</h1>
                            <p className="text-sm text-gray-600 mb-6 max-w-xs break-words bg-white p-2 rounded border border-gray-200">{this.state.error?.message}</p>
                            <div className="flex flex-col gap-2 w-full max-w-xs">
                                <button onClick={() => window.location.reload()} className="w-full py-3 bg-[#0ABAB5] text-white rounded-xl font-bold shadow-md hover:bg-[#008985]">é‡æ–°è¼‰å…¥é é¢</button>
                                <button onClick={() => { 
                                    if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœ¬æ©Ÿè³‡æ–™ä¸¦é‡ç½®å—ï¼Ÿé€™å°‡åˆªé™¤æœªä¸Šå‚³çš„é›¢ç·šè¡Œç¨‹ã€‚")) {
                                        localStorage.clear(); 
                                        window.location.reload(); 
                                    }
                                }} className="w-full py-3 bg-white text-red-500 border border-red-200 rounded-xl font-bold hover:bg-red-50">é‡ç½® App è³‡æ–™</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // New: Info Popup Component
        const InfoPopup = ({ isOpen, onClose, title, content }) => !isOpen ? null : (
            <div className="fixed inset-0 z-[100] flex items-center justify-center px-4">
                <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                <div className="bg-white w-full max-w-sm rounded-2xl p-6 relative z-10 shadow-xl animate-[fadeIn_0.2s_ease-out]">
                    <h3 className="text-lg font-bold text-[#0ABAB5] mb-3 flex items-center gap-2">
                        <Info size={20} /> {title}
                    </h3>
                    <div className="text-sm text-gray-600 leading-relaxed whitespace-pre-line">
                        {content}
                    </div>
                    <button onClick={onClose} className="mt-6 w-full py-2.5 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition-colors">
                        äº†è§£
                    </button>
                </div>
            </div>
        );

        // Unified Image Upload Helper
        const processImageUpload = async (file) => {
            const b64 = await resizeImage(file);
            if (!b64) return null;

            const imgbbKey = localStorage.getItem('gtp_imgbb_key');
            if (imgbbKey) {
                try {
                    const formData = new FormData();
                    formData.append('image', b64.split(',')[1]);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.success) {
                        return data.data.url;
                    } else {
                        console.error("Imgbb error:", data);
                        alert("åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œå°‡ä½¿ç”¨æœ¬æ©Ÿå„²å­˜ (å®¹é‡æœ‰é™)ã€‚éŒ¯èª¤: " + (data.error?.message || 'Unknown'));
                    }
                } catch (err) {
                    console.error("Imgbb fetch error:", err);
                    alert("é€£ç·š Imgbb å¤±æ•—ï¼Œå°‡ä½¿ç”¨æœ¬æ©Ÿå„²å­˜ã€‚");
                }
            }
            return b64;
        };

        // --- New Landing Page (Firebase Setup & Quick Join) ---
        const LandingView = ({ onConnect, onOffline, joinId, setJoinId, onJoin, recentTrips, onDeleteTrip, isOffline, onCreateTrip }) => {
            const [configInput, setConfigInput] = useState('');
            const [imgbbKey, setImgbbKey] = useState(''); 
            const [testStatus, setTestStatus] = useState('idle');
            const [errorMessage, setErrorMessage] = useState('');
            const [successMessage, setSuccessMessage] = useState(''); 
            const [infoType, setInfoType] = useState(null); 
            const [pendingJoinId, setPendingJoinId] = useState(null); 
            // FIX: Add state for ConfirmModal in LandingView for consistency
            const [confirmData, setConfirmData] = useState({ open: false, message: '', onConfirm: null });

            useEffect(() => {
                const storedConfig = localStorage.getItem('gtp_firebase_config');
                const storedImgbb = localStorage.getItem('gtp_imgbb_key');
                if (storedConfig) {
                    try {
                        const parsed = JSON.parse(storedConfig);
                        setConfigInput(JSON.stringify(parsed, null, 2).replace(/[{}]/g, '').trim());
                    } catch(e) {
                        setConfigInput(storedConfig);
                    }
                }
                if (storedImgbb) {
                    setImgbbKey(storedImgbb);
                }

                if (!isOffline) {
                    setTestStatus('success');
                    setSuccessMessage('ç›®å‰å·²é€£ç·š');
                    
                    if (pendingJoinId) {
                        onJoin(pendingJoinId);
                        setPendingJoinId(null);
                    }
                }
            }, [isOffline, pendingJoinId, onJoin]);

            const parseConfig = (str) => {
                try {
                    return JSON.parse(str);
                } catch (e) {
                    const obj = {};
                    const keys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
                    let found = false;
                    keys.forEach(key => {
                        const regex = new RegExp(`${key}\\s*:\\s*["']([^"']+)["']`, 'i');
                        const match = str.match(regex);
                        if (match && match[1]) {
                            obj[key] = match[1];
                            found = true;
                        }
                    });
                    return found ? obj : null;
                }
            };

            const handleTestConnection = async () => {
                setTestStatus('testing');
                setErrorMessage('');
                setSuccessMessage('');
                
                const config = parseConfig(configInput);
                if (!config || !config.apiKey || !config.projectId) {
                    setTestStatus('error');
                    setErrorMessage('ç„¡æ³•è¾¨è­˜ Firebase è¨­å®šæª”æ ¼å¼');
                    return;
                }

                try {
                    const tempAppName = 'test-' + Date.now();
                    const tempApp = initializeApp(config, tempAppName);
                    const tempAuth = getAuth(tempApp);
                    await signInAnonymously(tempAuth);
                    await deleteApp(tempApp);
                    
                    let imgbbVerified = false;
                    if (imgbbKey.trim()) {
                        try {
                            const formData = new FormData();
                            formData.append('image', 'R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');
                            
                            const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey.trim()}`, {
                                method: 'POST',
                                body: formData
                            });
                            const data = await res.json();
                            
                            if (!data.success) {
                                throw new Error(data.error?.message || 'Invalid API Key');
                            }
                            imgbbVerified = true;
                        } catch (imgError) {
                            setTestStatus('error');
                            setErrorMessage(`Firebase é€£ç·šæˆåŠŸï¼Œä½† Imgbb é€£ç·šå¤±æ•—: ${imgError.message}`);
                            return;
                        }
                    }

                    localStorage.setItem('gtp_firebase_config', JSON.stringify(config));
                    localStorage.setItem('gtp_imgbb_key', imgbbKey.trim());
                    
                    onConnect(config);

                } catch (e) {
                    console.error("Test failed", e);
                    setTestStatus('error');
                    setErrorMessage(`Firebase é€£ç·šå¤±æ•—: ${e.message}`);
                }
            };

            const handleJoinClick = () => {
                const cleanId = (joinId || '').trim();

                if (!cleanId) {
                    alert("è«‹è¼¸å…¥æ—…ç¨‹ ID");
                    return;
                }

                if (cleanId.startsWith('{') && cleanId.endsWith('}')) {
                    try {
                        const bundle = JSON.parse(cleanId);
                        if (bundle.id && bundle.firebase) {
                            // FIX: Use custom ConfirmModal instead of window.confirm for consistency
                            setConfirmData({
                                open: true,
                                message: `åµæ¸¬åˆ°åŒ…å« Firebase è¨­å®šçš„æ—…ç¨‹ä»£ç¢¼ (ID: ${bundle.id})ã€‚\n\næ˜¯å¦è¦è‡ªå‹•åŒ¯å…¥è¨­å®šã€å»ºç«‹é€£ç·šä¸¦åŠ å…¥æ—…ç¨‹ï¼Ÿ`,
                                onConfirm: () => {
                                    localStorage.setItem('gtp_firebase_config', JSON.stringify(bundle.firebase));
                                    if (bundle.imgbb) localStorage.setItem('gtp_imgbb_key', bundle.imgbb);
                                    
                                    setConfigInput(JSON.stringify(bundle.firebase, null, 2).replace(/[{}]/g, '').trim());
                                    setImgbbKey(bundle.imgbb || '');
                                    
                                    setPendingJoinId(bundle.id);
                                    setJoinId(bundle.id); 
                                    
                                    onConnect(bundle.firebase);
                                    
                                    alert("è¨­å®šå·²åŒ¯å…¥ï¼Œæ­£åœ¨å˜—è©¦é€£ç·š...\n\né€£ç·šæˆåŠŸå¾Œå°‡è‡ªå‹•é€²å…¥æ—…ç¨‹ã€‚");
                                }
                            });
                            return;
                        }
                    } catch (e) {
                        console.error("JSON Parse Error", e);
                    }
                }

                if (isOffline && configInput.trim().length > 10 && !localStorage.getItem('gtp_firebase_config')) {
                    alert("æ‚¨å·²å¡«å¯« Firebase è¨­å®šï¼Œä½†å°šæœªå»ºç«‹é€£ç·šï¼\n\nè«‹å…ˆé»æ“Šä¸Šæ–¹çš„ã€Œæ¸¬è©¦é€£ç·šã€ï¼Œç³»çµ±æœƒè‡ªå‹•å„²å­˜ä¸¦å»ºç«‹é€£ç·šã€‚");
                    return;
                }
                
                onJoin(cleanId);
            };

            return (
                <div className="flex flex-col h-full bg-[#F5FDFC] overflow-y-auto no-scrollbar">
                    <div className="flex-1 flex flex-col p-8 max-w-md mx-auto w-full">
                        <div className="text-center mb-6">
                            <h1 className="text-3xl font-bold text-[#0ABAB5] mb-2">Travel Plan</h1>
                            <p className="text-gray-500 text-sm">è¨­å®šé›²ç«¯é€£ç·šæˆ–è®€å–æœ¬æ©Ÿè¡Œç¨‹</p>
                        </div>

                        <div className="bg-gray-100 p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
                            <div className="flex justify-between items-center mb-2">
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wide">Firebase Configuration</label>
                                <button onClick={() => setInfoType('firebase')} className="text-gray-400 hover:text-[#0ABAB5] transition-colors"><Info size={16} /></button>
                            </div>
                            
                            <textarea 
                                value={configInput}
                                onChange={(e) => { setConfigInput(e.target.value); setTestStatus('idle'); }}
                                className="w-full h-12 p-3 bg-[#E2E2E2] border border-gray-200 rounded-xl text-xs font-mono outline-none focus:border-[#0ABAB5] focus:ring-1 focus:ring-[#0ABAB5] resize-none mb-4 placeholder-gray-500 text-gray-700"
                                placeholder={`apiKey: "...",\nprojectId: "..."`}
                            />

                            <div className="flex justify-between items-center mb-2">
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wide">Imgbb API Key (é¸å¡«)</label>
                                <button onClick={() => setInfoType('imgbb')} className="text-gray-400 hover:text-[#0ABAB5] transition-colors"><Info size={16} /></button>
                            </div>
                            <input 
                                value={imgbbKey}
                                onChange={(e) => { setImgbbKey(e.target.value); setTestStatus('idle'); }}
                                className="w-full p-3 bg-[#E2E2E2] border border-gray-200 rounded-xl text-xs font-mono outline-none focus:border-[#0ABAB5] focus:ring-1 focus:ring-[#0ABAB5] mb-4 placeholder-gray-500 text-gray-700"
                                placeholder="ä¾‹å¦‚: 358e4c7980312..."
                            />
                            
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={handleTestConnection}
                                    disabled={testStatus === 'testing'}
                                    className={`flex-1 py-2 rounded-lg font-bold text-xs transition-colors flex items-center justify-center gap-2
                                        ${testStatus === 'testing' ? 'bg-gray-200 text-gray-500' : 'bg-[#E0F2F1] text-[#00695C] hover:bg-[#B2DFDB]'}`}
                                >
                                    {testStatus === 'testing' ? <Loader className="animate-spin" size={14} /> : 'æ¸¬è©¦é€£ç·š'}
                                </button>
                                {testStatus === 'success' && <span className="text-green-500 flex items-center text-xs font-bold gap-1"><Check size={14}/> {successMessage}</span>}
                                {testStatus === 'error' && <span className="text-red-500 flex items-center text-xs font-bold gap-1"><X size={14}/> å¤±æ•—</span>}
                            </div>
                            {errorMessage && <p className="text-red-500 text-[10px] mt-2">{errorMessage}</p>}
                        </div>

                        <div className="flex gap-2 w-full mb-8">
                            <button 
                                onClick={() => {
                                    // FIX: Check for Imgbb Key before creating cloud trip
                                    const hasImgbb = localStorage.getItem('gtp_imgbb_key');
                                    if (!hasImgbb) {
                                        setConfirmData({
                                            open: true,
                                            message: "âš ï¸ æ³¨æ„ï¼šæ‚¨å°šæœªè¨­å®š Imgbb API Key\n\nå¦‚æœä¸è¨­å®šï¼Œç…§ç‰‡å°‡ç›´æ¥å­˜å…¥è³‡æ–™åº«ï¼Œå—é™æ–¼å–®ä¸€æ—…ç¨‹ 1MB çš„å®¹é‡ä¸Šé™ï¼Œæ‚¨å¯èƒ½åªèƒ½ä¸Šå‚³æ¥µå°‘é‡çš„ç…§ç‰‡ (ç´„ 3-5 å¼µ)ã€‚\n\nè‹¥æ‚¨æœ‰å¤§é‡ç…§ç‰‡ç´€éŒ„çš„éœ€æ±‚ï¼Œå¼·çƒˆå»ºè­°å…ˆå–å¾—ä¸¦è¨­å®š Imgbb API Keyã€‚\n\nç¢ºå®šè¦ç¹¼çºŒå»ºç«‹å—ï¼Ÿ",
                                            onConfirm: onCreateTrip
                                        });
                                    } else {
                                        onCreateTrip();
                                    }
                                }}
                                disabled={testStatus !== 'success'}
                                className={`flex-1 py-3 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition-all transform active:scale-95 text-sm
                                    ${testStatus === 'success' ? 'bg-[#0ABAB5] hover:bg-[#008985]' : 'bg-gray-300 cursor-not-allowed'}`}
                            >
                                <Plus size={18} /> å»ºç«‹é›²ç«¯æ–°æ—…ç¨‹
                            </button>

                            <button 
                                onClick={() => { localStorage.removeItem('gtp_firebase_config'); onOffline(); }}
                                className="w-[35%] py-3 rounded-xl font-bold text-white bg-red-400 border-2 border-transparent hover:bg-red-500 transition-all flex items-center justify-center gap-2 shadow-lg active:scale-95 text-xs sm:text-sm"
                            >
                                <WifiOff size={18} /> å–®æ©Ÿç‰ˆ
                            </button>
                        </div>

                        <div className="border-t border-gray-200 pt-6">
                            
                            <div className="bg-gray-100 border border-gray-100 rounded-xl p-3 mb-4 shadow-sm">
                                <div className="flex gap-2">
                                    <input 
                                        placeholder="è¼¸å…¥æ—…ç¨‹ ID ä¾‹å¦‚ï¼šx9z8y7" 
                                        value={joinId} 
                                        onChange={e => setJoinId(e.target.value)} 
                                        onKeyDown={(e) => e.key === 'Enter' && handleJoinClick()}
                                        className="flex-1 p-2 bg-[#E2E2E2] border border-gray-200 rounded-lg text-gray-700 font-bold outline-none focus:ring-2 focus:ring-[#0ABAB5] text-sm" 
                                    />
                                    <button 
                                        onClick={handleJoinClick}
                                        className="bg-[#0ABAB5] text-white p-2 rounded-lg hover:bg-[#008985] transition-colors"
                                    >
                                        <ArrowRight size={20} />
                                    </button>
                                </div>
                            </div>

                            {/* Recent Trips Section - Restored */}
                            {recentTrips.length > 0 && (
                                <div className="mt-8">
                                    <h3 className="text-xs font-bold text-gray-400 mb-3 flex items-center gap-2 uppercase tracking-wider"><History size={14}/> è¿‘æœŸç€è¦½</h3>
                                    <div className="space-y-2">
                                        {recentTrips.map(trip => (
                                            <div key={trip.id} onClick={() => onJoin(trip.id)} className="bg-[#EDF7F6] p-3 rounded-xl border border-gray-200 shadow-sm flex justify-between items-center cursor-pointer hover:border-[#0ABAB5] hover:shadow-md transition-all group">
                                                <div>
                                                    <div className="font-bold text-gray-700 text-sm flex items-center gap-2">
                                                        {trip.destination || 'æœªå‘½åè¡Œç¨‹'}
                                                        {/* ç°¡å–®åˆ¤æ–·æ˜¯å¦ç‚ºç´”æœ¬æ©Ÿ ID æ ¼å¼ (trip_é–‹é ­) */}
                                                        {trip.id.toString().startsWith('trip_') && <span className="text-[9px] bg-gray-100 text-gray-500 px-1.5 rounded border border-gray-200">æœ¬æ©Ÿ</span>}
                                                    </div>
                                                    <div className="text-[10px] text-gray-400 mt-0.5">{trip.dateRange}</div>
                                                </div>
                                                {/* [MODIFIED] ç§»é™¤ opacity-0 group-hover:opacity-100 è®“åƒåœ¾æ¡¶å¸¸æ™‚é¡¯ç¤º */}
                                                <button 
                                                    onClick={(e) => onDeleteTrip(trip.id, e)} 
                                                    className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-all"
                                                    title="ç§»é™¤ç´€éŒ„"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <InfoPopup 
                        isOpen={infoType === 'firebase'} 
                        onClose={() => setInfoType(null)} 
                        title="å¦‚ä½•å–å¾— Firebase è¨­å®š"
                        content={`1. å‰å¾€ Firebase Console (console.firebase.google.com)\n2. å»ºç«‹æ–°å°ˆæ¡ˆæˆ–é¸æ“‡ç¾æœ‰å°ˆæ¡ˆ\n3. é»æ“Š "Project Settings" (å°ˆæ¡ˆè¨­å®š)\n4. æ»‘å‹•è‡³ä¸‹æ–¹çš„ "Your apps" å€å¡Š\n5. é¸æ“‡ "Config" é¸é …\n6. è¤‡è£½ const firebaseConfig = {...} å¤§æ‹¬è™Ÿå…§çš„æ‰€æœ‰å…§å®¹ä¸¦è²¼ä¸Šã€‚`}
                    />
                    <InfoPopup 
                        isOpen={infoType === 'imgbb'} 
                        onClose={() => setInfoType(null)} 
                        title="å¦‚ä½•å–å¾— Imgbb API Key"
                        content={`1. å‰å¾€ api.imgbb.com\n2. è¨»å†Šæˆ–ç™»å…¥æ‚¨çš„å¸³è™Ÿ\n3. é»æ“Š "Get API Key" æŒ‰éˆ•\n4. è¤‡è£½ç”¢ç”Ÿçš„ Key ä¸¦è²¼ä¸Š\n\nğŸ’¡ è¨­å®šæ­¤é …å¯å°‡åœ–ç‰‡ä¸Šå‚³è‡³ Imgbb åœ–åºŠï¼Œè§£æ±º Firebase Firestore çš„ 1MB å„²å­˜é™åˆ¶ï¼Œè®“æ‚¨å¯ä»¥ä¸Šå‚³æ›´å¤šã€æ›´æ¸…æ™°çš„ç…§ç‰‡ã€‚`}
                    />
                    
                    {/* FIX: Render ConfirmModal inside LandingView */}
                    <ConfirmModal 
                        isOpen={confirmData.open} 
                        message={confirmData.message} 
                        onConfirm={() => {
                            if (confirmData.onConfirm) confirmData.onConfirm();
                            setConfirmData({ ...confirmData, open: false });
                        }} 
                        onCancel={() => setConfirmData({ ...confirmData, open: false })} 
                    />
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center px-4">
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onCancel}></div>
                    <div className="bg-[#F5FDFC] w-full max-w-xs rounded-2xl p-6 border border-[#eeeeee] relative z-10 flex flex-col items-center text-center">
                        <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-500"><Trash2 size={24} /></div>
                        <h3 className="text-lg font-bold text-gray-800 mb-2">ç¢ºèª</h3>
                        {/* FIX: Added whitespace-pre-line to support multiline warning messages */}
                        <p className="text-gray-600 mb-6 text-sm whitespace-pre-line">{message}</p>
                        <div className="flex gap-3 w-full">
                            <button onClick={onCancel} className="flex-1 py-2.5 rounded-xl text-gray-500 font-bold bg-gray-200 border border-[#eeeeee]">å–æ¶ˆ</button>
                            <button onClick={onConfirm} className="flex-1 py-2.5 rounded-xl bg-red-500 text-white font-bold border border-red-500">ç¢ºå®š</button>
                        </div>
                    </div>
                </div>
            );
        };

        const MemberManagementModal = ({ isOpen, onClose, tripData, currentMember, onUpdateMember, onRemoveMember, onAddMember }) => {
            const [editingIndex, setEditingIndex] = useState(null);
            const [editForm, setEditForm] = useState({ name: '', pin: '' });
            const [confirmRemove, setConfirmRemove] = useState(null);
            const [isAdding, setIsAdding] = useState(false);
            const [newMemberName, setNewMemberName] = useState('');

            if (!isOpen || !tripData) return null;

            const isOwner = currentMember?.role === 'owner';

            const handleEditClick = (member, index) => {
                setEditingIndex(index);
                setEditForm({ name: member.name, pin: member.pin });
            };

            const handleSaveClick = (index) => {
                if (!editForm.name.trim() || !editForm.pin.trim()) {
                    alert("æš±ç¨±èˆ‡ PIN ç¢¼ä¸å¾—ç‚ºç©º");
                    return;
                }
                onUpdateMember(index, editForm);
                setEditingIndex(null);
            };

            const handleRemoveClick = (index) => {
                setConfirmRemove(index);
            };

            const handleAddClick = () => {
                if (!newMemberName.trim()) {
                    alert("è«‹è¼¸å…¥æ—…ä¼´åç¨±");
                    return;
                }
                if (tripData.members.some(m => m.name === newMemberName.trim())) {
                    alert("æ­¤åç¨±å·²å­˜åœ¨");
                    return;
                }
                onAddMember({
                    name: newMemberName.trim(),
                    pin: '0000',
                    role: 'collaborator',
                    deviceId: 'offline_' + Date.now()
                });
                setNewMemberName('');
                setIsAdding(false);
            };

            return (
                <div className="fixed inset-0 z-[90] flex items-center justify-center px-4">
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-full max-w-md rounded-2xl p-6 border border-[#eeeeee] relative z-10 flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-center mb-4 border-b border-[#eeeeee] pb-2">
                            <h3 className="text-lg font-bold text-[#0ABAB5] flex items-center gap-2"><Users size={20}/> æ—…ä¼´ç®¡ç†</h3>
                            <button onClick={onClose}><X size={20} className="text-gray-400" /></button>
                        </div>
                        <div className="p-2 bg-yellow-50 rounded mb-2 text-xs text-yellow-600 border border-yellow-100">
                           å¯ä¿®æ”¹è‡ªå·±çš„æš±ç¨±èˆ‡ PIN ç¢¼ (ä¾›ç™»å…¥é©—è­‰ç”¨)ã€‚
                        </div>

                        <div className="space-y-3 overflow-y-auto p-1 mb-4 custom-scrollbar">
                            {tripData.members.map((member, index) => {
                                // FIX: Guard clause for dirty data
                                if (!member) return null;

                                const isEditing = editingIndex === index;
                                
                                // [CRITICAL FIX] å„ªå…ˆä½¿ç”¨ deviceId åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå·±ï¼Œ fallback æ‰æ˜¯åå­—æ¯”å°
                                const isSelf = (member.deviceId && currentMember?.deviceId && member.deviceId === currentMember.deviceId) || member.name === currentMember?.name;
                                const isMemberOwner = member.role === 'owner';
                                
                                // å…è¨± æ“æœ‰è€… ä¿®æ”¹æ‰€æœ‰äººï¼Œæˆ– ä»»ä½•äºº ä¿®æ”¹è‡ªå·±
                                const canEdit = isOwner || isSelf; 
                                const canRemove = isOwner && !isMemberOwner; 

                                return (
                                    <div key={index} className={`p-3 rounded-xl border ${isSelf ? 'border-[#0ABAB5] bg-[#E0F2F1]' : 'border-[#eeeeee] bg-[#EDF7F6]'} flex items-center justify-between`}>
                                            {isEditing ? (
                                                <div className="flex-1 flex gap-2 items-center">
                                                    <input 
                                                        value={editForm.name} 
                                                        onChange={e => setEditForm({...editForm, name: e.target.value})}
                                                        className="w-1/2 p-2 text-sm bg-[#E2E2E2] border border-[#eeeeee] rounded-lg outline-none focus:border-[#0ABAB5]"
                                                        placeholder="æš±ç¨±"
                                                    />
                                                    <input 
                                                        value={editForm.pin} 
                                                        onChange={e => setEditForm({...editForm, pin: e.target.value})}
                                                        className="w-1/3 p-2 text-sm bg-[#E2E2E2] border border-[#eeeeee] rounded-lg outline-none focus:border-[#0ABAB5]"
                                                        placeholder="PIN"
                                                    />
                                                    <button onClick={() => handleSaveClick(index)} className="text-green-500 p-1"><Save size={18} /></button>
                                                    <button onClick={() => setEditingIndex(null)} className="text-gray-400 p-1"><X size={18} /></button>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs ${isMemberOwner ? 'bg-yellow-400' : 'bg-gray-400'}`}>
                                                            {member.name.charAt(0).toUpperCase()}
                                                        </div>
                                                        <div>
                                                            <div className="font-bold text-gray-700 text-sm flex items-center gap-1">
                                                                {member.name}
                                                                {isMemberOwner && <Shield size={12} className="text-yellow-500"/>}
                                                                {isSelf && <span className="text-[10px] text-[#0ABAB5] bg-[#0ABAB5]/10 px-1 rounded">æˆ‘</span>}
                                                            </div>
                                                            <div className="text-[10px] text-gray-400">PIN: {member.pin}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex gap-1">
                                                        {canEdit && (
                                                            <button onClick={() => handleEditClick(member, index)} className="p-2 text-gray-400 hover:text-[#0ABAB5] transition-colors">
                                                                <Edit3 size={16} />
                                                            </button>
                                                        )}
                                                        {canRemove && (
                                                            <button onClick={() => handleRemoveClick(index)} className="p-2 text-gray-400 hover:text-red-500 transition-colors">
                                                                <UserX size={16} />
                                                            </button>
                                                        )}
                                                    </div>
                                                </>
                                            )}
                                    </div>
                                );
                            })}
                        </div>

                        {isOwner && (
                            <div className="mt-auto pt-2 border-t border-[#eeeeee]">
                                {isAdding ? (
                                    <div className="flex gap-2 items-center animate-fadeIn">
                                        <input 
                                            value={newMemberName}
                                            onChange={(e) => setNewMemberName(e.target.value)}
                                            placeholder="è¼¸å…¥æ–°æ—…ä¼´åç¨±"
                                            className="flex-1 p-3 bg-[#E2E2E2] border border-[#eeeeee] rounded-xl outline-none focus:border-[#0ABAB5] text-sm"
                                            autoFocus
                                        />
                                        <button onClick={handleAddClick} className="bg-[#0ABAB5] text-white p-3 rounded-xl hover:bg-[#008985]"><Check size={18} /></button>
                                        <button onClick={() => { setIsAdding(false); setNewMemberName(''); }} className="bg-gray-200 text-gray-500 p-3 rounded-xl hover:bg-gray-300"><X size={18} /></button>
                                    </div>
                                ) : (
                                    <button 
                                        onClick={() => setIsAdding(true)}
                                        className="w-full py-3 bg-[#E0F2F1] text-[#00695C] rounded-xl font-bold border border-[#B2DFDB] hover:bg-[#B2DFDB] transition-colors flex items-center justify-center gap-2"
                                    >
                                        <Plus size={18} /> æ–°å¢æ—…ä¼´
                                    </button>
                                )}
                            </div>
                        )}
                    </div>
                    
                    <ConfirmModal 
                        isOpen={confirmRemove !== null} 
                        message="ç¢ºå®šè¦ç§»é™¤é€™ä½æ—…ä¼´å—ï¼Ÿ(å…¶å»ºç«‹çš„è³‡æ–™å°‡æœƒä¿ç•™)" 
                        onConfirm={() => { onRemoveMember(confirmRemove); setConfirmRemove(null); }} 
                        onCancel={() => setConfirmRemove(null)} 
                    />
                </div>
            );
        };

        // [PATCH] è£œå›éºå¤±çš„ JoinModal å…ƒä»¶ (è«‹è²¼åœ¨ MemberManagementModal ä¹‹å¾Œ)
        const JoinModal = ({ isOpen, onClose, tripData, onJoin }) => {
            const [mode, setMode] = useState('new'); 
            const [name, setName] = useState('');
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');

            if (!isOpen || !tripData) return null;

            const handleJoin = () => {
                setError('');
                if (!pin.trim()) { setError('è«‹è¼¸å…¥ PIN ç¢¼'); return; }
                
                if (mode === 'new') {
                    if (!name.trim()) { setError('è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±'); return; }
                    if (tripData.members.some(m => m.name === name.trim())) { setError('æ­¤æš±ç¨±å·²è¢«ä½¿ç”¨ï¼Œè«‹æ›´æ›'); return; }
                    onJoin({ name: name.trim(), pin: pin.trim(), role: 'collaborator', isNew: true });
                } else {
                    if (!name) { setError('è«‹é¸æ“‡æ‚¨çš„èº«åˆ†'); return; }
                    const member = tripData.members.find(m => m.name === name);
                    if (!member) { setError('æ‰¾ä¸åˆ°æˆå“¡è³‡æ–™'); return; }
                    if (member.pin !== pin.trim()) { setError('PIN ç¢¼éŒ¯èª¤'); return; }
                    onJoin({ name: member.name, pin: member.pin, role: member.role, isNew: false });
                }
            };

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center px-4">
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-full max-w-sm rounded-2xl p-6 border border-[#eeeeee] shadow-2xl relative z-10 flex flex-col">
                        <h3 className="text-xl font-bold text-[#0ABAB5] mb-4 text-center">åŠ å…¥æ—…ç¨‹</h3>
                        <div className="flex bg-gray-200 p-1 rounded-xl mb-4">
                            <button onClick={() => setMode('new')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${mode === 'new' ? 'bg-white text-[#0ABAB5] shadow-sm' : 'text-gray-500'}`}>æˆ‘æ˜¯æ–°å”ä½œè€…</button>
                            <button onClick={() => setMode('old')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${mode === 'old' ? 'bg-white text-[#0ABAB5] shadow-sm' : 'text-gray-500'}`}>æˆ‘æ˜¯èˆŠæˆå“¡</button>
                        </div>
                        
                        <div className="space-y-4">
                            {mode === 'new' ? (
                                <div>
                                    <label className="text-xs font-bold text-gray-500 block mb-1">æ‚¨çš„æš±ç¨±</label>
                                    <input value={name} onChange={e => setName(e.target.value)} className="w-full p-3 bg-[#E2E2E2] rounded-xl text-gray-700 outline-none focus:ring-2 focus:ring-[#0ABAB5] border border-[#eeeeee]" placeholder="ä¾‹å¦‚ï¼šå°æ˜" />
                                </div>
                            ) : (
                                <div>
                                    <label className="text-xs font-bold text-gray-500 block mb-1">é¸æ“‡æ‚¨çš„èº«åˆ†</label>
                                    <select value={name} onChange={e => setName(e.target.value)} className="w-full p-3 bg-[#E2E2E2] rounded-xl text-gray-700 outline-none focus:ring-2 focus:ring-[#0ABAB5] border border-[#eeeeee]">
                                        <option value="">-- è«‹é¸æ“‡ --</option>
                                        {tripData.members.map(m => {
                                            // FIX: Guard clause
                                            if (!m) return null;
                                            return <option key={m.name} value={m.name}>{m.name}</option>;
                                        })}
                                    </select>
                                </div>
                            )}

                            <div>
                                <label className="text-xs font-bold text-gray-500 block mb-1">{mode === 'new' ? 'è¨­å®šæ‚¨çš„ PIN ç¢¼' : 'è¼¸å…¥ PIN ç¢¼é©—è­‰'}</label>
                                <input type="password" value={pin} onChange={e => setPin(e.target.value)} className="w-full p-3 bg-[#E2E2E2] rounded-xl text-gray-700 outline-none focus:ring-2 focus:ring-[#0ABAB5] border border-[#eeeeee]" placeholder="****" />
                            </div>
                        </div>

                        {error && <p className="text-red-500 text-xs font-bold mt-3 text-center">{error}</p>}

                        <button onClick={handleJoin} className="w-full py-3 bg-[#0ABAB5] text-white rounded-xl font-bold border border-[#0ABAB5] hover:bg-[#008985] transition-all mt-6">
                            {mode === 'new' ? 'åŠ å…¥ä¸¦é–‹å§‹' : 'é©—è­‰ä¸¦ç™»å…¥'}
                        </button>
                    </div>
                </div>
            );
        };

        // [MODIFIED] å‡ç´š AutoSaveInputï¼šæ”¯æ´ç¶²å€è‡ªå‹•é€£çµ (detectLinks æ¨¡å¼)
        const AutoSaveInput = ({ value, onSave, readOnly, detectLinks, ...props }) => {
            const [v, setV] = useState(value ?? '');
            const [isEditing, setIsEditing] = useState(false); // æ§åˆ¶ç·¨è¼¯ç‹€æ…‹
            
            useEffect(() => setV(value ?? ''), [value]);
            
            const handleBlur = () => {
                const normalizedV = v === null || v === undefined ? '' : String(v);
                const normalizedValue = value === null || value === undefined ? '' : String(value);

                if (normalizedV !== normalizedValue) {
                    onSave(v);
                }
                if (detectLinks) setIsEditing(false); // ç·¨è¼¯å®Œæˆå¾Œåˆ‡å›æª¢è¦–æ¨¡å¼
            };
            
            // [NEW] æª¢è¦–æ¨¡å¼ï¼šæ¸²æŸ“å¸¶æœ‰è¶…é€£çµçš„æ–‡å­—
            if (detectLinks && !isEditing) {
                const text = v === null || v === undefined ? '' : String(v);
                
                // Helper: è§£æ URL ä¸¦è½‰æ›ç‚º <a> æ¨™ç±¤
                const renderWithLinks = (str) => {
                    if (!str) return null;
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    const parts = str.split(urlRegex);
                    return parts.map((part, i) => {
                        if (part.match(urlRegex)) {
                            return (
                                <a 
                                    key={i} 
                                    href={part} 
                                    target="_blank" 
                                    rel="noopener noreferrer" 
                                    className="text-blue-500 underline break-all relative z-20 hover:text-blue-700"
                                    onClick={(e) => e.stopPropagation()} // é˜²æ­¢é»æ“Šé€£çµæ™‚è§¸ç™¼ç·¨è¼¯æ¨¡å¼
                                >
                                    {part}
                                </a>
                            );
                        }
                        return part;
                    });
                };

                return (
                    <div 
                        onClick={(e) => { 
                             if (!readOnly) {
                                 e.stopPropagation(); 
                                 setIsEditing(true); // é»æ“Šæ–‡å­—é€²å…¥ç·¨è¼¯æ¨¡å¼
                             }
                        }}
                        // æ¨¡ä»¿åŸæœ¬ input çš„æ¨£å¼ï¼Œä½†å…è¨±æ›è¡Œèˆ‡é€£çµé»æ“Š
                        className={`${props.className} cursor-text min-h-[1.5rem] whitespace-pre-wrap break-words flex items-center`}
                        style={{ cursor: readOnly ? 'default' : 'text' }}
                    >
                        {text ? renderWithLinks(text) : <span className="text-gray-400 opacity-60 italic">{props.placeholder}</span>}
                    </div>
                );
            }
            
            const propsFinal = { 
                ...props, 
                value: v, 
                onChange: e => setV(e.target.value), 
                onBlur: handleBlur, 
                onKeyDown: e => {
                    // [MODIFIED] åƒ…åœ¨é textarea æ™‚æŒ‰ Enter å„²å­˜
                    if (props.type !== 'textarea' && e.key === 'Enter') e.target.blur();
                }, 
                readOnly,
                autoFocus: detectLinks && isEditing // åˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼æ™‚è‡ªå‹•èšç„¦
            };
            return props.type === 'textarea' ? <textarea {...propsFinal} /> : <input {...propsFinal} />;
        };

        const ImageModal = ({ src, onClose }) => !src ? null : <div className="fixed inset-0 z-[70] bg-black/20 flex items-center justify-center p-4" onClick={onClose}><img src={src} className="max-w-full max-h-full object-contain rounded-lg" /></div>;

        // [MODIFIED] å¢åŠ  onSliceClick æ”¯æ´ä¸‹é‘½äº’å‹•
        const SimplePieChart = ({ data, onSliceClick }) => {
            const total = data.reduce((sum, item) => sum + item.value, 0);
            if (total === 0) return <div className="h-40 flex items-center justify-center text-gray-400 text-sm border-2 border-dashed border-gray-200 rounded-full w-40 mx-auto">å°šç„¡æ¶ˆè²»æ•¸æ“š</div>;
            let currentAngle = 0;
            return (
                <div className="relative h-48 w-48 mx-auto">
                <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                    {data.map((item, i) => {
                    const angle = (item.value / total) * 360;
                    const x1 = 50 + 50 * Math.cos(Math.PI * currentAngle / 180);
                    const y1 = 50 + 50 * Math.sin(Math.PI * currentAngle / 180);
                    const x2 = 50 + 50 * Math.cos(Math.PI * (currentAngle + angle) / 180);
                    const y2 = 50 + 50 * Math.sin(Math.PI * (currentAngle + angle) / 180);
                    const largeArc = angle > 180 ? 1 : 0;
                    const pathData = total === item.value ? `M 50 50 m -50, 0 a 50,50 0 1,0 100,0 a 50,50 0 1,0 -100,0` : `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArc} 1 ${x2} ${y2} Z`;
                    
                    // [MODIFIED] Add click handler and cursor style
                    const slice = (
                        <path 
                            key={i} 
                            d={pathData} 
                            fill={item.color} 
                            stroke="white" 
                            strokeWidth="1" 
                            onClick={() => onSliceClick && onSliceClick(item.category)}
                            className={onSliceClick ? "cursor-pointer hover:opacity-90 transition-opacity" : ""}
                        />
                    );
                    currentAngle += angle;
                    return slice;
                    })}
                    <circle cx="50" cy="50" r="30" fill="#F5FDFC" pointerEvents="none" />
                </svg>
                <div className="absolute inset-0 flex items-center justify-center flex-col pointer-events-none"><span className="text-xs text-gray-400">ç¸½æ”¯å‡º</span><span className="text-lg font-bold text-gray-700">${total.toLocaleString()}</span></div>
                </div>
            );
        };

        const SimpleBarChart = ({ data }) => {
            const maxVal = Math.max(...data.map(d => d.total), 1); 
            if (data.length === 0 || maxVal === 0) return <div className="text-xs text-center text-gray-400 py-4">å°šç„¡è³‡æ–™</div>;
            return (
                <div className="w-full overflow-x-auto no-scrollbar">
                <div className="flex items-end gap-3 h-40 pt-6 px-2 min-w-max">
                    {data.map((item, i) => {
                    const heightPercent = maxVal > 0 ? (item.total / maxVal) * 100 : 0;
                    const displayHeight = Math.max(heightPercent, 2); 
                    return (
                        <div key={i} className="flex flex-col items-center gap-1 group w-12 h-full justify-end">
                        <div className="relative w-4 flex flex-col-reverse rounded-t-md overflow-hidden bg-[#C8D9D9] border border-[#B0C4C4]" style={{ height: `${displayHeight}%` }}>
                            {item.breakdown.map((seg, idx) => {
                                const segHeight = item.total > 0 ? (seg.cost / item.total) * 100 : 0;
                                if(segHeight <= 0) return null;
                                return <div key={idx} style={{ height: `${segHeight}%`, backgroundColor: seg.color }} className="w-full transition-all duration-300" />;
                            })}
                            {item.total > 0 && <div className="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-20 shadow-lg pointer-events-none">${item.total}</div>}
                        </div>
                        <div className="text-[10px] text-gray-500 font-medium">{item.date.slice(5).replace('-','/')}</div>
                        </div>
                    );
                    })}
                </div>
                <div className="flex flex-wrap gap-3 mt-4 justify-center px-4">
                    {Object.keys(CATEGORY_COLORS).map(cat => (
                        <div key={cat} className="flex items-center gap-1"><div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: CATEGORY_COLORS[cat] }}></div><span className="text-[10px] text-gray-500">{cat}</span></div>
                    ))}
                </div>
                </div>
            );
        };

        const TransactionDetailModal = ({ transaction, onClose, onViewImage }) => {
            if (!transaction) return null;
            const color = CATEGORY_COLORS[transaction.category] || '#ccc';
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center" onClick={onClose}>
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm"></div>
                    <div className="bg-[#F5FDFC] w-[85%] max-w-sm rounded-2xl p-5 border border-[#eeeeee] relative z-10" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center gap-2 mb-4"><div className="w-2 h-8 rounded-full" style={{backgroundColor:color}}></div><h3 className="text-xl font-bold text-gray-800">{transaction.title || 'æœªå‘½å'}</h3></div>
                        <div className="space-y-4">
                            <div className="flex justify-between border-b border-[#eeeeee] pb-2"><span className="text-gray-500">é‡‘é¡</span><span className="text-2xl font-bold text-[#D68C68]">{transaction.cost} <small>{transaction.currency}</small></span></div>
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div><label className="text-xs text-gray-400 block">åˆ†é¡</label>{transaction.category}</div>
                                <div><label className="text-xs text-gray-400 block">ä»˜æ¬¾äºº</label>{transaction.payer}</div>
                            </div>
                            {transaction.photoUrls?.length > 0 && <div className="flex gap-2 overflow-x-auto">{transaction.photoUrls.map((p, i) => {
                                // FIX: Guard against null/undefined photos in TransactionDetailModal
                                if (!p) return null;
                                const url = typeof p === 'string' ? p : p.url;
                                return <img key={i} src={url} className="w-20 h-20 object-cover rounded-lg" onClick={() => onViewImage(url)} />;
                            })}</div>}
                        </div>
                    </div>
                </div>
            );
        };

        // Modified: Added members prop to support Payer selection
        const AccommodationCard = ({ date, data, onUpdate, onPhotoUpload, onPhotoDelete, onViewImage, onAdd, onDelete, isOwner, currentMember, members }) => {
            const [expandedId, setExpandedId] = useState(null);

            return (
                <div className="bg-[#FFF9C4] border border-yellow-300 shadow-sm rounded-2xl p-1.5 mt-4 relative mb-2">
                    
                    {(!data || data.length === 0) && <div className="text-center text-yellow-600 text-xs py-1">å°šæœªæ–°å¢ä½å®¿</div>}

                    {(data || []).map((item, index) => {
                        // FIX: Guard clause for dirty data (null items)
                        if (!item) return null;

                        const isExpanded = expandedId === item.id;
                        return (
                            <div key={item.id || index} className={index > 0 ? "border-t border-yellow-200 pt-0.5 mt-0.5" : ""}>
                                {/* Header - Always Visible */}
                                <div 
                                    className="flex items-center justify-between cursor-pointer" 
                                    onClick={() => setExpandedId(isExpanded ? null : item.id)}
                                >
                                    <div className="flex items-center gap-1 flex-1 min-w-0 pr-8">
                                        <BedDouble size={14} className="text-gray-600 flex-shrink-0" />
                                        {/* [MODIFIED] ä¿®æ”¹å®¹å™¨æ¨£å¼ï¼šä½¿ç”¨ flex-1 å’Œ flex items-center ç¢ºä¿å‚ç›´ç½®ä¸­ */}
                                        <div onClick={(e) => e.stopPropagation()} className="flex-1 flex items-center">
                                            <AutoSaveInput 
                                                type="text" 
                                                readOnly={!isOwner} 
                                                placeholder="è¼¸å…¥é£¯åº—åç¨±..." 
                                                value={item.name} 
                                                onSave={(val) => onUpdate(item.id, 'name', val)} 
                                                className="bg-transparent text-xs font-bold text-gray-800 outline-none placeholder-gray-400 w-full leading-none"
                                            />
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-1">
                                        {isOwner && <button onClick={(e) => { e.stopPropagation(); onDelete(item.id); }} className="text-red-400 hover:text-red-600 p-0.5"><Trash2 size={12} /></button>}
                                        <ChevronDown size={14} className={`text-yellow-600 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`} />
                                    </div>
                                </div>
                                
                                {/* Details - Collapsible */}
                                <div className={`transition-all duration-300 ease-in-out overflow-hidden ${isExpanded ? 'max-h-[1000px] opacity-100' : 'max-h-0 opacity-0'}`}>
                                    <div className="pt-1 pb-0.5 space-y-1">
                                        {/* Modified: Booking Code row with Check-in AND Check-out Boxes stacked on the right */}
                                        <div className="flex gap-1 mb-1 items-center px-1">
                                            {/* Booking Code Input */}
                                            <div className="flex-1 min-w-0">
                                                <AutoSaveInput 
                                                    type="text" 
                                                    readOnly={!isOwner} 
                                                    placeholder="è¨‚æˆ¿ç·¨è™Ÿ" 
                                                    value={item.bookingCode} 
                                                    onSave={(val) => onUpdate(item.id, 'bookingCode', val)} 
                                                    className="text-xs text-gray-500 bg-transparent outline-none w-full"
                                                />
                                            </div>

                                            {/* Date & Time Boxes Column */}
                                            <div className="flex flex-col gap-1 flex-shrink-0">
                                                {/* Check-in Box */}
                                                <div className="flex items-center gap-1 bg-[#E2E2E2] border border-gray-300 px-1.5 py-0.5 rounded-lg">
                                                    <LogIn size={10} className="text-green-600 flex-shrink-0" />
                                                    <input 
                                                        type="date" 
                                                        value={item.checkInDate || ''} 
                                                        onChange={(e) => onUpdate(item.id, 'checkInDate', e.target.value)} 
                                                        onClick={(e) => e.stopPropagation()}
                                                        disabled={!isOwner} 
                                                        className="text-[10px] bg-transparent outline-none w-[80px] font-bold text-gray-600 border-none cursor-pointer p-0 relative z-10" 
                                                    />
                                                    <div className="w-px h-2.5 bg-gray-300 mx-0.5"></div>
                                                    <select 
                                                        value={item.checkInTime || '15:00'} 
                                                        onChange={(e) => onUpdate(item.id, 'checkInTime', e.target.value)} 
                                                        onClick={(e) => e.stopPropagation()}
                                                        disabled={!isOwner} 
                                                        className="text-[10px] bg-transparent outline-none text-gray-600 font-bold appearance-none cursor-pointer relative z-10"
                                                    >
                                                        {TIME_OPTIONS.map(t => <option key={t} value={t}>{t}</option>)}
                                                    </select>
                                                </div>

                                                {/* Check-out Box - Added below Check-in */}
                                                <div className="flex items-center gap-1 bg-[#E2E2E2] border border-gray-300 px-1.5 py-0.5 rounded-lg">
                                                    <LogOutIcon size={10} className="text-red-500 flex-shrink-0" />
                                                    <input 
                                                        type="date" 
                                                        value={item.checkOutDate || ''} 
                                                        onChange={(e) => onUpdate(item.id, 'checkOutDate', e.target.value)} 
                                                        onClick={(e) => e.stopPropagation()}
                                                        disabled={!isOwner} 
                                                        className="text-[10px] bg-transparent outline-none w-[80px] font-bold text-gray-600 border-none cursor-pointer p-0 relative z-10" 
                                                    />
                                                    <div className="w-px h-2.5 bg-gray-300 mx-0.5"></div>
                                                    <select 
                                                        value={item.checkOutTime || '10:00'} 
                                                        onChange={(e) => onUpdate(item.id, 'checkOutTime', e.target.value)} 
                                                        onClick={(e) => e.stopPropagation()}
                                                        disabled={!isOwner} 
                                                        className="text-[10px] bg-transparent outline-none text-gray-600 font-bold appearance-none cursor-pointer relative z-10"
                                                    >
                                                        {TIME_OPTIONS.map(t => <option key={t} value={t}>{t}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Note Input Row */}
                                        <div className="px-1 flex gap-2 items-center">
                                            <div className="flex-[2] min-w-0">
                                                {/* [MODIFIED] å•Ÿç”¨ detectLinks åŠŸèƒ½ */}
                                                <AutoSaveInput 
                                                    type="text" 
                                                    readOnly={!isOwner} 
                                                    detectLinks={true}
                                                    placeholder="å‚™è¨» (Wifi/å¯†ç¢¼...)" 
                                                    value={item.note} 
                                                    onSave={(val) => onUpdate(item.id, 'note', val)} 
                                                    className="text-xs text-gray-600 bg-transparent outline-none w-full placeholder-gray-400 border-b border-yellow-200 border-dashed pb-1"
                                                />
                                            </div>
                                            
                                            {/* Expense Fields Container */}
                                            <div className="flex gap-1 flex-1 items-center justify-end">
                                                {/* Cost - Fixed Height h-6 */}
                                                <div className="flex items-center bg-white/60 rounded-lg px-1 border border-yellow-200 w-16 h-6">
                                                    <span className="text-[10px] text-gray-400 mr-0.5">$</span>
                                                    <AutoSaveInput 
                                                        type="number" 
                                                        readOnly={!isOwner} 
                                                        value={item.cost} 
                                                        onSave={(val) => onUpdate(item.id, 'cost', val)} 
                                                        placeholder="é‡‘é¡"
                                                        className="text-[10px] bg-transparent outline-none w-full text-gray-700 font-bold text-right h-full"
                                                    />
                                                </div>
                                                
                                                {/* Currency - Fixed Height h-6 */}
                                                <div className="relative w-12 h-6 bg-white/60 rounded-lg border border-yellow-200 overflow-hidden flex items-center">
                                                    <select 
                                                        value={item.currency || 'JPY'} 
                                                        onChange={(e) => onUpdate(item.id, 'currency', e.target.value)}
                                                        disabled={!isOwner}
                                                        className="w-full text-[10px] bg-transparent outline-none text-gray-600 appearance-none text-center font-bold h-full"
                                                    >
                                                        {currencies.map(c=><option key={c.value} value={c.value}>{c.value}</option>)}
                                                    </select>
                                                </div>

                                                {/* Payer - Fixed Height h-6 */}
                                                <div className="relative w-14 h-6 bg-white/60 rounded-lg border border-yellow-200 overflow-hidden flex items-center">
                                                    <select 
                                                        value={item.payer || (members?.[0]?.name) || 'æˆ‘'} 
                                                        onChange={(e) => onUpdate(item.id, 'payer', e.target.value)}
                                                        disabled={!isOwner}
                                                        className="w-full text-[10px] bg-transparent outline-none text-gray-600 appearance-none text-center font-bold h-full"
                                                    >
                                                        {(members || []).map(m => m ? <option key={m.name} value={m.name}>{m.name}</option> : null)}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="flex flex-col gap-1">
                                            <div className="flex gap-2 items-stretch">
                                                <div className="flex items-center gap-1 bg-[#E2E2E2] border border-gray-300 px-2 py-0.5 rounded-lg flex-[3] overflow-hidden">
                                                    <Phone size={10} className="text-green-600 flex-shrink-0" />
                                                    <AutoSaveInput type="text" readOnly={!isOwner} placeholder="é›»è©±" value={item.phone} onSave={(val) => onUpdate(item.id, 'phone', val)} className="text-xs text-gray-600 bg-transparent outline-none w-full min-w-0"/>
                                                </div>
                                                <div className="flex items-center gap-1 bg-[#E2E2E2] border border-gray-300 px-2 py-0.5 rounded-lg flex-[7] overflow-hidden">
                                                    <MapPin size={10} className="text-red-500 flex-shrink-0" />
                                                    <AutoSaveInput type="text" readOnly={!isOwner} placeholder="åœ°å€" value={item.address} onSave={(val) => onUpdate(item.id, 'address', val)} className="text-xs text-gray-600 bg-transparent outline-none w-full min-w-0"/>
                                                    <button onClick={() => item.address && window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}`, '_blank')} className="text-blue-500 hover:bg-blue-50 p-1 rounded flex-shrink-0"><Navigation size={10} /></button>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2 overflow-x-auto pb-1 no-scrollbar mt-0.5">
                                                    {item.photoUrls?.map((p, i) => {
                                                        // FIX: Handle null photos from dirty data
                                                        if (!p) return null;
                                                        const url = typeof p === 'string' ? p : p.url;
                                                        const uploader = typeof p === 'string' ? 'unknown' : p.uploader;
                                                        const canDelete = isOwner || (currentMember && uploader === currentMember.name);
                                                        return ( <div key={i} className="relative flex-shrink-0"> <img src={url} className="w-10 h-10 object-cover rounded-lg border border-yellow-200 cursor-zoom-in" onClick={() => onViewImage(url)} /> {canDelete && <button onClick={() => onPhotoDelete(item.id, url, 'accom')} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 hover:bg-red-600 transition"><X size={10} /></button>} </div> );
                                                    })}
                                                    {/* [FIX] å‚³å…¥ data: itemDataï¼Œä¿®å¾©ä½å®¿ç…§ç‰‡è¦†è“‹å•é¡Œ */}
                                                    <button onClick={() => {
                                                        const currentList = Array.isArray(data) ? data : [];
                                                        const itemData = currentList.find(i => i.id === item.id);
                                                        onPhotoUpload(item.id, itemData); 
                                                    }} className="w-10 h-10 flex items-center justify-center border-2 border-dashed border-yellow-300 text-yellow-500 hover:text-yellow-600 hover:border-yellow-600 rounded-lg transition-colors flex-shrink-0 bg-yellow-100"><Image size={16} /></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}

                    {/* Button Moved to Bottom Right Outside - Adjusted further down */}
                    {isOwner && <button onClick={onAdd} className="absolute -bottom-6 right-2 bg-yellow-400 text-white shadow-md rounded-full p-1.5 hover:bg-yellow-500 transition-colors z-10 border-2 border-white"><Plus size={14} /></button>}
                </div>
            );
        };

        const FlightCard = ({ label, icon: Icon, data, onUpdate, isOwner }) => (
            <div className="bg-[#EFF6FF] border-l-4 border-[#3B82F6] shadow-sm rounded-xl p-2 mb-2 relative border border-[#eeeeee]">
                <div className="absolute top-0 right-0 bg-[#3B82F6] text-white text-[10px] px-2 py-0.5 rounded-bl-lg rounded-tr-xl font-bold">{label}</div>
                <div className="flex items-center justify-between mt-3">
                    <div className="flex flex-col items-start w-1/3"><label className="text-[10px] text-gray-400 font-medium mb-0.5">èµ·é£›</label><AutoSaveInput type="text" readOnly={!isOwner} value={data.depTime} placeholder="14:00" maxLength={5} onSave={(val) => onUpdate('depTime', val)} className="text-lg font-bold text-gray-700 bg-transparent outline-none w-full p-0 leading-none" /><AutoSaveInput type="text" readOnly={!isOwner} placeholder="æ©Ÿå ´/èˆªå»ˆ" value={data.depAirport} onSave={(val) => onUpdate('depAirport', val)} className="text-xs text-gray-500 font-medium bg-transparent outline-none w-full mt-0.5 placeholder-gray-300" /></div>
                    <div className="flex flex-col items-center justify-center w-1/3 px-2"><div className="text-[#3B82F6] mb-0.5 transform rotate-45"><Icon size={20} /></div><div className="w-full flex items-center justify-center relative mb-0.5"><div className="h-px bg-gray-300 w-full absolute top-1/2 left-0"></div><div className="w-1.5 h-1.5 bg-[#3B82F6] rounded-full z-10"></div></div><AutoSaveInput type="text" readOnly={!isOwner} placeholder="èˆªç­è™Ÿ" value={data.number} onSave={(val) => onUpdate('number', val)} className="text-center text-xs font-bold text-[#1E40AF] bg-transparent outline-none w-full placeholder-gray-300 uppercase" /></div>
                    <div className="flex flex-col items-end w-1/3"><label className="text-[10px] text-gray-400 font-medium mb-0.5">æŠµé”</label><AutoSaveInput type="text" readOnly={!isOwner} value={data.arrTime} placeholder="18:30" maxLength={5} onSave={(val) => onUpdate('arrTime', val)} className="text-lg font-bold text-gray-700 bg-transparent outline-none w-full p-0 leading-none text-right" /><AutoSaveInput type="text" readOnly={!isOwner} placeholder="æ©Ÿå ´/èˆªå»ˆ" value={data.arrAirport} onSave={(val) => onUpdate('arrAirport', val)} className="text-xs text-gray-500 font-medium bg-transparent outline-none w-full mt-0.5 text-right placeholder-gray-300" /></div>
                </div>
            </div>
        );

        const EditTripModal = ({ isOpen, onClose, tripData, onSave }) => {
            const [formData, setFormData] = useState({});
            useEffect(() => {
                if (isOpen && tripData) {
                    setFormData({ destination: tripData.destination, startDate: tripData.startDate, endDate: tripData.endDate, currency: tripData.currency });
                }
            }, [isOpen, tripData]);
            if (!isOpen) return null;
            const handleSave = () => { if (!formData.destination.trim()) { alert('è«‹è¼¸å…¥ç›®çš„åœ°'); return; } onSave(formData); onClose(); };
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center px-4">
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-full max-w-sm rounded-2xl p-6 border border-[#eeeeee] relative z-10 flex flex-col">
                        <div className="flex justify-between items-center mb-4 border-b border-[#eeeeee] pb-2">
                            <h3 className="text-lg font-bold text-gray-800">ç·¨è¼¯æ—…ç¨‹è¨­å®š</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={20} /></button>
                        </div>
                        <div className="space-y-4">
                            <div><label className="text-xs text-gray-500 font-bold block mb-1">ç›®çš„åœ°</label><input type="text" value={formData.destination} onChange={(e) => setFormData({...formData, destination: e.target.value})} className="w-full p-2 bg-[#E2E2E2] rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 border border-[#eeeeee]" /></div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs text-gray-500 font-bold block mb-1">é–‹å§‹æ—¥æœŸ</label><input type="date" value={formData.startDate} onChange={(e) => setFormData({...formData, startDate: e.target.value})} className="flex-1 p-2 bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 border border-[#eeeeee]" /></div>
                                <div className="flex-1"><label className="text-xs text-gray-500 font-bold block mb-1">çµæŸæ—¥æœŸ</label><input type="date" value={formData.endDate} onChange={(e) => setFormData({...formData, endDate: e.target.value})} className="flex-1 p-2 bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 border border-[#eeeeee]" /></div>
                            </div>
                            <div>
                                <label className="text-xs text-gray-500 font-bold block mb-1">ä¸»è¦è²¨å¹£</label>
                                <select value={formData.currency} onChange={(e) => setFormData({...formData, currency: e.target.value})} className="w-full p-2 bg-[#E2E2E2] rounded-xl text-sm font-bold outline-none text-gray-700 border border-[#eeeeee]">
                                    {currencies.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}
                                </select>
                            </div>
                            <button onClick={handleSave} className="w-full py-3 bg-[#0ABAB5] text-white rounded-xl font-bold border border-[#0ABAB5] hover:bg-[#008985] transition-all mt-2">å„²å­˜è®Šæ›´</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ActivityModal = ({ isOpen, onClose, onSave, tripData, defaultValues, currentMember, selectedDate, onUpdateCategories }) => {
            // [MODIFIED] æ–°å¢ paymentMethod ç‹€æ…‹ï¼Œé è¨­ç‚º 'cash'
            const [formData, setFormData] = useState({ date: selectedDate, time: '09:00', title: '', note: '', transport: 'walk', duration: '60', bookingCode: '', cost: '', currency: 'JPY', paymentMethod: 'cash', payer: 'æˆ‘', category: '', photoUrls: [] });
            const [confirm, setConfirm] = useState({ open: false, idx: null });
            const fileRef = useRef(null);
            
            // New state for adding category
            const [isAddingCat, setIsAddingCat] = useState(false);
            const [newCatName, setNewCatName] = useState("");
            
            useEffect(() => {
                 if (isOpen) {
                     if (defaultValues) { 
                         setFormData({
                             ...defaultValues,
                             currency: defaultValues.currency || tripData?.currency || 'JPY',
                             // [MODIFIED] è¼‰å…¥æ—¢æœ‰çš„ä»˜æ¬¾æ–¹å¼
                             paymentMethod: defaultValues.paymentMethod || 'cash',
                             payer: defaultValues.payer || currentMember?.name || tripData?.members?.[0]?.name || 'æˆ‘',
                             category: defaultValues.category || '',
                             date: defaultValues.date || selectedDate 
                         }); 
                     } else { 
                         setFormData({ 
                             time: '09:00', title: '', note: '', transport: 'walk', duration: '60', 
                             bookingCode: '', cost: '', 
                             currency: tripData?.currency || 'JPY', 
                             // [MODIFIED] æ–°å¢é è¨­ä»˜æ¬¾æ–¹å¼
                             paymentMethod: 'cash',
                             payer: currentMember?.name || tripData?.members?.[0]?.name || 'æˆ‘', 
                             category: '', 
                             photoUrls: [],
                             date: selectedDate
                         }); 
                     }
                     setIsAddingCat(false);
                     setNewCatName("");
                 }
            }, [isOpen, defaultValues, tripData, currentMember, selectedDate]);

            // Effect: Auto-set category based on transport if category is empty
            useEffect(() => {
                if (!formData.category && isOpen && !defaultValues) {
                    if (['train', 'bus', 'taxi', 'car', 'plane', 'shinkansen', 'nightbus', 'tram'].includes(formData.transport)) {
                        setFormData(p => ({ ...p, category: 'äº¤é€š' }));
                    } else {
                        setFormData(p => ({ ...p, category: 'å¨›æ¨‚' }));
                    }
                }
            }, [formData.transport, isOpen, defaultValues]);

            if (!isOpen) return null;
            const handleSave = () => { 
                if(!formData.title.trim()) return alert('è«‹è¼¸å…¥åç¨±'); 
                onSave({...formData, cost: parseFloat(formData.cost)||0}); 
                onClose(); 
            };
            
            const handleFile = async (e) => { 
                const f = e.target.files[0]; 
                if(f) { 
                    const url = await processImageUpload(f); 
                    if(url) setFormData(p => ({...p, photoUrls: [...(p.photoUrls || []), url]})); 
                } 
                e.target.value = ''; 
            };
            
            const hasCost = formData.cost && parseFloat(formData.cost) > 0;

            return (
                <>
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 bg-black/20" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-[85%] sm:max-w-sm rounded-t-3xl sm:rounded-2xl overflow-hidden border border-[#eeeeee] relative z-10 flex flex-col max-h-[90vh]">
                        <div className="bg-[#6A8E83] p-3 text-center text-white font-bold relative">{defaultValues ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹'}<button onClick={onClose} className="absolute right-3"><X size={20}/></button></div>
                        <div className="p-4 space-y-4 overflow-y-auto flex-1">
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs text-gray-400 font-bold block">æ—¥æœŸ</label><input type="date" value={formData.date} onChange={e=>setFormData({...formData, date:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]" /></div>
                                <div className="flex-1"><label className="text-xs text-gray-400 font-bold block">æ™‚é–“</label><input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]" /></div>
                            </div>
                            <div><label className="text-xs text-gray-400 font-bold block">åç¨±</label><input value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})} className="w-full p-2 bg-[#E2E2E2] rounded-xl text-sm font-bold text-gray-700 border border-[#eeeeee]" autoFocus /></div>
                            
                            <div><label className="text-xs text-gray-400 font-bold block">å‚™è¨»</label><textarea value={formData.note} onChange={e=>setFormData({...formData, note:e.target.value})} rows={2} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm resize-none text-gray-700 border border-[#eeeeee]" /></div>
                            <div className="flex gap-2">
                                <div className="w-1/2"><label className="text-xs text-gray-400 font-bold block">äº¤é€š</label><select value={formData.transport} onChange={e=>setFormData({...formData, transport:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]">{transportOptions.map(t=><option key={t.value} value={t.value}>{t.label}</option>)}</select></div>
                                <div className="w-1/2"><label className="text-xs text-gray-400 font-bold block">åœç•™</label><select value={formData.duration} onChange={e=>setFormData({...formData, duration:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]">{durationOptions.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}</select></div>
                            </div>
                            
                            {/* Cost & Expense Section */}
                            <div className="border-t border-[#eeeeee] pt-2">
                                <div className="flex justify-between mb-2"><span className="text-xs font-bold text-gray-400">è²»ç”¨èˆ‡è¨˜å¸³</span></div>
                                <div className="flex gap-2 mb-2 items-start">
                                    <div className="flex-1 flex flex-col gap-2">
                                        {/* Cost Input - Wrapped for styling match */}
                                        {/* [MODIFIED] é«˜åº¦å¾ 38px èª¿æ•´ç‚º 42px ä»¥é…åˆå³å´ */}
                                        <div className="flex items-center bg-[#E2E2E2] rounded-xl px-2 border border-[#eeeeee] h-[42px]">
                                            <span className="text-xs text-gray-400">$</span>
                                            <input type="number" value={formData.cost} onChange={e=>setFormData({...formData, cost:e.target.value})} placeholder="é‡‘é¡" className="w-full bg-transparent p-2 text-sm outline-none text-gray-700 placeholder-gray-400" />
                                        </div>
                                        
                                        {/* Category - Fixed Display with Add Button */}
                                        <div>
                                            {/* Header with fixed height to match Payer header */}
                                            <div className="flex justify-between items-center mb-1 h-[16px]">
                                                <label className="text-[10px] text-gray-400 font-bold">åˆ†é¡</label>
                                                <button onClick={() => setIsAddingCat(!isAddingCat)} className="text-[10px] text-[#6A8E83] hover:text-[#557269] flex items-center gap-1 font-bold">
                                                    {isAddingCat ? 'å–æ¶ˆ' : '+ æ–°å¢'}
                                                </button>
                                            </div>
                                            {isAddingCat ? (
                                                <div className="flex gap-1 h-[34px]">
                                                    <input 
                                                        value={newCatName}
                                                        onChange={e => setNewCatName(e.target.value)}
                                                        placeholder="æ–°åˆ†é¡"
                                                        className="w-full bg-[#E2E2E2] rounded-xl p-2 text-xs text-gray-700 border border-[#eeeeee] outline-none focus:ring-1 focus:ring-[#6A8E83]"
                                                        autoFocus
                                                        onKeyDown={(e) => {
                                                            if (e.key === 'Enter') {
                                                                e.preventDefault();
                                                                if (newCatName.trim()) {
                                                                    const currentCats = tripData.expenseCategories || [];
                                                                    if (!currentCats.includes(newCatName.trim())) {
                                                                        onUpdateCategories([...currentCats, newCatName.trim()]);
                                                                        setFormData({ ...formData, category: newCatName.trim() });
                                                                    }
                                                                    setNewCatName("");
                                                                    setIsAddingCat(false);
                                                                }
                                                            }
                                                        }}
                                                    />
                                                    <button 
                                                        onClick={() => {
                                                            if (newCatName.trim()) {
                                                                const currentCats = tripData.expenseCategories || [];
                                                                if (!currentCats.includes(newCatName.trim())) {
                                                                    onUpdateCategories([...currentCats, newCatName.trim()]);
                                                                    setFormData({ ...formData, category: newCatName.trim() });
                                                                }
                                                                setNewCatName("");
                                                                setIsAddingCat(false);
                                                            }
                                                        }}
                                                        className="bg-[#6A8E83] text-white px-2 rounded-lg text-xs"
                                                    >
                                                        <Check size={14} />
                                                    </button>
                                                </div>
                                            ) : (
                                                <select value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl px-2 py-0 h-[34px] text-xs font-bold text-gray-700 border border-[#eeeeee]">
                                                    {(tripData.expenseCategories || []).map(c=><option key={c} value={c}>{c}</option>)}
                                                </select>
                                            )}
                                        </div>
                                    </div>
                                    <div className="w-[35%] flex flex-col gap-2">
                                        
                                        {/* [MODIFIED] Payment Method & Currency Row - Updated to match ExpenseModal style */}
                                        <div className="flex gap-1 h-[42px]">
                                            {/* Payment Method (Cash/Card) */}
                                            <div className="flex-1 bg-[#E2E2E2] rounded-xl px-0 border border-[#eeeeee] flex flex-col justify-center">
                                                <label className="text-[9px] text-gray-400 font-bold text-center -mt-1">æ”¯ä»˜</label>
                                                <select 
                                                    value={formData.paymentMethod} 
                                                    onChange={e=>setFormData({...formData, paymentMethod:e.target.value})} 
                                                    className="w-full bg-transparent p-0 text-sm font-bold text-gray-700 outline-none border-none text-center appearance-none"
                                                >
                                                    <option value="cash">ç¾é‡‘</option>
                                                    <option value="card">ä¿¡ç”¨å¡</option>
                                                </select>
                                            </div>

                                            {/* Currency (Reduced width) */}
                                            <div className="w-[45%] bg-[#E2E2E2] rounded-xl px-0 border border-[#eeeeee] flex flex-col justify-center">
                                                <label className="text-[9px] text-gray-400 font-bold text-center -mt-1">å¹£åˆ¥</label>
                                                <select value={formData.currency} onChange={e=>setFormData({...formData, currency:e.target.value})} className="w-full bg-transparent p-0 text-sm font-bold text-gray-700 outline-none border-none text-center appearance-none">
                                                    {currencies.map(c=><option key={c.value} value={c.value}>{c.value}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        
                                        {/* Payer - Fixed Display */}
                                        <div>
                                            <div className="flex justify-between items-center mb-1 h-[16px]">
                                                <label className="text-[10px] text-gray-400 font-bold block">ä»˜æ¬¾äºº</label>
                                            </div>
                                            <select value={formData.payer} onChange={e=>setFormData({...formData, payer:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl px-2 py-0 h-[34px] text-xs font-bold text-gray-700 border border-[#eeeeee]">
                                                {tripData.members.map(m => (
                                                    // FIX: Guard clause to prevent crash if member is null
                                                    m ? <option key={m.name} value={m.name}>{m.name}</option> : null
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-2">
                                    <input value={formData.bookingCode} onChange={e=>setFormData({...formData, bookingCode:e.target.value})} placeholder="è¨‚ä½/ç¥¨åˆ¸ä»£ç¢¼ (é¸å¡«)" className="w-full bg-[#E2E2E2] rounded-xl p-2 text-xs text-gray-700 border border-[#eeeeee]" />
                                </div>
                            </div>

                            <div>
                                <label className="text-xs text-gray-400 font-bold block mb-2"></label>
                                <div className="flex gap-2 overflow-x-auto">
                                    {formData.photoUrls?.map((url, i) => (
                                        <div key={i} className="relative w-10 h-10 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded-lg" /><button onClick={() => setConfirm({open:true, idx:i})} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button></div>
                                    ))}
                                    <button onClick={()=>fileRef.current.click()} className="w-10 h-10 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center"><Camera size={16}/></button>
                                    <input type="file" ref={fileRef} className="hidden" onChange={handleFile} />
                                </div>
                            </div>
                            <button onClick={handleSave} className="w-full py-3 bg-[#6A8E83] text-white rounded-xl font-bold shadow-md border border-[#6A8E83]">{defaultValues ? 'å„²å­˜è®Šæ›´' : 'åŠ å…¥è¡Œç¨‹'}</button>
                        </div>
                    </div>
                    <ConfirmModal isOpen={confirm.open} message="ç¢ºå®šåˆªé™¤ç…§ç‰‡ï¼Ÿ" onConfirm={() => { const n = [...formData.photoUrls]; n.splice(confirm.idx, 1); setFormData({...formData, photoUrls: n}); setConfirm({open:false}); }} onCancel={() => setConfirm({open:false})} />
                </div>
                </>
            );
        };

        // [FIX] è£œå›éºå¤±çš„ ExpenseModal å…ƒä»¶
        const ExpenseModal = ({ isOpen, onClose, onSave, onUpdateCategories, selectedDate, currentMember, defaultValues, tripData }) => {
            // [MODIFIED] æ–°å¢ paymentMethod ç‹€æ…‹
            const [formData, setFormData] = useState({ date: selectedDate, time: '', cost: '', title: '', payer: '', currency: '', paymentMethod: 'cash', category: '', photoUrls: [], note: '' });
            
            // [MODIFIED] æ”¹ç”¨ isAddingCat æ¨¡å¼ä¾†ç®¡ç†åˆ†é¡æ–°å¢ (èˆ‡æ–°å¢è¡Œç¨‹ä¸€è‡´)
            const [isAddingCat, setIsAddingCat] = useState(false);
            const [newCatName, setNewCatName] = useState("");
            
            const [confirm, setConfirm] = useState({ open: false, action: null, msg: '' });
            const fileRef = useRef(null);
            
            useEffect(() => {
                 if(isOpen) {
                     if (defaultValues) {
                         setFormData({
                             date: defaultValues.originalDate || selectedDate,
                             time: defaultValues.time || '',
                             cost: defaultValues.cost || '',
                             title: defaultValues.title || '',
                             payer: defaultValues.payer || '',
                             currency: defaultValues.currency || '',
                             // [MODIFIED] è¼‰å…¥ paymentMethod
                             paymentMethod: defaultValues.paymentMethod || 'cash',
                             category: defaultValues.category || '',
                             photoUrls: defaultValues.photoUrls || [],
                             note: defaultValues.note || ''
                         });
                     } else {
                         setFormData({ 
                             date: selectedDate,
                             time: new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}), 
                             cost: '', 
                             title: '', 
                             payer: currentMember?.name || tripData?.members?.[0]?.name || 'æˆ‘', 
                             currency: tripData?.currency || 'JPY', 
                             // [MODIFIED] é è¨­ paymentMethod
                             paymentMethod: 'cash',
                             category: 'é¤é£²', 
                             photoUrls: [],
                             note: ''
                         });
                     }
                     // Reset UI states
                     setIsAddingCat(false);
                     setNewCatName("");
                 }
            }, [isOpen, tripData, currentMember, defaultValues, selectedDate]);

            if (!isOpen) return null;
            
            const handleFile = async (e) => { 
                const f = e.target.files[0]; 
                if(f) { 
                    const url = await processImageUpload(f); 
                    if(url) setFormData(p => ({...p, photoUrls: [...(p.photoUrls || []), url]})); 
                } 
                e.target.value=''; 
            };
            
            return (
                <>
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 bg-black/20" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-[85%] sm:max-w-sm rounded-t-3xl sm:rounded-2xl overflow-hidden border border-[#eeeeee] relative z-10 flex flex-col max-h-[90vh]">
                        <div className="bg-[#D68C68] p-3 text-center text-white font-bold relative">{defaultValues ? 'ç·¨è¼¯è¨˜å¸³' : 'æ–°å¢è¨˜å¸³'}<button onClick={onClose} className="absolute right-3"><X size={20}/></button></div>
                        <div className="p-4 space-y-4 overflow-y-auto flex-1">
                            
                            {/* Row 1: Date & Time */}
                            <div className="flex gap-2">
                                <div className="flex-1">
                                    <label className="text-xs text-gray-400 font-bold block mb-1">æ—¥æœŸ</label>
                                    <input type="date" value={formData.date} onChange={e=>setFormData({...formData, date:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]" />
                                </div>
                                <div className="w-1/3">
                                    <label className="text-xs text-gray-400 font-bold block mb-1">æ™‚é–“</label>
                                    <input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]" />
                                </div>
                            </div>

                            {/* Row 2: Title */}
                            <div>
                                <label className="text-xs text-gray-400 font-bold block mb-1">åç¨±</label>
                                <input value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-3 text-sm font-bold text-gray-700 border border-[#eeeeee]" placeholder="æ¶ˆè²»é …ç›®åç¨±" />
                            </div>

                            {/* Row 3: Note */}
                            <div>
                                <label className="text-xs text-gray-400 font-bold block mb-1">å‚™è¨»</label>
                                <textarea value={formData.note} onChange={e=>setFormData({...formData, note:e.target.value})} rows={2} placeholder="å‚™è¨»..." className="w-full bg-[#E2E2E2] rounded-xl p-3 text-sm font-bold text-gray-700 border border-[#eeeeee] resize-none" />
                            </div>

                            {/* Row 4: Cost | Payment | Currency */}
                            <div className="flex gap-2 items-end">
                                {/* Left: Cost Input */}
                                <div className="flex-1">
                                    <label className="text-xs text-gray-400 font-bold block mb-1">é‡‘é¡</label>
                                    <div className="flex items-center bg-[#E2E2E2] rounded-xl px-2 border border-[#eeeeee] h-[42px]">
                                        <DollarSign className="text-gray-400 mr-1" size={16} />
                                        <input type="number" value={formData.cost} onChange={e=>setFormData({...formData, cost:e.target.value})} className="w-full bg-transparent p-2 text-xl font-bold text-gray-800 outline-none placeholder-gray-400" placeholder="0" autoFocus />
                                    </div>
                                </div>

                                {/* Right: Payment & Currency (Width ratio matches ActivityModal: 35%) */}
                                <div className="w-[35%] flex gap-1 h-[42px]">
                                    {/* Payment Method */}
                                    <div className="flex-1 bg-[#E2E2E2] rounded-xl px-0 border border-[#eeeeee] flex flex-col justify-center">
                                        <label className="text-[9px] text-gray-400 font-bold text-center -mt-1">æ”¯ä»˜</label>
                                        <select 
                                            value={formData.paymentMethod} 
                                            onChange={e=>setFormData({...formData, paymentMethod:e.target.value})} 
                                            className="w-full bg-transparent p-0 text-sm font-bold text-gray-700 outline-none border-none text-center appearance-none"
                                        >
                                            <option value="cash">ç¾é‡‘</option>
                                            <option value="card">ä¿¡ç”¨å¡</option>
                                        </select>
                                    </div>

                                    {/* Currency (Width 45%) */}
                                    <div className="w-[45%] bg-[#E2E2E2] rounded-xl px-0 border border-[#eeeeee] flex flex-col justify-center">
                                        <label className="text-[9px] text-gray-400 font-bold text-center -mt-1">å¹£åˆ¥</label>
                                        <select value={formData.currency} onChange={e=>setFormData({...formData, currency:e.target.value})} className="w-full bg-transparent p-0 text-sm font-bold text-gray-700 outline-none border-none text-center appearance-none">
                                            {currencies.map(c=><option key={c.value} value={c.value}>{c.value}</option>)}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            {/* Row 5: Category | Payer */}
                            <div className="flex gap-2">
                                {/* Category Dropdown */}
                                <div className="flex-1">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-xs text-gray-400 font-bold">åˆ†é¡</label>
                                        <button onClick={() => setIsAddingCat(!isAddingCat)} className="text-[10px] text-[#D68C68] hover:text-[#b57b5c] flex items-center gap-1 font-bold">
                                            {isAddingCat ? 'å–æ¶ˆ' : '+ æ–°å¢'}
                                        </button>
                                    </div>
                                    
                                    {isAddingCat ? (
                                        <div className="flex gap-1 h-[42px]">
                                            <input value={newCatName} onChange={e => setNewCatName(e.target.value)} placeholder="æ–°åˆ†é¡" className="w-full bg-[#E2E2E2] rounded-xl p-2 text-xs text-gray-700 border border-[#eeeeee] outline-none focus:ring-1 focus:ring-[#D68C68]" autoFocus onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); if (newCatName.trim()) { const currentCats = tripData.expenseCategories || []; if (!currentCats.includes(newCatName.trim())) { onUpdateCategories([...currentCats, newCatName.trim()]); setFormData({ ...formData, category: newCatName.trim() }); } setNewCatName(""); setIsAddingCat(false); } } }} />
                                            <button onClick={() => { if (newCatName.trim()) { const currentCats = tripData.expenseCategories || []; if (!currentCats.includes(newCatName.trim())) { onUpdateCategories([...currentCats, newCatName.trim()]); setFormData({ ...formData, category: newCatName.trim() }); } setNewCatName(""); setIsAddingCat(false); } }} className="bg-[#D68C68] text-white px-2 rounded-lg text-xs"><Check size={14} /></button>
                                        </div>
                                    ) : (
                                        <select value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl px-2 h-[42px] text-sm font-bold text-gray-700 border border-[#eeeeee]">
                                            {(tripData.expenseCategories||[]).map(c=><option key={c} value={c}>{c}</option>)}
                                        </select>
                                    )}
                                </div>

                                {/* Payer Dropdown */}
                                <div className="flex-1">
                                    <label className="text-xs text-gray-400 font-bold block mb-1">ä»˜æ¬¾äºº</label>
                                    <select value={formData.payer} onChange={e=>setFormData({...formData, payer:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl px-2 h-[42px] text-sm font-bold text-gray-700 border border-[#eeeeee]">
                                        {tripData.members.map(m => (
                                            m ? <option key={m.name} value={m.name}>{m.name}</option> : null
                                        ))}
                                    </select>
                                </div>
                            </div>

                            {/* Row 6: Photos */}
                            <div>
                                <label className="text-xs text-gray-400 font-bold block mb-2">ç…§ç‰‡</label>
                                <div className="flex gap-2 overflow-x-auto">
                                    {formData.photoUrls?.map((url, i)=><div key={i} className="relative w-10 h-10 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded-lg" /><button onClick={()=>setConfirm({open:true, msg:'åˆªé™¤ç…§ç‰‡?', action:()=>{const n=[...formData.photoUrls]; n.splice(i,1); setFormData({...formData, photoUrls:n})}})} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button></div>)}
                                    <button onClick={()=>fileRef.current.click()} className="w-10 h-10 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center"><Camera size={16}/></button>
                                    <input type="file" ref={fileRef} className="hidden" onChange={handleFile} />
                                </div>
                            </div>
                            
                            <button onClick={()=>{if(parseFloat(formData.cost)>0) { onSave(formData); }}} disabled={!formData.cost} className="w-full py-3 bg-[#D68C68] text-white rounded-xl font-bold shadow-md border border-[#D68C68]">{defaultValues ? 'å„²å­˜è®Šæ›´' : 'å„²å­˜'}</button>
                        </div>
                    </div>
                    <ConfirmModal isOpen={confirm.open} message={confirm.msg} onConfirm={()=>{confirm.action(); setConfirm({open:false});}} onCancel={()=>setConfirm({open:false})} />
                </div>
                </>
            );
        };

        const HeaderWithTabs = ({ tripData, selectedDate, setSelectedDate, handleAddDate, view, setView, setIsMenuOpen, onManageMembers, onExportExpenses, isOffline }) => {
            const datesList = useMemo(() => tripData ? getDatesArray(tripData.startDate, tripData.endDate) : [], [tripData]);
            
            return (
                <div className="bg-[#0ABAB5] z-10 relative flex flex-col">
                    {/* Top Row */}
                    <div className="text-white px-3 pt-3 pb-1 flex justify-between items-start">
                        <div className="flex items-center gap-3">
                            <button onClick={() => setIsMenuOpen(true)}><Menu size={24}/></button>
                            <h1 className="font-bold leading-tight text-lg">{tripData.destination}</h1>
                        </div>
                        <div className="flex items-center gap-1">
                             <div 
                                className="w-8 h-8 flex items-center justify-center text-white rounded-full cursor-pointer hover:bg-white/10"
                                onClick={() => {
                                    if (isOffline) {
                                        alert("ç›®å‰ç‚ºé›¢ç·šæ¨¡å¼ï¼Œç„¡æ³•ç”¢ç”Ÿåˆ†äº«é€£çµã€‚");
                                    } else {
                                        // ç”¢ç”Ÿä¸€éµåˆ†äº«åŒ…
                                        const fbConfigStr = localStorage.getItem('gtp_firebase_config');
                                        const imgbbKeyStr = localStorage.getItem('gtp_imgbb_key');
                                        if (fbConfigStr) {
                                            try {
                                                const bundle = {
                                                    id: tripData.id,
                                                    firebase: JSON.parse(fbConfigStr),
                                                    imgbb: imgbbKeyStr || ''
                                                };
                                                const textToCopy = JSON.stringify(bundle);
                                                const textArea = document.createElement("textarea");
                                                textArea.value = textToCopy;
                                                document.body.appendChild(textArea);
                                                textArea.select();
                                                document.execCommand("Copy");
                                                textArea.remove();
                                                alert("å·²è¤‡è£½ã€Œä¸€éµè¨­å®šæ‡¶äººåŒ…ã€ï¼\n\næœ‹å‹åªéœ€åœ¨é¦–é è²¼ä¸Šé€™ä¸²ä»£ç¢¼ï¼Œå³å¯è‡ªå‹•è¨­å®šé€£ç·šä¸¦åŠ å…¥æ—…ç¨‹ã€‚");
                                            } catch (e) {
                                                console.error("Bundle error", e);
                                                alert("ç”¢ç”Ÿåˆ†äº«é€£çµå¤±æ•—");
                                            }
                                        }
                                    }
                                }}
                                title={isOffline ? "ç›®å‰ç‚ºé›¢ç·šæ¨¡å¼" : "é»æ“Šè¤‡è£½ä¸€éµåˆ†äº«æ‡¶äººåŒ…"}
                            >
                                {isOffline ? <WifiOff size={16} className="text-red-300"/> : <Wifi size={16} className="text-[#00FF00]"/>}
                            </div>
                        </div>
                    </div>
                    
                    {/* Bottom Row: Dates + Dollar Button */}
                    <div className="flex items-center pl-2 pr-3 pb-2 gap-2">
                        {/* Date List */}
                        <div className="flex-1 flex overflow-x-auto space-x-2 no-scrollbar">
                            {datesList.map((d, i) => (
                                <button 
                                    key={d} 
                                    onClick={() => { setSelectedDate(d); setView('planner'); }} 
                                    className={`flex-shrink-0 w-10 h-10 flex flex-col items-center justify-center rounded-xl transition-all duration-200 border ${d === selectedDate ? 'bg-[#F5FDFC] text-[#00695C] font-bold border-[#eeeeee]' : 'bg-[#008985] text-white opacity-90 border-transparent'}`}
                                >
                                    <span className="text-[8px] leading-none opacity-80">D{i+1}</span>
                                    <span className="text-[10px] font-bold leading-tight my-0.5">{getMonthDay(d)}</span>
                                    <span className="text-[8px] leading-none opacity-90">{getDayOfWeek(d)}</span>
                                </button>
                            ))}
                            <button onClick={handleAddDate} className="flex-shrink-0 w-10 h-10 flex items-center justify-center border border-dashed border-white/50 rounded-xl text-white"><Plus size={20}/></button>
                        </div>

                        {/* Dollar Button - Centered with dates, Scaled Down 10% */}
                        <button onClick={() => setView(view === 'planner' ? 'expense' : 'planner')} className="flex-shrink-0 w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-yellow-900 ring-2 ring-[#D68C68] transform hover:scale-105 transition-transform">
                            <DollarSign size={20} strokeWidth={3} />
                        </button>
                    </div>
                    
                    {/* Export button removed from here */}

                </div>
            );
        };

        const App = () => {
            
            // Lazy Initialize State from LocalStorage
            const getRestoredState = () => {
                try {
                    const saved = localStorage.getItem('gtp_session_restore');
                    if (saved) return JSON.parse(saved); // Just read, do NOT remove here
                } catch(e) {}
                return null;
            };
            
            // Initialize from restored state
            const [restored] = useState(getRestoredState);

            const [userId, setUserId] = useState(getOrCreateUserId());
            const [view, setView] = useState(restored?.view || 'landing'); // DEFAULT TO LANDING IF NO RESTORED VIEW
            const [tripId, setTripId] = useState(restored?.tripId || '');
            const [tripData, setTripData] = useState(null);
            const [selectedDate, setSelectedDate] = useState(restored?.selectedDate || '');
            
            // Fix: Use ref to track selectedDate to avoid stale closure in onSnapshot
            const selectedDateRef = useRef(selectedDate);
            useEffect(() => { selectedDateRef.current = selectedDate; }, [selectedDate]);

            const [modals, setModals] = useState({ expense: false, activity: false, viewingImage: null, transaction: null, editTrip: false, members: false, join: false });
            const [expandedId, setExpandedId] = useState(null);
            const [recentTrips, setRecentTrips] = useState([]);
            
            // Restore setup form data if available
            const [setupForm, setSetupForm] = useState(
                restored?.setupForm || { 
                    destination: '', 
                    // FIX: Use robust formatter instead of locale-dependent string (en-CA)
                    startDate: toLocalISOString(new Date()), 
                    endDate: toLocalISOString(new Date(Date.now() + 4 * 24 * 60 * 60 * 1000)), 
                    currency: 'JPY', 
                    nickname: '', 
                    pin: '' 
                }
            );
            
            const [confirm, setConfirm] = useState({ open: false, msg: '', action: null });
            const [joinId, setJoinId] = useState('');
            const fileRef = useRef(null);
            const [uploadTarget, setUploadTarget] = useState(null);
            const [expenseFilterDate, setExpenseFilterDate] = useState('all');
            const [expenseListFilterDate, setExpenseListFilterDate] = useState('all'); // [NEW] æ–°å¢ï¼šè©³ç´°åˆ—è¡¨å°ˆç”¨çš„æ—¥æœŸç¯©é¸ç‹€æ…‹
            const [expenseFilterPayer, setExpenseFilterPayer] = useState('all'); // æ–°å¢ï¼šä»˜æ¬¾äººç¯©é¸ç‹€æ…‹
            const [expenseFilterCurrency, setExpenseFilterCurrency] = useState('all'); // æ–°å¢ï¼šå¹£åˆ¥ç¯©é¸ç‹€æ…‹
            
            // [NEW] æ–°å¢çµ±è¨ˆæª¢è¦–æ¨¡å¼ç‹€æ…‹ï¼š'category' (ä¾é¡åˆ¥) æˆ– 'member' (ä¾æˆå“¡)
            const [expenseViewMode, setExpenseViewMode] = useState('category');
            
            // [NEW] ä¸‹é‘½åˆ†é¡ç‹€æ…‹ï¼šè‹¥æœ‰å€¼ï¼Œä»£è¡¨æ­£åœ¨æª¢è¦–è©²åˆ†é¡çš„æˆå“¡åˆ†æ”¤è©³æƒ…
            const [drillDownCategory, setDrillDownCategory] = useState(null);

            const [isCreating, setIsCreating] = useState(false); 
            const [editingActivity, setEditingActivity] = useState(null);
            const [editingExpense, setEditingExpense] = useState(null); // æ–°å¢ï¼šæ­£åœ¨ç·¨è¼¯çš„è¨˜å¸³é …ç›®
            const [currentMember, setCurrentMember] = useState(null); 
            const [authError, setAuthError] = useState(null);
            const [connectionTimeout, setConnectionTimeout] = useState(false); 
            const [isMenuOpen, setIsMenuOpen] = useState(false); // Add missing state
            
            // Firebase states (default to offline/local)
            const [isOffline, setIsOffline] = useState(true);
            const [user, setUser] = useState(null); // Auth user
            const unsubscribeRef = useRef(null);
            const authUnsubscribeRef = useRef(null);
            
            // Derived state placed early to ensure scope availability
            const isOwner = currentMember?.role === 'owner';
            
            // Load recent trips and cleanup restore state on mount
            useEffect(() => {
                const storedRecents = localStorage.getItem('gtp_recent_trips');
                if (storedRecents) {
                    try {
                        setRecentTrips(JSON.parse(storedRecents));
                    } catch (e) {
                        console.error("Error parsing recent trips", e);
                        localStorage.removeItem('gtp_recent_trips');
                    }
                }
                
                // Clear restore data AFTER it's been used for initialization
                // We use a small timeout to ensure the app has fully mounted and state is settled
                const timer = setTimeout(() => {
                    localStorage.removeItem('gtp_session_restore');
                }, 500);

                // Check if firebase config exists, try to init (silent mode)
                const storedConfig = localStorage.getItem('gtp_firebase_config');
                if (storedConfig) {
                    try {
                        reInit(JSON.parse(storedConfig));
                    } catch (e) {
                        console.error("Error parsing firebase config", e);
                        // Don't nuke config, might be transient error, but fallback to local
                        setIsOffline(true);
                        setUser({ uid: 'local' });
                    }
                } else {
                    // Fix: If no config, default to local mode immediately
                    setIsOffline(true);
                    setUser({ uid: 'local' });
                }

                return () => clearTimeout(timer);
            }, []);

            const reInit = async (config) => {
                 // Cleanup existing auth listener
                 if (authUnsubscribeRef.current) {
                    authUnsubscribeRef.current();
                    authUnsubscribeRef.current = null;
                 }
                 
                 if (!config) {
                    setIsOffline(true);
                    setUser({ uid: 'local' }); // Fix: Set dummy user for local mode
                    return;
                 }

                 // If we have active apps, try to delete them to start fresh (simple hot reload logic)
                 if (getApps().length > 0) {
                     try {
                        await Promise.all(getApps().map(app => deleteApp(app)));
                     } catch(e) { console.warn("Cleanup failed", e); }
                 }

                 try {
                    const app = initializeApp(config);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    
                    // [NEW] å•Ÿç”¨ Firebase åŸç”Ÿé›¢ç·šæŒä¹…åŒ– (Offline Persistence)
                    // é€™è®“ App åœ¨ç¶²è·¯æ–·ç·šæ™‚ä»å¯è®€å¯«å¿«å–è³‡æ–™ï¼Œé€£ç·šå¾Œè‡ªå‹•åŒæ­¥
                    try {
                        await enableIndexedDbPersistence(db);
                        console.log("Firebase Offline Persistence Enabled");
                    } catch (err) {
                        if (err.code == 'failed-precondition') {
                            console.warn('å¤šå€‹åˆ†é é–‹å•Ÿä¸­ï¼ŒæŒä¹…åŒ–åƒ…èƒ½åœ¨ä¸€å€‹åˆ†é å•Ÿç”¨');
                        } else if (err.code == 'unimplemented') {
                            console.warn('ç€è¦½å™¨ä¸æ”¯æ´æŒä¹…åŒ–åŠŸèƒ½');
                        }
                    }
                    
                    // Wait for auth state
                    await signInAnonymously(auth);

                    // --- IDENTITY MIGRATION FIX START ---
                    const fbUser = auth.currentUser;
                    const localOfflineId = localStorage.getItem('gtp_local_uid');

                    if (fbUser && localOfflineId && fbUser.uid !== localOfflineId) {
                        console.log(`[Identity Migration] Migrating from ${localOfflineId} to ${fbUser.uid}`);
                        
                        // FIX: Use for...of to allow await inside loop
                        const keys = Object.keys(localStorage);
                        for (const key of keys) {
                            if (key.startsWith('gtp_trip_')) {
                                try {
                                    const rawData = localStorage.getItem(key);
                                    if (rawData) {
                                        const tripObj = JSON.parse(rawData);
                                        let isModified = false;

                                        // æª¢æŸ¥ä¸¦æ›´æ–°æˆå“¡åˆ—è¡¨ä¸­çš„ deviceId
                                        if (tripObj.members && Array.isArray(tripObj.members)) {
                                            tripObj.members = tripObj.members.map(m => {
                                                if (m.deviceId === localOfflineId) {
                                                    isModified = true;
                                                    return { ...m, deviceId: fbUser.uid };
                                                }
                                                return m;
                                            });
                                        }

                                        if (isModified) {
                                            // å¯«å› localStorage
                                            localStorage.setItem(key, JSON.stringify(tripObj));
                                            
                                            // FIX: Upload migrated data IMMEDIATELY to cloud to prevent onSnapshot from overwriting it with old data
                                            try {
                                                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripObj.id), sanitizeFirestoreData(tripObj));
                                                console.log(`[Identity Migration] Synced ${tripObj.id} to cloud`);
                                            } catch (uploadErr) {
                                                console.error("Migration upload failed", uploadErr);
                                            }

                                            // å¦‚æœé€™å‰›å¥½æ˜¯ç•¶å‰æ­£åœ¨é¡¯ç¤ºçš„æ—…ç¨‹ï¼ŒåŒæ­¥æ›´æ–° React Stateï¼Œé¿å… UI æ¬Šé™åˆ¤æ–·éŒ¯èª¤
                                            if (tripObj.id === tripId) {
                                                setTripData(tripObj);
                                                const newSelf = tripObj.members.find(m => m.deviceId === fbUser.uid);
                                                if (newSelf) setCurrentMember(newSelf);
                                            }
                                        }
                                    }
                                } catch (err) {
                                    console.error("[Identity Migration] Error processing trip:", key, err);
                                }
                            }
                        }
                    }
                    // --- IDENTITY MIGRATION FIX END ---
                    
                    setIsOffline(false);
                    setUser(auth.currentUser);
                    
                    const authUnsub = onAuthStateChanged(auth, (u) => {
                         if (u) {
                             setUser(u);
                         } else {
                             setUser(null);
                         }
                     });
                     authUnsubscribeRef.current = authUnsub;
                 } catch (e) {
                    console.error("Auto-connect failed", e);
                    // Fallback to offline mode on error so UI doesn't freeze
                    setIsOffline(true);
                    setUser({ uid: 'offline_fallback' });
                    alert("é€£ç·šå¤±æ•—ï¼Œå°‡åˆ‡æ›è‡³é›¢ç·šæ¨¡å¼ã€‚éŒ¯èª¤: " + e.message);
                 }
            };

            const handleConfigUpdate = async (config) => {
                 if (unsubscribeRef.current) {
                    unsubscribeRef.current();
                    unsubscribeRef.current = null;
                 }
                 if (authUnsubscribeRef.current) {
                    authUnsubscribeRef.current();
                    authUnsubscribeRef.current = null;
                 }
                 
                 setUser(null);
                 setIsOffline(true);
                 
                 // Add safety timeout to prevent infinite loading
                 const timeoutId = setTimeout(() => {
                     setUser((currentUser) => {
                         if (currentUser === null) {
                             alert("é€£ç·šé€¾æ™‚ï¼Œåˆ‡æ›è‡³é›¢ç·šæ¨¡å¼");
                             setIsOffline(true);
                             return { uid: 'timeout_fallback' };
                         }
                         return currentUser;
                     });
                 }, 10000); // 10 seconds timeout

                 try {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await reInit(config);
                 } catch (e) {
                    console.error("Config update critical failure", e);
                    setUser({ uid: 'error_fallback' });
                 } finally {
                    clearTimeout(timeoutId);
                 }
            };

            useEffect(() => {
                // We don't need to re-run reInit on mount again, it's handled in the first useEffect
                return () => {
                    if (unsubscribeRef.current) unsubscribeRef.current();
                    if (authUnsubscribeRef.current) authUnsubscribeRef.current();
                };
            }, []);

            // --- Data Sync Logic (Hybrid with Auto-Upload) ---
            useEffect(() => {
                if (!tripId) return;

                // [CRITICAL FIX] å¼·åŒ–è³‡æ–™è™•ç†å‡½å¼ï¼šæ·±åº¦æ¸…æ´—èˆ‡å‹åˆ¥çŸ¯æ­£ (Deep Cleaning)
                // ç¢ºä¿ members, expenseCategories ä»¥åŠ itinerary/accommodations å…§çš„æ¯ä¸€å¤©è³‡æ–™çµ•å°æ˜¯é™£åˆ—
                const processLoadedData = (d) => {
                    if (!d || typeof d !== 'object') return null;
                    
                    // 1. åŸºç¤çµæ§‹èˆ‡å¤–å±¤é™£åˆ—æª¢æŸ¥
                    let cleanData = {
                        ...d,
                        // [FIX] Ensure flights object exists and has correct shape
                        flights: {
                            outbound: (d.flights && typeof d.flights === 'object' && d.flights.outbound) || {},
                            inbound: (d.flights && typeof d.flights === 'object' && d.flights.inbound) || {}
                        },
                        expenseCategories: Array.isArray(d.expenseCategories) ? d.expenseCategories : Object.keys(CATEGORY_COLORS),
                        // [FIX] Filter out null/invalid members to prevent crash in statistics
                        members: Array.isArray(d.members) ? d.members.filter(m => m && m.name) : []
                    };

                    // 2. æ·±åº¦æ¸…æ´— itinerary (è¡Œç¨‹)
                    // ç¢ºä¿æ¯ä¸€å¤©çš„è³‡æ–™éƒ½æ˜¯é™£åˆ—ï¼Œè‹¥é‡åˆ°åº•å±¤æ ¼å¼æå£ (è®Šæˆç‰©ä»¶)ï¼Œå˜—è©¦æ•‘æ´è½‰å›é™£åˆ—
                    const cleanItinerary = {};
                    if (d.itinerary && typeof d.itinerary === 'object') {
                        Object.keys(d.itinerary).forEach(date => {
                            const dayActs = d.itinerary[date];
                            if (Array.isArray(dayActs)) {
                                cleanItinerary[date] = dayActs;
                            } else if (dayActs && typeof dayActs === 'object') {
                                // å˜—è©¦æ•‘æ´ï¼šå¦‚æœæ˜¯é¡é™£åˆ—ç‰©ä»¶ï¼Œè½‰å›é™£åˆ—
                                try {
                                    cleanItinerary[date] = Object.values(dayActs);
                                } catch(e) {
                                    cleanItinerary[date] = [];
                                }
                            } else {
                                cleanItinerary[date] = [];
                            }
                        });
                    } else {
                        // è‹¥ itinerary æœ¬èº«å…¨æ¯€ï¼Œé‡ç½®ç‚ºç©ºç‰©ä»¶
                         cleanData.itinerary = {};
                    }
                    if (Object.keys(cleanItinerary).length > 0) cleanData.itinerary = cleanItinerary;


                    // 3. æ·±åº¦æ¸…æ´— accommodations (ä½å®¿)
                    const cleanAccoms = {};
                    if (d.accommodations && typeof d.accommodations === 'object') {
                        Object.keys(d.accommodations).forEach(date => {
                            const dayAccoms = d.accommodations[date];
                            if (Array.isArray(dayAccoms)) {
                                cleanAccoms[date] = dayAccoms;
                            } else if (dayAccoms && typeof dayAccoms === 'object') {
                                try {
                                    cleanAccoms[date] = Object.values(dayAccoms);
                                } catch(e) {
                                    cleanAccoms[date] = [];
                                }
                            } else {
                                cleanAccoms[date] = [];
                            }
                        });
                    } else {
                        cleanData.accommodations = {};
                    }
                    if (Object.keys(cleanAccoms).length > 0) cleanData.accommodations = cleanAccoms;

                    return cleanData;
                };

                // 1. If Offline, load from LocalStorage
                if (isOffline) {
                    const localData = localStorage.getItem(`gtp_trip_${tripId}`);
                    if (localData) {
                        try {
                            const rawData = JSON.parse(localData);
                            const d = processLoadedData(rawData); // ä½¿ç”¨å¼·åŒ–ç‰ˆçš„è™•ç†å‡½å¼
                            
                            // [FIX] Check if data is valid before proceeding
                            if (d) { 
                                setTripData(d);
                                
                                // [CRITICAL FIX] æ™ºæ…§æ—¥æœŸæ ¡æ­£ï¼šå¦‚æœç•¶å‰é¸å–æ—¥æœŸç„¡æ•ˆæˆ–ä¸åœ¨ç¯„åœå…§ï¼Œé‡ç½®ç‚ºé–‹å§‹æ—¥æœŸ
                                // é¿å…åˆ‡æ›æ—…ç¨‹æ™‚åœç•™åœ¨èˆŠæ—¥æœŸå°è‡´ç™½å±(ç©ºç•«é¢)
                                const current = selectedDateRef.current;
                                const inRange = current >= d.startDate && current <= d.endDate;
                                if (!current || !inRange) {
                                    setSelectedDate(d.startDate);
                                }
                                
                                // [FIX] é›¢ç·šæ¨¡å¼åš´æ ¼èº«åˆ†æª¢æŸ¥
                                const found = d.members.find(m => m.deviceId === userId);
                                
                                if (found) {
                                    setCurrentMember(found);
                                    if(view === 'landing' || view === 'setup') {
                                         setView('planner');
                                         setSelectedDate(d.startDate);
                                    }
                                } else {
                                    // æ‰¾ä¸åˆ°èº«åˆ†æ™‚ï¼šå¼·åˆ¶æ¸…ç©ºä¸¦å½ˆå‡ºåŠ å…¥è¦–çª— (ç§»é™¤åŸæœ¬çš„è‡ªå‹•æŒ‡æ´¾ owner é‚è¼¯)
                                    setCurrentMember(null);
                                    setModals(m => ({...m, join: true}));
                                }

                                // Update recent trips
                                setRecentTrips(p => { 
                                    const newRecents = [{id: d.id, destination: d.destination, dateRange: `${d.startDate.slice(5)} - ${d.endDate.slice(5)}`}, ...p.filter(t=>t.id!==d.id)].slice(0,5); 
                                    localStorage.setItem('gtp_recent_trips', JSON.stringify(newRecents)); 
                                    return newRecents; 
                                });
                            } else {
                                throw new Error("è³‡æ–™çµæ§‹ç„¡æ•ˆ");
                            }
                        } catch (e) {
                            console.error("Error loading local data", e);
                            alert("è®€å–æœ¬æ©Ÿè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦æˆ–æª¢æŸ¥è³‡æ–™ã€‚");
                            // [FIX] Reset tripId to prevent stuck loading screen
                            setTripId('');
                            setView('landing');
                        }
                    } else {
                        // Local data not found (should be handled by LandingView, but double check here)
                        if (view !== 'setup') { // Don't alert if we just came from setup (race condition)
                             alert("æ‰¾ä¸åˆ°æ­¤æ—…ç¨‹çš„æœ¬æ©Ÿè³‡æ–™ã€‚");
                             setTripId('');
                             setView('landing');
                        }
                    }
                } else {
                    // 2. If Online, load from Firestore
                    const apps = getApps();
                    if (apps.length === 0) return;
                    const db = getFirestore(apps[0]);

                    if (unsubscribeRef.current) {
                        unsubscribeRef.current();
                        unsubscribeRef.current = null;
                    }
                    
                    const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId), 
                        async (s) => {
                            if(s.exists()) {
                                const d = processLoadedData(s.data()); // ä½¿ç”¨å¼·åŒ–ç‰ˆçš„è™•ç†å‡½å¼
                                
                                if (d) {
                                    setTripData(d);
                                    
                                    // [CRITICAL FIX] æ™ºæ…§æ—¥æœŸæ ¡æ­£ (ç·šä¸Šç‰ˆ)
                                    const current = selectedDateRef.current;
                                    const inRange = current >= d.startDate && current <= d.endDate;
                                    if (!current || !inRange) {
                                        setSelectedDate(d.startDate);
                                    }
                                    
                                    const currentAuthUser = getAuth(apps[0]).currentUser;
                                    if(currentAuthUser) {
                                        // [FIX] ç·šä¸Šæ¨¡å¼åš´æ ¼èº«åˆ†æª¢æŸ¥
                                        const found = d.members.find(m => m.deviceId === currentAuthUser.uid);
                                        if (found) {
                                            setCurrentMember(found);
                                            if(view === 'landing' || view === 'setup') {
                                                setView('planner');
                                                setSelectedDate(d.startDate);
                                            }
                                            // ç¢ºä¿å¦‚æœæ˜¯å·²é©—è­‰æˆå“¡ï¼ŒåŠ å…¥è¦–çª—æ˜¯é—œé–‰çš„
                                            setModals(m => ({...m, join: false}));
                                        } else {
                                            // æ‰¾ä¸åˆ°èº«åˆ†æ™‚ï¼šå¼·åˆ¶æ¸…ç©ºä¸¦å½ˆå‡ºåŠ å…¥è¦–çª—
                                            setCurrentMember(null);
                                            setModals(m => ({...m, join: true}));
                                        }
                                    }
                                    setRecentTrips(p => { 
                                        const newRecents = [{id: d.id, destination: d.destination, dateRange: `${d.startDate.slice(5)} - ${d.endDate.slice(5)}`}, ...p.filter(t=>t.id!==d.id)].slice(0,5); 
                                        localStorage.setItem('gtp_recent_trips', JSON.stringify(newRecents)); 
                                        return newRecents; 
                                    });
                                }
                            } else {
                                // --- AUTO UPLOAD LOGIC ---
                                const localData = localStorage.getItem(`gtp_trip_${tripId}`);
                                if (localData) {
                                    try {
                                            console.log("Auto-uploading local data to Firebase...");
                                            // Process data before upload to ensure integrity
                                            const cleanData = processLoadedData(JSON.parse(localData));
                                            if (cleanData) {
                                                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', tripId), sanitizeFirestoreData(cleanData));
                                            }
                                    } catch (e) {
                                            console.error("Auto-upload failed", e);
                                    }
                                } else {
                                     if (!isOffline) {
                                      alert("æ‰¾ä¸åˆ°æ­¤æ—…ç¨‹ IDï¼Œè«‹ç¢ºèª ID æ˜¯å¦æ­£ç¢ºã€‚");
                                      setTripId('');
                                      setView('landing');
                                     }
                                }
                            }
                        },
                        (error) => {
                            console.error("Snapshot error:", error);
                            alert("è®€å–å¤±æ•—ï¼Œå¯èƒ½æ˜¯æ¬Šé™å•é¡Œæˆ– ID éŒ¯èª¤ã€‚");
                            setTripId('');
                            setView('landing');
                        }
                    );
                    unsubscribeRef.current = unsub;
                }
            }, [user, tripId, isOffline, userId]);

            const handleStart = async () => {
                if (!setupForm.nickname || !setupForm.pin) { alert('è«‹è¼¸å…¥æš±ç¨±èˆ‡ PIN ç¢¼'); return; }
                
                try {
                    const id = generateId();
                    const dates = getDatesArray(setupForm.startDate, setupForm.endDate);
                    const itinerary = {}; dates.forEach(d => itinerary[d] = []);
                    const accoms = {}; dates.forEach(d => { accoms[d] = [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }]; });
                    
                    const currentUid = isOffline ? userId : (user ? user.uid : userId);
                    
                    const initialMember = { name: setupForm.nickname, pin: setupForm.pin, role: 'owner', deviceId: currentUid };
                    
                    const newData = { 
                        id, 
                        ...setupForm, 
                        ownerPin: setupForm.pin,
                        itinerary, 
                        accommodations: accoms, 
                        createdAt: Date.now(), 
                        members: [initialMember], 
                        expenseCategories: Object.keys(CATEGORY_COLORS), 
                        flights: { outbound: {}, inbound: {} } 
                    };
                    
                    if (isOffline) {
                        localStorage.setItem(`gtp_trip_${id}`, JSON.stringify(newData));
                        const newRecent = [{id: newData.id, destination: newData.destination, dateRange: `${newData.startDate.slice(5)} - ${newData.endDate.slice(5)}`}, ...recentTrips].slice(0, 5);
                        setRecentTrips(newRecent);
                        localStorage.setItem('gtp_recent_trips', JSON.stringify(newRecent));
                        setTripData(newData);
                        setCurrentMember(initialMember);
                        setTripId(id);
                        
                        // [CRITICAL FIX] å»ºç«‹å¾Œç«‹å³è¨­å®šé¸å–æ—¥æœŸï¼Œé¿å…é€²å…¥æ™‚ç•«é¢ç©ºç™½
                        setSelectedDate(newData.startDate);
                        
                        setView('planner');
                    } else {
                         const apps = getApps();
                         if (apps.length > 0) {
                             const db = getFirestore(apps[0]);
                             setIsCreating(true);
                             try {
                                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', id), sanitizeFirestoreData(newData));
                                setTripId(id);
                                setCurrentMember(initialMember);
                                
                                // [CRITICAL FIX] å»ºç«‹å¾Œç«‹å³è¨­å®šé¸å–æ—¥æœŸ
                                setSelectedDate(newData.startDate);
                                
                                setView('planner');
                             } catch (e) {
                                 console.error(e);
                                 alert("å»ºç«‹å¤±æ•—: " + e.message);
                             } finally {
                                 setIsCreating(false);
                             }
                         }
                    }
                } catch (err) {
                    console.error("Create trip critical error:", err);
                    alert("å»ºç«‹æ—…ç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤ (å¯èƒ½æ˜¯å„²å­˜ç©ºé–“ä¸è¶³): " + err.message);
                }
            };

            const updateTripData = (newData) => {
                setTripData(newData);
                localStorage.setItem(`gtp_trip_${newData.id}`, JSON.stringify(newData));
            };

            const updateTrip = (field, val) => {
                if (!tripData) return;
                
                if (isOffline) {
                     try {
                         const newData = { ...tripData, [field]: val };
                         setTripData(newData);
                         localStorage.setItem(`gtp_trip_${tripData.id}`, JSON.stringify(newData));
                     } catch (e) {
                         console.error("Local update failed", e);
                         alert("å„²å­˜æœ¬æ©Ÿè³‡æ–™å¤±æ•—: " + e.message);
                     }
                } else {
                     const apps = getApps();
                     if (apps.length > 0) {
                         // FIX: Wrap in try-catch to handle synchronous errors (e.g. invalid doc reference)
                         try {
                             if (!tripId) throw new Error("ç„¡æ•ˆçš„ Trip ID");
                             
                             const db = getFirestore(apps[0]);
                             // Validate tripId string to prevent doc() from throwing hard errors
                             const validTripId = String(tripId).trim();
                             if (!validTripId) throw new Error("Trip ID ç‚ºç©º");

                             updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', validTripId), { [field]: sanitizeFirestoreData(val) })
                                .catch(e => {
                                    console.error("Update trip failed (async):", e);
                                    alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™ã€‚\néŒ¯èª¤: " + e.message);
                                });
                         } catch (e) {
                             console.error("Update trip failed (sync):", e);
                             alert("ç³»çµ±éŒ¯èª¤ (åŒæ­¥): " + e.message);
                         }
                     }
                }
            };
            
            const updateTripFull = (newData) => {
                if (isOffline) {
                     try {
                         setTripData(newData);
                         localStorage.setItem(`gtp_trip_${newData.id}`, JSON.stringify(newData));
                     } catch (e) {
                         console.error("Local full update failed", e);
                         alert("å„²å­˜æœ¬æ©Ÿè³‡æ–™å¤±æ•—: " + e.message);
                     }
                } else {
                     const apps = getApps();
                     if (apps.length > 0) {
                         // FIX: Wrap in try-catch to handle synchronous errors
                         try {
                             if (!tripId) throw new Error("ç„¡æ•ˆçš„ Trip ID");

                             const db = getFirestore(apps[0]);
                             const validTripId = String(tripId).trim();
                             if (!validTripId) throw new Error("Trip ID ç‚ºç©º");

                             setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trips', validTripId), sanitizeFirestoreData(newData))
                                .catch(e => {
                                    console.error("Update full trip failed (async):", e);
                                    alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™ã€‚\néŒ¯èª¤: " + e.message);
                                });
                         } catch (e) {
                             console.error("Update full trip failed (sync):", e);
                             alert("ç³»çµ±éŒ¯èª¤ (åŒæ­¥): " + e.message);
                         }
                     }
                }
            }

            const handleUpdateMember = (index, newInfo) => {
                const newMembers = [...tripData.members];
                const updatedMember = { ...newMembers[index], ...newInfo };
                newMembers[index] = updatedMember;
                
                // [FIX] å¦‚æœæ›´æ–°çš„æ˜¯è‡ªå·±ï¼Œç«‹å³åŒæ­¥æ›´æ–° App çš„ currentMember ç‹€æ…‹ï¼Œé¿å…æ¬Šé™éºå¤±
                if (currentMember && (updatedMember.deviceId === currentMember.deviceId || updatedMember.name === currentMember.name)) {
                    setCurrentMember(updatedMember);
                }
                
                updateTrip('members', newMembers);
            };

            const handleAddMember = (newMember) => {
                const newMembers = [...tripData.members, newMember];
                updateTrip('members', newMembers);
            };

            const handleRemoveMember = (index) => {
                const newMembers = tripData.members.filter((_, i) => i !== index);
                updateTrip('members', newMembers);
            };

            // [FIX] ä¿®æ­£ï¼šæ—…ç¨‹è¨­å®šè®Šæ›´æ™‚ï¼Œè‹¥ä¿®æ”¹äº†è²¨å¹£ï¼Œè‡ªå‹•åŒæ­¥æ›´æ–°æ‰€æœ‰èˆŠè³‡æ–™çš„å¹£åˆ¥ (æº¯åŠæ—¢å¾€)
            const handleEditTripSave = (newData) => {
                if(!isOwner) return;
                
                let updatedItinerary = { ...tripData.itinerary };
                let updatedAccommodations = { ...tripData.accommodations };
                let shouldResetDate = false;
                let newStartDate = newData.startDate;

                // 1. è™•ç†æ—¥æœŸè®Šæ›´ (Handle Date Change)
                if (newData.startDate !== tripData.startDate || newData.endDate !== tripData.endDate) {
                     const newDates = getDatesArray(newData.startDate, newData.endDate);
                     const cleanItinerary = {};
                     const cleanAccoms = {};
                     
                     newDates.forEach(d => { 
                         // ä¿ç•™æ–°æ—¥æœŸç¯„åœå…§çš„èˆŠè³‡æ–™ï¼Œç¯„åœå¤–å‰‡åˆå§‹åŒ–
                         cleanItinerary[d] = tripData.itinerary[d] || []; 
                         cleanAccoms[d] = tripData.accommodations[d] || [{ 
                             id: generateId(), 
                             name: '', 
                             bookingCode: '', 
                             checkInTime: '', 
                             checkOutDate: '', 
                             checkOutTime: '', 
                             phone: '', 
                             address: '', 
                             photoUrls: [] 
                         }]; 
                     });
                     
                     updatedItinerary = cleanItinerary;
                     updatedAccommodations = cleanAccoms;
                     
                     // è‹¥ç•¶å‰é¸å–æ—¥æœŸåœ¨æ–°ç¯„åœå¤–ï¼Œé‡ç½®ç‚ºç¬¬ä¸€å¤©
                     if (!newDates.includes(selectedDate)) {
                         shouldResetDate = true;
                         newStartDate = newDates[0];
                     }
                }

                // 2. è™•ç†è²¨å¹£è®Šæ›´ (Handle Currency Change - Retroactive)
                if (newData.currency !== tripData.currency) {
                    const newCurrency = newData.currency;
                    
                    // æ›´æ–°æ‰€æœ‰è¡Œç¨‹èˆ‡è¨˜å¸³çš„å¹£åˆ¥
                    Object.keys(updatedItinerary).forEach(date => {
                        if (Array.isArray(updatedItinerary[date])) {
                            updatedItinerary[date] = updatedItinerary[date].map(act => {
                                // è‹¥æ˜¯æ¶ˆè²»é …ç›®æˆ–æœ‰å¡«å¯«è²»ç”¨çš„è¡Œç¨‹ï¼Œæ›´æ–°å¹£åˆ¥
                                if (act && (act.transport === 'expense' || (act.cost && parseFloat(act.cost) > 0))) {
                                    return { ...act, currency: newCurrency };
                                }
                                return act;
                            });
                        }
                    });

                    // æ›´æ–°æ‰€æœ‰ä½å®¿çš„å¹£åˆ¥
                    Object.keys(updatedAccommodations).forEach(date => {
                        if (Array.isArray(updatedAccommodations[date])) {
                            updatedAccommodations[date] = updatedAccommodations[date].map(acc => {
                                if (acc) {
                                    return { ...acc, currency: newCurrency };
                                }
                                return acc;
                            });
                        }
                    });
                }

                // 3. çµ„åˆæœ€çµ‚è³‡æ–™ä¸¦å„²å­˜
                const updatedTrip = { 
                    ...tripData, 
                    ...newData, 
                    itinerary: updatedItinerary, 
                    accommodations: updatedAccommodations 
                };
                
                updateTripFull(updatedTrip);
                
                if (shouldResetDate) {
                    setSelectedDate(newStartDate);
                }
            };
            
            const updateActivity = (id, field, val) => { 
                const acts = [...tripData.itinerary[selectedDate]]; 
                const idx = acts.findIndex(a=>a.id===id); 
                if(idx>=0) {
                    // [MODIFIED] Allow Owner OR Creator to edit
                    const act = acts[idx];
                    if (!isOwner && act.createdBy !== currentMember?.name) return;
                    
                    acts[idx][field]=val; 
                    updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: acts}); 
                } 
            };

            // FIX: Modified to support cross-date activity saving
            const handleSaveActivity = (data) => {
                // [MODIFIED] Allow Owner OR Creator (if editing) OR Any Member (if creating)
                if (!isOwner && editingActivity && editingActivity.createdBy !== currentMember?.name) {
                     alert("åªèƒ½ä¿®æ”¹è‡ªå·±å»ºç«‹çš„è¡Œç¨‹");
                     return;
                }
                
                const targetDate = data.date;
                // For editing, if defaultValues exists, use the original date and ID
                const oldDate = editingActivity?.date || selectedDate;
                const activityId = editingActivity?.id || generateId();
                const activityCreator = editingActivity?.createdBy || currentMember.name;

                const activityData = { ...data };
                delete activityData.date; // Date is used as key, remove from object payload
                
                const newItinerary = { ...tripData.itinerary };

                if (editingActivity) {
                    // Update Mode
                    if (oldDate !== targetDate) {
                        // 1. Remove from old date
                        if (newItinerary[oldDate]) {
                            newItinerary[oldDate] = newItinerary[oldDate].filter(a => a.id !== activityId);
                        }
                    } else {
                        // 2. Simple update on the same day (remove old, add new to ensure proper re-sort)
                        newItinerary[targetDate] = (newItinerary[targetDate] || []).filter(a => a.id !== activityId);
                    }
                } else if (newItinerary[oldDate]) { // Non-editing, check if exists on selected date
                     // If adding a new activity, simply push to the targetDate. The filtering in the else block above is not strictly necessary for CREATE, but we keep the targetDate handling logic here.
                }

                // 3. Add or update on the target date
                if (!newItinerary[targetDate]) newItinerary[targetDate] = [];
                // Re-filter before push in case of non-editing mode to ensure uniqueness for current operation
                if (!editingActivity) {
                    newItinerary[targetDate] = newItinerary[targetDate].filter(a => a.id !== activityId);
                }
                newItinerary[targetDate].push({
                    id: activityId,
                    ...activityData,
                    createdBy: activityCreator
                });
                
                // If the selectedDate remains valid after saving, set it to target date if it changed
                if (selectedDate !== targetDate) {
                   setSelectedDate(targetDate);
                }

                updateTrip('itinerary', newItinerary);
                setEditingActivity(null);
            };

            // New: Handle saving expenses (create and update with date change support)
            const handleSaveExpense = (data) => {
                const targetDate = data.date;
                const cost = parseFloat(data.cost);
                
                // Prepare expense object (without temporary date field)
                const expenseData = { ...data, cost, transport: 'expense' };
                delete expenseData.date;

                const newItinerary = { ...tripData.itinerary };

                if (editingExpense) {
                    // Update Mode
                    const oldDate = editingExpense.originalDate;
                    
                    // 1. Remove from old date
                    if (newItinerary[oldDate]) {
                        newItinerary[oldDate] = newItinerary[oldDate].filter(e => e.id !== editingExpense.id);
                    }
                    
                    // 2. Add to new date (keep original ID and creator)
                    // [FIX] Use spread syntax instead of push to avoid state mutation
                    const currentList = newItinerary[targetDate] || [];
                    // Note: If oldDate == targetDate, currentList is already filtered above (as newItinerary[oldDate] IS newItinerary[targetDate])
                    // But to be safe and consistent with strict immutability:
                    const listToAdd = (oldDate === targetDate) ? currentList : (newItinerary[targetDate] || []);
                    
                    newItinerary[targetDate] = [
                        ...listToAdd,
                        {
                            ...expenseData,
                            id: editingExpense.id,
                            createdBy: editingExpense.createdBy
                        }
                    ];
                } else {
                    // Create Mode
                    // [FIX] Use spread syntax instead of push to avoid state mutation
                    const currentList = newItinerary[targetDate] || [];
                    newItinerary[targetDate] = [
                        ...currentList,
                        {
                            id: generateId(),
                            ...expenseData,
                            createdBy: currentMember.name
                        }
                    ];
                }

                updateTrip('itinerary', newItinerary);
                setModals(m => ({ ...m, expense: false }));
                setEditingExpense(null);
                // setView('expense'); // Removed to stay on current view
            };
            
            const deleteActivity = (id) => {
                // [MODIFIED] Allow Owner OR Creator to delete
                const act = tripData.itinerary[selectedDate].find(a=>a.id===id);
                if (!isOwner && act?.createdBy !== currentMember?.name) return;
                
                setConfirm({ open: true, msg: 'ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ', action: () => {
                    const newActs = tripData.itinerary[selectedDate].filter(a=>a.id!==id);
                    updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: newActs});
                }});
            };

            const deleteTransaction = (id, date, item) => {
                // [FIX] Support deleting accommodations from expense list
                if (item.isAccommodation) {
                     if (!isOwner) { alert("åªæœ‰ä¸»è¾¦äººå¯ä»¥åˆªé™¤ä½å®¿"); return; }
                     setConfirm({ open: true, msg: 'ç¢ºå®šåˆªé™¤æ­¤ä½å®¿ï¼Ÿ', action: () => {
                         let currentList = tripData.accommodations?.[date] || [];
                         if (!Array.isArray(currentList)) currentList = [currentList];
                         const newList = currentList.filter(acc => acc.id !== id);
                         updateTrip('accommodations', { ...tripData.accommodations, [date]: newList });
                     }});
                     return;
                }

                // CRITICAL FIX: Ensure currentMember exists before accessing name
                if (!isOwner && item.createdBy !== currentMember?.name) { alert("åªèƒ½åˆªé™¤è‡ªå·±å»ºç«‹çš„è¨˜å¸³"); return; }
                setConfirm({ open: true, msg: 'ç¢ºå®šåˆªé™¤æ­¤äº¤æ˜“ï¼Ÿ', action: () => {
                    const newActs = tripData.itinerary[date].filter(a=>a.id!==id);
                    updateTrip('itinerary', {...tripData.itinerary, [date]: newActs});
                }});
            };
            
            const handleJoinTrip = async (memberInfo) => {
                 const { name, pin, role, isNew } = memberInfo;
                 let newMembers = [...tripData.members];
                 
                 // Determine ID based on mode
                 const currentUid = isOffline ? userId : (user ? user.uid : userId);
                 
                 if (isNew) {
                     newMembers.push({ name, pin, role, deviceId: currentUid });
                 } else {
                     newMembers = newMembers.map(m => m.name === name ? { ...m, deviceId: currentUid } : m);
                 }
 
                 updateTrip('members', newMembers);
                 
                 // Update local state immediately
                 const switchedMember = newMembers.find(m => m.name === name) || newMembers[newMembers.length - 1];
                 if(switchedMember) setCurrentMember(switchedMember);
                 
                 setModals(m => ({...m, join: false}));
            };

            const handleLocalJoin = (targetId) => {
                // å„ªå…ˆä½¿ç”¨ targetIdï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨ joinIdï¼Œä¸¦å¼·åˆ¶ç§»é™¤å‰å¾Œç©ºç™½ï¼Œé¿å…è¤‡è£½è²¼ä¸Šæ™‚å‡ºéŒ¯
                const rawId = targetId !== undefined ? targetId : joinId;
                const idToJoin = (rawId || '').toString().trim();
                
                if (!idToJoin) return;
                
                // ã€ä¿®å¾©ç™½å±é—œéµã€‘åˆ‡æ› ID æ™‚å…ˆæ¸…ç©ºèˆŠè³‡æ–™ï¼Œé¿å…æ¸²æŸ“éŒ¯èª¤æˆ–æ®˜ç•™
                setTripData(null); 

                // 1. Always check local storage first (fastest)
                const localData = localStorage.getItem(`gtp_trip_${idToJoin}`);
                if (localData) {
                    setTripId(idToJoin);
                    setView('planner');
                    return;
                }

                // 2. If not local, check connectivity
                if (isOffline) {
                    // Check if they simply haven't configured it yet
                    const hasConfig = localStorage.getItem('gtp_firebase_config');
                    if (hasConfig) {
                        alert("æ‰¾ä¸åˆ°æœ¬æ©Ÿè³‡æ–™ï¼Œä¸”ç›®å‰å°šæœªæˆåŠŸé€£ç·šè‡³é›²ç«¯ã€‚\n\nè«‹æª¢æŸ¥ç¶²è·¯ï¼Œæˆ–é»æ“Šä¸Šæ–¹ã€Œæ¸¬è©¦é€£ç·šã€ç¢ºèªè¨­å®šæ˜¯å¦æ­£ç¢ºã€‚");
                    } else {
                        alert("æ‰¾ä¸åˆ°æœ¬æ©Ÿè³‡æ–™ã€‚\n\nè‹¥é€™æ˜¯ä¸€å€‹é›²ç«¯è¡Œç¨‹ IDï¼Œè«‹ç¢ºèªï¼š\n1. ä¸Šæ–¹ Firebase è¨­å®šæ˜¯å¦æ­£ç¢º\n2. æ˜¯å¦å·²é»æ“Šã€Œå„²å­˜é€£ç·šã€æŒ‰éˆ• (éœ€çœ‹åˆ°ç¶ è‰² Wifi ç‡ˆè™Ÿ)");
                    }
                } else {
                    // 3. Online: Try to fetch from cloud (via useEffect)
                     setTripId(idToJoin);
                     setView('planner');
                }
            };
            
            const handleDeleteTrip = (id, e) => {
                e.stopPropagation();
                setConfirm({ open: true, msg: 'ç¢ºå®šç§»é™¤æ­¤ç´€éŒ„?', action: () => {
                    const updated = recentTrips.filter(t => t.id !== id);
                    setRecentTrips(updated);
                    localStorage.setItem('gtp_recent_trips', JSON.stringify(updated));
                    localStorage.removeItem(`gtp_trip_${id}`);
                }});
            };

            const handleAddDate = async () => {
                if(!isOwner) return;
                const currentEnd = new Date(tripData.endDate); currentEnd.setDate(currentEnd.getDate() + 1); const newEndDate = currentEnd.toISOString().split('T')[0];
                const newItinerary = { ...tripData.itinerary, [newEndDate]: [] };
                const newAccommodations = { ...tripData.accommodations, [newEndDate]: [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }] };
                const newData = { ...tripData, endDate: newEndDate, itinerary: newItinerary, accommodations: newAccommodations };
                updateTripFull(newData);
            };

            const handleDeleteDate = () => {
                if (!isOwner) return;
                
                const dates = getDatesArray(tripData.startDate, tripData.endDate);
                if (dates.length <= 1) {
                    alert("æ—…ç¨‹è‡³å°‘éœ€è¦ä¿ç•™ä¸€å¤©ï¼Œç„¡æ³•åˆªé™¤æœ€å¾Œä¸€å¤©ã€‚");
                    return;
                }

                setConfirm({
                    open: true,
                    msg: `ç¢ºå®šè¦åˆªé™¤ ${selectedDate} çš„æ‰€æœ‰è¡Œç¨‹å—ï¼Ÿ\n\næ³¨æ„ï¼š\n1. ç•¶æ—¥æ‰€æœ‰æ´»å‹•èˆ‡è¨˜å¸³å°‡è¢«ç§»é™¤\n2. å¾ŒçºŒæ—¥æœŸçš„è¡Œç¨‹å°‡å¾€å‰éè£œ\n3. æ—…ç¨‹ç¸½å¤©æ•¸å°‡æ¸›å°‘ä¸€å¤©`,
                    action: () => {
                        const targetIndex = dates.indexOf(selectedDate);
                        if (targetIndex === -1) return;

                        const newItinerary = { ...tripData.itinerary };
                        const newAccommodations = { ...tripData.accommodations };

                        // å°‡å¾Œé¢çš„æ—¥æœŸè³‡æ–™å¾€å‰æ¬ç§»
                        for (let i = targetIndex; i < dates.length - 1; i++) {
                            const currDate = dates[i];
                            const nextDate = dates[i+1];
                            newItinerary[currDate] = newItinerary[nextDate] || [];
                            newAccommodations[currDate] = newAccommodations[nextDate] || [];
                        }

                        // åˆªé™¤æœ€å¾Œä¸€å¤©çš„è³‡æ–™ (å› ç‚ºå·²ç¶“ç§»åˆ°å‰ä¸€å¤©äº†ï¼Œæˆ–è€…æœ¬ä¾†å°±æ˜¯ç©ºçš„)
                        const oldEndDate = dates[dates.length - 1];
                        delete newItinerary[oldEndDate];
                        delete newAccommodations[oldEndDate];

                        // è¨ˆç®—æ–°çš„çµæŸæ—¥æœŸ (æ¸›ä¸€å¤©)
                        const newEndDateObj = new Date(tripData.endDate);
                        newEndDateObj.setDate(newEndDateObj.getDate() - 1);
                        const newEndDate = newEndDateObj.toISOString().split('T')[0];

                        // æ±ºå®šåˆªé™¤å¾Œè¦åœç•™åœ¨å“ªä¸€å¤©
                        // å¦‚æœåˆªé™¤çš„æ˜¯æœ€å¾Œä¸€å¤©ï¼Œå°±è·³åˆ°æ–°çš„æœ€å¾Œä¸€å¤©ï¼›å¦å‰‡åœç•™åœ¨åŸæ—¥æœŸ(å› ç‚ºå¾Œé¢çš„è£œä¸Šä¾†äº†)
                        let newSelectedDate = selectedDate;
                        if (selectedDate > newEndDate) {
                            newSelectedDate = newEndDate;
                        }

                        const newData = {
                            ...tripData,
                            endDate: newEndDate,
                            itinerary: newItinerary,
                            accommodations: newAccommodations
                        };

                        updateTripFull(newData);
                        setSelectedDate(newSelectedDate);
                    }
                });
            };

            // Modified: Enhanced logic to handle date changes (cleanup old dates) and prevent duplicate blank cards
            const handleUpdateAccommodation = (id, field, val) => { 
                if(!isOwner) return; 
                
                const newAccommodations = { ...tripData.accommodations };
                
                // Get current date's list
                if (!newAccommodations[selectedDate]) newAccommodations[selectedDate] = [];
                let currentList = [...newAccommodations[selectedDate]];
                
                // 1. Find and update the item in the current date
                const itemIndex = currentList.findIndex(item => item.id === id);
                if (itemIndex === -1) return;
                
                const oldItem = currentList[itemIndex];
                
                // FIX: Update the specific field in the current item copy
                const updatedItem = { ...oldItem, [field]: val };
                currentList[itemIndex] = updatedItem;
                newAccommodations[selectedDate] = currentList;

                // Helper to check if a date string is within a range [start, end)
                // FIX: Use string comparison to avoid timezone issues with Date parsing
                const isInRange = (dStr, start, end) => {
                    if (!start || !end) return false;
                    return dStr >= start && dStr < end; 
                };

                // 2. Logic to Sync to other dates
                
                // --- Determine the fields that need synchronization ---
                // FIX: Added time fields to sync list so changes reflect immediately
                // [MODIFIED] Added 'cost', 'payer', 'currency' to sync fields
                const fieldsToSync = ['name', 'bookingCode', 'note', 'phone', 'address', 'photoUrls', 'checkInTime', 'checkOutTime', 'cost', 'payer', 'currency'];
                const isFieldToSync = fieldsToSync.includes(field);
                
                // --- Determine range changes ---
                const rangeChanged = (updatedItem.checkInDate !== oldItem.checkInDate) || (updatedItem.checkOutDate !== oldItem.checkOutDate);
                
                // Only run complex range sync logic if needed
                if (rangeChanged || isFieldToSync) {

                    // Collect all dates in the current trip range
                    const allDates = getDatesArray(tripData.startDate, tripData.endDate);

                    allDates.forEach(dateStr => {
                        // Skip if the current date hasn't been initialized in accommodations yet
                        if (!newAccommodations[dateStr]) return;
                        
                        // Check if this item should exist on this day based on the new date range
                        // FIX: Prevent card from vanishing if user sets Invalid Range (Start > End) temporarily while editing
                        const hasDates = updatedItem.checkInDate && updatedItem.checkOutDate;
                        const validDates = hasDates && updatedItem.checkInDate < updatedItem.checkOutDate;
                        
                        const shouldExist = validDates
                            ? isInRange(dateStr, updatedItem.checkInDate, updatedItem.checkOutDate)
                            : dateStr === selectedDate; // Fallback: Keep on current screen if dates are invalid or missing

                        let dayList = [...newAccommodations[dateStr]];
                        const existingIdx = dayList.findIndex(i => i.id === id);

                        if (shouldExist) {
                            // Item should exist on this day
                            if (existingIdx > -1) {
                                // å­˜åœ¨ï¼šæ›´æ–°æ‰€æœ‰æ¬„ä½
                                // Use oldItem properties if the specific field wasn't changed now (only sync changed date fields)
                                if (rangeChanged) {
                                    // Range changed: full sync of all linked items
                                    dayList[existingIdx] = { ...updatedItem };
                                } else if (isFieldToSync) {
                                    // Content changed: sync only the changed content field
                                    dayList[existingIdx] = { ...dayList[existingIdx], [field]: val };
                                }
                                
                            } else if (dateStr !== updatedItem.checkOutDate) { // Avoid adding to checkout date itself
                                // ä¸å­˜åœ¨ï¼šå¦‚æœä¸æ˜¯ç•¶å‰ç·¨è¼¯çš„æ—¥æœŸï¼Œä¸”åœ¨æ–°çš„ç¯„åœå…§ï¼Œå‰‡æ·»åŠ å‰¯æœ¬
                                // First remove placeholder if exists
                                if (dayList.length === 1 && !dayList[0].name && !dayList[0].bookingCode) {
                                    dayList = [];
                                }
                                dayList.push({ ...updatedItem });
                            }
                        } else {
                            // Item should NOT exist on this day: Remove it
                            if (existingIdx > -1) {
                                dayList.splice(existingIdx, 1);
                            }
                        }

                        // Update the accommodations map for this date
                        newAccommodations[dateStr] = dayList.filter(Boolean);
                    });
                }
                // --- End Sync Logic ---
                
                updateTrip('accommodations', newAccommodations);
            };

            const handleAddAccommodation = () => { if(!isOwner) return; let currentList = tripData.accommodations[selectedDate] || []; if (!Array.isArray(currentList)) currentList = [currentList]; const newList = [...currentList, { id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }]; updateTrip('accommodations', { ...tripData.accommodations, [selectedDate]: newList }); };
            
            // [FIX] ä¿®æ­£ä½å®¿åˆªé™¤é‚è¼¯ï¼šåˆªé™¤æ™‚åµæ¸¬æ˜¯å¦ç‚ºé€£çºŒä½å®¿ï¼Œä¸¦çµ¦äºˆå°æ‡‰æç¤º
            const handleDeleteAccommodation = (id) => { 
                if(!isOwner) return; 

                // 1. è¨ˆç®—æ­¤ä½å®¿ ID å‡ºç¾åœ¨å¹¾å¤©ä¸­
                let dayCount = 0;
                if (tripData.accommodations) {
                    Object.values(tripData.accommodations).forEach(list => {
                        if (Array.isArray(list) && list.some(item => item.id === id)) {
                            dayCount++;
                        }
                    });
                }

                // 2. æ ¹æ“šå¤©æ•¸æ±ºå®šæç¤ºè¨Šæ¯
                const msg = dayCount > 1 
                    ? `âš ï¸ åµæ¸¬åˆ°æ­¤ç‚ºé€£çºŒä½å®¿ (${dayCount} æ™š)\n\nåˆªé™¤æ­¤é …ç›®å°‡æœƒã€Œä¸€ä½µç§»é™¤ã€æ‰€æœ‰æ—¥æœŸçš„ä½å®¿ç´€éŒ„ã€‚\n\nç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ` 
                    : 'ç¢ºå®šåˆªé™¤æ­¤ä½å®¿ï¼Ÿ';

                setConfirm({ 
                    open: true, 
                    msg: msg, 
                    action: () => { 
                        const newAccommodations = { ...tripData.accommodations };
                        
                        // éæ­·æ‰€æœ‰æ—¥æœŸï¼Œç§»é™¤ ID åŒ¹é…çš„ä½å®¿é …ç›®
                        Object.keys(newAccommodations).forEach(date => {
                            if (Array.isArray(newAccommodations[date])) {
                                newAccommodations[date] = newAccommodations[date].filter(item => item.id !== id);
                            }
                        });
                        
                        updateTrip('accommodations', newAccommodations); 
                    }
                }); 
            };
            
            const handlePhotoUpload = async (e) => {
                const f = e.target.files[0];
                if (f && uploadTarget) {
                    // Modified: Use processImageUpload for unified logic
                    const finalUrl = await processImageUpload(f);
                    
                    if (finalUrl) {
                        const photoObj = { url: finalUrl, uploader: currentMember.name };
                        const newPhotoUrls = [...(uploadTarget.data?.photoUrls || []), photoObj];

                        // Logic to sync photoUrls across multiple components/dates
                        if (uploadTarget.type === 'activity') {
                            const acts = [...tripData.itinerary[selectedDate]];
                            const idx = acts.findIndex(a=>a.id===uploadTarget.id);
                            if(idx>=0) { 
                                acts[idx].photoUrls = newPhotoUrls;
                                updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: acts}); 
                            }
                        } else if (uploadTarget.type === 'accom') {
                            // Special case for accommodation: Need to update all linked dates
                            const newAccoms = { ...tripData.accommodations };
                            const allDates = getDatesArray(tripData.startDate, tripData.endDate);

                            allDates.forEach(dateStr => {
                                if (newAccoms[dateStr]) {
                                    newAccoms[dateStr] = newAccoms[dateStr].map(item => {
                                        if (item.id === uploadTarget.id) {
                                            // The core accommodation object is modified here
                                            return { ...item, photoUrls: newPhotoUrls };
                                        }
                                        return item;
                                    });
                                }
                            });
                            updateTrip('accommodations', newAccoms);
                        }
                    }
                }
                e.target.value = ''; setUploadTarget(null);
            };

            const handlePhotoDelete = (targetId, urlToDelete, type) => {
                setConfirm({ open: true, msg: 'ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ', action: () => {
                    const newAccoms = { ...tripData.accommodations };
                    const allDates = getDatesArray(tripData.startDate, tripData.endDate);

                    if (type === 'activity') {
                        const acts = [...tripData.itinerary[selectedDate]];
                        const idx = acts.findIndex(a => a.id === targetId);
                        if(idx >= 0) { 
                            acts[idx].photoUrls = acts[idx].photoUrls.filter(p => (typeof p === 'string' ? p : p.url) !== urlToDelete); 
                            updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: acts}); 
                        }
                    } else { // type === 'accom'
                        // FIX: Iterate all dates to remove the photo from all linked copies
                        allDates.forEach(dateStr => {
                            if (newAccoms[dateStr]) {
                                newAccoms[dateStr] = newAccoms[dateStr].map(item => {
                                    if (item.id === targetId) {
                                        return { 
                                            ...item, 
                                            photoUrls: item.photoUrls.filter(p => (typeof p === 'string' ? p : p.url) !== urlToDelete) 
                                        };
                                    }
                                    return item;
                                });
                            }
                        });
                        updateTrip('accommodations', newAccoms);
                    }
                }});
            };

            // FIX: Added handleExportExpenses function
            const handleExportExpenses = () => {
                if (!tripData || !tripData.itinerary) {
                    alert("ç„¡è¨˜å¸³è³‡æ–™å¯åŒ¯å‡ºï¼");
                    return;
                }

                const allExpenses = [];
                const allDates = getDatesArray(tripData.startDate, tripData.endDate);

                allDates.forEach(date => {
                    // 1. ä¸€èˆ¬è¡Œç¨‹èˆ‡è¨˜å¸³
                    const dayActs = tripData.itinerary[date] || [];
                    dayActs.filter(a => a && (a.transport === 'expense' || (a.cost && a.cost > 0))).forEach(e => {
                        let photoUrlsJoined = 'N/A';
                        if (e.photoUrls && e.photoUrls.length > 0) {
                            photoUrlsJoined = e.photoUrls.map(p => typeof p === 'string' ? p : p.url).join('; ');
                        }

                        allExpenses.push({
                            date: date,
                            time: e.time || 'N/A',
                            payer: e.payer || 'N/A',
                            name: e.title || 'N/A',
                            category: e.category || 'N/A',
                            cost: e.cost || 0,
                            currency: e.currency || tripData.currency || 'TWD',
                            photoUrls: photoUrlsJoined
                        });
                    });

                    // 2. [NEW] ä½å®¿è²»ç”¨ (åƒ…åœ¨ Check-in æ—¥æœŸåŒ¯å‡º)
                    const dayAccoms = tripData.accommodations?.[date] || [];
                    dayAccoms.forEach(acc => {
                        if (acc && acc.cost && parseFloat(acc.cost) > 0 && acc.checkInDate === date) {
                            allExpenses.push({
                                date: date,
                                time: acc.checkInTime || '15:00',
                                payer: acc.payer || (tripData.members?.[0]?.name) || 'æˆ‘',
                                name: acc.name || 'ä½å®¿è²»',
                                category: 'ä½å®¿',
                                cost: parseFloat(acc.cost),
                                currency: acc.currency || tripData.currency || 'JPY',
                                photoUrls: 'N/A'
                            });
                        }
                    });
                });

                if (allExpenses.length === 0) {
                    alert("ç„¡è¨˜å¸³è³‡æ–™å¯åŒ¯å‡ºï¼");
                    return;
                }

                // Prepare CSV content
                // FIX: Added Category and Photos to header
                const header = ["æ—¥æœŸ", "æ™‚é–“", "ä»˜æ¬¾äºº", "åç¨±", "åˆ†é¡", "åƒ¹æ ¼ (é‡‘é¡)", "åƒ¹æ ¼ (å¹£åˆ¥)", "ç…§ç‰‡é€£çµ"];
                
                // Helper to format string for CSV (handle commas/quotes)
                const escapeCsv = (str) => {
                    if (str === null || str === undefined) return "";
                    str = String(str);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };

                const rows = allExpenses.map(e => [
                    escapeCsv(e.date),
                    escapeCsv(e.time),
                    escapeCsv(e.payer),
                    escapeCsv(e.name), // FIX: Use consistent 'name' field
                    escapeCsv(e.category),
                    escapeCsv(e.cost),
                    escapeCsv(e.currency),
                    escapeCsv(e.photoUrls) // FIX: Add photo links
                ]);
                
                // FIX: Add BOM marker (\ufeff) to the beginning of the CSV content for Chinese compatibility in Excel
                const BOM = '\ufeff';

                const csvContent = [
                    header.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');

                // Trigger download
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${tripData.destination}_Expenses_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è‡ªå‹•ä¸‹è¼‰ï¼Œè«‹è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼š\n\n' + csvContent);
                }
            };

            // Modified: Group statistics by currency to allow vertical stacking of charts
            const expenseStatsByCurrency = useMemo(() => {
                if (!tripData) return [];
                
                // Determine which currencies to calculate (Selected one or All available in constants + Data)
                let targetCurrencies = [];
                if (expenseFilterCurrency !== 'all') {
                    targetCurrencies = [expenseFilterCurrency];
                } else {
                    // FIX: Dynamically collect ALL currencies used in the trip data, not just the default ones
                    const usedCurrencies = new Set(currencies.map(c => c.value)); // Start with defaults
                    
                    if (tripData.itinerary) {
                        Object.values(tripData.itinerary).forEach(dayActs => {
                            if (Array.isArray(dayActs)) {
                                dayActs.forEach(act => {
                                    if (act && (act.transport === 'expense' || (act.cost && parseFloat(act.cost) > 0))) {
                                        if (act.currency) usedCurrencies.add(act.currency);
                                    }
                                });
                            }
                        });
                    }
                    // [NEW] Also check accommodations for currencies
                    if (tripData.accommodations) {
                        Object.values(tripData.accommodations).forEach(dayAccoms => {
                             if (Array.isArray(dayAccoms)) {
                                 dayAccoms.forEach(acc => {
                                     if (acc && acc.cost && parseFloat(acc.cost) > 0) {
                                         if (acc.currency) usedCurrencies.add(acc.currency);
                                     }
                                 });
                             }
                        });
                    }
                    targetCurrencies = Array.from(usedCurrencies);
                }

                const datesToShow = expenseFilterDate === 'all' ? getDatesArray(tripData.startDate, tripData.endDate) : [expenseFilterDate];
                
                // [MODIFIED] Determine Grouping Logic based on View Mode AND Drill Down
                const isByMemberMode = expenseViewMode === 'member';
                const isDrillDown = !!drillDownCategory;
                
                // å¦‚æœæ˜¯ã€Œä¾æˆå“¡ã€æ¨¡å¼ï¼Œæˆ–è€…æ˜¯ã€Œä¸‹é‘½ã€æ¨¡å¼ï¼Œéƒ½æ”¹ç”¨æˆå“¡ä¾†åˆ†çµ„
                const effectiveGroupByMember = isByMemberMode || isDrillDown;

                let groupKeys = [];
                let getColor = (k) => '#ccc';

                if (effectiveGroupByMember) {
                    // Mode: By Member (or Drill-down breakdown by member)
                    // [CRITICAL FIX] Ensure we don't crash on null members
                    const validMembers = (tripData.members || []).filter(m => m && m.name);
                    groupKeys = validMembers.map(m => m.name);
                    groupKeys.push('æœªçŸ¥'); // Handle edge case
                    
                    // Use a distinct palette for members
                    const MEMBER_PALETTE = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6B6B', '#C9CBCF', '#4D5360', '#F7464A'];
                    getColor = (name) => {
                        const idx = validMembers.findIndex(m => m.name === name);
                        return idx >= 0 ? MEMBER_PALETTE[idx % MEMBER_PALETTE.length] : '#ccc';
                    };
                } else {
                    // Mode: By Category (Default)
                    // [FIX] Create a copy to avoid mutating state
                    groupKeys = [...(tripData.expenseCategories || Object.keys(CATEGORY_COLORS))];
                    if (!groupKeys.includes('ä½å®¿')) groupKeys.push('ä½å®¿'); // Ensure 'ä½å®¿' exists
                    if (!groupKeys.includes('å…¶ä»–')) groupKeys.push('å…¶ä»–');
                    getColor = (cat) => CATEGORY_COLORS[cat] || '#ccc';
                }

                return targetCurrencies.map(currency => {
                    let totalForCurrency = 0;
                    const groupTotals = {};
                    groupKeys.forEach(k => groupTotals[k] = 0);

                    // Calculate Bar Data (Daily Breakdown) & Accumulate Totals
                    const barData = datesToShow.map(date => {
                         const dayActs = tripData.itinerary?.[date] || [];
                         const dayAccoms = tripData.accommodations?.[date] || [];
                         
                         // Filter relevant expenses for this day, payer, and THIS specific currency loop
                         const relevant = dayActs.filter(a => 
                            a && 
                            (a.transport === 'expense' || (a.cost && a.cost > 0)) &&
                            (expenseFilterPayer === 'all' || a.payer === expenseFilterPayer) &&
                            (a.currency === currency)
                         );
                         
                         let dayTotal = 0;
                         const dayBreakdown = {};
                         
                         // Helper to process cost
                         const addCost = (cost, catName, payerName) => {
                             const val = parseFloat(cost) || 0;
                             if (val <= 0) return;
                             
                             // [DRILL DOWN FILTER] å¦‚æœæ­£åœ¨ä¸‹é‘½ï¼Œåªè¨ˆç®—ç¬¦åˆè©²åˆ†é¡çš„é …ç›®
                             if (isDrillDown && catName !== drillDownCategory) return;

                             dayTotal += val;
                             totalForCurrency += val;
                             
                             // Determine key based on mode
                             const key = effectiveGroupByMember ? (payerName || 'æœªçŸ¥') : (catName || 'å…¶ä»–');
                             
                             // Initialize if not present (handle ad-hoc keys)
                             if (dayBreakdown[key] === undefined) dayBreakdown[key] = 0;
                             if (groupTotals[key] === undefined) groupTotals[key] = 0;

                             dayBreakdown[key] += val;
                             groupTotals[key] += val;
                         };

                         // 1. Process Normal Expenses
                         relevant.forEach(e => {
                             let cat = e.category;
                             if (!cat) {
                                if (e.transport === 'expense') cat = 'å…¶ä»–';
                                else if (['plane','shinkansen','nightbus','train','bus','taxi','car'].includes(e.transport)) cat = 'äº¤é€š';
                                else if (e.title && e.title.includes('é–€ç¥¨')) cat = 'é–€ç¥¨';
                                else cat = 'å¨›æ¨‚';
                             }
                             addCost(e.cost, cat, e.payer);
                         });

                         // 2. Process Accommodation Expenses (Check-in date only)
                         dayAccoms.forEach(acc => {
                             if (acc && acc.cost && parseFloat(acc.cost) > 0 && acc.checkInDate === date) {
                                 const accPayer = acc.payer || (tripData.members?.[0]?.name) || 'æˆ‘';
                                 const accCurrency = acc.currency || 'JPY';
                                 
                                 // Apply filters
                                 if (expenseFilterPayer !== 'all' && accPayer !== expenseFilterPayer) return;
                                 if (accCurrency !== currency) return;

                                 addCost(acc.cost, 'ä½å®¿', accPayer);
                             }
                         });
                         
                         // Format breakdown for SimpleBarChart
                         const breakdown = Object.keys(dayBreakdown).map(k => ({
                             category: k,
                             cost: dayBreakdown[k],
                             color: getColor(k)
                         }));
                         
                         return { date, total: dayTotal, breakdown };
                    });

                    // Format Pie Data
                    const pieData = Object.keys(groupTotals)
                        .filter(k => groupTotals[k] > 0)
                        .map(k => ({ 
                            category: k, 
                            value: groupTotals[k], 
                            color: getColor(k) 
                        }))
                        .sort((a, b) => b.value - a.value); // Sort by value descending

                    // Hide currency group if total is 0 AND user selected 'all'
                    // But allow if we are drilling down to specific cat (might want to see 0?)
                    // Keep hiding logic for cleaner UI
                    if (expenseFilterCurrency === 'all' && totalForCurrency === 0) return null;

                    return {
                        currency,
                        total: totalForCurrency,
                        pieData,
                        barData
                    };
                }).filter(Boolean); // Remove nulls
            }, [tripData, expenseFilterDate, expenseFilterPayer, expenseFilterCurrency, expenseViewMode, drillDownCategory]); // Added drillDownCategory dependency

            const sortedExpensesByDate = useMemo(() => {
                if (!tripData) return [];
                // [MODIFIED] æ”¹ç‚ºä½¿ç”¨ expenseListFilterDate (åˆ—è¡¨å°ˆç”¨ç¯©é¸)
                const dates = expenseListFilterDate === 'all' ? getDatesArray(tripData.startDate, tripData.endDate) : [expenseListFilterDate];
                const expenseList = [];
                dates.forEach(date => {
                    // é‡å°åˆ—è¡¨è³‡æ–™ï¼ŒåŠ å…¥ä»˜æ¬¾äººèˆ‡å¹£åˆ¥ç¯©é¸
                    // FIX: Added guard check (!a) to prevent crash on dirty data
                    const dayExpenses = (tripData.itinerary?.[date] || []).filter(a => 
                        a &&
                        (a.transport === 'expense' || (a.cost && a.cost > 0)) &&
                        (expenseFilterPayer === 'all' || a.payer === expenseFilterPayer) &&
                        (expenseFilterCurrency === 'all' || a.currency === expenseFilterCurrency)
                    );
                    
                    // [NEW] Add Accommodation items to the list (Only on Check-in Date)
                    const dayAccoms = (tripData.accommodations?.[date] || []).filter(acc => 
                        acc && acc.cost && parseFloat(acc.cost) > 0 && acc.checkInDate === date &&
                        (expenseFilterPayer === 'all' || (acc.payer || (tripData.members?.[0]?.name) || 'æˆ‘') === expenseFilterPayer) &&
                        (expenseFilterCurrency === 'all' || (acc.currency || 'JPY') === expenseFilterCurrency)
                    ).map(acc => ({
                        id: acc.id,
                        title: (acc.name || 'ä½å®¿') + ' (ä½å®¿è²»)',
                        category: 'ä½å®¿',
                        cost: parseFloat(acc.cost),
                        currency: acc.currency || 'JPY',
                        payer: acc.payer || (tripData.members?.[0]?.name) || 'æˆ‘',
                        time: acc.checkInTime || '15:00',
                        isAccommodation: true // Marker
                    }));

                    const combinedItems = [...dayExpenses, ...dayAccoms];

                    if (combinedItems.length > 0) { expenseList.push({ date, items: combinedItems }); }
                });
                return expenseList;
            }, [tripData, expenseListFilterDate, expenseFilterPayer, expenseFilterCurrency]); // [MODIFIED] ä¾è³´æ”¹ç‚º expenseListFilterDate

            const sortedActivities = useMemo(() => {
                const acts = tripData?.itinerary?.[selectedDate] || [];
                // FIX: Add fallback for missing time to prevent crash
                // Also added filter(Boolean) to remove nulls before sort
                return [...acts].filter(Boolean).sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            }, [tripData, selectedDate]);

            if (authError || connectionTimeout) return <div className="flex h-screen items-center justify-center bg-red-50 p-8"><div className="bg-[#F5FDFC] p-6 rounded-2xl shadow-xl max-w-md text-center"><h2 className="text-2xl font-bold text-red-500 mb-2">{authError ? "Firebase é©—è­‰éŒ¯èª¤" : "é€£ç·šé€¾æ™‚"}</h2><button onClick={() => window.location.reload()} className="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">é‡è©¦</button></div></div>;

            // Pass session data to modal so it can save it before reloading
            const currentSessionData = { view, tripId, selectedDate, setupForm };

            return (
                <div className="w-full max-w-[480px] h-screen bg-[#E0F2F1] shadow-2xl flex flex-col overflow-hidden relative mx-auto border-x border-[#eeeeee]">
                    
                    {/* --- Conditional Content Rendering --- */}
                    {!user ? (
                        <div className="flex h-full items-center justify-center text-[#0ABAB5] font-bold animate-pulse">
                            è¼‰å…¥ä¸­...
                        </div>
                    ) : (
                        <>
                            {view === 'landing' ? (
                                <LandingView 
                                    onConnect={(config) => handleConfigUpdate(config)}
                                    onOffline={() => handleConfigUpdate(null).then(() => setView('setup'))}
                                    onCreateTrip={() => setView('setup')}
                                    joinId={joinId}
                                    setJoinId={setJoinId}
                                    onJoin={(arg) => handleLocalJoin(typeof arg === 'string' ? arg : null)}
                                    recentTrips={recentTrips}
                                    onDeleteTrip={handleDeleteTrip}
                                    isOffline={isOffline}
                                />
                            ) : (
                                <>
                                    {/* Menu Overlay */}
                                    <div className={`absolute inset-0 z-50 bg-black/50 ${!isMenuOpen && 'hidden'}`} onClick={()=>setIsMenuOpen(false)}>
                                        <div className="w-72 bg-[#F5FDFC] h-full p-4" onClick={e=>e.stopPropagation()}>
                                            <h2 className="text-lg font-bold text-[#0ABAB5] mb-4">Travel Plan</h2>
                                            
                                            {/* Trip ID Display */}
                                            {tripData && view !== 'setup' && (
                                                <div className="mb-4 p-3 bg-[#EDF7F6] border border-[#eeeeee] rounded-xl shadow-sm">
                                                    <label className="text-[10px] font-bold text-gray-400 block mb-1">
                                                        {isOffline ? 'æœ¬æ©Ÿæ—…ç¨‹ ID (åƒ…ä¾›æœ¬æ©Ÿè®€å–)' : 'é›²ç«¯æ—…ç¨‹ ID (é»æ“Šè¤‡è£½)'}
                                                    </label>
                                                    <div 
                                                        className="text-xl font-bold text-gray-700 flex items-center gap-2 cursor-pointer active:scale-95 transition-transform"
                                                        onClick={() => {
                                                            const textArea = document.createElement("textarea");
                                                            
                                                            // NEW: ä¸€éµåˆ†äº«é‚è¼¯ (èˆ‡ Header æŒ‰éˆ•é‚è¼¯ä¸€è‡´)
                                                            let textToCopy = tripData.id;
                                                            let alertMsg = isOffline ? "å·²è¤‡è£½æœ¬æ©Ÿ ID (æ­¤ ID åƒ…èƒ½åœ¨æ­¤ç€è¦½å™¨ä¸Šè®€å–)" : "ID å·²è¤‡è£½ï¼Œå‚³é€çµ¦æœ‹å‹å³å¯åŠ å…¥æ—…ç¨‹ï¼";

                                                            // åªæœ‰åœ¨é€£ç·šæ¨¡å¼ä¸‹ï¼Œæ‰å˜—è©¦æ‰“åŒ…è¨­å®šæª”
                                                            if (!isOffline) {
                                                                const fbConfigStr = localStorage.getItem('gtp_firebase_config');
                                                                const imgbbKeyStr = localStorage.getItem('gtp_imgbb_key');
                                                                if (fbConfigStr) {
                                                                    try {
                                                                            const bundle = {
                                                                                id: tripData.id,
                                                                                firebase: JSON.parse(fbConfigStr),
                                                                                imgbb: imgbbKeyStr || ''
                                                                            };
                                                                            textToCopy = JSON.stringify(bundle);
                                                                            alertMsg = "å·²è¤‡è£½ã€Œä¸€éµè¨­å®šæ‡¶äººåŒ…ã€ï¼\n\næœ‹å‹åªéœ€åœ¨é¦–é è²¼ä¸Šé€™ä¸²ä»£ç¢¼ï¼Œå³å¯è‡ªå‹•è¨­å®šé€£ç·šä¸¦åŠ å…¥æ—…ç¨‹ã€‚";
                                                                    } catch (e) {
                                                                        console.error("Bundle error", e);
                                                                    }
                                                                }
                                                            }

                                                            textArea.value = textToCopy;
                                                            document.body.appendChild(textArea);
                                                            textArea.select();
                                                            document.execCommand("Copy");
                                                            textArea.remove();
                                                            alert(alertMsg); 
                                                        }}
                                                    >
                                                        {tripData.id}
                                                        <span className="text-xs text-[#0ABAB5] bg-[#0ABAB5]/10 px-2 py-1 rounded-full">COPY</span>
                                                    </div>
                                                </div>
                                            )}

                                            {/* [MOVED] "å»ºç«‹æ–°æ—…ç¨‹" button removed from here */}

                                            {view !== 'setup' && (
                                                <>
                                                    <button 
                                                        onClick={() => { setModals({ ...modals, members: true }); setIsMenuOpen(false); }} 
                                                        className="w-full text-left p-3 hover:bg-gray-100 rounded-xl mb-2 flex items-center gap-3 font-bold text-gray-600"
                                                    >
                                                        <Users size={18} /> æ—…ä¼´ç®¡ç†
                                                    </button>
                                                    
                                                    {/* FIX: Added Edit Trip Settings button for Owner */}
                                                    {isOwner && (
                                                        <button 
                                                            onClick={() => { setModals({ ...modals, editTrip: true }); setIsMenuOpen(false); }} 
                                                            className="w-full text-left p-3 hover:bg-gray-100 rounded-xl mb-2 flex items-center gap-3 font-bold text-gray-600"
                                                        >
                                                            <Edit3 size={18} /> æ—…ç¨‹è¨­å®š
                                                        </button>
                                                    )}
                                                </>
                                            )}
                                            
                                            {/* Button to go back to Landing Page (Firebase Setup) */}
                                            <div className="mt-4 pt-4 border-t border-gray-200">
                                                {/* [MOVED] "å»ºç«‹æ–°æ—…ç¨‹" button moved here */}
                                                <button 
                                                    onClick={()=>{setView('setup'); setIsMenuOpen(false);}} 
                                                    className="w-full text-left p-3 hover:bg-gray-100 rounded-xl mb-2 flex items-center gap-3 font-bold text-gray-600"
                                                >
                                                    <Plus size={18} /> å»ºç«‹æ–°æ—…ç¨‹
                                                </button>

                                                <button 
                                                    onClick={() => {
                                                        setIsMenuOpen(false);
                                                        setView('landing');
                                                    }}
                                                    className="w-full text-left p-3 hover:bg-gray-100 rounded-xl font-bold text-gray-500 flex items-center gap-2"
                                                >
                                                    <Settings size={18} /> å›åˆ°é€£ç·šè¨­å®š
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    {view === 'setup' && (
                                        <div className="p-8 h-full flex flex-col relative">
                                            {/* Header Area */}
                                            <div className="flex justify-center items-center mb-6 relative">
                                                <h2 className="text-3xl font-bold text-[#0ABAB5]">Travel Planner</h2>
                                            </div>

                                            {/* Content Area - Only Create Mode Now */}
                                            <div className="flex-1 overflow-y-auto no-scrollbar pb-20">
                                                <div className="space-y-4">
                                                    {/* Header "å»ºç«‹æ–°æ—…ç¨‹" removed here */}
                                                    <div className="space-y-3 p-1">
                                                        <input placeholder="ç›®çš„åœ°" value={setupForm.destination} onChange={e=>setSetupForm({...setupForm, destination:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                                        <div className="flex gap-2">
                                                            <input type="date" value={setupForm.startDate} onChange={e=>setSetupForm({...setupForm, startDate:e.target.value})} className="flex-1 p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 font-bold" />
                                                            <input type="date" value={setupForm.endDate} onChange={e=>setSetupForm({...setupForm, endDate:e.target.value})} className="flex-1 p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 font-bold" />
                                                        </div>
                                                        <select value={setupForm.currency} onChange={e=>setSetupForm({...formData, currency:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm font-bold outline-none text-gray-700">
                                                            {currencies.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}
                                                        </select>
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <input placeholder="æ‚¨çš„æš±ç¨±" value={setupForm.nickname} onChange={e=>setSetupForm({...setupForm, nickname:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                                            <input type="password" placeholder="è¨­å®š PIN ç¢¼" value={setupForm.pin} onChange={e=>setSetupForm({...setupForm, pin:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                                        </div>
                                                        <button onClick={handleStart} disabled={isCreating} className="w-full py-3.5 bg-[#0ABAB5] text-white rounded-xl font-bold shadow-sm hover:bg-[#008985] transition-all mt-4 flex items-center justify-center">{isCreating ? <Loader className="animate-spin" /> : 'é–‹å§‹è¦åŠƒ'}</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Planner & Expense Views */}
                                    {(view === 'planner' || view === 'expense') && (
                                        !tripData ? (
                                            <div className="flex h-full items-center justify-center flex-col gap-4 text-gray-400">
                                                 <Loader size={32} className="animate-spin text-[#0ABAB5]" />
                                                 <p>æ­£åœ¨æœå°‹æ—…ç¨‹...</p>
                                                 <button onClick={() => setView('landing')} className="text-sm underline hover:text-gray-600">å–æ¶ˆ</button>
                                            </div>
                                        ) : (
                                        <>
                                            {/* PASS EXPORT HANDLER TO HEADER */}
                                            <HeaderWithTabs tripData={tripData} selectedDate={selectedDate} setSelectedDate={setSelectedDate} handleAddDate={handleAddDate} view={view} setView={setView} setIsMenuOpen={setIsMenuOpen} onManageMembers={() => setModals({ ...modals, members: true })} isOffline={isOffline} onExportExpenses={handleExportExpenses} />
                                            
                                            <div className="flex-1 overflow-y-auto p-4 pb-24">
                                                {view === 'planner' ? (
                                                    <>
                                                        <div className="grid grid-cols-2 gap-3 mb-4">
                                                            {/* FIX: Pass selectedDate to ActivityModal */}
                                                            {isOwner && <button onClick={()=>setModals({...modals, activity:true})} className="py-2 rounded-xl bg-[#6A8E83] text-white font-bold flex justify-center items-center gap-2 border border-[#6A8E83] shadow-sm active:scale-95 transition-transform"><Plus size={18}/> æ–°å¢è¡Œç¨‹</button>}
                                                            <button onClick={()=>setModals({...modals, expense:true})} className={`py-2 rounded-xl bg-[#D68C68] text-white font-bold flex justify-center items-center gap-2 border border-[#D68C68] shadow-sm active:scale-95 transition-transform ${!isOwner ? 'col-span-2' : ''}`}><DollarSign size={18}/> è¨˜å¸³</button>
                                                        </div>

                                                        {/* Day Total Summary REMOVED HERE */}

                                                        {/* Fix: Added unique keys to FlightCards to prevent state leakage */}
                                                        {selectedDate === tripData.startDate && <FlightCard key="outbound" label="å»ç¨‹" icon={Plane} data={tripData.flights.outbound} onUpdate={(f,v)=>updateTrip('flights', {...tripData.flights, outbound: {...tripData.flights.outbound, [f]:v}})} isOwner={isOwner} />}
                                                        {selectedDate === tripData.endDate && <FlightCard key="inbound" label="å›ç¨‹" icon={Plane} data={tripData.flights.inbound} onUpdate={(f,v)=>updateTrip('flights', {...tripData.flights, inbound: {...tripData.flights.inbound, [f]:v}})} isOwner={isOwner} />}
                                                        <div className="space-y-2">
                                                            {sortedActivities.map(act => {
                                                                const isExpanded = expandedId === act.id;
                                                                // [MODIFIED] åˆ¤æ–·æ˜¯å¦ç‚ºæ¶ˆè²»é …ç›®ï¼Œç”¨æ–¼è¨­å®šåº•è‰²
                                                                const isExpense = act.transport === 'expense';
                                                                return (
                                                                <div key={act.id} className={`rounded-xl border overflow-hidden ${isExpense ? 'bg-[#FFF5F2] border-[#E6CEC5]' : 'bg-[#F5FDFC] border-[#eeeeee]'}`}>
                                                                    {/* [MODIFIED] é«˜åº¦ç¶­æŒ 2.2rem */}
                                                                    <div className="flex items-stretch min-h-[2.2rem] cursor-pointer" onClick={()=>setExpandedId(isExpanded?null:act.id)}>
                                                                        {/* å·¦å´æ™‚é–“æ¬„ */}
                                                                        <div className="w-14 flex flex-col items-center justify-center border-r border-gray-100 bg-white/50 py-0.5 px-0.5">
                                                                            <div onClick={(e) => e.stopPropagation()}><AutoSaveInput value={act.time} onSave={v=>updateActivity(act.id,'time',v)} readOnly={!isOwner} className="font-bold text-xs text-center bg-transparent w-full outline-none p-0 text-gray-700 leading-none" /></div>
                                                                            {isExpense ? <div className="text-[10px] text-orange-400 flex items-center gap-0.5 mt-0"></div> : <div className="flex items-center justify-center gap-0.5 mt-0 w-full"></div>}
                                                                        </div>
                                                                        
                                                                        {/* [MODIFIED] ä¸­é–“æ¨™é¡Œæ¬„ï¼šå¢åŠ  py-1 ç¸®å°å¯¦éš›è§¸ç™¼ç·¨è¼¯çš„ç¯„åœ (é»æ“Šä¸Šä¸‹é‚Šç·£å¯å±•é–‹) */}
                                                                        <div className="flex-1 flex items-center px-2 overflow-hidden">
                                                                            <div className="w-full py-1" onClick={(e) => e.stopPropagation()}>
                                                                                <AutoSaveInput value={act.title} onSave={v=>updateActivity(act.id,'title',v)} readOnly={!isOwner} className="font-bold text-sm bg-transparent w-full text-gray-800 leading-tight" />
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        {/* [MODIFIED] å³å´æŒ‰éˆ•æ¬„ï¼šæ”¹ç‚ºé å³å°é½Š (justify-end) ä¸¦åŠ ä¸Š pr-2ï¼Œç¢ºä¿ç®­é ­åœ¨æ‰€æœ‰åˆ—éƒ½å‚ç›´å°é½Š */}
                                                                        <div className="w-16 flex items-center justify-end gap-2 pr-2">
                                                                            {!isExpense && <button onClick={(e) => {e.stopPropagation(); openGoogleMaps(act.title);}} className="text-gray-400 hover:text-[#0ABAB5] flex items-center justify-center p-1"><Navigation size={12} /></button>}
                                                                            <ChevronDown size={16} className={`text-gray-400 transition ${isExpanded?'rotate-180':''}`}/>
                                                                        </div>
                                                                    </div>
                                                                    <div className={`transition-all ${isExpanded?'max-h-[500px]':'max-h-0'}`}>
                                                                        <div className="p-3 border-t border-gray-100 bg-[#F5FDFC] space-y-2">
                                                                            {/* [MODIFIED] å•Ÿç”¨ detectLinks åŠŸèƒ½ */}
                                                                            <AutoSaveInput detectLinks={true} value={act.note} onSave={v=>updateActivity(act.id,'note',v)} readOnly={!isOwner} placeholder="å‚™è¨»..." className="w-full text-xs bg-[#E2E2E2] rounded-lg p-2 text-gray-700 border border-[#eeeeee]" />
                                                                            
                                                                            {/* [NEW] è‡ªå‹•åµæ¸¬å‚™è¨»ä¸­çš„é€£çµä¸¦é¡¯ç¤ºæŒ‰éˆ• */}
                                                                            {act.note && act.note.match(/(https?:\/\/[^\s]+)/g) && (
                                                                                <div className="flex flex-wrap gap-2 px-1">
                                                                                    {act.note.match(/(https?:\/\/[^\s]+)/g).map((url, idx) => (
                                                                                        <a 
                                                                                            key={idx} 
                                                                                            href={url} 
                                                                                            target="_blank" 
                                                                                            rel="noopener noreferrer" 
                                                                                            className="inline-flex items-center gap-1 text-[10px] text-[#0ABAB5] bg-[#E0F2F1] px-2 py-1 rounded-md border border-[#B2DFDB] hover:bg-[#B2DFDB] transition-colors no-underline"
                                                                                            onClick={(e) => e.stopPropagation()}
                                                                                        >
                                                                                            <ExternalLink size={10} /> é€£çµ {idx + 1}
                                                                                        </a>
                                                                                    ))}
                                                                                </div>
                                                                            )}

                                                                            {!isExpense && <div className="grid grid-cols-2 gap-2">
                                                                                {/* [MODIFIED] æ”¹ç‚ºå·¦å³æ’åˆ— (Flex) ä»¥ç¸®æ¸›é«˜åº¦ */}
                                                                                <div className="flex items-center gap-2 bg-[#E2E2E2] px-2 py-1 rounded-lg border border-[#eeeeee]">
                                                                                    <label className="text-[10px] text-gray-400 font-bold whitespace-nowrap">ä»£ç¢¼</label>
                                                                                    <AutoSaveInput value={act.bookingCode} onSave={v=>updateActivity(act.id,'bookingCode',v)} readOnly={!isOwner} className="text-xs bg-transparent w-full text-gray-700 outline-none"/>
                                                                                </div>
                                                                                <div className="flex items-center gap-2 bg-[#E2E2E2] px-2 py-1 rounded-lg border border-[#eeeeee]">
                                                                                    <label className="text-[10px] text-gray-400 font-bold whitespace-nowrap">è²»ç”¨</label>
                                                                                    <AutoSaveInput value={act.cost} onSave={v=>updateActivity(act.id,'cost',v)} type="number" readOnly={!isOwner} className="text-xs bg-transparent w-full text-gray-700 outline-none"/>
                                                                                </div>
                                                                            </div>}
                                                                            {isExpense && <div className="flex gap-2 bg-orange-50 p-2 rounded-lg border border-orange-100 text-xs"><div className="flex-1 text-orange-600 font-bold">${act.cost}</div><div className="flex-1">{act.currency}</div><div className="flex-1">{act.category}</div><div className="text-[10px] text-gray-400 self-center">{act.payer}ä»˜</div></div>}
                                                                            <div>
                                                                                <div className="flex justify-between items-center mb-1"><label className="text-[10px] font-bold text-gray-400">ç…§ç‰‡</label>
                                                                                    <div className="flex gap-2">
                                                                                        {!isExpense && isOwner && <button onClick={() => { setEditingActivity(act); setModals({ ...modals, activity: true }); }} className="text-blue-400 hover:text-blue-600"><Pencil size={14} /></button>}
                                                                                        {isExpense && (isOwner || act.createdBy === currentMember?.name) && <button onClick={() => { setEditingExpense({...act, originalDate: selectedDate}); setModals({ ...modals, expense: true }); }} className="text-blue-400 hover:text-blue-600"><Pencil size={14} /></button>}
                                                                                        {(isOwner || (isExpense && act.createdBy === currentMember?.name)) && <button onClick={() => isExpense ? deleteTransaction(act.id, selectedDate, act) : deleteActivity(act.id)} className="text-red-400 hover:text-red-600"><Trash2 size={14}/></button>}
                                                                                    </div>
                                                                                </div>
                                                                                <div className="flex gap-2 overflow-x-auto">{act.photoUrls?.map((p,i) => { 
                                                                                    if (!p) return null;
                                                                                    const url = typeof p === 'string' ? p : p.url; 
                                                                                    return (<div key={i} className="relative w-10 h-10 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded" onClick={()=>setModals({...modals, viewingImage:url})} />{(isOwner || (typeof p !== 'string' && p.uploader === currentMember?.name)) && <button onClick={()=>setConfirm({open:true, msg:'åˆªé™¤ç…§ç‰‡?', action:()=>{const n=[...act.photoUrls]; n.splice(i,1); updateActivity(act.id, 'photoUrls', n)}})} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button>}</div>) })}
                                                                                    {/* [FIX] å‚³å…¥ data: actï¼Œä¿®å¾©ç…§ç‰‡è¦†è“‹å•é¡Œ */}
                                                                                    <button onClick={()=>{setUploadTarget({type:'activity', id:act.id, data: act}); fileRef.current.click();}} className="w-10 h-10 border-2 border-dashed rounded flex items-center justify-center text-gray-400"><Camera size={14}/></button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )})}
                                                        </div>
                                                        <AccommodationCard 
                                                            date={selectedDate} 
                                                            data={Array.isArray(tripData.accommodations?.[selectedDate]) ? tripData.accommodations[selectedDate] : (tripData.accommodations?.[selectedDate] ? [tripData.accommodations[selectedDate]] : [])} 
                                                            onUpdate={handleUpdateAccommodation} 
                                                            // [FIX] å‚³å…¥ data: itemDataï¼Œä¿®å¾©ä½å®¿ç…§ç‰‡è¦†è“‹å•é¡Œ
                                                            onPhotoUpload={(id) => { 
                                                                const currentList = Array.isArray(tripData.accommodations?.[selectedDate]) ? tripData.accommodations[selectedDate] : [];
                                                                const itemData = currentList.find(i => i.id === id);
                                                                setUploadTarget({type: 'accom', id: id, data: itemData}); 
                                                                fileRef.current?.click(); 
                                                            }} 
                                                            onPhotoDelete={handlePhotoDelete} 
                                                            onViewImage={(u)=>setModals({...modals, viewingImage:u})} 
                                                            onAdd={handleAddAccommodation} 
                                                            onDelete={handleDeleteAccommodation} 
                                                            isOwner={isOwner} 
                                                            currentMember={currentMember} 
                                                            members={tripData.members}
                                                        />
                                                        
                                                        {isOwner && (
                                                            <div className="mt-8 mb-4 flex justify-center">
                                                                <button 
                                                                    onClick={handleDeleteDate}
                                                                    className="flex items-center gap-2 px-4 py-2 bg-red-50 text-red-400 rounded-xl text-xs font-bold hover:bg-red-100 hover:text-red-500 transition-colors border border-red-100"
                                                                >
                                                                    <Trash2 size={14} /> åˆªé™¤ç•¶æ—¥ ({selectedDate})
                                                                </button>
                                                            </div>
                                                        )}
                                                    </>
                                                ) : (
                                                    // Expense View
                                                    <div className="space-y-6">
                                                        <div className="flex flex-col gap-3 mb-2">
                                                            <div className="flex justify-between items-center">
                                                                <h3 className="text-lg font-bold text-gray-700 flex items-center gap-2">
                                                                    <History size={20} className="text-[#D68C68]" /> äº¤æ˜“ç´€éŒ„
                                                                </h3>
                                                                
                                                                {/* Button is now correctly positioned outside h3, and the parent flex container ensures alignment */}
                                                                <button
                                                                    onClick={handleExportExpenses}
                                                                    className="flex items-center justify-center p-1.5 bg-[#D68C68]/20 hover:bg-[#D68C68]/30 text-[#D68C68] rounded-full transition-colors"
                                                                    title="åŒ¯å‡ºæ‰€æœ‰è¨˜å¸³ç´€éŒ„ (CSV)"
                                                                >
                                                                    <Download size={16} />
                                                                </button>
                                                            </div>
                                                            
                                                            {/* ç¯©é¸å™¨å€åŸŸ */}
                                                            <div className="flex gap-2 w-full">
                                                                {/* ä»˜æ¬¾äººç¯©é¸ */}
                                                                <div className="relative flex-1">
                                                                    <select 
                                                                        value={expenseFilterPayer} 
                                                                        onChange={(e) => setExpenseFilterPayer(e.target.value)} 
                                                                        className="w-full appearance-none pl-3 pr-8 py-2 bg-[#E2E2E2] border border-gray-200 text-gray-700 text-xs font-bold rounded-lg shadow-sm focus:outline-none focus:ring-1 focus:ring-[#0ABAB5] cursor-pointer"
                                                                    >
                                                                        <option value="all">æ‰€æœ‰æˆå“¡</option>
                                                                        {tripData.members.map(m => (
                                                                            // FIX: Guard clause
                                                                            m ? <option key={m.name} value={m.name}>{m.name}</option> : null
                                                                        ))}
                                                                    </select>
                                                                    <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                                                                        <ChevronDown size={12} />
                                                                    </div>
                                                                </div>

                                                                {/* æ—¥æœŸç¯©é¸ */}
                                                                <div className="relative flex-1">
                                                                    <select 
                                                                        value={expenseFilterDate} 
                                                                        onChange={(e) => setExpenseFilterDate(e.target.value)} 
                                                                        className="w-full appearance-none pl-3 pr-8 py-2 bg-[#E2E2E2] border border-gray-200 text-gray-700 text-xs font-bold rounded-lg shadow-sm focus:outline-none focus:ring-1 focus:ring-[#0ABAB5] cursor-pointer"
                                                                    >
                                                                        <option value="all">å…¨éƒ¨æ—¥æœŸ</option>
                                                                        {getDatesArray(tripData.startDate, tripData.endDate).map(date => (
                                                                            <option key={date} value={date}>{date}</option>
                                                                        ))}
                                                                    </select>
                                                                    <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                                                                        <ChevronDown size={12} />
                                                                    </div>
                                                                </div>

                                                                {/* å¹£åˆ¥ç¯©é¸ */}
                                                                <div className="relative flex-1">
                                                                    <select 
                                                                        value={expenseFilterCurrency} 
                                                                        onChange={(e) => setExpenseFilterCurrency(e.target.value)} 
                                                                        className="w-full appearance-none pl-3 pr-8 py-2 bg-[#E2E2E2] border border-gray-200 text-gray-700 text-xs font-bold rounded-lg shadow-sm focus:outline-none focus:ring-1 focus:ring-[#0ABAB5] cursor-pointer"
                                                                    >
                                                                        <option value="all">æ‰€æœ‰å¹£åˆ¥</option>
                                                                        {currencies.map(c => (
                                                                            <option key={c.value} value={c.value}>{c.value}</option>
                                                                        ))}
                                                                    </select>
                                                                    <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                                                                        <ChevronDown size={12} />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* [NEW] çµ±è¨ˆç¶­åº¦åˆ‡æ›èˆ‡ä¸‹é‘½å°èˆª */}
                                                        {drillDownCategory ? (
                                                            // [MODIFIED] ä¸‹é‘½å°èˆªåˆ—ï¼šæ”¹ç‚ºè¨˜å¸³ä¸»é¡Œè‰²ç³» (æ·ºç²‰è†šåº•ã€æ©˜å­—)
                                                            <div className="flex items-center gap-2 mb-2 bg-[#FFF5F2] p-2 rounded-xl text-sm border border-[#E6CEC5] animate-fade-in">
                                                                <button 
                                                                    onClick={() => setDrillDownCategory(null)} 
                                                                    className="flex items-center gap-1 font-bold text-[#D68C68] hover:underline"
                                                                >
                                                                    <ArrowRightCircle size={16} className="rotate-180"/> è¿”å›
                                                                </button>
                                                                <span className="text-gray-400">|</span>
                                                                <span className="font-bold text-gray-700 flex items-center gap-1">
                                                                    <div className="w-2.5 h-2.5 rounded-full" style={{backgroundColor: CATEGORY_COLORS[drillDownCategory] || '#ccc'}}></div>
                                                                    {drillDownCategory} åˆ†æ”¤è©³æƒ…
                                                                </span>
                                                            </div>
                                                        ) : (
                                                            /* [NEW] çµ±è¨ˆç¶­åº¦åˆ‡æ› (ä¾é¡åˆ¥ vs ä¾æˆå“¡) - åƒ…åœ¨éä¸‹é‘½æ¨¡å¼é¡¯ç¤º */
                                                            <div className="flex bg-[#E2E2E2] p-1 rounded-xl mb-2">
                                                                {/* [MODIFIED] æŒ‰éˆ•é¸å–ç‹€æ…‹ï¼šæ”¹ç‚ºå¯¦å¿ƒèƒŒæ™¯è‰² #4DB6AC (æ·ºç¶ ) é…ç™½è‰²æ–‡å­—ï¼Œç¬¦åˆä¸Šæ–¹è‰²ç³»ä½†è¼ƒæ·¡ */}
                                                                <button onClick={() => setExpenseViewMode('category')} className={`flex-1 py-1.5 text-xs font-bold rounded-lg transition-all flex items-center justify-center gap-1 ${expenseViewMode === 'category' ? 'bg-[#4DB6AC] text-white shadow-md' : 'text-gray-500 hover:bg-white/50'}`}>
                                                                    <PieChart size={12} /> ä¾é¡åˆ¥
                                                                </button>
                                                                <button onClick={() => setExpenseViewMode('member')} className={`flex-1 py-1.5 text-xs font-bold rounded-lg transition-all flex items-center justify-center gap-1 ${expenseViewMode === 'member' ? 'bg-[#4DB6AC] text-white shadow-md' : 'text-gray-500 hover:bg-white/50'}`}>
                                                                    <Users size={12} /> ä¾æˆå“¡åˆ†æ”¤
                                                                </button>
                                                            </div>
                                                        )}

                                                        {/* Modified: Statistics Section Moved to Top */}
                                                        {expenseStatsByCurrency.length === 0 && sortedExpensesByDate.length > 0 ? (
                                                            <div className="text-center text-gray-400 text-xs mt-4">ç„¡çµ±è¨ˆæ•¸æ“š</div>
                                                        ) : (
                                                            expenseStatsByCurrency.map(stat => (
                                                                <div key={stat.currency} className="space-y-4 pt-4 mt-4 border-t-2 border-dashed border-gray-200 first:border-0 first:mt-0 first:pt-0">
                                                                    {/* [MODIFIED] ç§»é™¤åº•æ¡†ï¼Œç¸®å°æ–‡å­—ï¼Œæ”¹ç‚ºç°¡ç´„é¢¨æ ¼ */}
                                                                    <div className="flex items-center gap-2 mb-2 px-1">
                                                                        <div className={`h-3 w-1 rounded-full ${stat.currency === 'JPY' ? 'bg-red-400' : 'bg-blue-400'}`}></div>
                                                                        <h4 className="font-bold text-gray-500 text-sm flex-1 tracking-wide">{stat.currency === 'JPY' ? 'ğŸ‡¯ğŸ‡µ æ—¥åœ“' : 'ğŸ‡¹ğŸ‡¼ å°å¹£'} çµ±è¨ˆ</h4>
                                                                    </div>
                                                                    
                                                                    <div className="bg-[#F5FDFC] p-4 rounded-xl border border-[#eeeeee]">
                                                                        <h3 className="font-bold text-gray-700 mb-4 text-sm flex items-center gap-2">
                                                                            <PieChart size={16} /> 
                                                                            {drillDownCategory ? 'æˆå“¡åˆ†æ”¤æ¯”ä¾‹' : (expenseViewMode === 'member' ? 'æˆå“¡æ”¯å‡ºæ¯”ä¾‹' : 'æ”¯å‡ºé¡åˆ¥çµ±è¨ˆ')}
                                                                            {!drillDownCategory && expenseViewMode === 'category' && <span className="text-[10px] text-gray-400 font-normal ml-2">(é»æ“Šåœ–è¡¨å¯æŸ¥çœ‹åˆ†æ”¤)</span>}
                                                                            {/* [MODIFIED] æ–°å¢æç¤ºï¼šä¸‹é‘½æ¨¡å¼ä¸‹ï¼Œé»æ“Šåœ–è¡¨å¯è¿”å› */}
                                                                            {drillDownCategory && <span className="text-[10px] text-gray-400 font-normal ml-2 cursor-pointer" onClick={() => setDrillDownCategory(null)}>(é»æ“Šåœ–è¡¨è¿”å›)</span>}
                                                                        </h3>
                                                                        {/* [MODIFIED] ä¿®æ”¹é»æ“Šé‚è¼¯ï¼šè‹¥å·²åœ¨ä¸‹é‘½æ¨¡å¼ (drillDownCategory æœ‰å€¼)ï¼Œé»æ“Šå‰‡æ¸…ç©º (è¿”å›) */}
                                                                        <SimplePieChart 
                                                                            data={stat.pieData} 
                                                                            onSliceClick={
                                                                                drillDownCategory 
                                                                                    ? () => setDrillDownCategory(null) 
                                                                                    : (expenseViewMode === 'category' ? (cat) => setDrillDownCategory(cat) : null)
                                                                            }
                                                                        />
                                                                        
                                                                        {/* New: Category Breakdown List */}
                                                                        <div className="mt-6 space-y-2">
                                                                            {stat.pieData.map(item => (
                                                                                <div 
                                                                                    key={item.category} 
                                                                                    onClick={() => (!drillDownCategory && expenseViewMode === 'category') ? setDrillDownCategory(item.category) : null}
                                                                                    className={`flex justify-between items-center text-xs border-b border-dashed border-gray-200 pb-2 last:border-0 last:pb-0 ${(!drillDownCategory && expenseViewMode === 'category') ? 'cursor-pointer hover:bg-gray-50 p-1 rounded transition-colors' : ''}`}
                                                                                >
                                                                                    <div className="flex items-center gap-2">
                                                                                        <div className="w-2.5 h-2.5 rounded-full shadow-sm" style={{backgroundColor: item.color}}></div>
                                                                                        <span className="text-gray-600 font-medium">{item.category}</span>
                                                                                        {/* ä¸‹é‘½æŒ‡ç¤ºç®­é ­ */}
                                                                                        {!drillDownCategory && expenseViewMode === 'category' && <ArrowRightCircle size={10} className="text-gray-300" />}
                                                                                    </div>
                                                                                    <div className="flex items-center gap-2">
                                                                                        <span className="text-gray-400 text-[10px]">({Math.round((item.value / stat.total) * 100)}%)</span>
                                                                                        <span className="font-bold text-gray-700 text-sm">${item.value.toLocaleString()}</span>
                                                                                    </div>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    <div className="bg-[#F5FDFC] p-4 rounded-xl border border-[#eeeeee]">
                                                                        <h3 className="font-bold text-gray-700 mb-4 text-sm flex items-center gap-2"><BarChart3 size={16} /> æ¯æ—¥è¶¨å‹¢</h3>
                                                                        <SimpleBarChart data={stat.barData} />
                                                                    </div>

                                                                    {/* Total Expense */}
                                                                    <div className="bg-[#FFF3E0] p-4 rounded-xl border border-[#FFE0B2] flex justify-between items-center shadow-sm">
                                                                        <span className="font-bold text-[#D68C68] text-sm">ç¸½æ”¯å‡º ({stat.currency})</span>
                                                                        <span className="font-bold text-[#D68C68] text-2xl">${stat.total.toLocaleString()}</span>
                                                                    </div>
                                                                </div>
                                                            ))
                                                        )}

                                                        <div className="bg-[#F5FDFC] p-4 rounded-xl border border-[#eeeeee] shadow-sm">
                                                            {/* [MODIFIED] ä¿®æ”¹æ¨™é¡Œåˆ—ï¼ŒåŠ å…¥ç¨ç«‹çš„æ—¥æœŸä¸‹æ‹‰é¸å–® */}
                                                            <div className="flex justify-between items-center mb-2">
                                                                <div className="text-xs font-bold text-gray-400">è©³ç´°åˆ—è¡¨</div>
                                                                <div className="relative">
                                                                    <select 
                                                                        value={expenseListFilterDate} 
                                                                        onChange={(e) => setExpenseListFilterDate(e.target.value)} 
                                                                        className="appearance-none bg-transparent pl-2 pr-4 text-[10px] font-bold text-[#0ABAB5] outline-none cursor-pointer hover:underline text-right"
                                                                    >
                                                                        <option value="all">é¡¯ç¤ºå…¨éƒ¨æ—¥æœŸ</option>
                                                                        {getDatesArray(tripData.startDate, tripData.endDate).map(date => (
                                                                            <option key={date} value={date}>{date} ({getDayOfWeek(date)})</option>
                                                                        ))}
                                                                    </select>
                                                                    <div className="absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none text-[#0ABAB5]">
                                                                        <ChevronDown size={10} />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {sortedExpensesByDate.length === 0 ? (
                                                                <div className="text-center py-8 text-gray-400 border-2 border-dashed border-gray-300 rounded-xl">å°šç„¡æ¶ˆè²»ç´€éŒ„</div>
                                                            ) : (
                                                                <div className="space-y-4">
                                                                    {sortedExpensesByDate.map(({ date, items }) => (
                                                                        <div key={date}>
                                                                            <div className="flex items-center gap-2 mb-2">
                                                                                <span className="text-[10px] font-bold text-gray-500 bg-white/60 px-1.5 py-0.5 rounded border border-gray-200">{date}</span>
                                                                                <span className="text-[10px] text-gray-400">({getDayOfWeek(date)})</span>
                                                                            </div>
                                                                            <div className="space-y-2">
                                                                                {items.map(e => {
                                                                                    const isCreator = e.createdBy === currentMember?.name;
                                                                                    const canDelete = isOwner || (!e.isAccommodation && isCreator);
                                                                                    const canEdit = !e.isAccommodation && (isOwner || isCreator);
                                                                                    
                                                                                    return (
                                                                                    // [MODIFIED] ä¿®æ”¹ Layoutï¼šä½¿ç”¨å›ºå®šå¯¬åº¦çš„å³å´å€å¡Šä¾†é”æˆå°é½Š
                                                                                    <div key={e.id} onClick={() => !e.isAccommodation && setModals({...modals, transaction:e})} className={`flex items-center bg-[#EDF7F6] p-2 rounded-lg border border-[#E0F2F1] ${!e.isAccommodation ? 'active:scale-[0.99] transition-transform cursor-pointer' : ''}`}>
                                                                                        
                                                                                        {/* å·¦å´ï¼šæ–‡å­—è³‡è¨Š (Flex-1 è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ï¼Œæ”¯æ´æ›è¡Œ) */}
                                                                                        <div className="flex-1 min-w-0 pr-2 flex flex-col justify-center">
                                                                                            <div className="font-bold text-gray-700 text-sm leading-tight break-words">{e.title || 'æœªå‘½å'}</div>
                                                                                            <div className="text-[10px] text-gray-400 flex flex-wrap items-center gap-1 mt-1">
                                                                                                <span className="bg-[#E2E2E2] px-1.5 py-0.5 rounded text-gray-500 whitespace-nowrap">{e.category}</span>
                                                                                                <span className="whitespace-nowrap">â€¢ {e.payer}</span>
                                                                                                {e.time && <span className="whitespace-nowrap">â€¢ {e.time}</span>}
                                                                                            </div>
                                                                                        </div>

                                                                                        {/* å³å´ï¼šé‡‘é¡èˆ‡æŒ‰éˆ• (å›ºå®šå¯¬åº¦å€å¡Šï¼Œç¢ºä¿ä¸Šä¸‹å°é½Š) */}
                                                                                        <div className="flex items-center shrink-0 gap-1">
                                                                                            
                                                                                            {/* é‡‘é¡ï¼šå›ºå®šå¯¬åº¦ w-24 (ç´„96px)ï¼Œå‘å³å°é½Šï¼Œç¢ºä¿æ•¸å­—æ•´é½Šæ’åˆ— */}
                                                                                            <div className="w-24 flex justify-end">
                                                                                                <div className="text-red-500 font-bold text-sm bg-red-50 px-2 py-1 rounded-lg text-right truncate w-full">
                                                                                                    -{e.cost} <span className="text-[10px] font-normal text-red-400">{e.currency}</span>
                                                                                                </div>
                                                                                            </div>
                                                                                            
                                                                                            {/* ç·¨è¼¯æŒ‰éˆ•æ ¼ï¼šå›ºå®š w-8ï¼Œè‹¥ç„¡æ¬Šé™å‰‡ç•™ç™½ (Empty Div) */}
                                                                                            <div className="w-8 flex justify-center">
                                                                                                {canEdit ? (
                                                                                                    <button 
                                                                                                        onClick={(evt) => { 
                                                                                                            evt.stopPropagation(); 
                                                                                                            setEditingExpense({ ...e, originalDate: date }); 
                                                                                                            setModals({...modals, expense: true}); 
                                                                                                        }} 
                                                                                                        className="text-gray-400 hover:text-blue-500 p-1.5 rounded-full hover:bg-blue-50 transition-colors"
                                                                                                    >
                                                                                                        <Edit3 size={16} />
                                                                                                    </button>
                                                                                                ) : <div className="w-8"></div>}
                                                                                            </div>
                                                                                            
                                                                                            {/* åˆªé™¤æŒ‰éˆ•æ ¼ï¼šå›ºå®š w-8ï¼Œè‹¥ç„¡æ¬Šé™å‰‡ç•™ç™½ */}
                                                                                            <div className="w-8 flex justify-center">
                                                                                                {canDelete ? (
                                                                                                    <button 
                                                                                                        onClick={(evt) => { 
                                                                                                            evt.stopPropagation(); 
                                                                                                            deleteTransaction(e.id, date, e); 
                                                                                                        }} 
                                                                                                        className="text-gray-400 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-colors"
                                                                                                    >
                                                                                                        <Trash2 size={16} />
                                                                                                    </button>
                                                                                                ) : <div className="w-8"></div>}
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                );
                                                                                })}
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            <ActivityModal isOpen={modals.activity} onClose={() => { setModals({...modals, activity:false}); setEditingActivity(null); }} onSave={handleSaveActivity} tripData={tripData} defaultValues={editingActivity} currentMember={currentMember} selectedDate={selectedDate} onUpdateCategories={c=>updateTrip('expenseCategories',c)} />
                                            <ExpenseModal 
                                                isOpen={modals.expense} 
                                                onClose={()=> { setModals({...modals, expense:false}); setEditingExpense(null); }} 
                                                tripData={tripData} 
                                                onSave={handleSaveExpense} 
                                                onUpdateCategories={c=>updateTrip('expenseCategories',c)} 
                                                selectedDate={selectedDate} 
                                                currentMember={currentMember}
                                                defaultValues={editingExpense}
                                            />
                                            {modals.transaction && (
                                                <TransactionDetailModal 
                                                    transaction={modals.transaction} 
                                                    onClose={() => setModals({ ...modals, transaction: null })} 
                                                    onViewImage={(url) => setModals({ ...modals, viewingImage: url })} 
                                                />
                                            )}
                                            <ImageModal src={modals.viewingImage} onClose={()=>setModals({...modals, viewingImage:null})} />
                                            {modals.editTrip && <EditTripModal isOpen={modals.editTrip} onClose={() => setModals({ ...modals, editTrip: false })} tripData={tripData} onSave={handleEditTripSave} />}
                                            <JoinModal isOpen={modals.join} onClose={() => setModals(m => ({...m, join: false}))} tripData={tripData} onJoin={handleJoinTrip} />
                                            <MemberManagementModal 
                                                isOpen={modals.members} 
                                                onClose={() => setModals({ ...modals, members: false })} 
                                                tripData={tripData} 
                                                currentMember={currentMember} 
                                                onUpdateMember={handleUpdateMember} 
                                                onRemoveMember={handleRemoveMember}
                                                onAddMember={handleAddMember}
                                            />
                                            <input type="file" ref={fileRef} className="hidden" onChange={handlePhotoUpload} accept="image/*" />
                                        </>
                                        )
                                    )}
                                </>
                            )}
                            
                            {/* GLOBAL MODALS */}
                            <ConfirmModal isOpen={confirm.open} message={confirm.msg} onConfirm={()=>{confirm.action(); setConfirm({open:false})}} onCancel={()=>setConfirm({open:false})} />
                        </>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>