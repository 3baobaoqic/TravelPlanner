<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Good Travel Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
    <style>
        * { -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }
        @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .animate-slide-in-left { animation: slideInLeft 0.3s ease-out forwards; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f9f9f9; 
            color: #4b5563; 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden; 
        }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* CSS Hack to hide AM/PM text in WebKit browsers */
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            display: none;
        }
        /* Disable input interaction when readOnly */
        input:read-only, select:disabled, textarea:read-only {
            pointer-events: none;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp, getApps, deleteApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { Calendar, MapPin, Clock, Train, Bus, Car, Footprints, Plane, TramFront, Plus, Trash2, Map, ArrowRight, Image, Loader, X, DollarSign, Navigation, PieChart, Menu, History, LogOut, Check, CloudSun, Timer, BarChart3, BedDouble, Phone, LogOut as CheckOutIcon, Settings, Camera, ChevronDown, LogIn, LogOut as LogOutIcon, Pencil, Users, Wifi, WifiOff, Edit3, CloudCog, Shield, Save, UserX } from 'lucide-react';

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-travel-planner';

        // --- Constants ---
        const currencies = [
            { value: 'JPY', label: '日圓 (JPY)' },
            { value: 'TWD', label: '新台幣 (NTD)' },
            { value: 'USD', label: '美元 (USD)' },
            { value: 'KRW', label: '韓元 (KRW)' },
            { value: 'EUR', label: '歐元 (EUR)' }
        ];

        const transportOptions = [
            { value: 'walk', label: '步行', icon: Footprints }, { value: 'car', label: '自駕', icon: Car },
            { value: 'taxi', label: '計程車', icon: Car }, { value: 'bus', label: '公車', icon: Bus },
            { value: 'train', label: '電車', icon: Train }, { value: 'shinkansen', label: '新幹線', icon: Train },
            { value: 'nightbus', label: '夜間巴士', icon: Bus }, { value: 'tram', label: '路面電車', icon: TramFront },
            { value: 'plane', label: '飛機', icon: Plane },
        ];

        const durationOptions = Array.from({ length: 20 }, (_, i) => {
            const m = (i + 1) * 15, h = Math.floor(m / 60), min = m % 60;
            return { value: String(m), label: h === 0 ? `${min} 分鐘` : min === 0 ? `${h} 小時` : `${h} 小時 ${min} 分` };
        });

        const CATEGORY_COLORS = { '餐飲': '#FF6384', '交通': '#36A2EB', '住宿': '#FFCE56', '購物': '#4BC0C0', '娛樂': '#9966FF', '門票': '#FF9F40', '藥妝': '#FF6B6B', '其他': '#C9CBCF' };
        const PALETTE = Object.values(CATEGORY_COLORS);
        const TIME_OPTIONS = [];
        for(let i=0; i<24; i++) {
            const h = String(i).padStart(2, '0');
            TIME_OPTIONS.push(`${h}:00`);
            TIME_OPTIONS.push(`${h}:30`);
        }

        // --- Dynamic Firebase Helper ---
        const initFirebaseSystem = async () => {
            let config = null;
            
            if (typeof __firebase_config !== 'undefined') {
                try {
                    config = JSON.parse(__firebase_config);
                } catch (e) {
                    console.error("Error parsing __firebase_config", e);
                }
            }

            const storedConfigStr = localStorage.getItem('gtp_firebase_config');
            if (storedConfigStr) {
                try {
                    const manualConfig = JSON.parse(storedConfigStr);
                    if (manualConfig.apiKey && manualConfig.projectId) {
                        config = manualConfig;
                    }
                } catch (e) {
                    console.error("Error parsing stored config", e);
                }
            }

            if (!config) {
                return { auth: null, db: null, valid: false };
            }

            try {
                if (getApps().length > 0) {
                    await Promise.all(getApps().map(app => deleteApp(app)));
                }

                const app = initializeApp(config);
                const auth = getAuth(app);
                const db = getFirestore(app);
                return { auth, db, valid: true };
            } catch (e) {
                console.error("Firebase Init Error:", e);
                return { auth: null, db: null, valid: false, error: e };
            }
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);
        const resizeImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height, max = 1024;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
        const sanitizeFirestoreData = (data) => JSON.parse(JSON.stringify(data, (k, v) => v === undefined ? null : v));
        const getDatesArray = (s, e) => { const a = [], d = new Date(s), ed = new Date(e); while(d<=ed) { a.push(new Date(d).toISOString().split('T')[0]); d.setDate(d.getDate()+1); } return a; };
        const getDayOfWeek = (d) => ['週日','週一','週二','週三','週四','週五','週六'][new Date(d).getDay()];
        const getMonthDay = (d) => { const date = new Date(d); return `${date.getMonth()+1}/${date.getDate()}`; };

        const ConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => !isOpen ? null : (
            <div className="fixed inset-0 z-[100] flex items-center justify-center px-4">
                <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onCancel}></div>
                <div className="bg-[#F5FDFC] w-full max-w-xs rounded-2xl p-6 border border-[#eeeeee] relative z-10 flex flex-col items-center text-center">
                    <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-500"><Trash2 size={24} /></div>
                    <h3 className="text-lg font-bold text-gray-800 mb-2">確認</h3>
                    <p className="text-gray-600 mb-6 text-sm">{message}</p>
                    <div className="flex gap-3 w-full">
                        <button onClick={onCancel} className="flex-1 py-2.5 rounded-xl text-gray-500 font-bold bg-gray-200 border border-[#eeeeee]">取消</button>
                        <button onClick={onConfirm} className="flex-1 py-2.5 rounded-xl bg-red-500 text-white font-bold border border-red-500">確定</button>
                    </div>
                </div>
            </div>
        );

        const MemberManagementModal = ({ isOpen, onClose, tripData, currentMember, onUpdateMember, onRemoveMember }) => {
            const [editingIndex, setEditingIndex] = useState(null);
            const [editForm, setEditForm] = useState({ name: '', pin: '' });
            const [confirmRemove, setConfirmRemove] = useState(null);

            if (!isOpen || !tripData) return null;

            const isOwner = currentMember?.role === 'owner';

            const handleEditClick = (member, index) => {
                setEditingIndex(index);
                setEditForm({ name: member.name, pin: member.pin });
            };

            const handleSaveClick = (index) => {
                if (!editForm.name.trim() || !editForm.pin.trim()) {
                    alert("暱稱與 PIN 碼不得為空");
                    return;
                }
                onUpdateMember(index, editForm);
                setEditingIndex(null);
            };

            const handleRemoveClick = (index) => {
                setConfirmRemove(index);
            };

            return (
                <div className="fixed inset-0 z-[90] flex items-center justify-center px-4">
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-full max-w-md rounded-2xl p-6 border border-[#eeeeee] relative z-10 flex flex-col max-h-[85vh]">
                        <div className="flex justify-between items-center mb-4 border-b border-[#eeeeee] pb-2">
                            <h3 className="text-lg font-bold text-[#0ABAB5] flex items-center gap-2"><Users size={20}/> 旅伴管理</h3>
                            <button onClick={onClose}><X size={20} className="text-gray-400" /></button>
                        </div>

                        <div className="space-y-3 overflow-y-auto p-1">
                            {tripData.members.map((member, index) => {
                                const isEditing = editingIndex === index;
                                const isSelf = member.name === currentMember.name;
                                const isMemberOwner = member.role === 'owner';
                                const canEdit = isOwner || isSelf; 
                                const canRemove = isOwner && !isMemberOwner; 

                                return (
                                    <div key={index} className={`p-3 rounded-xl border ${isSelf ? 'border-[#0ABAB5] bg-[#E0F2F1]' : 'border-[#eeeeee] bg-white'} flex items-center justify-between`}>
                                        {isEditing ? (
                                            <div className="flex-1 flex gap-2 items-center">
                                                <input 
                                                    value={editForm.name} 
                                                    onChange={e => setEditForm({...editForm, name: e.target.value})}
                                                    className="w-1/2 p-2 text-sm bg-white border border-[#eeeeee] rounded-lg outline-none focus:border-[#0ABAB5]"
                                                    placeholder="暱稱"
                                                />
                                                <input 
                                                    value={editForm.pin} 
                                                    onChange={e => setEditForm({...editForm, pin: e.target.value})}
                                                    className="w-1/3 p-2 text-sm bg-white border border-[#eeeeee] rounded-lg outline-none focus:border-[#0ABAB5]"
                                                    placeholder="PIN"
                                                />
                                                <button onClick={() => handleSaveClick(index)} className="text-green-500 p-1"><Save size={18} /></button>
                                                <button onClick={() => setEditingIndex(null)} className="text-gray-400 p-1"><X size={18} /></button>
                                            </div>
                                        ) : (
                                            <>
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs ${isMemberOwner ? 'bg-yellow-400' : 'bg-gray-400'}`}>
                                                        {member.name.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <div className="font-bold text-gray-700 text-sm flex items-center gap-1">
                                                            {member.name}
                                                            {isMemberOwner && <Shield size={12} className="text-yellow-500"/>}
                                                            {isSelf && <span className="text-[10px] text-[#0ABAB5] bg-[#0ABAB5]/10 px-1 rounded">我</span>}
                                                        </div>
                                                        <div className="text-[10px] text-gray-400">PIN: {isOwner || isSelf ? member.pin : '****'}</div>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex gap-1">
                                                    {canEdit && (
                                                        <button onClick={() => handleEditClick(member, index)} className="p-2 text-gray-400 hover:text-[#0ABAB5] transition-colors">
                                                            <Edit3 size={16} />
                                                        </button>
                                                    )}
                                                    {canRemove && (
                                                        <button onClick={() => handleRemoveClick(index)} className="p-2 text-gray-400 hover:text-red-500 transition-colors">
                                                            <UserX size={16} />
                                                        </button>
                                                    )}
                                                </div>
                                            </>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                    <ConfirmModal 
                        isOpen={confirmRemove !== null} 
                        message="確定要移除這位旅伴嗎？(其建立的資料將會保留)" 
                        onConfirm={() => { onRemoveMember(confirmRemove); setConfirmRemove(null); }} 
                        onCancel={() => setConfirmRemove(null)} 
                    />
                </div>
            );
        };

        const JoinModal = ({ isOpen, onClose, tripData, onJoin }) => {
            const [mode, setMode] = useState('new'); 
            const [name, setName] = useState('');
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');

            if (!isOpen || !tripData) return null;

            const handleJoin = () => {
                setError('');
                if (!pin.trim()) { setError('請輸入 PIN 碼'); return; }
                
                if (mode === 'new') {
                    if (!name.trim()) { setError('請輸入您的暱稱'); return; }
                    if (tripData.members.some(m => m.name === name.trim())) { setError('此暱稱已被使用，請更換'); return; }
                    onJoin({ name: name.trim(), pin: pin.trim(), role: 'collaborator', isNew: true });
                } else {
                    if (!name) { setError('請選擇您的身分'); return; }
                    const member = tripData.members.find(m => m.name === name);
                    if (!member) { setError('找不到成員資料'); return; }
                    if (member.pin !== pin.trim()) { setError('PIN 碼錯誤'); return; }
                    onJoin({ name: member.name, pin: member.pin, role: member.role, isNew: false });
                }
            };

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center px-4">
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-full max-w-sm rounded-2xl p-6 border border-[#eeeeee] shadow-2xl relative z-10 flex flex-col">
                        <h3 className="text-xl font-bold text-[#0ABAB5] mb-4 text-center">加入旅程</h3>
                        <div className="flex bg-gray-200 p-1 rounded-xl mb-4">
                            <button onClick={() => setMode('new')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${mode === 'new' ? 'bg-white text-[#0ABAB5] shadow-sm' : 'text-gray-500'}`}>我是新協作者</button>
                            <button onClick={() => setMode('old')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${mode === 'old' ? 'bg-white text-[#0ABAB5] shadow-sm' : 'text-gray-500'}`}>我是舊成員</button>
                        </div>
                        
                        <div className="space-y-4">
                            {mode === 'new' ? (
                                <div>
                                    <label className="text-xs font-bold text-gray-500 block mb-1">您的暱稱</label>
                                    <input value={name} onChange={e => setName(e.target.value)} className="w-full p-3 bg-[#E2E2E2] rounded-xl text-gray-700 outline-none focus:ring-2 focus:ring-[#0ABAB5] border border-[#eeeeee]" placeholder="例如：小明" />
                                </div>
                            ) : (
                                <div>
                                    <label className="text-xs font-bold text-gray-500 block mb-1">選擇您的身分</label>
                                    <select value={name} onChange={e => setName(e.target.value)} className="w-full p-3 bg-[#E2E2E2] rounded-xl text-gray-700 outline-none focus:ring-2 focus:ring-[#0ABAB5] border border-[#eeeeee]">
                                        <option value="">-- 請選擇 --</option>
                                        {tripData.members.map(m => <option key={m.name} value={m.name}>{m.name}</option>)}
                                    </select>
                                </div>
                            )}

                            <div>
                                <label className="text-xs font-bold text-gray-500 block mb-1">{mode === 'new' ? '設定您的 PIN 碼' : '輸入 PIN 碼驗證'}</label>
                                <input type="password" value={pin} onChange={e => setPin(e.target.value)} className="w-full p-3 bg-[#E2E2E2] rounded-xl text-gray-700 outline-none focus:ring-2 focus:ring-[#0ABAB5] border border-[#eeeeee]" placeholder="****" />
                            </div>
                        </div>

                        {error && <p className="text-red-500 text-xs font-bold mt-3 text-center">{error}</p>}

                        <button onClick={handleJoin} className="w-full py-3 bg-[#0ABAB5] text-white rounded-xl font-bold border border-[#0ABAB5] hover:bg-[#008985] transition-all mt-6">
                            {mode === 'new' ? '加入並開始' : '驗證並登入'}
                        </button>
                    </div>
                </div>
            );
        };

        const FirebaseConfigModal = ({ isOpen, onClose, onConfigUpdate }) => {
            const [form, setForm] = useState({
                apiKey: '', authDomain: '', projectId: '', storageBucket: '', messagingSenderId: '', appId: ''
            });
            const [rawConfig, setRawConfig] = useState('');

            useEffect(() => {
                if (isOpen) {
                    const stored = localStorage.getItem('gtp_firebase_config');
                    if (stored) {
                        try {
                            setForm(JSON.parse(stored));
                        } catch(e) {}
                    }
                }
            }, [isOpen]);

            const handleRawInput = (e) => {
                const text = e.target.value;
                setRawConfig(text);
                const newForm = { ...form };
                const keys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
                let updated = false;
                keys.forEach(key => {
                    const regex = new RegExp(`${key}\\s*:\\s*["']([^"']+)["']`, 'i');
                    const match = text.match(regex);
                    if (match && match[1]) { newForm[key] = match[1]; updated = true; }
                });
                if (updated) { setForm(newForm); }
            };

            const handleSave = async () => {
                const cleanedForm = Object.keys(form).reduce((acc, key) => { acc[key] = form[key].trim().replace(/^["']|["']$/g, ''); return acc; }, {});
                if (!cleanedForm.apiKey || !cleanedForm.projectId) { alert("請至少輸入 API Key 與 Project ID"); return; }
                setForm(cleanedForm);
                localStorage.setItem('gtp_firebase_config', JSON.stringify(cleanedForm));
                await onConfigUpdate();
                onClose();
            };

            const handleClear = async () => {
                if (confirm("確定要清除設定並切換回單機版嗎？")) { localStorage.removeItem('gtp_firebase_config'); await onConfigUpdate(); onClose(); }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center px-4">
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-full max-w-md rounded-2xl p-6 border border-[#eeeeee] relative z-10 flex flex-col max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-800">雲端同步設定 (Firebase)</h3>
                            <button onClick={onClose}><X size={20} className="text-gray-400" /></button>
                        </div>
                        <div className="mb-4">
                            <label className="text-xs font-bold text-gray-500 block mb-1">快速貼上 (貼上整段 Config 自動辨識)</label>
                            <textarea value={rawConfig} onChange={handleRawInput} className="w-full p-2 bg-[#E2E2E2] rounded-lg text-xs text-gray-700 outline-none focus:ring-1 focus:ring-[#0ABAB5] font-mono h-20 resize-none border border-[#eeeeee]" placeholder={`例如：\napiKey: "AIzaSy...",\nauthDomain: "..."`} />
                        </div>
                        <p className="text-xs text-gray-500 mb-4 bg-yellow-50 p-2 rounded border border-yellow-100 leading-relaxed">
                            下方欄位將自動填入，您也可以手動修改。<br/>
                            <span className="text-red-500 font-bold block mt-1">* 請確保您的 Firebase Authentication 已啟用「匿名登入 (Anonymous)」。</span>
                        </p>
                        <div className="space-y-3">
                            {['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'].map(field => (
                                <div key={field}>
                                    <label className="text-xs font-bold text-gray-500 block mb-1 capitalize">{field}</label>
                                    <input value={form[field]} onChange={e => setForm({...form, [field]: e.target.value})} className="w-full p-2 bg-[#E2E2E2] rounded-lg text-xs text-gray-700 outline-none focus:ring-1 focus:ring-[#0ABAB5] border border-[#eeeeee]" placeholder={`Enter ${field}`} />
                                </div>
                            ))}
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button onClick={handleClear} className="flex-1 py-3 rounded-xl text-red-500 font-bold bg-red-50 text-sm border border-red-100">清除設定 (單機)</button>
                            <button onClick={handleSave} className="flex-1 py-3 rounded-xl bg-[#0ABAB5] text-white font-bold text-sm border border-[#0ABAB5]">儲存並連線</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AutoSaveInput = ({ value, onSave, readOnly, ...props }) => {
            const [v, setV] = useState(value ?? '');
            useEffect(() => setV(value ?? ''), [value]);
            const propsFinal = { ...props, value: v, onChange: e => setV(e.target.value), onBlur: () => v !== (value??'') && onSave(v), onKeyDown: e => e.key === 'Enter' && e.target.blur(), readOnly };
            return props.type === 'textarea' ? <textarea {...propsFinal} /> : <input {...propsFinal} />;
        };

        const ImageModal = ({ src, onClose }) => !src ? null : <div className="fixed inset-0 z-[70] bg-black/20 flex items-center justify-center p-4" onClick={onClose}><img src={src} className="max-w-full max-h-full object-contain rounded-lg" /></div>;

        const SimplePieChart = ({ data }) => {
            const total = data.reduce((sum, item) => sum + item.value, 0);
            if (total === 0) return <div className="h-40 flex items-center justify-center text-gray-400 text-sm border-2 border-dashed border-gray-200 rounded-full w-40 mx-auto">尚無消費數據</div>;
            let currentAngle = 0;
            return (
                <div className="relative h-48 w-48 mx-auto">
                <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                    {data.map((item, i) => {
                    const angle = (item.value / total) * 360;
                    const x1 = 50 + 50 * Math.cos(Math.PI * currentAngle / 180);
                    const y1 = 50 + 50 * Math.sin(Math.PI * currentAngle / 180);
                    const x2 = 50 + 50 * Math.cos(Math.PI * (currentAngle + angle) / 180);
                    const y2 = 50 + 50 * Math.sin(Math.PI * (currentAngle + angle) / 180);
                    const largeArc = angle > 180 ? 1 : 0;
                    const pathData = total === item.value ? `M 50 50 m -50, 0 a 50,50 0 1,0 100,0 a 50,50 0 1,0 -100,0` : `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArc} 1 ${x2} ${y2} Z`;
                    const slice = <path key={i} d={pathData} fill={item.color} stroke="white" strokeWidth="1" />;
                    currentAngle += angle;
                    return slice;
                    })}
                    <circle cx="50" cy="50" r="30" fill="#F5FDFC" />
                </svg>
                <div className="absolute inset-0 flex items-center justify-center flex-col"><span className="text-xs text-gray-400">總支出</span><span className="text-lg font-bold text-gray-700">${total.toLocaleString()}</span></div>
                </div>
            );
        };

        const SimpleBarChart = ({ data }) => {
            const maxVal = Math.max(...data.map(d => d.total), 1); 
            if (data.length === 0 || maxVal === 0) return <div className="text-xs text-center text-gray-400 py-4">尚無資料</div>;
            return (
                <div className="w-full overflow-x-auto no-scrollbar">
                <div className="flex items-end gap-3 h-40 pt-6 px-2 min-w-max">
                    {data.map((item, i) => {
                    const heightPercent = maxVal > 0 ? (item.total / maxVal) * 100 : 0;
                    const displayHeight = Math.max(heightPercent, 2); 
                    return (
                        <div key={i} className="flex flex-col items-center gap-1 group w-12 h-full justify-end">
                        <div className="relative w-4 flex flex-col-reverse rounded-t-md overflow-hidden bg-[#C8D9D9] border border-[#B0C4C4]" style={{ height: `${displayHeight}%` }}>
                            {item.breakdown.map((seg, idx) => {
                                const segHeight = item.total > 0 ? (seg.cost / item.total) * 100 : 0;
                                if(segHeight <= 0) return null;
                                return <div key={idx} style={{ height: `${segHeight}%`, backgroundColor: seg.color }} className="w-full transition-all duration-300" />;
                            })}
                            {item.total > 0 && <div className="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-20 shadow-lg pointer-events-none">${item.total}</div>}
                        </div>
                        <div className="text-[10px] text-gray-500 font-medium">{item.date.slice(5).replace('-','/')}</div>
                        </div>
                    );
                    })}
                </div>
                <div className="flex flex-wrap gap-3 mt-4 justify-center px-4">
                    {Object.keys(CATEGORY_COLORS).map(cat => (
                        <div key={cat} className="flex items-center gap-1"><div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: CATEGORY_COLORS[cat] }}></div><span className="text-[10px] text-gray-500">{cat}</span></div>
                    ))}
                </div>
                </div>
            );
        };

        const TransactionDetailModal = ({ transaction, onClose, onViewImage }) => {
            if (!transaction) return null;
            const color = CATEGORY_COLORS[transaction.category] || '#ccc';
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center" onClick={onClose}>
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm"></div>
                    <div className="bg-[#F5FDFC] w-[85%] max-w-sm rounded-2xl p-5 border border-[#eeeeee] relative z-10" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center gap-2 mb-4"><div className="w-2 h-8 rounded-full" style={{backgroundColor:color}}></div><h3 className="text-xl font-bold text-gray-800">{transaction.title || '未命名'}</h3></div>
                        <div className="space-y-4">
                            <div className="flex justify-between border-b border-[#eeeeee] pb-2"><span className="text-gray-500">金額</span><span className="text-2xl font-bold text-[#D68C68]">{transaction.cost} <small>{transaction.currency}</small></span></div>
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div><label className="text-xs text-gray-400 block">分類</label>{transaction.category}</div>
                                <div><label className="text-xs text-gray-400 block">付款人</label>{transaction.payer}</div>
                            </div>
                            {transaction.photoUrls?.length > 0 && <div className="flex gap-2 overflow-x-auto">{transaction.photoUrls.map((url, i) => <img key={i} src={url} className="w-20 h-20 object-cover rounded-lg" onClick={() => onViewImage(url)} />)}</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const AccommodationCard = ({ date, data, onUpdate, onPhotoUpload, onPhotoDelete, onViewImage, onAdd, onDelete, isOwner, currentMember }) => {
            return (
                <div className="bg-[#FFF9C4] border border-yellow-300 shadow-sm rounded-2xl p-3 mt-6 relative">
                    {isOwner && <button onClick={onAdd} className="absolute top-3 right-3 bg-yellow-200 text-yellow-700 rounded-full p-1 hover:bg-yellow-300 transition-colors z-10"><Plus size={16} /></button>}
                    {(data || []).map((item, index) => (
                        <div key={item.id || index} className={index > 0 ? "border-t border-yellow-200 pt-4 mt-4" : ""}>
                            <div className="flex items-center justify-start mb-2 gap-2 pr-8">
                               <BedDouble size={18} className="text-gray-600 flex-shrink-0" />
                               <AutoSaveInput type="text" readOnly={!isOwner} placeholder="輸入飯店名稱..." value={item.name} onSave={(val) => onUpdate(item.id, 'name', val)} className="flex-1 bg-transparent text-lg font-bold text-gray-800 outline-none placeholder-gray-400"/>
                               {isOwner && <button onClick={() => onDelete(item.id)} className="text-red-400 hover:text-red-600"><Trash2 size={16} /></button>}
                            </div>
                            <div className="flex items-center gap-2 mb-2">
                                <div className="flex-1 pl-1"><AutoSaveInput type="text" readOnly={!isOwner} placeholder="訂房編號" value={item.bookingCode} onSave={(val) => onUpdate(item.id, 'bookingCode', val)} className="text-xs text-gray-500 bg-transparent outline-none w-full"/></div>
                                <div className="w-[28%] flex items-center justify-between gap-1 bg-[#E2E2E2] border border-gray-300 px-1 py-1 rounded-lg relative group">
                                   <LogIn size={12} className="text-green-600 flex-shrink-0" />
                                   <select value={item.checkInTime || '15:00'} onChange={(e) => onUpdate(item.id, 'checkInTime', e.target.value)} disabled={!isOwner} className="text-xs text-gray-600 bg-transparent outline-none w-full text-center appearance-none font-bold">{TIME_OPTIONS.map(t => <option key={t} value={t}>{t}</option>)}</select>
                                   <div className="pointer-events-none absolute right-1 top-1/2 -translate-y-1/2 text-gray-400"><Clock size={12} /></div>
                                </div>
                                <div className="w-[28%] flex items-center justify-between gap-1 bg-[#E2E2E2] border border-gray-300 px-1 py-1 rounded-lg relative group">
                                   <LogOutIcon size={12} className="text-red-500 flex-shrink-0" />
                                   <select value={item.checkOutTime || '11:00'} onChange={(e) => onUpdate(item.id, 'checkOutTime', e.target.value)} disabled={!isOwner} className="text-xs text-gray-600 bg-transparent outline-none w-full text-center appearance-none font-bold">{TIME_OPTIONS.map(t => <option key={t} value={t}>{t}</option>)}</select>
                                   <div className="pointer-events-none absolute right-1 top-1/2 -translate-y-1/2 text-gray-400"><Clock size={12} /></div>
                                </div>
                            </div>
                            <div className="flex flex-col gap-2">
                               <div className="flex items-center gap-2">
                                  <div className="flex items-center gap-1 bg-[#E2E2E2] border border-gray-300 px-2 py-1 rounded-lg flex-[3] overflow-hidden">
                                      <Phone size={12} className="text-green-600 flex-shrink-0" />
                                      <AutoSaveInput type="text" readOnly={!isOwner} placeholder="電話" value={item.phone} onSave={(val) => onUpdate(item.id, 'phone', val)} className="text-xs text-gray-600 bg-transparent outline-none w-full min-w-0"/>
                                  </div>
                                  <div className="flex items-center gap-1 bg-[#E2E2E2] border border-gray-300 px-2 py-1 rounded-lg flex-[7] overflow-hidden">
                                       <MapPin size={12} className="text-red-500 flex-shrink-0" />
                                       <AutoSaveInput type="text" readOnly={!isOwner} placeholder="地址" value={item.address} onSave={(val) => onUpdate(item.id, 'address', val)} className="text-xs text-gray-600 bg-transparent outline-none w-full min-w-0"/>
                                       <button onClick={() => item.address && window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}`, '_blank')} className="text-blue-500 hover:bg-blue-50 p-1 rounded flex-shrink-0"><Navigation size={12} /></button>
                                   </div>
                               </div>
                               <div className="flex items-center gap-2 overflow-x-auto pb-1 no-scrollbar border-t border-yellow-200 pt-2 mt-1">
                                    {item.photoUrls?.map((p, i) => {
                                        const url = typeof p === 'string' ? p : p.url;
                                        const uploader = typeof p === 'string' ? 'unknown' : p.uploader;
                                        const canDelete = isOwner || (currentMember && uploader === currentMember.name);
                                        return ( <div key={i} className="relative flex-shrink-0"> <img src={url} className="w-10 h-10 object-cover rounded-lg border border-yellow-200 cursor-zoom-in" onClick={() => onViewImage(url)} /> {canDelete && <button onClick={() => onPhotoDelete(item.id, url)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 hover:bg-red-600 transition"><X size={10} /></button>} </div> );
                                    })}
                                    <button onClick={() => onPhotoUpload(item.id)} className="w-10 h-10 flex items-center justify-center border-2 border-dashed border-yellow-300 text-yellow-500 hover:text-yellow-600 hover:border-yellow-600 rounded-lg transition-colors flex-shrink-0 bg-yellow-100"><Image size={16} /></button>
                               </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const FlightCard = ({ label, icon: Icon, data, onUpdate, isOwner }) => (
            <div className="bg-[#EFF6FF] border-l-4 border-[#3B82F6] shadow-sm rounded-xl p-3 mb-4 relative border border-[#eeeeee]">
                <div className="absolute top-0 right-0 bg-[#3B82F6] text-white text-[10px] px-2 py-0.5 rounded-bl-lg rounded-tr-xl font-bold">{label}</div>
                <div className="flex items-center justify-between mt-2">
                    <div className="flex flex-col items-start w-1/3"><label className="text-[10px] text-gray-400 font-medium mb-0.5">起飛</label><AutoSaveInput type="text" readOnly={!isOwner} value={data.depTime} placeholder="14:00" maxLength={5} onSave={(val) => onUpdate('depTime', val)} className="text-lg font-bold text-gray-700 bg-transparent outline-none w-full p-0 leading-none" /><AutoSaveInput type="text" readOnly={!isOwner} placeholder="機場/航廈" value={data.depAirport} onSave={(val) => onUpdate('depAirport', val)} className="text-xs text-gray-500 font-medium bg-transparent outline-none w-full mt-1 placeholder-gray-300" /></div>
                    <div className="flex flex-col items-center justify-center w-1/3 px-2"><div className="text-[#3B82F6] mb-1 transform rotate-45"><Icon size={24} /></div><div className="w-full flex items-center justify-center relative mb-1"><div className="h-px bg-gray-300 w-full absolute top-1/2 left-0"></div><div className="w-1.5 h-1.5 bg-[#3B82F6] rounded-full z-10"></div></div><AutoSaveInput type="text" readOnly={!isOwner} placeholder="航班號" value={data.number} onSave={(val) => onUpdate('number', val)} className="text-center text-sm font-bold text-[#1E40AF] bg-transparent outline-none w-full placeholder-gray-300 uppercase" /></div>
                    <div className="flex flex-col items-end w-1/3"><label className="text-[10px] text-gray-400 font-medium mb-0.5">抵達</label><AutoSaveInput type="text" readOnly={!isOwner} value={data.arrTime} placeholder="18:30" maxLength={5} onSave={(val) => onUpdate('arrTime', val)} className="text-lg font-bold text-gray-700 bg-transparent outline-none w-full p-0 leading-none text-right" /><AutoSaveInput type="text" readOnly={!isOwner} placeholder="機場/航廈" value={data.arrAirport} onSave={(val) => onUpdate('arrAirport', val)} className="text-xs text-gray-500 font-medium bg-transparent outline-none w-full mt-1 text-right placeholder-gray-300" /></div>
                </div>
            </div>
        );

        const EditTripModal = ({ isOpen, onClose, tripData, onSave }) => {
            const [formData, setFormData] = useState({});
            useEffect(() => {
                if (isOpen && tripData) {
                    setFormData({ destination: tripData.destination, startDate: tripData.startDate, endDate: tripData.endDate, currency: tripData.currency });
                }
            }, [isOpen, tripData]);
            if (!isOpen) return null;
            const handleSave = () => { if (!formData.destination.trim()) { alert('請輸入目的地'); return; } onSave(formData); onClose(); };
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center px-4">
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-full max-w-sm rounded-2xl p-6 border border-[#eeeeee] relative z-10 flex flex-col">
                        <div className="flex justify-between items-center mb-4 border-b border-[#eeeeee] pb-2">
                            <h3 className="text-lg font-bold text-gray-800">編輯旅程設定</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={20} /></button>
                        </div>
                        <div className="space-y-4">
                            <div><label className="text-xs text-gray-500 font-bold block mb-1">目的地</label><input type="text" value={formData.destination} onChange={(e) => setFormData({...formData, destination: e.target.value})} className="w-full p-2 bg-[#E2E2E2] rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 border border-[#eeeeee]" /></div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs text-gray-500 font-bold block mb-1">開始日期</label><input type="date" value={formData.startDate} onChange={(e) => setFormData({...formData, startDate: e.target.value})} className="w-full p-2 bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 border border-[#eeeeee]" /></div>
                                <div className="flex-1"><label className="text-xs text-gray-500 font-bold block mb-1">結束日期</label><input type="date" value={formData.endDate} onChange={(e) => setFormData({...formData, endDate: e.target.value})} className="w-full p-2 bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 border border-[#eeeeee]" /></div>
                            </div>
                            <div>
                                <label className="text-xs text-gray-500 font-bold block mb-1">主要貨幣</label>
                                <select value={formData.currency} onChange={(e) => setFormData({...formData, currency: e.target.value})} className="w-full p-2 bg-[#E2E2E2] rounded-xl text-sm font-bold outline-none text-gray-700 border border-[#eeeeee]">
                                    {currencies.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}
                                </select>
                            </div>
                            <button onClick={handleSave} className="w-full py-3 bg-[#0ABAB5] text-white rounded-xl font-bold border border-[#0ABAB5] hover:bg-[#008985] transition-all mt-2">儲存變更</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ActivityModal = ({ isOpen, onClose, onSave, tripData, defaultValues }) => {
            const [formData, setFormData] = useState({ time: '09:00', title: '', note: '', transport: 'walk', duration: '60', bookingCode: '', cost: '', currency: 'JPY', payer: '我', photoUrls: [] });
            const [confirm, setConfirm] = useState({ open: false, idx: null });
            const fileRef = useRef(null);
            useEffect(() => {
                 if (isOpen) {
                     if (defaultValues) { setFormData(defaultValues); } else { setFormData({ time: '09:00', title: '', note: '', transport: 'walk', duration: '60', bookingCode: '', cost: '', currency: tripData?.currency || 'JPY', payer: tripData?.members?.[0]?.name || '我', photoUrls: [] }); }
                 }
            }, [isOpen, defaultValues, tripData]);
            if (!isOpen) return null;
            const handleSave = () => { if(!formData.title.trim()) return alert('請輸入名稱'); onSave({...formData, cost: parseFloat(formData.cost)||0}); onClose(); };
            const handleFile = async (e) => { const f = e.target.files[0]; if(f) { const b64 = await resizeImage(f); if(b64) setFormData(p => ({...p, photoUrls: [...(p.photoUrls || []), b64]})); } e.target.value = ''; };
            
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 bg-black/20" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-[85%] sm:max-w-sm rounded-t-3xl sm:rounded-2xl overflow-hidden border border-[#eeeeee] relative z-10 flex flex-col max-h-[90vh]">
                        <div className="bg-[#6A8E83] p-3 text-center text-white font-bold relative">{defaultValues ? '編輯行程' : '新增行程'}<button onClick={onClose} className="absolute right-3"><X size={20}/></button></div>
                        <div className="p-4 space-y-4 overflow-y-auto">
                            <div className="flex gap-2">
                                <div className="w-1/3"><label className="text-xs text-gray-400 font-bold block">時間</label><input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]" /></div>
                                <div className="w-2/3"><label className="text-xs text-gray-400 font-bold block">名稱</label><input value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]" autoFocus /></div>
                            </div>
                            <div><label className="text-xs text-gray-400 font-bold block">備註</label><textarea value={formData.note} onChange={e=>setFormData({...formData, note:e.target.value})} rows={2} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm resize-none text-gray-700 border border-[#eeeeee]" /></div>
                            <div className="flex gap-2">
                                <div className="w-1/2"><label className="text-xs text-gray-400 font-bold block">交通</label><select value={formData.transport} onChange={e=>setFormData({...formData, transport:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]">{transportOptions.map(t=><option key={t.value} value={t.value}>{t.label}</option>)}</select></div>
                                <div className="w-1/2"><label className="text-xs text-gray-400 font-bold block">停留</label><select value={formData.duration} onChange={e=>setFormData({...formData, duration:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]">{durationOptions.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}</select></div>
                            </div>
                            <div className="border-t border-[#eeeeee] pt-2">
                                <div className="flex justify-between mb-2"><span className="text-xs font-bold text-gray-400">進階選項 (費用/訂位)</span></div>
                                <div className="grid grid-cols-2 gap-2">
                                    <input value={formData.bookingCode} onChange={e=>setFormData({...formData, bookingCode:e.target.value})} placeholder="訂位代碼" className="bg-[#E2E2E2] rounded-xl p-2 text-xs text-gray-700 border border-[#eeeeee]" />
                                    <div className="flex items-center bg-[#E2E2E2] rounded-xl px-2 border border-[#eeeeee]"><span className="text-xs text-gray-400">$</span><input type="number" value={formData.cost} onChange={e=>setFormData({...formData, cost:e.target.value})} placeholder="預算" className="w-full bg-transparent p-2 text-xs outline-none text-gray-700" /></div>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs text-gray-400 font-bold block mb-2"></label>
                                <div className="flex gap-2 overflow-x-auto">
                                    {formData.photoUrls?.map((url, i) => (
                                        <div key={i} className="relative w-10 h-10 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded-lg" /><button onClick={() => setConfirm({open:true, idx:i})} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button></div>
                                    ))}
                                    <button onClick={()=>fileRef.current.click()} className="w-10 h-10 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center"><Camera size={16} /></button>
                                    <input type="file" ref={fileRef} className="hidden" onChange={handleFile} />
                                </div>
                            </div>
                            <button onClick={handleSave} className="w-full py-3 bg-[#6A8E83] text-white rounded-xl font-bold shadow-md border border-[#6A8E83]">{defaultValues ? '儲存變更' : '加入行程'}</button>
                        </div>
                    </div>
                    <ConfirmModal isOpen={confirm.open} message="確定刪除照片？" onConfirm={() => { const n = [...formData.photoUrls]; n.splice(confirm.idx, 1); setFormData({...formData, photoUrls: n}); setConfirm({open:false}); }} onCancel={() => setConfirm({open:false})} />
                </div>
            );
        };

        const ExpenseModal = ({ isOpen, onClose, tripData, onSave, onUpdateCategories, selectedDate }) => {
            const [formData, setFormData] = useState({ time: '', cost: '', title: '', payer: '', currency: '', category: '', photoUrls: [] });
            const [isManage, setIsManage] = useState(false);
            const [newCat, setNewCat] = useState('');
            const [confirm, setConfirm] = useState({ open: false, action: null, msg: '' });
            const fileRef = useRef(null);
            
            useEffect(() => {
                 if(isOpen) setFormData({ time: new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}), cost: '', title: '', payer: tripData?.members?.[0]?.name || '我', currency: tripData?.currency || 'JPY', category: '餐飲', photoUrls: [] });
            }, [isOpen, tripData]);

            if (!isOpen) return null;
            const handleFile = async (e) => { const f = e.target.files[0]; if(f) { const b64 = await resizeImage(f); if(b64) setFormData(p => ({...p, photoUrls: [...(p.photoUrls || []), b64]})); } e.target.value=''; };
            
            return (
                <>
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 bg-black/20" onClick={onClose}></div>
                    <div className="bg-[#F5FDFC] w-[85%] sm:max-w-sm rounded-t-3xl sm:rounded-2xl overflow-hidden border border-[#eeeeee] relative z-10 flex flex-col max-h-[90vh]">
                        <div className="bg-[#D68C68] p-3 text-center text-white font-bold relative">新增記帳<button onClick={onClose} className="absolute right-3"><X size={20}/></button></div>
                        <div className="p-4 space-y-4 overflow-y-auto">
                            <div className="flex items-end gap-2">
                                <div className="w-[50%]"><label className="text-xs text-gray-400 font-bold block">金額</label><div className="relative"><DollarSign className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400" size={16} /><input type="number" value={formData.cost} onChange={e=>setFormData({...formData, cost:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl pl-7 p-2 text-xl font-bold text-gray-800 border border-[#eeeeee]" autoFocus /></div></div>
                                <div className="w-[20%]"><label className="text-xs text-gray-400 font-bold block">幣別</label><select value={formData.currency} onChange={e=>setFormData({...formData, currency:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]">{currencies.map(c=><option key={c.value} value={c.value}>{c.value}</option>)}</select></div>
                                <div className="w-[30%]"><label className="text-xs text-gray-400 font-bold block">付款人</label><select value={formData.payer} onChange={e=>setFormData({...formData, payer:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]">{tripData.members.map(m=><option key={m.name} value={m.name}>{m.name}</option>)}</select></div>
                            </div>
                            <div>
                                <div className="flex justify-between items-center mb-2"><label className="text-xs text-gray-400 font-bold">分類</label><button onClick={()=>setIsManage(!isManage)} className="text-xs text-[#D68C68] flex items-center gap-1 font-bold"><Settings size={12}/>管理</button></div>
                                {isManage ? <div className="bg-[#E2E2E2] p-2 rounded-xl mb-2 border border-[#eeeeee]"><div className="flex flex-wrap gap-1 mb-2">{(tripData.expenseCategories||[]).map(c=><span key={c} className="bg-white px-2 py-1 rounded text-[10px] flex items-center gap-1 border border-[#eeeeee]">{c}<button onClick={()=>setConfirm({open:true, msg:`刪除 ${c}?`, action:()=>onUpdateCategories((tripData.expenseCategories||[]).filter(x=>x!==c))})}><X size={10}/></button></span>)}</div><div className="flex gap-1"><input value={newCat} onChange={e=>setNewCat(e.target.value)} placeholder="新分類" className="flex-1 p-1 text-xs rounded text-gray-700 border border-[#eeeeee]" /><button onClick={()=>{if(newCat){onUpdateCategories([...(tripData.expenseCategories||[]), newCat]); setNewCat('');}}} className="bg-green-500 text-white p-1 rounded border border-green-500"><Plus size={14}/></button></div></div> : <div className="flex flex-wrap gap-1.5">{(tripData.expenseCategories||[]).map(c=><button key={c} onClick={()=>setFormData({...formData, category:c})} className={`px-3 py-1.5 rounded-lg text-xs font-bold border ${formData.category===c?'bg-[#D68C68] text-white border-[#D68C68]':'bg-[#E2E2E2] text-gray-600 border-[#eeeeee]'}`}>{c}</button>)}</div>}
                            </div>
                            <div className="flex gap-2"><input type="date" value={selectedDate} disabled className="flex-1 bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]" /><input type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-1/3 bg-[#E2E2E2] rounded-xl p-2 text-sm font-bold text-gray-700 border border-[#eeeeee]" /></div>
                            <div><label className="text-xs text-gray-400 font-bold block">品項</label><input value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})} className="w-full bg-[#E2E2E2] rounded-xl p-3 text-sm font-bold text-gray-700 border border-[#eeeeee]" /></div>
                            <div><label className="text-xs text-gray-400 font-bold block">照片</label><div className="flex gap-2 overflow-x-auto">{formData.photoUrls?.map((url, i)=><div key={i} className="relative w-10 h-10 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded-lg" /><button onClick={()=>setConfirm({open:true, msg:'刪除照片?', action:()=>{const n=[...formData.photoUrls]; n.splice(i,1); setFormData({...formData, photoUrls:n})}})} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button></div>)}<button onClick={()=>fileRef.current.click()} className="w-10 h-10 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center"><Camera size={16}/></button><input type="file" ref={fileRef} className="hidden" onChange={handleFile} /></div></div>
                            <button onClick={()=>{if(parseFloat(formData.cost)>0) { onSave({...formData, cost:parseFloat(formData.cost), transport:'expense'}, selectedDate); }}} disabled={!formData.cost} className="w-full py-3 bg-[#D68C68] text-white rounded-xl font-bold shadow-md border border-[#D68C68]">儲存</button>
                        </div>
                    </div>
                    <ConfirmModal isOpen={confirm.open} message={confirm.msg} onConfirm={()=>{confirm.action(); setConfirm({open:false});}} onCancel={()=>setConfirm({open:false})} />
                </div>
                </>
            );
        };

        const HeaderWithTabs = ({ tripData, selectedDate, setSelectedDate, handleAddDate, view, setView, setIsMenuOpen, isOffline, onConfig, onManageMembers }) => {
            const datesList = useMemo(() => tripData ? getDatesArray(tripData.startDate, tripData.endDate) : [], [tripData]);
            const openWeatherLink = () => { 
                const destination = tripData?.destination || ''; 
                const query = encodeURIComponent(destination); 
                window.open(`https://tenki.jp/search/?keyword=${query}`, '_blank'); 
            };
            return (
                <div className="bg-[#0ABAB5] z-10 relative flex flex-col">
                    {/* Top Row */}
                    <div className="text-white px-3 pt-3 pb-1 flex justify-between items-start">
                        <div className="flex items-center gap-3">
                            <button onClick={() => setIsMenuOpen(true)}><Menu size={24}/></button>
                            <h1 className="font-bold leading-tight text-lg">{tripData.destination}</h1>
                        </div>
                        <div className="flex items-center gap-1">
                             <button 
                                onClick={onConfig} 
                                className="w-8 h-8 bg-[#008985] rounded-full flex items-center justify-center hover:opacity-90 transition-all text-white"
                            >
                                {isOffline ? <WifiOff size={16} className="text-red-300"/> : <Wifi size={16} className="text-[#00FF00]"/>}
                            </button>
                        </div>
                    </div>
                    
                    {/* Bottom Row: Dates + Dollar Button */}
                    <div className="flex items-center pl-2 pr-3 pb-2 gap-2">
                        {/* Date List */}
                        <div className="flex-1 flex overflow-x-auto space-x-2 no-scrollbar">
                            {datesList.map((d, i) => (
                                <button 
                                    key={d} 
                                    onClick={() => { setSelectedDate(d); setView('planner'); }} 
                                    className={`flex-shrink-0 w-10 h-10 flex flex-col items-center justify-center rounded-xl transition-all duration-200 border ${d === selectedDate ? 'bg-[#F5FDFC] text-[#00695C] font-bold border-[#eeeeee]' : 'bg-[#008985] text-white opacity-90 border-transparent'}`}
                                >
                                    <span className="text-[8px] leading-none opacity-80">D{i+1}</span>
                                    <span className="text-[10px] font-bold leading-tight my-0.5">{getMonthDay(d)}</span>
                                    <span className="text-[8px] leading-none opacity-90">{getDayOfWeek(d)}</span>
                                </button>
                            ))}
                            <button onClick={handleAddDate} className="flex-shrink-0 w-10 h-10 flex items-center justify-center border border-dashed border-white/50 rounded-xl text-white"><Plus size={20}/></button>
                        </div>

                        {/* Dollar Button - Centered with dates, Scaled Down 10% */}
                        <button onClick={() => setView(view === 'planner' ? 'expense' : 'planner')} className="flex-shrink-0 w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-yellow-900 ring-2 ring-[#D68C68] transform hover:scale-105 transition-transform">
                            <DollarSign size={20} strokeWidth={3} />
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('setup');
            const [tripId, setTripId] = useState('');
            const [tripData, setTripData] = useState(null);
            const [selectedDate, setSelectedDate] = useState('');
            const [modals, setModals] = useState({ expense: false, activity: false, viewingImage: null, transaction: null, editTrip: false, config: false, join: false, members: false });
            const [expandedId, setExpandedId] = useState(null);
            const [recentTrips, setRecentTrips] = useState([]);
            const [setupForm, setSetupForm] = useState({ destination: '', startDate: new Date().toISOString().split('T')[0], endDate: new Date(new Date().setDate(new Date().getDate() + 4)).toISOString().split('T')[0], currency: 'JPY', nickname: '', pin: '' });
            const [confirm, setConfirm] = useState({ open: false, msg: '', action: null });
            const [joinId, setJoinId] = useState('');
            const [homeJoinInput, setHomeJoinInput] = useState('');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [setupTab, setSetupTab] = useState('create');
            const fileRef = useRef(null);
            const [uploadTarget, setUploadTarget] = useState(null);
            const [expenseFilterDate, setExpenseFilterDate] = useState('all');
            const [authError, setAuthError] = useState(null);
            const [isCreating, setIsCreating] = useState(false); 
            const [connectionTimeout, setConnectionTimeout] = useState(false); 
            const [isOffline, setIsOffline] = useState(true);
            const [editingActivity, setEditingActivity] = useState(null);
            const [currentMember, setCurrentMember] = useState(null); // { name, role }
            
            // Derived state placed early to ensure scope availability
            const isOwner = currentMember?.role === 'owner';

            const dbRef = useRef(null);
            const authRef = useRef(null);

            // Check connection function
            const checkConnection = async (dbInstance) => {
                try {
                    await getDoc(doc(dbInstance, 'artifacts', appId, 'public', 'data', 'ping')); 
                    setIsOffline(false);
                } catch (e) {
                    console.warn("Connection check failed:", e);
                    setIsOffline(true);
                }
            };

            const reInit = async () => {
                 const { auth: newAuth, db: newDb, valid } = await initFirebaseSystem();
                 if (valid) {
                     authRef.current = newAuth;
                     dbRef.current = newDb;
                     
                     try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(newAuth, __initial_auth_token);
                        } else {
                            await signInAnonymously(newAuth);
                        }
                        
                        // 登入成功後，主動進行一次連線檢查
                        await checkConnection(newDb);

                     } catch (e) {
                        console.error("Auth failed, falling back to anonymous", e);
                        try {
                           await signInAnonymously(newAuth);
                           // 即使匿名登入成功，也要檢查連線權限
                           await checkConnection(newDb);
                        } catch (e2) {
                           console.error("Anonymous auth failed", e2);
                           setIsOffline(true);
                           setUser({ uid: 'offline' });
                           return;
                        }
                     }
                     
                     onAuthStateChanged(newAuth, (u) => {
                         if (u) {
                             setUser(u);
                         } else {
                             // Session expired or signed out
                             setUser(null);
                         }
                     });
                 } else {
                     setIsOffline(true);
                     setUser({ uid: 'offline' });
                 }
            };

            // --- Core Auth & Config Logic ---
            const handleConfigUpdate = async () => {
                await reInit();
            };

            useEffect(() => {
                reInit();
            }, []);

            // --- Data Sync Logic ---
            useEffect(() => {
                if (!user || !tripId) return;

                if (isOffline) {
                    const localData = localStorage.getItem(`gtp_trip_${tripId}`);
                    if (localData) {
                        const d = JSON.parse(localData);
                        setTripData(d);
                        if(!selectedDate) setSelectedDate(d.startDate);
                        if(view === 'setup') { 
                             // Offline auto-login logic
                             setCurrentMember(d.members.find(m => m.role === 'owner') || d.members[0]);
                             setView('planner'); setSelectedDate(d.startDate); 
                        }
                        setRecentTrips(p => { const n = [{id: d.id, destination: d.destination, dateRange: `${d.startDate.slice(5)} - ${d.endDate.slice(5)}`}, ...p.filter(t=>t.id!==d.id)].slice(0,5); localStorage.setItem('gtp_recent_trips', JSON.stringify(n)); return n; });
                    }
                } else {
                    if (!dbRef.current) return;
                    
                    // 加入錯誤處理 callback，確保權限不足時切換為紅燈
                    return onSnapshot(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'trips', tripId), 
                        (s) => {
                            if(s.exists()) {
                                const d = s.data();
                                setTripData(d);
                                if(!selectedDate) setSelectedDate(d.startDate);
                                
                                // Check if current user is already a member
                                if(view === 'setup') {
                                    const found = d.members.find(m => m.deviceId === user.uid);
                                    if (found) {
                                        setCurrentMember(found);
                                        setView('planner');
                                        setSelectedDate(d.startDate);
                                    } else {
                                        setModals(m => ({...m, join: true}));
                                    }
                                }
                                setRecentTrips(p => { const n = [{id: d.id, destination: d.destination, dateRange: `${d.startDate.slice(5)} - ${d.endDate.slice(5)}`}, ...p.filter(t=>t.id!==d.id)].slice(0,5); localStorage.setItem('gtp_recent_trips', JSON.stringify(n)); return n; });
                                
                                // 資料讀取成功，確保為綠燈
                                if (isOffline) setIsOffline(false);
                            }
                        },
                        (error) => {
                            console.error("Snapshot error (Permission or Network):", error);
                            // 發生錯誤（如權限不足），切換為紅燈
                            setIsOffline(true);
                        }
                    );
                }
            }, [user, tripId, isOffline]);

            const handleStart = async () => {
                if (!setupForm.nickname || !setupForm.pin) { alert('請輸入暱稱與 PIN 碼'); return; }
                
                const id = generateId();
                const dates = getDatesArray(setupForm.startDate, setupForm.endDate);
                const itinerary = {}; dates.forEach(d => itinerary[d] = []);
                const accoms = {}; dates.forEach(d => { accoms[d] = [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }]; });
                
                const initialMember = { name: setupForm.nickname, pin: setupForm.pin, role: 'owner', deviceId: user.uid };
                
                const newData = { 
                    id, 
                    ...setupForm, 
                    ownerPin: setupForm.pin,
                    itinerary, 
                    accommodations: accoms, 
                    createdAt: Date.now(), 
                    members: [initialMember], 
                    expenseCategories: Object.keys(CATEGORY_COLORS), 
                    flights: { outbound: {}, inbound: {} } 
                };
                
                if (isOffline) {
                    localStorage.setItem(`gtp_trip_${id}`, JSON.stringify(newData));
                    setTripData(newData);
                    setCurrentMember(initialMember);
                    setTripId(id);
                    setView('planner');
                } else {
                    if(!dbRef.current) return;
                    setIsCreating(true);
                    try {
                        await setDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'trips', id), sanitizeFirestoreData(newData));
                        setTripId(id);
                        setCurrentMember(initialMember);
                        setView('planner');
                        // 成功寫入表示連線正常
                        setIsOffline(false);
                    } catch (e) { console.error(e); alert("Error: " + e.message); setIsOffline(true); } finally { setIsCreating(false); }
                }
            };

            const updateTrip = (field, val) => {
                if (isOffline) {
                    const newData = { ...tripData, [field]: val };
                    setTripData(newData);
                    localStorage.setItem(`gtp_trip_${tripId}`, JSON.stringify(newData));
                } else {
                    if(!dbRef.current) return;
                    updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'trips', tripId), { [field]: sanitizeFirestoreData(val) });
                }
            };

            const handleUpdateMember = (index, newInfo) => {
                const newMembers = [...tripData.members];
                newMembers[index] = { ...newMembers[index], ...newInfo };
                updateTrip('members', newMembers);
            };

            const handleRemoveMember = (index) => {
                const newMembers = tripData.members.filter((_, i) => i !== index);
                updateTrip('members', newMembers);
            };

            const handleEditTripSave = (newData) => {
                if(!isOwner) return;
                const updatedTrip = { ...tripData, ...newData };
                if (newData.startDate !== tripData.startDate || newData.endDate !== tripData.endDate) {
                     const newDates = getDatesArray(newData.startDate, newData.endDate);
                     const newItinerary = {}; const newAccoms = {};
                     newDates.forEach(d => { newItinerary[d] = tripData.itinerary[d] || []; newAccoms[d] = tripData.accommodations[d] || [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }]; });
                     updatedTrip.itinerary = newItinerary; updatedTrip.accommodations = newAccoms; setSelectedDate(newDates[0]); 
                }
                updateTrip('destination', updatedTrip.destination); 
                if (isOffline) { setTripData(updatedTrip); localStorage.setItem(`gtp_trip_${tripId}`, JSON.stringify(updatedTrip)); }
                else updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'trips', tripId), newData);
            };
            
            const updateActivity = (id, field, val) => { 
                if (!isOwner) return; 
                const acts = [...tripData.itinerary[selectedDate]]; 
                const idx = acts.findIndex(a=>a.id===id); 
                if(idx>=0) { acts[idx][field]=val; updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: acts}); } 
            };

            const handleSaveActivity = (data) => {
                if (!isOwner) return; 
                let acts = [...(tripData.itinerary[selectedDate] || [])];
                if (editingActivity) { acts = acts.map(a => a.id === editingActivity.id ? { ...data, id: editingActivity.id, createdBy: currentMember.name } : a); } 
                else { acts.push({ id: generateId(), ...data, createdBy: currentMember.name }); }
                updateTrip('itinerary', { ...tripData.itinerary, [selectedDate]: acts });
                setEditingActivity(null);
            };
            
            const deleteActivity = (id) => {
                if (!isOwner) return;
                setConfirm({ open: true, msg: '確定刪除此項目？', action: () => {
                    const newActs = tripData.itinerary[selectedDate].filter(a=>a.id!==id);
                    updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: newActs});
                }});
            };

            const deleteTransaction = (id, date, item) => {
                if (!isOwner && item.createdBy !== currentMember.name) { alert("只能刪除自己建立的記帳"); return; }
                setConfirm({ open: true, msg: '確定刪除此交易？', action: () => {
                    const newActs = tripData.itinerary[date].filter(a=>a.id!==id);
                    updateTrip('itinerary', {...tripData.itinerary, [date]: newActs});
                }});
            };
            
            const handleJoinTrip = async (memberInfo) => {
                const { name, pin, role, isNew } = memberInfo;
                let newMembers = [...tripData.members];
                
                if (isNew) {
                    newMembers.push({ name, pin, role, deviceId: user.uid });
                } else {
                    newMembers = newMembers.map(m => m.name === name ? { ...m, deviceId: user.uid } : m);
                }

                if (isOffline) {
                    const updated = { ...tripData, members: newMembers };
                    setTripData(updated);
                    localStorage.setItem(`gtp_trip_${tripId}`, JSON.stringify(updated));
                } else {
                    await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'trips', tripId), { members: newMembers });
                }
                setCurrentMember({ name, pin, role, deviceId: user.uid });
                setView('planner');
                setModals(m => ({...m, join: false}));
            };
            
            const handleDeleteTrip = (id, e) => {
                e.stopPropagation();
                setConfirm({ open: true, msg: '確定移除此紀錄?', action: () => {
                    const updated = recentTrips.filter(t => t.id !== id);
                    setRecentTrips(updated);
                    localStorage.setItem('gtp_recent_trips', JSON.stringify(updated));
                }});
            };

            const handleAddDate = async () => {
                if(!isOwner) return;
                const currentEnd = new Date(tripData.endDate); currentEnd.setDate(currentEnd.getDate() + 1); const newEndDate = currentEnd.toISOString().split('T')[0];
                if (isOffline) {
                    const newItinerary = { ...tripData.itinerary, [newEndDate]: [] };
                    const newAccommodations = { ...tripData.accommodations, [newEndDate]: [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }] };
                    const newData = { ...tripData, endDate: newEndDate, itinerary: newItinerary, accommodations: newAccommodations };
                    setTripData(newData); localStorage.setItem(`gtp_trip_${tripId}`, JSON.stringify(newData));
                } else {
                    const updates = { endDate: newEndDate, [`itinerary.${newEndDate}`]: [], [`accommodations.${newEndDate}`]: [{ id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }] };
                    await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'trips', tripId), sanitizeFirestoreData(updates));
                }
            };

            const handleUpdateAccommodation = (id, field, val) => { if(!isOwner) return; let currentList = tripData.accommodations[selectedDate]; if (!Array.isArray(currentList)) currentList = [currentList]; const newList = currentList.map(item => item.id === id ? { ...item, [field]: val } : item); updateTrip('accommodations', { ...tripData.accommodations, [selectedDate]: newList }); };
            const handleAddAccommodation = () => { if(!isOwner) return; let currentList = tripData.accommodations[selectedDate] || []; if (!Array.isArray(currentList)) currentList = [currentList]; const newList = [...currentList, { id: generateId(), name: '', bookingCode: '', checkInTime: '', checkOutDate: '', checkOutTime: '', phone: '', address: '', photoUrls: [] }]; updateTrip('accommodations', { ...tripData.accommodations, [selectedDate]: newList }); };
            const handleDeleteAccommodation = (id) => { if(!isOwner) return; setConfirm({ open: true, msg: '確定刪除?', action: () => { let currentList = tripData.accommodations[selectedDate]; if (!Array.isArray(currentList)) currentList = [currentList]; const newList = currentList.filter(item => item.id !== id); updateTrip('accommodations', { ...tripData.accommodations, [selectedDate]: newList }); }}); };
            
            const handlePhotoUpload = async (e) => {
                const f = e.target.files[0];
                if (f && uploadTarget) {
                    const b64 = await resizeImage(f);
                    if (b64) {
                        const photoObj = { url: b64, uploader: currentMember.name };
                        if (uploadTarget.type === 'activity') {
                            const acts = [...tripData.itinerary[selectedDate]];
                            const idx = acts.findIndex(a=>a.id===uploadTarget.id);
                            if(idx>=0) { 
                                acts[idx].photoUrls = [...(acts[idx].photoUrls||[]), photoObj]; 
                                updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: acts}); 
                            }
                        } else if (uploadTarget.type === 'accom') {
                            let currentList = tripData.accommodations[selectedDate];
                            if (!Array.isArray(currentList)) currentList = [currentList];
                            const newList = currentList.map(item => item.id === uploadTarget.id ? { ...item, photoUrls: [...(item.photoUrls || []), photoObj] } : item);
                            updateTrip('accommodations', { ...tripData.accommodations, [selectedDate]: newList });
                        }
                    }
                }
                e.target.value = ''; setUploadTarget(null);
            };

            const handlePhotoDelete = (targetId, urlToDelete, type) => {
                setConfirm({ open: true, msg: '確定要刪除這張照片嗎？', action: () => {
                    if (type === 'activity') {
                        const acts = [...tripData.itinerary[selectedDate]];
                        const idx = acts.findIndex(a => a.id === targetId);
                        if(idx >= 0) { 
                            acts[idx].photoUrls = acts[idx].photoUrls.filter(p => (typeof p === 'string' ? p : p.url) !== urlToDelete); 
                            updateTrip('itinerary', {...tripData.itinerary, [selectedDate]: acts}); 
                        }
                    } else {
                        let currentList = tripData.accommodations[selectedDate];
                        if (!Array.isArray(currentList)) currentList = [currentList];
                        const newList = currentList.map(item => item.id === targetId ? { ...item, photoUrls: item.photoUrls.filter(p => (typeof p === 'string' ? p : p.url) !== urlToDelete) } : item);
                        updateTrip('accommodations', { ...tripData.accommodations, [selectedDate]: newList });
                    }
                }});
            };

            const expenseData = useMemo(() => {
                if (!tripData) return [];
                let targetActivities = [];
                if (expenseFilterDate === 'all') { targetActivities = Object.values(tripData.itinerary || {}).flat(); } 
                else { targetActivities = tripData.itinerary?.[expenseFilterDate] || []; }
                const expenses = targetActivities.filter(a => a.transport === 'expense' || (a.cost && a.cost > 0));
                const totals = {};
                const currentCategories = tripData.expenseCategories || Object.keys(CATEGORY_COLORS);
                currentCategories.forEach(c => totals[c] = 0);
                expenses.forEach(e => {
                    let cat = e.category;
                    if (!cat) {
                        if (e.transport === 'expense') cat = '其他';
                        else if (['plane','shinkansen','nightbus','train','bus','taxi','car'].includes(e.transport)) cat = '交通';
                        else if (e.title && e.title.includes('門票')) cat = '門票';
                        else cat = '娛樂';
                    }
                    totals[cat] = (totals[cat] || 0) + (e.cost || 0);
                });
                return Object.keys(totals).map(k => ({ category: k, value: totals[k], color: CATEGORY_COLORS[k] || '#ccc' }));
            }, [tripData, expenseFilterDate]);

            const dailyExpenseData = useMemo(() => {
                if (!tripData) return [];
                const datesToShow = expenseFilterDate === 'all' ? getDatesArray(tripData.startDate, tripData.endDate) : [expenseFilterDate];
                return datesToShow.map(date => {
                    const dayExpenses = (tripData.itinerary?.[date] || []).filter(a => a.transport === 'expense' || (a.cost && a.cost > 0));
                    let total = 0;
                    const breakdown = [];
                    const dayCatTotals = {};
                    dayExpenses.forEach(e => {
                        let cat = e.category;
                        if (!cat) {
                            if (e.transport === 'expense') cat = '其他';
                            else if (['plane','shinkansen','nightbus','train','bus','taxi','car'].includes(e.transport)) cat = '交通';
                            else if (e.title && e.title.includes('門票')) cat = '門票';
                            else cat = '娛樂';
                        }
                        dayCatTotals[cat] = (dayCatTotals[cat] || 0) + (e.cost || 0);
                        total += (e.cost || 0);
                    });
                    Object.keys(dayCatTotals).forEach(cat => { breakdown.push({ category: cat, cost: dayCatTotals[cat], color: CATEGORY_COLORS[cat] || PALETTE[Math.floor(Math.random() * PALETTE.length)] }); });
                    return { date, total, breakdown };
                });
            }, [tripData, expenseFilterDate]);

            const sortedExpensesByDate = useMemo(() => {
                if (!tripData) return [];
                const dates = expenseFilterDate === 'all' ? getDatesArray(tripData.startDate, tripData.endDate) : [expenseFilterDate];
                const expenseList = [];
                dates.forEach(date => {
                    const dayExpenses = (tripData.itinerary?.[date] || []).filter(a => a.transport === 'expense' || (a.cost && a.cost > 0));
                    if (dayExpenses.length > 0) { expenseList.push({ date, items: dayExpenses }); }
                });
                return expenseList;
            }, [tripData, expenseFilterDate]);

            const sortedActivities = useMemo(() => {
                const acts = tripData?.itinerary?.[selectedDate] || [];
                return [...acts].sort((a, b) => a.time.localeCompare(b.time));
            }, [tripData, selectedDate]);

            if (authError || connectionTimeout) return <div className="flex h-screen items-center justify-center bg-red-50 p-8"><div className="bg-[#F5FDFC] p-6 rounded-2xl shadow-xl max-w-md text-center"><h2 className="text-2xl font-bold text-red-500 mb-2">{authError ? "Firebase 驗證錯誤" : "連線逾時"}</h2><button onClick={() => window.location.reload()} className="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">重試</button></div></div>;
            if (!user) return <div className="flex h-screen items-center justify-center text-[#0ABAB5] font-bold animate-pulse">載入中...</div>;

            return (
                <div className="w-full max-w-[480px] h-screen bg-[#E0F2F1] shadow-2xl flex flex-col overflow-hidden relative mx-auto border-x border-[#eeeeee]">
                    <div className={`absolute inset-0 z-50 bg-black/50 ${!isMenuOpen && 'hidden'}`} onClick={()=>setIsMenuOpen(false)}>
                        <div className="w-72 bg-[#F5FDFC] h-full p-4" onClick={e=>e.stopPropagation()}>
                            <h2 className="text-lg font-bold text-[#0ABAB5] mb-4">Good Travel Plan</h2>
                            <button onClick={()=>{setView('setup'); setIsMenuOpen(false);}} className="w-full text-left p-2 hover:bg-gray-100 rounded mb-2">建立新旅程</button>
                            {view !== 'setup' && (
                                <button 
                                    onClick={() => { setModals({ ...modals, members: true }); setIsMenuOpen(false); }} 
                                    className="w-full text-left p-2 hover:bg-gray-100 rounded mb-2 flex items-center gap-2 text-gray-700"
                                >
                                    <Users size={18} /> 旅伴管理
                                </button>
                            )}
                            <h3 className="text-xs font-bold text-gray-400 mt-4 mb-2">近期</h3>
                            {recentTrips.map(t => <div key={t.id} onClick={()=>{setTripId(t.id); setView('planner'); setIsMenuOpen(false);}} className="p-2 hover:bg-gray-100 rounded cursor-pointer flex justify-between"><div><div className="font-bold">{t.destination}</div><div className="text-xs text-gray-400">{t.dateRange}</div></div><button onClick={e=>{e.stopPropagation(); setConfirm({open:true, msg:'刪除紀錄?', action:()=>setRecentTrips(p=>p.filter(x=>x.id!==t.id))})}}><Trash2 size={14}/></button></div>)}
                        </div>
                    </div>

                    {view === 'setup' && (
                        <div className="p-8 h-full flex flex-col relative">
                             {/* Header Area */}
                             <div className="flex justify-center items-center mb-6 relative">
                                 <h2 className="text-3xl font-bold text-[#0ABAB5]">Travel Planner</h2>
                                 <button 
                                    onClick={() => setModals({ ...modals, config: true })}
                                    className="absolute right-0 w-10 h-10 bg-[#F5FDFC] rounded-full flex items-center justify-center hover:opacity-90 transition-all z-20 border border-[#eeeeee]"
                                >
                                    {isOffline ? <WifiOff size={20} className="text-red-400"/> : <Wifi size={20} className="text-green-500"/>}
                                </button>
                            </div>

                             {/* Tabs */}
                             <div className="flex mb-6 border-b border-gray-200">
                                 <button 
                                    onClick={() => setSetupTab('create')} 
                                    className={`flex-1 pb-2 text-sm font-bold transition-colors ${setupTab === 'create' ? 'text-[#0ABAB5] border-b-2 border-[#0ABAB5]' : 'text-gray-400'}`}
                                 >
                                    建立旅程
                                 </button>
                                 <button 
                                    onClick={() => setSetupTab('join')} 
                                    className={`flex-1 pb-2 text-sm font-bold transition-colors ${setupTab === 'join' ? 'text-[#0ABAB5] border-b-2 border-[#0ABAB5]' : 'text-gray-400'}`}
                                 >
                                    加入旅程
                                 </button>
                             </div>

                             {/* Content Area */}
                             <div className="flex-1 overflow-y-auto no-scrollbar pb-20">
                                 {setupTab === 'create' ? (
                                     <div className="space-y-4">
                                         <div className="space-y-3 p-1">
                                            <input placeholder="目的地" value={setupForm.destination} onChange={e=>setSetupForm({...setupForm, destination:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                            <div className="flex gap-2">
                                                <input type="date" value={setupForm.startDate} onChange={e=>setSetupForm({...setupForm, startDate:e.target.value})} className="flex-1 p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 font-bold" />
                                                <input type="date" value={setupForm.endDate} onChange={e=>setSetupForm({...setupForm, endDate:e.target.value})} className="flex-1 p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm outline-none text-gray-700 font-bold" />
                                            </div>
                                            <select value={setupForm.currency} onChange={e=>setSetupForm({...setupForm, currency:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl text-sm font-bold outline-none text-gray-700">
                                                {currencies.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}
                                            </select>
                                            <div className="grid grid-cols-2 gap-2">
                                                <input placeholder="您的暱稱" value={setupForm.nickname} onChange={e=>setSetupForm({...setupForm, nickname:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                                <input type="password" placeholder="設定 PIN 碼" value={setupForm.pin} onChange={e=>setSetupForm({...setupForm, pin:e.target.value})} className="w-full p-3 border border-[#eeeeee] bg-[#E2E2E2] rounded-xl outline-none focus:ring-2 focus:ring-[#0ABAB5] text-gray-700 font-bold" />
                                            </div>
                                            <button onClick={handleStart} disabled={isCreating} className="w-full py-3.5 bg-[#0ABAB5] text-white rounded-xl font-bold shadow-sm hover:bg-[#008985] transition-all mt-4 flex items-center justify-center">{isCreating ? <Loader className="animate-spin" /> : '開始規劃'}</button>
                                         </div>
                                     </div>
                                 ) : (
                                     <div className="space-y-4 p-1">
                                         <div className="bg-[#F5FDFC] border border-[#eeeeee] rounded-xl p-4">
                                             <label className="text-xs font-bold text-gray-500 block mb-2">輸入旅程 ID</label>
                                             <div className="flex gap-2">
                                                 <input 
                                                     placeholder="例如：x9z8y7" 
                                                     value={joinId} 
                                                     onChange={e => setJoinId(e.target.value)} 
                                                     className="flex-1 p-3 bg-[#E2E2E2] border border-[#eeeeee] rounded-xl text-gray-700 font-bold outline-none focus:ring-2 focus:ring-[#0ABAB5]" 
                                                 />
                                                 <button 
                                                     onClick={() => { if(joinId){ setTripId(joinId); setView('planner'); } }} 
                                                     className="bg-gray-800 text-white px-6 rounded-xl font-bold hover:bg-gray-700 transition-all"
                                                 >
                                                     加入
                                                 </button>
                                             </div>
                                             <p className="text-[10px] text-gray-400 mt-2">
                                                 * 加入後，系統將會驗證您的身分。若為新成員，請準備好設定您的專屬 PIN 碼。
                                             </p>
                                         </div>
                                     </div>
                                 )}

                                 {/* Recent Trips Cards - Only shown if there are trips */}
                                 {recentTrips.length > 0 && (
                                     <div className="mt-8">
                                         <h3 className="text-sm font-bold text-gray-500 mb-3">最近瀏覽</h3>
                                         <div className="space-y-3">
                                             {recentTrips.map((t) => (
                                                 <div key={t.id} onClick={() => { setTripId(t.id); setView('planner'); }} className="group bg-white border border-[#eeeeee] rounded-xl p-4 flex items-center gap-4 cursor-pointer hover:border-[#0ABAB5] transition-all">
                                                     {/* Date Box */}
                                                     <div className="bg-[#F5FDFC] rounded-lg p-2 w-14 h-14 flex flex-col items-center justify-center text-[#0ABAB5] border border-[#eeeeee]">
                                                         <span className="text-[10px] font-bold uppercase">{t.dateRange ? t.dateRange.split('-')[0].trim().split('/')[0] : 'N/A'}月</span>
                                                         <span className="text-lg font-bold leading-none">{t.dateRange ? t.dateRange.split('-')[0].trim().split('/')[1] : '--'}</span>
                                                     </div>
                                                     
                                                     {/* Info */}
                                                     <div className="flex-1">
                                                         <h4 className="font-bold text-gray-800 text-lg">{t.destination}</h4>
                                                         <p className="text-xs text-gray-400 mt-0.5">{t.dateRange}</p>
                                                     </div>

                                                     {/* Action */}
                                                     <div className="flex flex-col items-end gap-2">
                                                         <button onClick={(e) => handleDeleteTrip(t.id, e)} className="p-2 text-gray-300 hover:text-red-400 transition-colors">
                                                             <Trash2 size={16} />
                                                         </button>
                                                         <div className="text-[#0ABAB5] opacity-0 group-hover:opacity-100 transition-opacity">
                                                             <ArrowRight size={20} />
                                                         </div>
                                                     </div>
                                                 </div>
                                             ))}
                                         </div>
                                     </div>
                                 )}
                                 
                                 {/* Empty State if no recent trips (optional, if you want to show something when empty) */}
                                 {recentTrips.length === 0 && (
                                     <div className="mt-12 flex flex-col items-center justify-center text-center opacity-50">
                                         {/* Use a simple SVG icon or lucide icon */}
                                         <div className="w-24 h-24 bg-[#E2E2E2] rounded-full flex items-center justify-center mb-4">
                                             <Plane size={40} className="text-gray-400" />
                                         </div>
                                         <p className="text-sm font-bold text-gray-400">還沒有計畫嗎？</p>
                                         <p className="text-xs text-gray-400 mt-1">開始你的第一趟旅程吧！</p>
                                     </div>
                                 )}
                             </div>
                        </div>
                    )}

                    {(view === 'planner' || view === 'expense') && tripData && (
                        <>
                            <HeaderWithTabs tripData={tripData} selectedDate={selectedDate} setSelectedDate={setSelectedDate} handleAddDate={handleAddDate} view={view} setView={setView} setIsMenuOpen={setIsMenuOpen} isOffline={isOffline} onConfig={() => setModals({ ...modals, config: true })} onManageMembers={() => setModals({ ...modals, members: true })} />
                            
                            <div className="flex-1 overflow-y-auto p-4 pb-24">
                                {view === 'planner' ? (
                                    <>
                                        <div className="grid grid-cols-2 gap-3 mb-4">
                                            {isOwner && <button onClick={()=>setModals({...modals, activity:true})} className="p-3 rounded-2xl bg-[#6A8E83] text-white font-bold flex justify-center items-center gap-2 border border-[#6A8E83]"><Plus size={18}/> 新增行程</button>}
                                            <button onClick={()=>setModals({...modals, expense:true})} className={`p-3 rounded-2xl bg-[#D68C68] text-white font-bold flex justify-center items-center gap-2 border border-[#D68C68] ${!isOwner ? 'col-span-2' : ''}`}><DollarSign size={18}/> 記帳</button>
                                        </div>
                                        {selectedDate === tripData.startDate && <FlightCard label="去程" icon={Plane} data={tripData.flights.outbound} onUpdate={(f,v)=>updateTrip('flights', {...tripData.flights, outbound: {...tripData.flights.outbound, [f]:v}})} isOwner={isOwner} />}
                                        {selectedDate === tripData.endDate && <FlightCard label="回程" icon={Plane} data={tripData.flights.inbound} onUpdate={(f,v)=>updateTrip('flights', {...tripData.flights, inbound: {...tripData.flights.inbound, [f]:v}})} isOwner={isOwner} />}
                                        <div className="space-y-3">
                                            {sortedActivities.map(act => {
                                                const isExpanded = expandedId === act.id;
                                                return (
                                                <div key={act.id} className={`bg-[#F5FDFC] rounded-2xl border overflow-hidden ${act.transport==='expense'?'border-orange-100 bg-orange-50/30':'border-[#eeeeee]'}`}>
                                                    <div className="flex items-stretch min-h-[2.8rem] cursor-pointer" onClick={()=>setExpandedId(isExpanded?null:act.id)}>
                                                        <div className="w-16 flex flex-col items-center justify-center border-r border-gray-100 bg-white/50 py-1 px-1">
                                                            <div onClick={(e) => e.stopPropagation()}><AutoSaveInput value={act.time} onSave={v=>updateActivity(act.id,'time',v)} readOnly={!isOwner} className="font-bold text-sm text-center bg-transparent w-full outline-none p-0 text-gray-700" /></div>
                                                            {act.transport === 'expense' ? <div className="text-[10px] text-orange-400 flex items-center gap-1 mt-0.5"><DollarSign size={10}/>消費</div> : <div className="flex items-center justify-center gap-1 mt-0.5 w-full"></div>}
                                                        </div>
                                                        <div className="flex-1 flex items-center px-4 overflow-hidden"><div className="w-full" onClick={(e) => e.stopPropagation()}><AutoSaveInput value={act.title} onSave={v=>updateActivity(act.id,'title',v)} readOnly={!isOwner} className="font-bold text-lg bg-transparent w-full text-gray-800" /></div></div>
                                                        <div className="flex items-center pr-3 gap-2">
                                                            {act.transport !== 'expense' && <button onClick={(e) => {e.stopPropagation(); openGoogleMaps(act.title);}} className="text-gray-400 hover:text-[#0ABAB5] flex items-center justify-center p-1"><Navigation size={16} /></button>}
                                                            <ChevronDown size={20} className={`text-gray-300 transition ${isExpanded?'rotate-180':''}`}/>
                                                        </div>
                                                    </div>
                                                    <div className={`transition-all ${isExpanded?'max-h-[500px]':'max-h-0'}`}>
                                                        <div className="p-4 border-t border-gray-100 bg-[#F5FDFC] space-y-3">
                                                            <AutoSaveInput value={act.note} onSave={v=>updateActivity(act.id,'note',v)} readOnly={!isOwner} placeholder="備註..." className="w-full text-sm bg-[#E2E2E2] rounded-xl p-2 text-gray-700 border border-[#eeeeee]" />
                                                            {act.transport!=='expense' && <div className="grid grid-cols-2 gap-2">
                                                                <div className="bg-[#E2E2E2] p-2 rounded-xl border border-[#eeeeee]"><label className="text-[10px] text-gray-400 font-bold">代碼</label><AutoSaveInput value={act.bookingCode} onSave={v=>updateActivity(act.id,'bookingCode',v)} readOnly={!isOwner} className="text-sm bg-transparent w-full text-gray-700"/></div>
                                                                <div className="bg-[#E2E2E2] p-2 rounded-xl border border-[#eeeeee]"><label className="text-[10px] text-gray-400 font-bold">費用</label><AutoSaveInput value={act.cost} onSave={v=>updateActivity(act.id,'cost',v)} type="number" readOnly={!isOwner} className="text-sm bg-transparent w-full text-gray-700"/></div>
                                                            </div>}
                                                            {act.transport==='expense' && <div className="flex gap-2 bg-orange-50 p-2 rounded-xl border border-orange-100"><div className="flex-1 text-orange-600 font-bold">${act.cost}</div><div className="flex-1">{act.currency}</div><div className="flex-1">{act.category}</div><div className="text-xs text-gray-400 self-center">{act.payer}付</div></div>}
                                                            <div>
                                                                <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-gray-400">照片</label>
                                                                    <div className="flex gap-2">
                                                                        {act.transport!=='expense' && isOwner && <button onClick={() => { setEditingActivity(act); setModals({ ...modals, activity: true }); }} className="text-blue-400 hover:text-blue-600"><Pencil size={16} /></button>}
                                                                        {(isOwner || (act.transport === 'expense' && act.createdBy === currentMember.name)) && <button onClick={() => act.transport==='expense' ? deleteTransaction(act.id, selectedDate, act) : deleteActivity(act.id)} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button>}
                                                                    </div>
                                                                </div>
                                                                <div className="flex gap-2 overflow-x-auto">{act.photoUrls?.map((p,i) => { const url = typeof p === 'string' ? p : p.url; return (<div key={i} className="relative w-10 h-10 flex-shrink-0"><img src={url} className="w-full h-full object-cover rounded" onClick={()=>setModals({...modals, viewingImage:url})} />{(isOwner || (typeof p !== 'string' && p.uploader === currentMember.name)) && <button onClick={()=>setConfirm({open:true, msg:'刪除照片?', action:()=>{const n=[...act.photoUrls]; n.splice(i,1); updateActivity(act.id, 'photoUrls', n)}})} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button>}</div>) })}<button onClick={()=>{setUploadTarget({type:'activity', id:act.id}); fileRef.current.click();}} className="w-10 h-10 border-2 border-dashed rounded flex items-center justify-center text-gray-400"><Camera size={16}/></button></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )})}
                                        </div>
                                        <AccommodationCard date={selectedDate} data={Array.isArray(tripData.accommodations?.[selectedDate]) ? tripData.accommodations[selectedDate] : (tripData.accommodations?.[selectedDate] ? [tripData.accommodations[selectedDate]] : [])} onUpdate={handleUpdateAccommodation} onPhotoUpload={(id) => { setUploadTarget({type: 'accom', id: id}); fileRef.current?.click(); }} onPhotoDelete={handlePhotoDelete} onViewImage={(u)=>setModals({...modals, viewingImage:u})} onAdd={handleAddAccommodation} onDelete={handleDeleteAccommodation} isOwner={isOwner} currentMember={currentMember} />
                                    </>
                                ) : (
                                    // ... (Expense View)
                                    <div className="space-y-6">
                                        <div className="flex justify-between items-center mb-2"><h3 className="text-lg font-bold text-gray-700 flex items-center gap-2"><History size={20} className="text-[#D68C68]" /> 交易紀錄</h3><div className="relative"><select value={expenseFilterDate} onChange={(e) => setExpenseFilterDate(e.target.value)} className="appearance-none pl-3 pr-8 py-1.5 bg-[#E2E2E2] border border-gray-200 text-gray-700 text-xs font-bold rounded-lg shadow-sm focus:outline-none focus:ring-1 focus:ring-[#0ABAB5] cursor-pointer"><option value="all">全部日期</option>{getDatesArray(tripData.startDate, tripData.endDate).map(date => (<option key={date} value={date}>{date}</option>))}</select><div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500"><ChevronDown size={12} /></div></div></div>
                                        
                                        {/* Inserted Transaction List Here */}
                                        <div className="bg-[#F5FDFC] p-4 rounded-xl border border-[#eeeeee] shadow-sm">
                                            {sortedExpensesByDate.length === 0 ? (
                                                <div className="text-center py-8 text-gray-400 border-2 border-dashed border-gray-300 rounded-xl">尚無消費紀錄</div>
                                            ) : (
                                                <div className="space-y-4">
                                                    {sortedExpensesByDate.map(({ date, items }) => (
                                                        <div key={date}>
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <span className="text-xs font-bold text-gray-600 bg-white px-2 py-1 rounded-md shadow-sm border border-gray-100">{date}</span>
                                                                <span className="text-[10px] text-gray-400">({getDayOfWeek(date)})</span>
                                                            </div>
                                                            <div className="space-y-2">
                                                                {items.map(e => (
                                                                    <div key={e.id} onClick={() => setModals({...modals, transaction:e})} className="flex justify-between items-center bg-white p-2.5 rounded-lg shadow-sm border border-gray-100 active:scale-[0.99] transition-transform cursor-pointer">
                                                                        <div className="flex flex-col">
                                                                            <div className="font-bold text-gray-700 text-sm">{e.title || '未命名'}</div>
                                                                            <div className="text-[10px] text-gray-400 flex items-center gap-1 mt-0.5">
                                                                                <span className="bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">{e.category}</span>
                                                                                <span>•</span><span>{e.payer}</span>
                                                                                {e.time && <span>• {e.time}</span>}
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex items-center gap-3">
                                                                            <div className="text-red-500 font-bold text-sm bg-red-50 px-2 py-1 rounded-lg">-{e.cost} <span className="text-[10px] font-normal text-red-400">{e.currency}</span></div>
                                                                            <button onClick={(evt) => { evt.stopPropagation(); deleteTransaction(e.id, date, e); }} className="text-gray-400 hover:text-red-500 p-1 rounded-full hover:bg-red-50 transition-colors"><Trash2 size={16} /></button>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>

                                        <div className="bg-[#F5FDFC] p-4 rounded-xl border border-[#eeeeee]"><h3 className="font-bold text-gray-700 mb-4 text-sm flex items-center gap-2"><PieChart size={16} /> 支出類別統計</h3><SimplePieChart data={expenseData} /></div>
                                        <div className="bg-[#F5FDFC] p-4 rounded-xl border border-[#eeeeee]"><h3 className="font-bold text-gray-700 mb-4 text-sm flex items-center gap-2"><BarChart3 size={16} /> 每日趨勢</h3><SimpleBarChart data={dailyExpenseData} /></div>
                                    </div>
                                )}
                            </div>

                            <ActivityModal isOpen={modals.activity} onClose={() => { setModals({...modals, activity:false}); setEditingActivity(null); }} onSave={handleSaveActivity} tripData={tripData} defaultValues={editingActivity} />
                            <ExpenseModal isOpen={modals.expense} onClose={()=>setModals({...modals, expense:false})} tripData={tripData} onSave={(d, date)=>{const acts=[...(tripData.itinerary[date]||[]), {id:generateId(), ...d, transport:'expense', createdBy: currentMember.name}]; updateTrip('itinerary', {...tripData.itinerary, [date]: acts});}} onUpdateCategories={c=>updateTrip('expenseCategories',c)} selectedDate={selectedDate} />
                            <ImageModal src={modals.viewingImage} onClose={()=>setModals({...modals, viewingImage:null})} />
                            <TransactionDetailModal transaction={modals.transaction} onClose={()=>setModals({...modals, transaction:null})} onViewImage={u=>setModals({...modals, viewingImage:u})} />
                            {modals.editTrip && <EditTripModal isOpen={modals.editTrip} onClose={() => setModals({ ...modals, editTrip: false })} tripData={tripData} onSave={handleEditTripSave} />}
                            <JoinModal isOpen={modals.join} onClose={() => setModals(m => ({...m, join: false}))} tripData={tripData} onJoin={handleJoinTrip} />
                            <MemberManagementModal isOpen={modals.members} onClose={() => setModals({ ...modals, members: false })} tripData={tripData} currentMember={currentMember} onUpdateMember={handleUpdateMember} onRemoveMember={handleRemoveMember} />
                            <input type="file" ref={fileRef} className="hidden" onChange={handlePhotoUpload} accept="image/*" />
                            <FirebaseConfigModal isOpen={modals.config} onClose={() => setModals({ ...modals, config: false })} onConfigUpdate={handleConfigUpdate} />
                            <ConfirmModal isOpen={confirm.open} message={confirm.msg} onConfirm={()=>{confirm.action(); setConfirm({open:false})}} onCancel={()=>setConfirm({open:false})} />
                        </>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>